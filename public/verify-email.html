<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MEI Robô — Verifique seu e-mail</title>

  <!-- Firebase compat (já usado no projeto) -->
  <script defer src="/__/firebase/9.22.2/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/9.22.2/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/init.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0e0f10;color:#e8e8e8;margin:0}
    .wrap{max-width:520px;margin:6rem auto 2rem;padding:24px;background:#151618;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    h1{font-size:1.2rem;margin:0 0 8px}
    p{opacity:.9;line-height:1.5}
    .row{margin:10px 0}
    .hint{font-size:.9rem;opacity:.8}
    .ok{color:#9be69b}
    .err{color:#ff7a7a}
    button{width:100%;padding:14px 16px;border-radius:12px;border:0;cursor:pointer;font-size:1rem}
    .primary{background:#25d366;color:#0b141a;font-weight:600}
    .ghost{background:#2a2d31;color:#e8e8e8}
    .email{font-family:ui-monospace,Consolas,monospace;background:#111;padding:6px 8px;border-radius:8px;display:inline-block}
    .top{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .logo{width:28px;height:28px;border-radius:6px;background:#25d366}
    .row-actions{display:flex;gap:10px;flex-wrap:wrap}
    .row-actions button{flex:1 1 200px}
    small.dim{opacity:.65}
    .muted{opacity:.75}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo"></div>
      <h1>Verificação de e-mail</h1>
    </div>
    <p class="hint" id="intro">Abra o link que enviamos para seu e-mail. Se você chegou por esse link, estamos confirmando automaticamente…</p>
    <div class="row">E-mail: <span id="email" class="email">—</span></div>

    <div class="row row-actions">
      <button id="btn" class="primary">Já verifiquei — continuar</button>
      <button id="resendBtn" class="ghost" title="Reenvia o e-mail com logo e botão">Reenviar e-mail</button>
    </div>

    <div id="msg" class="row hint"></div>
    <div class="row"><small class="dim" id="tip"></small></div>
  </div>

  <script>
    // ===== Utils de querystring =====
    function qs(k){
      try { return new URLSearchParams(location.search).get(k) || ""; }
      catch(_) { return ""; }
    }

    // Para onde vamos depois de verificar
    const cont = qs("cont") || "/pages/configuracao.html";
    // Token de verificação gerado pelo backend (vt=...)
    const vt = qs("vt") || "";
    // E-mail opcional vindo no link
    const emailParam = qs("email") || "";

    // Backend canônico (Render)
    const API_BASE = "https://mei-robo-prod.onrender.com";

    // Refs de UI
    const msg = document.getElementById("msg");
    const btn = document.getElementById("btn");
    const resendBtn = document.getElementById("resendBtn");
    const emailSpan = document.getElementById("email");
    const tip = document.getElementById("tip");
    const intro = document.getElementById("intro");

    // Debounce local para reenvio
    const LS_KEY = "meirobo_last_verif_sent_at"; // timestamp do último reenvio

    // ===== Sinalização para outras abas/janelas =====
    function broadcastVerified(){
      // Flag que o cadastro.html e outros scripts já conhecem
      try { localStorage.setItem("mr_email_verified","1"); } catch(_) {}

      try {
        if ("BroadcastChannel" in window) {
          new BroadcastChannel("auth").postMessage({ type: "email-verified" });
          new BroadcastChannel("mr_events").postMessage({ type: "email_verified" });
        }
      } catch(_) {}

      try { window.opener && window.opener.postMessage({ type: "email-verified" }, "*"); } catch(_) {}
      try { window.parent && window.parent.postMessage({ type: "email-verified" }, "*"); } catch(_) {}

      try {
        const ev = new Event("email-verified");
        window.dispatchEvent(ev);
      } catch(_) {}
    }

    // ===== Debounce de reenvio =====
    function renderDebounceTip(){
      let last = 0;
      try { last = Number(localStorage.getItem(LS_KEY) || "0"); } catch(_) { last = 0; }
      if (!last) { tip.textContent = ""; return; }

      const secs = Math.max(0, 90 - Math.floor((Date.now() - last)/1000));
      tip.textContent = secs > 0 ? ("Você pode reenviar novamente em " + secs + "s.") : "";
      if (secs > 0) setTimeout(renderDebounceTip, 1000);
    }

    function canResend(){
      let last = 0;
      try { last = Number(localStorage.getItem(LS_KEY) || "0"); } catch(_) { last = 0; }
      return (Date.now() - last) > 90_000; // 90s
    }

    // ===== Confirmação via backend usando vt =====
    async function confirmWithBackend(){
      if (!vt) {
        msg.textContent = "Link de verificação inválido ou incompleto. Abra o e-mail mais recente e clique no botão.";
        msg.className = "row err";
        return false;
      }

      msg.textContent = "Confirmando seu e-mail…";
      msg.className = "row hint";

      try {
        const body = { vt: vt };
        if (emailParam) body.email = emailParam;

        const res = await fetch(API_BASE.replace(/\/$/,"") + "/api/auth/confirm-email", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(body)
        });

        const raw = await res.text();
        let data = {};
        try { data = raw ? JSON.parse(raw) : {}; } catch(_) {}

        const ok =
          !!(data &&
             (data.verified === true ||
              data.email_verified === true ||
              data.ok === true ||
              data.status === "verified"));

        let already =
          !!(data &&
             (data.already === true ||
              /already|usado|expirado/i.test(String(data.message || ""))));

        // Se o backend responder 409/410 mas marcar como já usado, tratamos como sucesso idempotente
        if (!res.ok && (res.status === 409 || res.status === 410)) {
          already = true;
        }

        if (ok || already) {
          try { localStorage.setItem("mr_email_verified","1"); } catch(_) {}

          msg.textContent = already
            ? "Este link já tinha sido usado, mas seu e-mail está verificado. Vamos seguir…"
            : "E-mail verificado com sucesso! Redirecionando…";
          msg.className = "row ok";

          broadcastVerified();

          setTimeout(function(){
            location.href = cont || "/pages/configuracao.html";
          }, 800);
          return true;
        }

        // Caso não venha nenhum sinal de sucesso
        msg.textContent =
          (data && data.message) ||
          "Não conseguimos confirmar este link. Abra o e-mail mais recente ou peça um novo envio.";
        msg.className = "row err";
        return false;

      } catch (e) {
        msg.textContent = "Erro ao confirmar: " + (e && e.message ? e.message : e);
        msg.className = "row err";
        return false;
      }
    }

    // ===== Reenvio via backend (se o usuário estiver logado nesta aba) =====
    async function resend(){
      msg.textContent = "";
      msg.className = "row hint";

      try {
        if (!window.firebase || !firebase.auth) {
          msg.textContent = "Abra a aba original onde você fez o cadastro para reenviar o e-mail.";
          msg.className = "row err";
          return;
        }

        const u = firebase.auth().currentUser || null;
        if (!u) {
          msg.textContent = "Faça login na aba original e tente reenviar de lá.";
          msg.className = "row err";
          return;
        }

        if (!canResend()) {
          renderDebounceTip();
          msg.textContent = "Aguarde alguns segundos antes de reenviar.";
          msg.className = "row hint";
          return;
        }

        resendBtn.disabled = true;
        resendBtn.textContent = "Reenviando…";

        const idToken = await u.getIdToken(true);
        const r = await fetch(API_BASE.replace(/\/$/,"") + "/api/auth/send-verification-email", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + idToken,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({})
        });

        const text = await r.text();
        if (r.ok) {
          try { localStorage.setItem(LS_KEY, String(Date.now())); } catch(_) {}
          renderDebounceTip();
          msg.textContent = "Reenviado! Verifique sua caixa de entrada e o spam.";
          msg.className = "row ok";
        } else {
          msg.textContent = "Falhou ao reenviar: " + (text || r.status);
          msg.className = "row err";
        }

      } catch (e) {
        msg.textContent = "Erro ao reenviar: " + (e && e.message ? e.message : e);
        msg.className = "row err";
      } finally {
        resendBtn.disabled = false;
        resendBtn.textContent = "Reenviar e-mail";
      }
    }

    // ===== Boot =====
    document.addEventListener("DOMContentLoaded", function(){
      // Mostra o e-mail se veio no link
      emailSpan.textContent = emailParam || "—";

      renderDebounceTip();

      if (vt) {
        // Caso normal vindo do e-mail oficial com vt
        intro.textContent = "Confirmando seu e-mail…";
        confirmWithBackend();
      } else {
        // Link sem vt (antigo / manual)
        intro.textContent =
          "Abra o link que enviamos para seu e-mail. Se você chegou por esse link, estamos confirmando automaticamente…";
      }
    });

    // ===== Botões =====
    btn.addEventListener("click", function(){
      if (vt) {
        confirmWithBackend();
      } else {
        msg.textContent = "Este link está incompleto. Abra o e-mail mais recente e clique no botão de verificação.";
        msg.className = "row err";
      }
    });

    resendBtn.addEventListener("click", resend);
  </script>
</body>
</html>
