<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MEI Robô — Verifique seu e-mail</title>

  <!-- Firebase compat (já usado no projeto) -->
  <script defer src="/__/firebase/9.22.2/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/9.22.2/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/init.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0e0f10;color:#e8e8e8;margin:0}
    .wrap{max-width:520px;margin:6rem auto 2rem;padding:24px;background:#151618;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    h1{font-size:1.2rem;margin:0 0 8px}
    p{opacity:.9;line-height:1.5}
    .row{margin:10px 0}
    .hint{font-size:.9rem;opacity:.8}
    .ok{color:#9be69b}
    .err{color:#ff7a7a}
    button{width:100%;padding:14px 16px;border-radius:12px;border:0;cursor:pointer;font-size:1rem}
    .primary{background:#25d366;color:#0b141a;font-weight:600}
    .ghost{background:#2a2d31;color:#e8e8e8}
    .email{font-family:ui-monospace,Consolas,monospace;background:#111;padding:6px 8px;border-radius:8px;display:inline-block}
    .top{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .logo{width:28px;height:28px;border-radius:6px;background:#25d366}
    .row-actions{display:flex;gap:10px;flex-wrap:wrap}
    .row-actions button{flex:1 1 200px}
    small.dim{opacity:.65}
    .muted{opacity:.75}

    /* Destaque de instrução forte */
    .callout{
      margin:14px 0 8px;
      padding:14px 16px;
      border-radius:12px;
      background:#0f3b2f;
      border:1px solid #1f5f4e;
      color:#d6fff0;
    }
    .callout strong{color:#ffffff}
  </style>
</head>
<body>
  <div class="wrap" id="verifyBox">
    <div class="top">
      <div class="logo"></div>
      <h1>Confirme seu e-mail para continuar</h1>
    </div>

    <div class="callout">
      <p style="margin:0">
        <strong>Abra sua caixa de entrada agora</strong> e clique no botão do e-mail de confirmação.<br/>
        Depois, <strong>volte para esta aba</strong>: vamos avançar automaticamente para <em>Configuração da conta</em>.
      </p>
    </div>

    <p class="hint" id="intro">Se você chegou por um link do e-mail, estamos confirmando automaticamente…</p>
    <div class="row">E-mail: <span id="email" class="email">—</span></div>

    <div class="row row-actions">
      <!-- Mantidos porém ocultos -->
      <button id="btn" class="primary" style="display:none">Já verifiquei — continuar</button>
      <button id="resendBtn" class="ghost" title="Reenvia o e-mail com logo e botão" style="display:none">Reenviar e-mail</button>
    </div>

    <div id="msg" class="row hint"></div>
    <div class="row"><small class="dim" id="tip"></small></div>
  </div>

  <script>
    // ===== Base do backend
    const API_BASE = (window.API_BASE || 'https://mei-robo-prod.onrender.com').replace(/\/$/,'');
    // [ADD] Flag compartilhada com cadastro.html para retomar "modo espera"
    const WAIT_FLAG_KEY = 'mr_waiting_email_verification';

    // ===== Utils / Query
    function qs(k){try{return new URLSearchParams(location.search).get(k)||""}catch(_){return ""}}
    const cont = qs("cont") || "/pages/configuracao.html";
    const mode = qs("mode");
    const oobCode = qs("oobCode");
    const continueUrl = qs("continueUrl") || "";
    const emailParam = qs("email") || "";

    // ===== Refs
    const msg = document.getElementById("msg");
    const btn = document.getElementById("btn");
    const resendBtn = document.getElementById("resendBtn");
    const emailSpan = document.getElementById("email");
    const tip = document.getElementById("tip");
    const intro = document.getElementById("intro");
    const LS_KEY = "meirobo_last_verif_sent_at"; // debounce local p/ reenvio

    // ===== Broadcast cross-aba
    function broadcastVerified(){
      try { if ('BroadcastChannel' in window) new BroadcastChannel('auth').postMessage({type:'email-verified'}); } catch(_) {}
      try { window.opener && window.opener.postMessage({type:'email-verified'}, "*"); } catch(_) {}
      try { window.parent && window.parent.postMessage({type:'email-verified'}, "*"); } catch(_) {}
      try { const ev = new Event('email-verified'); window.dispatchEvent(ev); } catch(_) {}
      try { localStorage.setItem('mr_email_verified','1'); } catch(_) {}
      // [ADD] garante que a outra aba retome o "modo de espera" mesmo se aberta direto por link
      try { localStorage.setItem(WAIT_FLAG_KEY,'1'); } catch(_) {}
    }

    // ===== UI minimalista pós-verificação (ASCII-only)
    function showReturnMessage() {
      var box = document.getElementById('verifyBox');
      if (box) {
        var html = ''
          + '<h2>E-mail verificado</h2>'
          + '<p>Agora <strong>volte para a ABA onde voce iniciou o cadastro</strong>. '
          + 'La vamos avancar automaticamente para a Configuracao da conta.</p>'
          + '<p class="hint">Se esta janela tiver sido aberta so para confirmar, voce pode fecha-la com seguranca.</p>';
        try { box.innerHTML = html; } catch(_) {}
      }
      try { if (window.opener) setTimeout(function(){ window.close(); }, 2000); } catch(_) {}
    }

    // ===== Debounce visual (apenas se reenvio estiver habilitado futuramente)
    function renderDebounceTip(){
      const last = Number(localStorage.getItem(LS_KEY) || "0");
      if (!last) { tip.textContent = ""; return; }
      const secs = Math.max(0, 90 - Math.floor((Date.now() - last)/1000));
      tip.textContent = secs > 0 ? `Você pode reenviar novamente em ${secs}s.` : "";
      if (secs > 0) setTimeout(renderDebounceTip, 1000);
    }
    function canResend(){ const last = Number(localStorage.getItem(LS_KEY) || "0"); return (Date.now() - last) > 90_000; }

    // ===== Verificação via backend (com Bearer)
    async function checkWithBackend(){
      msg.textContent = "Verificando...";
      msg.className = "row hint";
      try{
        const u = firebase.auth().currentUser;
        if (!u) { msg.textContent = "Entre com seu e-mail e senha e tente de novo."; msg.className = "row err"; return false; }
        const idToken = await u.getIdToken(true);

        // 1) GET /api/auth/check-verification
        let res = await fetch(API_BASE + "/api/auth/check-verification", {
          method: "GET",
          headers: { "Authorization": "Bearer " + idToken, "Accept": "application/json" }
        });

        if (res.status === 405) {
          // 2) Fallback: /api/auth/whoami
          const r2 = await fetch(API_BASE + "/api/auth/whoami", {
            method: "GET",
            headers: { "Authorization": "Bearer " + idToken, "Accept": "application/json" }
          });
          if (r2.ok) {
            const j2 = await r2.json().catch(()=>({}));
            const verified = !!(j2 && (j2.email_verified === true || j2.emailVerified === true));
            if (verified) {
              msg.textContent = "E-mail verificado!";
              msg.className = "row ok";
              // === 3 LINHAS SOLICITADAS (logo após marcar como verificado) ===
              try { localStorage.setItem('mr_email_verified','1'); } catch(_) {}
              try { new BroadcastChannel('mr_events').postMessage({ type: 'email_verified' }); } catch(_) {}
              try { console.log('[verify-email] sinal disparado (mr_email_verified + BC)'); } catch(_) {}
              // ===============================================================
              broadcastVerified();
              showReturnMessage();
              return true;
            } else {
              msg.textContent = "Ainda não verificou. Abra o link do e-mail e tente novamente.";
              msg.className = "row err";
              return false;
            }
          } else {
            msg.textContent = "Falha no fallback de verificação (" + r2.status + ").";
            msg.className = "row err";
            return false;
          }
        } else {
          const data = await res.json().catch(()=>({}));
          if (res.ok && data && data.verified === true) {
            msg.textContent = "E-mail verificado!";
            msg.className = "row ok";
            // === 3 LINHAS SOLICITADAS (logo após marcar como verificado) ===
            try { localStorage.setItem('mr_email_verified','1'); } catch(_) {}
            try { new BroadcastChannel('mr_events').postMessage({ type: 'email_verified' }); } catch(_) {}
            try { console.log('[verify-email] sinal disparado (mr_email_verified + BC)'); } catch(_) {}
            // ===============================================================
            broadcastVerified();
            showReturnMessage();
            return true;
          }
        }

        // 3) Último recurso: Firebase local
        try { await u.reload(); } catch(_){}
        if (u.emailVerified === true) {
          msg.textContent = "E-mail verificado!";
          msg.className = "row ok";
          // === 3 LINHAS SOLICITADAS (logo após marcar como verificado) ===
          try { localStorage.setItem('mr_email_verified','1'); } catch(_) {}
          try { new BroadcastChannel('mr_events').postMessage({ type: 'email_verified' }); } catch(_) {}
          try { console.log('[verify-email] sinal disparado (mr_email_verified + BC)'); } catch(_) {}
          // ===============================================================
          broadcastVerified();
          showReturnMessage();
          return true;
        } else {
          msg.textContent = "Ainda não verificou. Abra o link do e-mail e tente novamente.";
          msg.className = "row err";
          return false;
        }
      } catch(e){
        msg.textContent = "Erro ao verificar: " + (e && e.message ? e.message : e);
        msg.className = "row err";
        return false;
      }
    }

    // ===== Reenvio (mantido, mas oculto)
    async function resend(){
      msg.textContent = "";
      msg.className = "row hint";
      try {
        const u = firebase?.auth?.().currentUser;
        if (!u) { msg.textContent = "Faça login e tente de novo."; msg.className = "row err"; return; }
        if (!canResend()){
          renderDebounceTip();
          msg.textContent = "Aguarde alguns segundos antes de reenviar.";
          msg.className = "row hint";
          return;
        }
        resendBtn.disabled = true; resendBtn.textContent = "Reenviando…";
        const idToken = await u.getIdToken(true);
        const r = await fetch(API_BASE + "/api/auth/send-verification-email", {
          method: "POST",
          headers: { "Authorization": "Bearer " + idToken, "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        const text = await r.text();
        if (r.ok) {
          localStorage.setItem(LS_KEY, String(Date.now()));
          renderDebounceTip();
          msg.textContent = "Reenviado! Verifique sua caixa de entrada e o spam.";
          msg.className = "row ok";
        } else {
          msg.textContent = "Falhou ao reenviar: " + (text || r.status);
          msg.className = "row err";
        }
      } catch (e) {
        msg.textContent = "Erro ao reenviar: " + (e?.message || e);
        msg.className = "row err";
      } finally {
        resendBtn.disabled = false; resendBtn.textContent = "Reenviar e-mail";
      }
    }

    // ===== BOOT
    document.addEventListener("DOMContentLoaded", async () => {
      // [ADD] Seta o flag de "espera de verificação" assim que a página carrega
      try { localStorage.setItem(WAIT_FLAG_KEY,'1'); } catch(_) {}
      try {
        await new Promise(r => setTimeout(r, 200)); // dá tempo do firebase init
        const u = firebase.auth().currentUser || null;
        // Prioriza o ?email= antes do usuário logado — evita mostrar "—" quando a aba não está autenticada
        emailSpan.textContent = emailParam || (u?.email) || "—";
        renderDebounceTip();

        // Se já estiver verificado, não redireciona: só sinaliza e instrui a voltar
        if (u) {
          try { await u.reload(); } catch(_){}
          if (u.emailVerified === true) {
            broadcastVerified();
            showReturnMessage();
            return;
          }
        }

        // [ADD - opcional] se a flag existir, reforça a UI de "volte à aba do cadastro"
        try {
          if (localStorage.getItem(WAIT_FLAG_KEY) === '1') {
            // só UI: a outra aba cuidará do avanço
            // (mantemos a página informativa minimalista)
          }
        } catch(_) {}
      } catch {}
    });

    // ===== Pós-applyActionCode
    async function afterApplyActionCodeSuccess() {
      try { localStorage.setItem('mr_email_verified', '1'); } catch(_) {}
      // [ADD] reforço do estado "aguardando verificação" para a outra aba
      try { localStorage.setItem(WAIT_FLAG_KEY,'1'); } catch(_) {}
      try {
        const user = firebase.auth().currentUser;
        if (user) {
          try { await user.reload(); } catch(_){}
          await user.getIdToken(true);
          const token = await user.getIdToken();
          fetch(API_BASE + '/api/auth/check-verification', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}`, 'Accept':'application/json' },
            credentials: 'omit'
          }).catch(()=>{});
        }
      } catch(_) {}
      try { if (navigator.sendBeacon) navigator.sendBeacon(API_BASE + '/health'); } catch(_) {}
      try { window.opener && window.opener.postMessage({type:'email-verified'}, "*"); } catch(_) {}
      try { window.parent && window.parent.postMessage({type:'email-verified'}, "*"); } catch(_) {}
      try { const bc = new BroadcastChannel('auth'); try { bc.postMessage({type:'email-verified'}); } finally { bc.close?.(); } } catch(_) {}
      try { localStorage.setItem('mr_email_verified','1'); } catch(_) {}
    }
    async function afterVerifiedUI() { broadcastVerified(); showReturnMessage(); }
    async function onVerified() { await afterVerifiedUI(); }

    // ===== Tratamento do oobCode (link do e-mail)
    (async () => {
      const params = new URLSearchParams(location.search);
      const oob = params.get('oobCode');
      if (oob) {
        try {
          await firebase.auth().applyActionCode(oob);
          await afterApplyActionCodeSuccess();
          await onVerified();
        } catch (e) {
          console.warn('[verify-email] applyActionCode falhou:', e?.message || e);
          // Mesmo se falhar por já usado/expirado, ainda sinalizamos para destravar a outra aba
          await onVerified();
        }
      } else {
        // Sem oobCode: página acessada diretamente; mantém apenas instruções.
      }
    })();

    // ===== Listeners mantidos (ocultos)
    btn?.addEventListener("click", async () => {
      if ((mode||"").toLowerCase() === "verifyemail" && oobCode) {
        try {
          await firebase.auth().applyActionCode(oobCode);
          await afterApplyActionCodeSuccess();
          broadcastVerified();
          msg.textContent = "Confirmado!";
          msg.className = "row ok";
          showReturnMessage();
          return;
        } catch(_) {}
      }
      await checkWithBackend();
    });
    resendBtn?.addEventListener("click", resend);

    // Evita erro caso exista função global antiga
    document.addEventListener('DOMContentLoaded',()=>{ 
      try { if (typeof check === 'function') setTimeout(check,300); } catch(_) {}
    });
  </script>
</body>
</html>

