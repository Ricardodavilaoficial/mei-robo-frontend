<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verifique seu e-mail — MEI Robô</title>

  <!-- Reforço de cache (Hosting já aplica headers globais) -->
  <meta http-equiv="Cache-Control" content="no-store" />

  <!-- Estilos canônicos -->
  <link rel="stylesheet" href="/assets/styles.css" />

  <style>
    /* ===== App Shell: evita “página anã” ===== */
    body.shell-page { min-height: 100svh; display: flex; flex-direction: column; background: var(--bg, #0b1f1a); }
    main.shell-content { flex: 1; display: grid; place-items: center; padding: clamp(16px, 3vw, 40px); }

    /* Container central preservando tua classe .center */
    .center{max-width:720px;margin:0 auto}

    /* Chip de e-mail para leitura melhor */
    .email-chip{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-weight: 700; padding: 2px 8px; border-radius: 8px;
      background: #0f3b2f; color: #b9f4d8;
      word-break: break-all;
    }

    /* Placeholder “branco acinzentado” */
    .input::placeholder{ color: rgba(255,255,255,0.55); }

    /* Mensagens de status (mantendo tua taxonomia) */
    #msg.hint{ color: rgba(255,255,255,0.8); }
    #msg.ok{ color: #86f7c2; }
    #msg.error{ color: #ff9c9c; }
  </style>
</head>
<body class="shell-page">
  <!-- HEADER (injetado por layout.js; com fallback se precisar) -->
  <div id="app-header"></div>

  <main class="section shell-content">
    <div class="container center">
      <h1 style="color:var(--wa-dark); margin:0 0 6px">Confirme seu e-mail</h1>

      <p class="note">
        Enviamos um link de verificação para
        <strong id="emailLabel" class="email-chip">seu_email@exemplo.com</strong>.
        Abra sua caixa de entrada e clique no link para continuar.
      </p>

      <div class="card">
        <h2 style="color:var(--wa-dark)">Não recebeu?</h2>

        <form id="resendForm" class="form-row" action="#" method="POST" novalidate aria-describedby="form-hint">
          <label for="email"><strong>E-mail</strong></label>
          <input id="email" name="email" class="input" type="email"
                 placeholder="Confirme aqui seu e-mail de validação"
                 inputmode="email" autocomplete="email" spellcheck="false" required />

          <div id="form-hint" class="hint" style="margin-top:6px">
            Usaremos este e-mail para reenviar o link de verificação.
          </div>

          <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
            <button id="btnResend" class="cta" type="submit">Reenviar e-mail</button>
            <a id="btnCheck" class="btn-secondary" href="#" role="button">Já verifiquei — continuar</a>
            <a id="btnChange" class="btn-secondary" href="/cadastro.html" role="button">Trocar e-mail</a>
          </div>

          <div id="msg" class="hint" style="margin-top:8px"></div>
        </form>
      </div>

      <p class="note" style="margin-top:10px">
        Dica: confira a pasta de <strong>Spam</strong>/<strong>Promoções</strong> e adicione nosso remetente à lista segura.
      </p>
    </div>
  </main>

  <!-- FOOTER (injetado por layout.js; com fallback se precisar) -->
  <div id="app-footer"></div>

  <!-- Scripts do projeto -->
  <script src="/assets/firebase-init.js" defer></script>
  <script src="/assets/layout.js" defer></script>

  <script>
  (function(){
    // ====== Config de produção ======
    const BACKEND = 'https://mei-robo-prod.onrender.com';
    const API = {
      resendEmail:  BACKEND + '/api/auth/resend-verification', // POST { email }
      checkStatus:  BACKEND + '/api/auth/check-verification'   // POST { email? }
    };

    // ====== Helpers ======
    const $ = (sel) => document.querySelector(sel);
    const msg = $('#msg');
    const emailInput = $('#email');
    const emailLabel = $('#emailLabel');
    const btnResend = $('#btnResend');
    const btnCheck  = $('#btnCheck');
    const btnChange = $('#btnChange');

    function setMsg(text, cls){
      msg.className = cls || 'hint';
      msg.textContent = text || '';
    }
    function sanitizeEmail(s){
      if(!s || typeof s !== 'string') return '';
      s = s.trim().replace(/\s+/g, '');
      return s.replace(/[\u200B-\u200D\uFEFF]/g, '');
    }
    function isValidEmail(s){
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(s);
    }
    function readQueryEmail(){
      try{
        const params = new URLSearchParams(window.location.search);
        const raw = params.get('email'); // URLSearchParams já decodifica %40 -> @
        return raw || '';
      }catch{ return ''; }
    }
    function applyEmailToUI(email){
      if(email && isValidEmail(email)){
        emailInput.value = email;
        emailLabel.textContent = email;
        emailLabel.setAttribute('title', email);
      }else{
        emailInput.value = '';
        emailLabel.textContent = 'seu_email@exemplo.com';
        emailLabel.removeAttribute('title');
      }
    }

    // ====== Header/Footer fallback se layout.js falhar ======
    async function ensureHeaderFooter(){
      try{
        await new Promise(r=>setTimeout(r, 250));
        const headerOk = $('#app-header')?.children?.length > 0;
        const footerOk = $('#app-footer')?.children?.length > 0;
        if(!headerOk){
          const h = await fetch('/partials/header.html').then(r=>r.text());
          $('#app-header').innerHTML = h;
          console.info('[verify] header fallback aplicado');
        }
        if(!footerOk){
          const f = await fetch('/partials/footer.html').then(r=>r.text());
          $('#app-footer').innerHTML = f;
          console.info('[verify] footer fallback aplicado');
        }
      }catch(e){
        console.info('[verify] fallback header/footer falhou:', e);
      }
    }

    // ====== Eventos ======
    $('#resendForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      setMsg('Enviando...', 'hint');

      const email = sanitizeEmail(emailInput.value || '');
      if(!isValidEmail(email)){
        setMsg('Informe um e-mail válido.', 'error');
        emailInput.focus();
        return;
      }

      btnResend.disabled = true; btnCheck.setAttribute('aria-disabled','true');

      try{
        const res = await fetch(API.resendEmail, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ email })
        });
        const data = await res.json().catch(()=> ({}));
        if(res.ok && (data.ok === true || data.success === true)){
          setMsg('Pronto! Verifique sua caixa de entrada.', 'ok');
        }else{
          const m = (data && (data.message || data.error)) || 'Não foi possível reenviar agora.';
          setMsg('Falha ao reenviar: ' + m, 'error');
        }
      }catch(err){
        console.info('[verify] resend error:', err);
        setMsg('Erro de rede ao reenviar. Tente novamente em instantes.', 'error');
      }finally{
        btnResend.disabled = false; btnCheck.removeAttribute('aria-disabled');
      }
    });

    btnCheck.addEventListener('click', async (e)=>{
      e.preventDefault();
      setMsg('', 'hint');

      btnCheck.setAttribute('aria-disabled','true'); btnResend.disabled = true;

      try{
        // 1) Se houver sessão Firebase, preferir checagem local
        const hasFirebase = typeof window.firebase !== 'undefined' && firebase?.auth;
        if(hasFirebase){
          try{
            const user = firebase.auth().currentUser || null;
            if(user){
              await user.reload();
              if(user.emailVerified === true){
                setMsg('E-mail verificado com sucesso! Redirecionando…', 'ok');
                setTimeout(()=> window.location.href = '/configuracao.html', 600);
                return;
              }
            }
          }catch(e){ console.info('[verify] firebase reload falhou:', e); }
        }

        // 2) Fallback: perguntar ao backend
        const email = sanitizeEmail(emailInput.value || '');
        const payload = isValidEmail(email) ? { email } : {};
        const res = await fetch(API.checkStatus, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=> ({}));

        if(res.ok && (data.verified === true || data.ok === true)){
          setMsg('E-mail verificado com sucesso! Redirecionando…', 'ok');
          setTimeout(()=> window.location.href = '/configuracao.html', 600);
        }else{
          setMsg('Ainda não detectamos a verificação. Tente novamente em alguns segundos.', 'hint');
        }
      }catch(err){
        console.info('[verify] check error:', err);
        setMsg('Erro ao checar verificação. Tente novamente em instantes.', 'error');
      }finally{
        btnCheck.removeAttribute('aria-disabled'); btnResend.disabled = false;
      }
    });

    btnChange.addEventListener('click', async (e)=>{
      // limpar sessão antes de trocar e-mail
      try{
        e.preventDefault();
        try{
          localStorage.removeItem('uid');
          localStorage.removeItem('idToken');
          localStorage.removeItem('isAdmin');
        }catch{}
        if(typeof window.firebase !== 'undefined' && firebase?.auth){
          try{ await firebase.auth().signOut(); }catch(err){ console.info('[verify] signOut:', err); }
        }
      }finally{
        window.location.href = '/cadastro.html';
      }
    });

    // ====== Init ======
    (async function init(){
      const qEmail = sanitizeEmail(readQueryEmail());
      applyEmailToUI(qEmail);
      await ensureHeaderFooter();

      // limpar msg ao digitar
      emailInput.addEventListener('input', ()=> setMsg('', 'hint'));

      if(new URLSearchParams(location.search).get('validate') === '1'){
        console.info('[verify] sessão limpa solicitada (&validate=1).');
      }
    })();
  })();
  </script>
</body>
</html>
