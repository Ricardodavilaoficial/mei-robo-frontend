<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard — MEI Robô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- relativo porque esta página está em /pages -->
  <link rel="stylesheet" href="../assets/styles.css" />
  <script defer src="/assets/layout.js?v=20250905a"></script>
</head>
<body>
  <div id="app-header"></div>

  <main class="container">
    <div class="grid grid-2">
      <div class="card">
        <h2>Agenda</h2>
        <p class="note">Crie, confirme e cancele compromissos.</p>
        <p><a class="btn" href="/pages/agenda.html">Abrir Agenda</a></p>
      </div>

      <div class="card">
        <h2>Admin • Cupons</h2>
        <p class="note">Gere e liste cupons de ativação. (Acesso restrito)</p>
        <p><a class="btn secondary" href="/pages/admin-cupons.html">Abrir Admin Cupons</a></p>
      </div>

      <div class="card">
        <h2>Ativar Conta</h2>
        <p class="note">Fluxo de onboarding e verificação.</p>
        <p><a class="btn secondary" href="/pages/ativar.html">Abrir Ativar</a></p>
      </div>

      <div class="card">
        <h2>Status da Licença</h2>
        <p class="note">Seu plano precisa estar <em>ativo</em> para liberar o Dashboard.</p>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="btnStatus">Ver status da licença</button>
          <label style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" id="toggleAdmin" />
            Eu sou administrador (dev)
          </label>
          <button class="btn secondary" id="saveGate">Aplicar</button>
          <span class="note">Flag salva em <code>localStorage.isAdmin</code></span>
        </div>
        <pre id="out" style="margin-top:12px"></pre>
      </div>
    </div>
  </main>

  <div id="app-footer"></div>

  <script>
    // ====== Config ======
    // Mantive seu endpoint de status. Se quiser apontar para outro ambiente, troque aqui.
    const STATUS_URL = "https://eu-digital.onrender.com/licencas/status";
    const token = () => localStorage.getItem('idToken');

    // ====== Helpers ======
    function setOut(msg){
      const el = document.getElementById('out');
      if(msg == null || msg === '') { el.textContent = ''; return; }
      if(typeof msg === 'string') el.textContent = msg;
      else el.textContent = JSON.stringify(msg, null, 2);
    }

    function gateApply(){
      const isAdmin = localStorage.getItem('isAdmin') === 'true';
      document.getElementById('toggleAdmin').checked = isAdmin;
    }

    // ====== Ações ======
    async function verStatus(){
      setOut("Consultando status...");
      try{
        const r = await fetch(STATUS_URL, {
          headers: {
            // Inclua o token se sua API exigir:
            // 'Authorization': 'Bearer ' + token()
          }
        });
        const ct = r.headers.get('content-type') || '';
        if(!r.ok){
          const txt = await r.text().catch(()=>'(sem corpo)');
          throw new Error(`GET ${STATUS_URL} -> ${r.status}: ${txt.slice(0,200)}`);
        }
        const data = ct.includes('application/json') ? await r.json() : { ok:true, detalhe:'Resposta não-JSON' };
        setOut(data);
      }catch(err){
        setOut({ erro: 'Falha ao consultar status', detalhe: err.message });
      }
    }

    // ====== Setup ======
    window.addEventListener('DOMContentLoaded', () => {
      gateApply();
      document.getElementById('btnStatus').onclick = verStatus;
      document.getElementById('saveGate').onclick = () => {
        const v = document.getElementById('toggleAdmin').checked;
        localStorage.setItem('isAdmin', v ? 'true' : 'false');
        gateApply();
      };
    });
  </script>
</body>
</html>
