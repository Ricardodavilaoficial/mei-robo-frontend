<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Preços e Serviços — MEI Robô</title>

  <!-- Caminhos absolutos canônicos -->
  <link rel="stylesheet" href="/assets/styles.css" />

  <!-- Acessibilidade e contraste mínimo local (reforço ao styles.css) -->
  <style>
    :root { --soft: rgba(0,0,0,.55); --value: rgba(0,0,0,.80); }
    body.app-shell { min-height: 100svh; background:#fafafa; }
    .app-main { min-height: 82svh; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .title-xl { font-size:1.5rem; font-weight:800; letter-spacing:.2px; }
    .muted { color: var(--soft); }
    .value { color: var(--value); }
    .input, .select, .button, .upload {
      border:1.5px solid #cbd5e1; border-radius:10px; padding:10px 12px; font-size:1rem; outline:none; background:#fff;
    }
    .input::placeholder { color: var(--soft); }
    .input:focus, .upload:focus { border-color:#0f9d58; box-shadow:0 0 0 3px rgba(15,157,88,.15); }
    .button { cursor:pointer; font-weight:700; }
    .button.primary { background:#0f9d58; color:#fff; border-color:#0f9d58; }
    .button.ghost { background:#fff; color:#0f9d58; border-color:#0f9d58; }
    .button.warn { background:#f97316; color:#fff; border-color:#ea580c; }
    .button:disabled { opacity:.55; cursor:not-allowed; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1 1 280px; }
    .badge { display:inline-flex; align-items:center; gap:6px; font-weight:700; font-size:.85rem; padding:4px 10px; border-radius:999px; border:1px solid #b8f3cf; background:#e8fff2; color:#0d7a56; }
    .badge.gray { background:#eef2f7; border-color:#e5e7eb; color:#334155; }
    .help { font-size:.92rem; color:var(--soft); }
    .table { width:100%; border-collapse:collapse; }
    .table th, .table td { padding:10px; border-bottom:1px solid #eee; text-align:left; font-size:.95rem; vertical-align:top; }
    .table th { font-weight:800; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:6px; padding:2px 6px; font-size:.9rem; }
    .upload-area { border:2px dashed #b7c7c2; border-radius:12px; padding:18px; cursor:pointer; background:#fff; }
    .upload-area:hover { background:#f8fafc; }
    .error { background:#fef2f2; border:1px solid #fecaca; color:#991b1b; border-radius:8px; padding:10px; font-weight:700; }
    .success { background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46; border-radius:8px; padding:10px; font-weight:700; }
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer { height:8px; }
    .hidden { display:none !important; }
    .nowrap { white-space:nowrap; }
    .w-100 { width:100%; }
    .text-right { text-align:right; }
    .mt-1{margin-top:4px} .mt-2{margin-top:8px} .mt-3{margin-top:12px} .mt-4{margin-top:16px} .mt-6{margin-top:24px} .mt-8{margin-top:32px}
    .mb-2{margin-bottom:8px} .mb-4{margin-bottom:16px} .mb-6{margin-bottom:24px}
  </style>
</head>
<body class="app-shell">
  <!-- Header dinâmico pelo layout.js -->
  <header id="app-header"></header>

  <main class="app-main">
    <section class="container" style="max-width:1100px;margin:0 auto;padding:16px;">
      <div class="row">
        <div class="col" style="flex-basis:100%;">
          <h1 class="title-xl">Preços e Serviços</h1>
          <div class="mt-2 help">
            Defina aqui o que o seu MEI Robô vende. Esses dados são usados para entender pedidos dos seus clientes,
            responder com naturalidade e <b>propor agendamentos com duração correta</b>.<br />
            <span class="muted">
              Dica: os “apelidos” (ex.: <i>pezinho</i>, <i>corte social</i>) serão aprendidos automaticamente ao longo do uso (NLU por IA),
              mas você pode informar <span class="kbd">sinonimos</span> no CSV para acelerar.
            </span>
          </div>
        </div>
      </div>

      <!-- Status / Onboarding -->
      <div class="mt-4 row">
        <div class="col card">
          <div class="badge gray" id="env-badge">Produção</div>
          <div class="mt-2"><b>Usuário:</b> <span id="user-email" class="value">—</span></div>
          <div class="mt-1"><b>UID:</b> <span id="user-uid" class="value">—</span></div>
          <div class="mt-1"><b>Verificado:</b> <span id="user-verified" class="value">—</span></div>
          <div class="mt-2 help">
            Se o e-mail não estiver verificado, a importação ficará desabilitada. Você ainda poderá visualizar sua lista.
          </div>
        </div>

        <!-- Importação -->
        <div class="col card">
          <div class="toolbar">
            <div class="badge">Importar CSV</div>
            <span class="help">Cabeçalho:</span>
            <span class="kbd">slug</span>,
            <span class="kbd">nome</span>,
            <span class="kbd">precoBase</span>,
            <span class="kbd">duracaoMin</span>,
            <span class="kbd">sinonimos</span>
          </div>

          <div class="mt-2 upload-area" id="dropzone" tabindex="0" role="button" aria-label="Selecione um arquivo CSV">
            <div><b>Selecione seu arquivo CSV</b> ou arraste aqui.</div>
            <div class="help mt-1">
              Tamanho máximo: 1MB. <span class="kbd">sinonimos</span> separados por <span class="kbd">;</span>.
              Ex.: <span class="kbd">corte;tesoura;maquina</span>
            </div>
            <input id="file-input" type="file" accept=".csv,text/csv" class="hidden" />
          </div>

          <div class="mt-2 toolbar">
            <button id="btn-preview" class="button ghost" disabled>Pré-visualizar</button>
            <button id="btn-import" class="button primary" disabled>Importar para minha conta</button>
            <button id="btn-sample" class="button" title="Baixar modelo CSV com exemplos">Baixar modelo CSV</button>
            <button id="btn-excel" class="button" disabled title="Em breve: Excel/PDF com ajuda de IA">Importar Excel/PDF (em breve)</button>
          </div>

          <div id="import-msg" class="mt-2 hidden"></div>
          <div id="preview-wrap" class="mt-2 hidden">
            <div class="help"><b>Prévia do CSV</b> (primeiras linhas):</div>
            <table class="table" id="preview-table" aria-label="Prévia do CSV"></table>
          </div>
        </div>
      </div>

      <!-- Lista de serviços -->
      <div class="mt-4 card">
        <div class="toolbar">
          <div class="badge gray">Serviços cadastrados</div>
          <input id="search" class="input" placeholder="Buscar por nome, slug ou sinônimos…" style="flex:1 1 280px" />
          <div class="help">Resultados: <span id="count">0</span></div>
        </div>

        <div class="mt-2">
          <table class="table" id="svc-table" aria-label="Tabela de serviços">
            <thead>
              <tr>
                <th>Slug</th>
                <th>Nome</th>
                <th class="nowrap">Preço (R$)</th>
                <th class="nowrap">Duração (min)</th>
                <th>Sinônimos</th>
              </tr>
            </thead>
            <tbody id="svc-body"><tr><td colspan="5" class="muted">Carregando…</td></tr></tbody>
          </table>
          <div class="mt-2 text-right">
            <button id="prev" class="button ghost" disabled>Anterior</button>
            <button id="next" class="button ghost" disabled>Próximo</button>
          </div>
        </div>

        <div class="mt-2 help">
          Observações:
          <ul style="margin:6px 0 0 20px">
            <li>Você poderá anexar catálogos, manuais e folders por serviço em breve (PDF/Imagens/Vídeo curto).</li>
            <li>Apelidos locais serão aprendidos automaticamente ao longo do uso (IA/NLU com cache).</li>
          </ul>
        </div>
      </div>

      <!-- Navegação -->
      <div class="mt-6 row">
        <div class="col">
          <button id="btn-back" class="button ghost">← Voltar (Configuração)</button>
        </div>
        <div class="col" style="text-align:center;">
          <button id="btn-logout" class="button warn">Sair</button>
        </div>
        <div class="col" style="text-align:right;">
          <button id="btn-next" class="button primary">Próximo (Contatos)</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer dinâmico pelo layout.js -->
  <footer id="app-footer"></footer>

  <!-- Loader de header/footer canônico -->
  <script src="/assets/layout.js"></script>

  <!-- Firebase init + helpers do projeto -->
  <script src="/assets/firebase-init.js"></script>
  <script src="/assets/backend-patch.js"></script>

  <!-- Lógica da página -->
  <script>
    (function(){
      const log = (...a) => console.log('[precos]', ...a);
      const qs = sel => document.querySelector(sel);
      const byId = id => document.getElementById(id);
      const params = new URLSearchParams(location.search);

      // ===== Fallback header/footer se layout.js falhar =====
      async function ensureHeaderFooter() {
        try {
          const hdr = document.querySelector('header.app-header');
          const ftr = document.querySelector('footer.app-footer');
          if (!hdr && byId('app-header')) {
            const h = await fetch('/partials/header.html'); byId('app-header').innerHTML = await h.text();
          }
          if (!ftr && byId('app-footer')) {
            const f = await fetch('/partials/footer.html'); byId('app-footer').innerHTML = await f.text();
          }
          log('OK: header/footer');
        } catch(e) { console.warn('[precos] fallback header/footer falhou', e); }
      }

      // ===== Estado global =====
      let currentUser = null;
      let isVerified = false;
      let uid = null;
      const PAGE_SIZE = 10;
      let dataAll = [];     // todos serviços (cache local)
      let dataView = [];    // filtrado
      let page = 0;

      // ===== Navegação =====
      byId('btn-back').onclick = () => location.href = '/pages/configuracao.html';
      byId('btn-next').onclick = () => location.href = '/pages/contatos.html';
      byId('btn-logout').onclick = async () => {
        try { await firebase.auth().signOut(); } catch(e){}
        try { localStorage.removeItem('uid'); localStorage.removeItem('idToken'); localStorage.removeItem('isAdmin'); } catch(e){}
        location.href = '/pages/login.html';
      };

      // ===== Sessão de validação opcional =====
      async function maybeCleanSession() {
        if (params.get('validate') === '1') {
          log('Sessão limpa por validate=1');
          try { await firebase.auth().signOut(); } catch(e){}
          try { localStorage.removeItem('uid'); localStorage.removeItem('idToken'); localStorage.removeItem('isAdmin'); } catch(e){}
        }
      }

      // ===== UI helpers =====
      function setMsg(el, type, text) {
        el.classList.remove('hidden'); el.classList.remove('error','success');
        if (type === 'error') el.classList.add('error');
        if (type === 'success') el.classList.add('success');
        el.textContent = text;
      }
      function clearMsg(el){ el.classList.add('hidden'); el.textContent=''; }

      // ===== Sample CSV =====
      function getSampleCsvBlob() {
        const rows = [
          'slug,nome,precoBase,duracaoMin,sinonimos',
          'corte-masculino,Corte masculino,45.00,30,"corte;tesoura;maquina"',
          'corte-infantil,Corte infantil,35.00,30,"corte crianca;cabelo infantil;tesoura"',
          'barba,Barba tradicional,30.00,20,"barbear;navalha;aparatem"',
          'corte-e-barba,Combo corte + barba,70.00,60,"combo;pacote"',
          'sombra-progressiva,Sombra e acabamento,25.00,15,"acabamento;contorno;finitura"',
          'hidratacao,Hidratação capilar,60.00,40,"tratamento;mascara capilar"',
          'pigmentacao,Pigmentação/Correção,80.00,45,"tonalizante;correcao de falhas;pigmento"'
        ].join('\n');
        return new Blob([rows], {type:'text/csv;charset=utf-8'});
      }
      byId('btn-sample').onclick = () => {
        const blob = getSampleCsvBlob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'modelo-precos.csv'; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 2000);
      };

      // ===== Upload CSV (drag & drop + input) =====
      const drop = byId('dropzone');
      const finput = byId('file-input');
      drop.addEventListener('click', ()=>finput.click());
      drop.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); finput.click(); }});
      drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#f1f5f9'; });
      drop.addEventListener('dragleave', e=>{ drop.style.background='#fff'; });
      drop.addEventListener('drop', e=>{
        e.preventDefault(); drop.style.background='#fff';
        if (e.dataTransfer.files?.length) { finput.files = e.dataTransfer.files; onFileSelected(); }
      });
      finput.addEventListener('change', onFileSelected);

      let csvText = '';
      function onFileSelected(){
        clearMsg(byId('import-msg'));
        byId('preview-wrap').classList.add('hidden');
        csvText = '';
        const f = finput.files?.[0];
        if (!f) { byId('btn-preview').disabled = true; byId('btn-import').disabled = true; return; }
        if (f.size > 1024*1024) { setMsg(byId('import-msg'), 'error', 'Arquivo muito grande (máx. 1MB).'); finput.value = ''; return; }
        const reader = new FileReader();
        reader.onload = () => {
          csvText = String(reader.result || '');
          byId('btn-preview').disabled = !csvText;
          byId('btn-import').disabled = !csvText || !isVerified;
        };
        reader.readAsText(f, 'UTF-8');
      }

      // ===== CSV parsing simples (espera vírgulas e ; nos sinônimos) =====
      function parseCsvBasic(text){
        const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        if (!lines.length) return { header:[], rows:[] };
        const header = lines[0].split(',').map(h=>h.trim());
        const rows = lines.slice(1).map(line=>{
          // split básico por vírgula; campos "com aspas" mantêm ; nos sinônimos
          // (para v1 é suficiente – evitamos complexidade de CSV completo)
          const cols = [];
          let cur = ''; let inQ = false;
          for (let i=0;i<line.length;i++){
            const ch = line[i];
            if (ch === '"') { inQ = !inQ; continue; }
            if (ch === ',' && !inQ) { cols.push(cur); cur=''; continue; }
            cur += ch;
          }
          cols.push(cur);
          return cols.map(c=>c.trim());
        });
        return { header, rows };
      }

      // ===== Pré-visualização =====
      byId('btn-preview').onclick = ()=>{
        clearMsg(byId('import-msg'));
        const { header, rows } = parseCsvBasic(csvText);
        const needed = ['slug','nome','precoBase','duracaoMin','sinonimos'];
        const lower = header.map(h=>h.toLowerCase());
        const ok = needed.every(n=>lower.includes(n));
        if (!ok) { setMsg(byId('import-msg'),'error','Cabeçalho inválido. Use: slug,nome,precoBase,duracaoMin,sinonimos'); return; }

        const t = byId('preview-table');
        t.innerHTML = '';
        const thead = document.createElement('thead'), trh = document.createElement('tr');
        needed.forEach(n=>{ const th=document.createElement('th'); th.textContent=n; trh.appendChild(th); });
        thead.appendChild(trh); t.appendChild(thead);
        const tbody = document.createElement('tbody');
        rows.slice(0,10).forEach(cols=>{
          const map = {};
          lower.forEach((h,i)=> map[h] = cols[i] ?? '');
          const tr = document.createElement('tr');
          needed.forEach(n=>{
            const td = document.createElement('td'); td.textContent = map[n] || '';
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        t.appendChild(tbody);
        byId('preview-wrap').classList.remove('hidden');
      };

      // ===== Importação para o backend =====
      const BACKEND_BASE = window.BACKEND_BASE || 'https://mei-robo-prod.onrender.com';
      async function doImportCsv(){
        clearMsg(byId('import-msg'));
        if (!currentUser) { setMsg(byId('import-msg'),'error','Sessão expirada. Faça login novamente.'); return; }
        if (!isVerified) { setMsg(byId('import-msg'),'error','Seu e-mail não está verificado. Verifique para habilitar a importação.'); return; }
        if (!finput.files?.[0]) { setMsg(byId('import-msg'),'error','Selecione um CSV antes.'); return; }

        const fd = new FormData();
        fd.append('file', finput.files[0], finput.files[0].name);
        // fd.append('dryRun', 'false'); // opcional

        const token = await currentUser.getIdToken(true);
        byId('btn-import').disabled = true; byId('btn-preview').disabled = true;

        try {
          const url = BACKEND_BASE.replace(/\/$/,'') + '/api/importar-precos';
          const res = await fetch(url, { method:'POST', headers: { 'Authorization': 'Bearer ' + token }, body: fd });
          const text = await res.text();
          let json;
          try { json = JSON.parse(text); } catch { json = { ok:false, error: 'Resposta inesperada do servidor', raw:text }; }
          if (!res.ok || json.ok === false) {
            const msg = json?.error || ('Falha HTTP ' + res.status);
            setMsg(byId('import-msg'),'error','Erro ao importar: ' + msg);
          } else {
            const det = `Importados: ${json.imported ?? 0}` + (json.skipped ? ` | Ignorados: ${json.skipped}` : '');
            setMsg(byId('import-msg'),'success','Importação concluída. ' + det);
            // recarrega lista
            loadServices().catch(()=>{});
          }
        } catch(e) {
          setMsg(byId('import-msg'),'error','Erro de rede/servidor ao importar.');
          console.error('[precos] import error', e);
        } finally {
          byId('btn-import').disabled = !csvText || !isVerified;
          byId('btn-preview').disabled = !csvText;
        }
      }
      byId('btn-import').onclick = doImportCsv;

      // ===== Firestore: listar serviços =====
      async function loadServices(){
        const db = firebase.firestore();
        const col = db.collection('profissionais').doc(uid).collection('produtosEServicos');
        // leitura simples; se o volume crescer, migrar para paginação via startAfter
        const snap = await col.orderBy('nome').get();
        dataAll = snap.docs.map(d=>{
          const v = d.data() || {};
          return {
            id: d.id,
            slug: v.slug || '',
            nome: v.nome || '',
            precoBase: typeof v.precoBase === 'number' ? v.precoBase : parseFloat(v.precoBase || '0') || 0,
            duracaoMin: typeof v.duracaoMin === 'number' ? v.duracaoMin : parseInt(v.duracaoMin || '0') || 0,
            sinonimos: Array.isArray(v.sinonimos) ? v.sinonimos : (typeof v.sinonimos === 'string' ? v.sinonimos.split(';').map(s=>s.trim()).filter(Boolean) : [])
          };
        });
        applyFilter();
      }

      function applyFilter(){
        const q = (byId('search').value || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
        if (!q) dataView = dataAll.slice();
        else {
          dataView = dataAll.filter(s=>{
            const norm = (t)=> String(t||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
            return norm(s.slug).includes(q) || norm(s.nome).includes(q) || norm((s.sinonimos||[]).join(' ')).includes(q);
          });
        }
        page = 0;
        renderTable();
      }
      byId('search').addEventListener('input', ()=>applyFilter());

      function renderTable(){
        const body = byId('svc-body');
        body.innerHTML = '';
        if (!dataView.length) {
          const tr=document.createElement('tr'); const td=document.createElement('td');
          td.colSpan=5; td.className='muted'; td.textContent='Nenhum serviço encontrado.'; tr.appendChild(td); body.appendChild(tr);
        } else {
          const start = page * PAGE_SIZE, end = Math.min(start + PAGE_SIZE, dataView.length);
          dataView.slice(start, end).forEach(s=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="kbd">${s.slug}</td>
              <td>${s.nome}</td>
              <td class="nowrap">${s.precoBase.toFixed(2)}</td>
              <td class="nowrap">${s.duracaoMin}</td>
              <td>${(s.sinonimos||[]).join(', ')}</td>
            `;
            body.appendChild(tr);
          });
        }
        byId('count').textContent = String(dataView.length);
        byId('prev').disabled = page<=0;
        byId('next').disabled = (page+1)*PAGE_SIZE >= dataView.length;
      }
      byId('prev').onclick = ()=>{ if(page>0){ page--; renderTable(); } };
      byId('next').onclick = ()=>{ if((page+1)*PAGE_SIZE < dataView.length){ page++; renderTable(); } };

      // ===== Gate de sessão =====
      async function ensureAuth(){
        await maybeCleanSession();
        await ensureHeaderFooter();

        return new Promise((resolve)=>{
          firebase.auth().onAuthStateChanged(async (u)=>{
            if (!u) {
              log('Sem sessão: redirecionando para login');
              location.href = '/pages/login.html';
              return;
            }
            currentUser = u;
            uid = u.uid;
            isVerified = !!u.emailVerified;

            byId('user-email').textContent = u.email || '(sem e-mail)';
            byId('user-uid').textContent = u.uid;
            byId('user-verified').textContent = isVerified ? 'Sim' : 'Não';
            if (!isVerified) {
              // bloqueia import, mas mantém visualização
              byId('btn-import').disabled = true;
            } else {
              // libera import se já houver arquivo
              byId('btn-import').disabled = !(finput.files?.[0] && csvText);
            }
            resolve();
          });
        });
      }

      // ===== Init =====
      (async function init(){
        try {
          await ensureAuth();
          await loadServices();
          // Wire preview após auth
          // (para ter estado de verificação)
          // (handlers já ligados)
          log('Pronto.');
        } catch(e) {
          console.error('[precos] init error', e);
          const tb = byId('svc-body');
          tb.innerHTML = '<tr><td colspan="5" class="error">Falha ao carregar a página. Recarregue e verifique sua conexão.</td></tr>';
        }
      })();
    })();
  </script>
</body>
</html>
