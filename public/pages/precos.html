<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pre√ßos e Servi√ßos ‚Äî MEI Rob√¥</title>

  <!-- Estilos can√¥nicos do projeto -->
  <link rel="stylesheet" href="/assets/styles.css" />

  <!-- Firebase SDK v8 ‚Äî ORDEM IMPORTA -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- Inicializa√ß√£o DEFAULT do projeto (sem defer, para estar pronto no load) -->
  <script src="/assets/firebase-init.js"></script>

  <!-- Microlayout e legibilidade (herdando a paleta do tema escuro) -->
  <style>
    .app-main { min-height: 82svh; }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1 1 320px; }
    .card { border-radius: 16px; padding: 16px; }
    .title-xl { font-size: 1.5rem; font-weight: 800; letter-spacing: .2px; }
    .help { font-size: .92rem; opacity: .85; }
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .mt-1{margin-top:4px} .mt-2{margin-top:8px} .mt-3{margin-top:12px} .mt-4{margin-top:16px} .mt-6{margin-top:24px} .mt-8{margin-top:32px}
    .mb-2{margin-bottom:8px} .mb-4{margin-bottom:16px}
    .hidden { display:none !important; }
    .text-right { text-align: right; }
    .nowrap { white-space: nowrap; }

    /* Inputs: manter contraste do tema; refor√ßar placeholder */
    .input { border-radius:10px; padding:10px 12px; font-size:1rem; color: inherit; width: 100%; }
    .input::placeholder { opacity:.55; } /* solu√ß√£o memorizada: placeholder ~55% */
    .button { border-radius:10px; padding:10px 12px; font-size:1rem; font-weight:700; cursor:pointer; }
    .button:disabled { opacity:.55; cursor:not-allowed; }

    /* Bot√£o pequeno para a√ß√µes na tabela */
    .button-sm {
      padding: 4px 8px;
      font-size: .8rem;
      border-radius: 999px;
      margin-left: 4px;
    }

    /* Tabela */
    .table { width:100%; border-collapse:collapse; }
    .table th, .table td { padding:10px; text-align:left; font-size:.95rem; vertical-align:top; }

    /* Upload */
    .upload-area { border:2px dashed currentColor; border-radius:12px; padding:18px; cursor:pointer; }
    .upload-area:focus { outline: none; box-shadow: 0 0 0 3px rgba(15,157,88,.25); }

    /* Mensagens */
    .msg { border-radius:8px; padding:10px; font-weight:700; }
    .msg.ok { border:1px solid; }
    .msg.err { border:1px solid; }

    /* Badge simples */
    .badge { display:inline-flex; align-items:center; gap:6px; font-weight:700; font-size:.85rem; padding:4px 10px; border-radius:999px; border:1px solid currentColor; opacity:.9; }

    /* Pager invis√≠vel (mantemos a l√≥gica, escondemos na UI) */
    .nav-pager { display:none; }
  </style>
</head>
<body class="app-shell">
  <!-- Header din√¢mico -->
  <header id="app-header"></header>

  <main class="app-main">
    <section class="container">
      <h1 class="title-xl">Pre√ßos e Servi√ßos</h1>
      <div class="mt-2 help">
        Cadastre aqui o que voc√™ faz e quanto cobra. Esses dados ajudam o MEI Rob√¥ a entender o pedido do seu cliente,
        responder natural e <b>propor agendamentos com dura√ß√£o correta do servi√ßo</b>.
        <div class="mt-1">Exemplo: <i>Corte masculino ‚Äî <b>C√ìDIGO BARB01</b> ‚Äî R$ 45,00 ‚Äî 30 minutos</i>.</div>
      </div>

      <!-- 1) Adicionar servi√ßo (formul√°rio simples) -->
      <div class="mt-4 card">
        <div class="badge">Adicionar servi√ßo</div>
        <div class="row mt-2">
          <div class="col">
            <label for="f-cod">C√≥digo (opcional)</label>
            <input id="f-cod" class="input" placeholder="Ex.: BARB01" maxlength="24" />
            <div class="help mt-1">Use letras, n√∫meros e tra√ßo (-). Sem espa√ßos. √önico por MEI.</div>
          </div>
          <div class="col">
            <label for="f-nome">Nome do servi√ßo</label>
            <input id="f-nome" class="input" placeholder="Ex.: Corte masculino" maxlength="80" />
            <div class="help mt-1">Use um nome simples que o cliente reconhe√ßa.</div>
          </div>
          <div class="col">
            <label for="f-preco">Pre√ßo (R$)</label>
            <input id="f-preco" class="input" placeholder="Ex.: 45,00" inputmode="decimal" />
            <div class="help mt-1">Use v√≠rgula para centavos (ex.: 60,00).</div>
          </div>
          <div class="col">
            <label for="f-dur">Tempo do servi√ßo (minutos)</label>
            <input id="f-dur" class="input" placeholder="Ex.: 30" inputmode="numeric" />
            <div class="help mt-1">De 1 a 360 minutos.</div>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col" style="flex-basis:100%;">
            <label for="f-info">Complete aqui outras informa√ß√µes do servi√ßo (opcional)</label>
            <input id="f-info" class="input" placeholder="Ex.: a domic√≠lio, feminino, infantil, unhas de gel, acabamento, hidr√°ulica" maxlength="200" />
            <div class="help mt-1">Separe por v√≠rgulas. Escreva palavras que ajudem a identificar o servi√ßo (onde, para quem, varia√ß√µes, material, estilo). Evite colocar pre√ßo ou tempo aqui.</div>
          </div>
        </div>
        <div class="mt-2 toolbar">
          <button id="btn-add" class="button">Salvar servi√ßo</button>
          <button id="btn-clear" class="button">Limpar</button>
        </div>
        <div id="add-msg" class="mt-2 msg hidden"></div>
      </div>

      <!-- 2) Seus servi√ßos -->
      <div class="mt-4 card">
        <div class="toolbar">
          <div class="badge">Seus servi√ßos</div>
          <input id="search" class="input" placeholder="Buscar por C√ìDIGO, nome ou outras informa√ß√µes‚Ä¶" style="flex:1 1 280px" />
          <div class="help">Resultados: <span id="count">0</span></div>
        </div>

        <div class="mt-2">
          <table class="table" id="svc-table" aria-label="Tabela de servi√ßos">
            <thead>
              <tr>
                <th class="nowrap">C√≥digo</th>
                <th>Servi√ßo</th>
                <th class="nowrap">Pre√ßo (R$)</th>
                <th class="nowrap">Tempo (min)</th>
                <th>Outras informa√ß√µes</th>
                <th class="nowrap">Foto</th>
                <th class="nowrap">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="svc-body"><tr><td colspan="7">Carregando‚Ä¶</td></tr></tbody>
          </table>
          <div class="mt-2 text-right nav-pager">
            <button id="prev" class="button" disabled>Anterior</button>
            <button id="next" class="button" disabled>Pr√≥ximo</button>
          </div>
        </div>

        <div class="mt-2 help">
          Voc√™ pode anexar 1 foto por servi√ßo (at√© 2 MB). O MEI Rob√¥ usa essas fotos quando fizer sentido para explicar melhor o servi√ßo ao seu cliente.
        </div>

        <input id="photo-input" type="file" accept="image/*" class="hidden" />
      </div>

      <!-- 3) Importar planilha -->
      <div class="mt-4 card">
        <div class="badge">Importar planilha (opcional)</div>
        <div class="help mt-1">
          Para puxar sua tabela pra c√°, siga estes passos:
          <br>1) Clique em <b>Escolher arquivo</b> (ou arraste a planilha <b>.csv</b>).
          <br>2) Se quiser conferir, use <b>Ver pr√©via</b>.
          <br>3) Clique em <b>Importar</b> para mandar tudo para a sua lista.
        </div>

        <div id="import-ready" class="mt-2 help"></div>

        <div class="mt-2 upload-area" id="dropzone" tabindex="0" role="button" aria-label="Escolher arquivo de planilha">
          <div><b>Passo 1 ‚Äî clique aqui</b> para escolher o arquivo .csv (ou arraste a planilha).</div>
          <div class="help mt-1">
            Colunas esperadas: <b>c√≥digo (opcional)</b>, <b>nome do servi√ßo</b>, <b>pre√ßo (R$)</b>, <b>tempo (min)</b>, <b>outras informa√ß√µes (opcional)</b>.
          </div>
          <input id="file-input" type="file" accept=".csv,text/csv" class="hidden" />
        </div>

        <div class="mt-2 toolbar">
          <button id="btn-preview" class="button" disabled>Ver pr√©via</button>
          <button id="btn-import" class="button" disabled>Importar</button>
          <button id="btn-sample" class="button" title="Baixar exemplo">Baixar exemplo de planilha</button>
        </div>

        <div id="import-msg" class="mt-2 msg hidden"></div>
        <div id="preview-wrap" class="mt-2 hidden">
          <div class="help"><b>Pr√©via (primeiras linhas)</b>:</div>
          <table class="table" id="preview-table" aria-label="Pr√©via da planilha"></table>
          <div id="preview-note" class="help mt-2 hidden"></div>
        </div>
      </div>

      <div class="mt-6 row">
        <div class="col" style="text-align:left;">
          <button id="btn-back-dashboard" class="button">‚Üê Voltar para o painel</button>
        </div>
      </div>
    </section>
  </main>

  <footer id="app-footer"></footer>
  <script src="/assets/layout.js"></script>
  <script src="/assets/backend-patch.js"></script>

  <script>
    (function(){
      const log = (...a) => console.log('[precos]', ...a);
      const $ = (sel) => document.querySelector(sel);
      const byId = id => document.getElementById(id);
      const params = new URLSearchParams(location.search);
      let REDIRECTING_TO_LOGIN = false;

      const MAX_PHOTO_BYTES = 2 * 1024 * 1024;

      byId('btn-back-dashboard').onclick = () => location.href = '/pages/dashboard.html';

      async function maybeCleanSession() {
        if (params.get('validate') === '1') {
          log('Sess√£o limpa por validate=1');
          try { await firebase.auth().signOut(); } catch(e){}
          try { localStorage.removeItem('uid'); localStorage.removeItem('idToken'); localStorage.removeItem('isAdmin'); } catch(e){}
        }
      }

      function setMsg(el, type, text) {
        el.classList.remove('hidden','ok','err'); el.classList.add('msg');
        el.classList.add(type === 'error' ? 'err' : 'ok');
        el.textContent = text;
      }
      function clearMsg(el){ el.classList.add('hidden'); el.textContent=''; }

      function slugify(str){
        return String(str || '')
          .normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'')
          .toLowerCase()
          .replace(/[^a-z0-9]+/g,'-')
          .replace(/^-+|-+$/g,'')
          .slice(0, 80);
      }

      function parsePriceBRL(s){
        if (!s) return NaN;
        let x = String(s).trim().replace(/\s+/g,'');
        x = x.replace(/\./g,'').replace(',', '.');
        return Number(x);
      }

      function splitTags(s) {
        if (!s) return [];
        return String(s)
          .split(/[;,]/)
          .map(v => v.trim())
          .filter(Boolean)
          .slice(0, 15);
      }

      async function getViewUrlForPath(gcsPath) {
        if (!gcsPath) throw new Error('path vazio');
        const token = await currentUser.getIdToken(true);
        const url = BACKEND_BASE.replace(/\/$/,'') + '/media/signed-url';

        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contentType: 'image/jpeg',
            path: gcsPath
          })
        });

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = null; }

        if (!res.ok || !json || json.ok === false) {
          throw new Error((json && json.error) || ('Falha HTTP ' + res.status));
        }
        if (!json.downloadUrl) {
          throw new Error('downloadUrl ausente na resposta');
        }
        return json.downloadUrl;
      }

      byId('btn-clear').onclick = () => {
        byId('f-cod').value=''; byId('f-nome').value=''; byId('f-preco').value=''; byId('f-dur').value=''; byId('f-info').value='';
        clearMsg(byId('add-msg'));
        byId('f-cod').focus();
      };

      let currentUser = null;
      let isVerified = false;
      let uid = null;

      const PAGE_SIZE = 10;
      let dataAll = [];
      let dataView = [];
      let page = 0;

      let photoSvcId = null;

      byId('btn-add').onclick = async () => {
        clearMsg(byId('add-msg'));
        if (!currentUser) { setMsg(byId('add-msg'),'error','Sess√£o expirada. Fa√ßa login novamente.'); return; }

        let codigo = byId('f-cod').value.trim();
        const nome = byId('f-nome').value.trim();
        const precoStr = byId('f-preco').value.trim();
        const durStr = byId('f-dur').value.trim();
        const infoStr = byId('f-info').value.trim();

        if (codigo) {
          codigo = codigo.toUpperCase();
          if (!/^[A-Z0-9-]{1,24}$/.test(codigo)) {
            setMsg(byId('add-msg'),'error','C√≥digo inv√°lido. Use apenas letras, n√∫meros e "-" (at√© 24).'); return;
          }
        }

        if (!nome) { setMsg(byId('add-msg'),'error','Informe o nome do servi√ßo.'); return; }
        if (nome.length > 80) { setMsg(byId('add-msg'),'error','Nome muito longo (m√°x. 80 caracteres).'); return; }

        const preco = parsePriceBRL(precoStr);
        if (!(preco >= 0)) { setMsg(byId('add-msg'),'error','Pre√ßo inv√°lido. Use formato 45,00.'); return; }
        if (preco > 99999.99) { setMsg(byId('add-msg'),'error','Pre√ßo muito alto.'); return; }

        const dur = parseInt(durStr, 10);
        if (!(dur >= 1 && dur <= 360)) { setMsg(byId('add-msg'),'error','Tempo inv√°lido. Use de 1 a 360 minutos.'); return; }

        const outrasInfo = splitTags(infoStr);
        const slug = slugify(nome);
        if (!slug) { setMsg(byId('add-msg'),'error','N√£o foi poss√≠vel gerar um identificador para este nome.'); return; }

        try {
          const db = firebase.firestore();
          const col = db.collection('profissionais').doc(uid).collection('produtosEServicos');

          const dup = await col.where('slug','==',slug).limit(1).get();
          if (!dup.empty) { setMsg(byId('add-msg'),'error','Este servi√ßo j√° existe na sua lista.'); return; }
          if (codigo) {
            const dupCod = await col.where('codigo','==',codigo).limit(1).get();
            if (!dupCod.empty) { setMsg(byId('add-msg'),'error','Este C√ìDIGO j√° est√° em uso nos seus servi√ßos.'); return; }
          }

          const now = firebase.firestore.FieldValue.serverTimestamp();
          await col.add({
            codigo: codigo || null,
            slug,
            nome,
            precoBase: Number(preco.toFixed(2)),
            duracaoMin: dur,
            sinonimos: outrasInfo,
            createdAt: now,
            updatedAt: now
          });

          setMsg(byId('add-msg'),'ok','Servi√ßo salvo com sucesso.');
          byId('btn-clear').click();
          await loadServices();
        } catch(e) {
          console.error('[precos] add error', e);
          setMsg(byId('add-msg'),'error','N√£o foi poss√≠vel salvar agora. Tente novamente.');
        }
      };

      function getSampleCsvBlob() {
        const rows = [
          'codigo,nome do servico,preco (R$),tempo (min),outras informacoes',
          'BARB01,Corte masculino,45,30,"corte, pezinho, maquina"',
          'CORT-INF,Corte infantil,35,30,"cabelo infantil, tesoura"',
          'BARB-TRAD,Barba tradicional,30,20,"barbear, navalha"',
          'COMBO-CB,Combo corte + barba,70,60,"combo, pacote"',
          'ACAB25,Sombra e acabamento,25,15,"acabamento, contorno"',
          'HIDR60,Hidrata√ß√£o capilar,60,40,"tratamento, mascara capilar"',
          'PIGM80,Pigmenta√ß√£o/Corre√ß√£o,80,45,"tonalizante, correcao de falhas"'
        ].join('\n');
        return new Blob([rows], {type:'text/csv;charset=utf-8'});
      }
      byId('btn-sample').onclick = () => {
        const blob = getSampleCsvBlob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'exemplo-planilha.csv'; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
      };

      const drop = byId('dropzone');
      const finput = byId('file-input');
      drop.addEventListener('click', ()=>finput.click());
      drop.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); finput.click(); }});
      drop.addEventListener('dragover', e=>{ e.preventDefault(); });
      drop.addEventListener('drop', e=>{
        e.preventDefault();
        if (e.dataTransfer.files?.length) { finput.files = e.dataTransfer.files; onFileSelected(); }
      });
      finput.addEventListener('change', onFileSelected);

      let csvText = '';
      function onFileSelected(){
        clearMsg(byId('import-msg'));
        byId('preview-wrap').classList.add('hidden');
        csvText = '';

        const f = finput.files && finput.files[0];
        console.log('[precos] onFileSelected, file =', f && f.name, 'size =', f && f.size);

        if (!f) {
          byId('btn-preview').disabled = true;
          byId('btn-import').disabled = true;
          return;
        }

        // Limite de 1 MB
        if (f.size > 1024 * 1024) {
          setMsg(byId('import-msg'), 'error', 'Arquivo muito grande (m√°x. 1MB).');
          finput.value = '';
          byId('btn-preview').disabled = true;
          byId('btn-import').disabled = true;
          return;
        }

        // üëâ A partir daqui o arquivo foi aceito: j√° libera os bot√µes
        byId('btn-preview').disabled = false;
        byId('btn-import').disabled = false;

        const reader = new FileReader();
        reader.onload = () => {
          csvText = String(reader.result || '');
          console.log('[precos] CSV carregado, tamanho chars =', csvText.length);

          // Se por algum motivo vier vazio, re-desabilita
          if (!csvText.trim()) {
            byId('btn-preview').disabled = true;
            byId('btn-import').disabled = true;
          }
        };
        reader.onerror = (err) => {
          console.error('[precos] erro ao ler CSV', err);
          setMsg(byId('import-msg'), 'error', 'N√£o foi poss√≠vel ler o arquivo. Tente novamente.');
          csvText = '';
          byId('btn-preview').disabled = true;
          byId('btn-import').disabled = true;
        };
        reader.readAsText(f, 'UTF-8');
      }

      function parseCsvBasic(text){
        const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        if (!lines.length) return { header:[], rows:[] };
        const headerRaw = lines[0].split(',').map(h=>h.trim());
        const header = headerRaw.map(h=>h.toLowerCase());
        const rows = lines.slice(1).map(line=>{
          const cols = [];
          let cur = ''; let inQ = false;
          for (let i=0;i<line.length;i++){
            const ch = line[i];
            if (ch === '"') { inQ = !inQ; continue; }
            if (ch === ',' && !inQ) { cols.push(cur); cur=''; continue; }
            cur += ch;
          }
          cols.push(cur);
          return cols.map(c=>c.trim());
        });
        return { headerRaw, header, rows };
      }

      const colMap = {
        codigo: ['codigo','c√≥digo','cod','c√≥d'],
        nome: ['nome do servico','nome','servico','descri√ß√£o','descricao'],
        preco: ['preco (r$)','preco','valor','preco r$','pre√ßo','pre√ßo (r$)'],
        tempo: ['tempo (min)','duracao','min','duracao (min)','tempo'],
        outras: ['outras informacoes','outras informa√ß√µes','outros nomes','sinonimos','apelidos','palavras-chave','detalhes']
      };
      function pickBy(header, cols, keys){
        for (const k of keys) { const i = header.indexOf(k); if (i>=0) return cols[i] ?? ''; }
        return '';
      }
      function findExtras(header){
        const known = new Set([ ...colMap.codigo, ...colMap.nome, ...colMap.preco, ...colMap.tempo, ...colMap.outras ]);
        return header.filter(h => !known.has(h));
      }

      byId('btn-preview').onclick = () => {
        clearMsg(byId('import-msg'));

        // Se ainda n√£o tem arquivo escolhido, ajudamos abrindo o seletor
        if (!finput.files || !finput.files[0]) {
          finput.click();
          return;
        }

        if (!csvText.trim()) {
          setMsg(byId('import-msg'), 'error', 'N√£o foi poss√≠vel ler o arquivo. Escolha novamente o .csv.');
          return;
        }

        const { headerRaw, header, rows } = parseCsvBasic(csvText);

        const t = byId('preview-table');
        t.innerHTML = '';
        const thead = document.createElement('thead'), trh = document.createElement('tr');
        ['nome do servico','preco (R$)','tempo (min)','outras informacoes'].forEach(n=>{ const th=document.createElement('th'); th.textContent=n; trh.appendChild(th); });
        thead.appendChild(trh); t.appendChild(thead);

        const tbody = document.createElement('tbody');
        rows.slice(0,10).forEach(cols=>{
          const vNome = pickBy(header, cols, colMap.nome);
          const vPreco = pickBy(header, cols, colMap.preco);
          const vTempo = pickBy(header, cols, colMap.tempo);
          const vOutras = pickBy(header, cols, colMap.outras);

          const tr = document.createElement('tr');
          [vNome, vPreco, vTempo, vOutras].forEach(v=>{
            const td = document.createElement('td'); td.textContent = v || ''; tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        t.appendChild(tbody);

        const extras = findExtras(header);
        const note = byId('preview-note');
        if (extras.length) {
          note.textContent = 'Aten√ß√£o: as seguintes colunas ser√£o ignoradas nesta pr√©via: ' + extras.join(', ') + '.';
          note.classList.remove('hidden');
        } else {
          note.classList.add('hidden');
          note.textContent = '';
        }

        byId('preview-wrap').classList.remove('hidden');
      };

      const BACKEND_BASE = window.BACKEND_BASE || 'https://mei-robo-prod.onrender.com';
      byId('btn-import').onclick = async ()=>{
        clearMsg(byId('import-msg'));
        if (!currentUser) { setMsg(byId('import-msg'),'error','Sess√£o expirada. Fa√ßa login novamente.'); return; }
        if (!finput.files?.[0]) { setMsg(byId('import-msg'),'error','Escolha um arquivo primeiro.'); return; }

        try {
          const { header, rows } = parseCsvBasic(csvText);
          const out = [];
          out.push('slug,nome,precoBase,duracaoMin,sinonimos');
          rows.forEach(cols=>{
            const nome = pickBy(header, cols, colMap.nome);
            const precoRaw = pickBy(header, cols, colMap.preco);
            const tempoRaw = pickBy(header, cols, colMap.tempo);
            const outrasRaw = pickBy(header, cols, colMap.outras);

            if (!nome) return;
            const slug = slugify(nome);
            const preco = parsePriceBRL(precoRaw);
            const tempo = parseInt(String(tempoRaw).replace(/\D/g,''), 10);
            const tags = splitTags(outrasRaw).join(';');

            out.push([
              slug,
              '"' + nome.replace(/"/g,'""') + '"',
              (isFinite(preco)?preco.toFixed(2):'0.00'),
              (isFinite(tempo)?tempo:0),
              '"' + tags.replace(/"/g,'""') + '"'
            ].join(','));
          });
          const canonicalBlob = new Blob([out.join('\n')], {type:'text/csv;charset=utf-8'});
          const canonicalFile = new File([canonicalBlob], 'importado.csv', { type: 'text/csv' });

          const token = await currentUser.getIdToken(true);
          const url = BACKEND_BASE.replace(/\/$/,'') + '/api/importar-precos';
          const fd = new FormData();
          fd.append('file', canonicalFile, canonicalFile.name);

          const res = await fetch(url, { method:'POST', headers: { 'Authorization': 'Bearer ' + token }, body: fd });
          const text = await res.text();
          let json; try { json = JSON.parse(text); } catch { json = { ok:false, error: 'Resposta inesperada do servidor' }; }

          if (!res.ok || json.ok === false) {
            setMsg(byId('import-msg'),'error', json?.error || ('Falha HTTP ' + res.status));
          } else {
            const det = 'Importados: ' + (json.imported ?? 0) + (json.skipped ? (' | Ignorados: ' + json.skipped) : '');
            setMsg(byId('import-msg'),'ok','Importa√ß√£o conclu√≠da. ' + det);
            await loadServices();
          }
        } catch(e) {
          console.error('[precos] import error', e);
          setMsg(byId('import-msg'),'error','N√£o foi poss√≠vel importar agora.');
        }
      };

      const photoInput = byId('photo-input');
      const svcBody = byId('svc-body');

      svcBody.addEventListener('click', async (e) => {
        const btnUpload = e.target.closest('button[data-photo-svc]');
        const btnView = e.target.closest('button[data-view-photo]');
        const btnEdit = e.target.closest('button[data-edit-svc]');

        if (btnUpload) {
          if (!currentUser) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            return;
          }
          photoSvcId = btnUpload.getAttribute('data-photo-svc');
          if (!photoSvcId) return;
          photoInput.value = '';
          photoInput.click();
          return;
        }

        if (btnView) {
          if (!currentUser) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            return;
          }
          const svcId = btnView.getAttribute('data-view-photo');
          const svc = dataAll.find(s => s.id === svcId);
          if (!svc) return;

          try {
            if (svc.fotoPath) {
              const viewUrl = await getViewUrlForPath(svc.fotoPath);
              window.open(viewUrl, '_blank', 'noopener');
            } else if (svc.fotoUrlLegacy) {
              window.open(svc.fotoUrlLegacy, '_blank', 'noopener');
            } else {
              alert('Este servi√ßo ainda n√£o tem foto salva.');
            }
          } catch (err) {
            console.error('[precos] ver foto error', err);
            alert('N√£o foi poss√≠vel abrir a foto agora. Tente reenviar a foto ou recarregar a p√°gina.');
          }
          return;
        }

        if (btnEdit) {
          if (!currentUser) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            return;
          }
          const svcId = btnEdit.getAttribute('data-edit-svc');
          const svc = dataAll.find(s => s.id === svcId);
          if (!svc) return;

          const codAtual = svc.codigo || '';
          const nomeAtual = svc.nome || '';
          const precoAtualStr = String((svc.precoBase || 0).toFixed(2)).replace('.', ',');
          const durAtualStr = svc.duracaoMin ? String(svc.duracaoMin) : '';
          const outrasAtualStr = (svc.sinonimos || []).join(', ');

          const novoCod = prompt('C√≥digo (opcional)', codAtual);
          if (novoCod === null) return;

          const novoNome = prompt('Nome do servi√ßo', nomeAtual);
          if (novoNome === null) return;

          const novoPrecoStr = prompt('Pre√ßo (R$)', precoAtualStr);
          if (novoPrecoStr === null) return;

          const novoDurStr = prompt('Tempo (minutos)', durAtualStr);
          if (novoDurStr === null) return;

          const novasOutrasStr = prompt('Outras informa√ß√µes (separe por v√≠rgula)', outrasAtualStr);
          if (novasOutrasStr === null) return;

          let codigoTrim = (novoCod || '').trim();
          if (codigoTrim) {
            codigoTrim = codigoTrim.toUpperCase();
            if (!/^[A-Z0-9-]{1,24}$/.test(codigoTrim)) {
              alert('C√≥digo inv√°lido. Use apenas letras, n√∫meros e "-" (at√© 24).');
              return;
            }
          } else {
            codigoTrim = '';
          }

          const nomeTrim = (novoNome || '').trim();
          if (!nomeTrim) {
            alert('O nome do servi√ßo n√£o pode ficar vazio.');
            return;
          }

          const precoNum = parsePriceBRL(novoPrecoStr);
          if (!(precoNum >= 0)) {
            alert('Pre√ßo inv√°lido. Use formato 45,00.');
            return;
          }
          if (precoNum > 99999.99) {
            alert('Pre√ßo muito alto.');
            return;
          }

          const durNum = parseInt(String(novoDurStr).replace(/\D/g, ''), 10);
          if (!(durNum >= 1 && durNum <= 360)) {
            alert('Tempo inv√°lido. Use de 1 a 360 minutos.');
            return;
          }

          const novasTags = splitTags(novasOutrasStr);

          try {
            const db = firebase.firestore();
            const col = db.collection('profissionais').doc(uid).collection('produtosEServicos');

            if (codigoTrim && codigoTrim !== (svc.codigo || '')) {
              const dupCod = await col.where('codigo', '==', codigoTrim).limit(1).get();
              if (!dupCod.empty && dupCod.docs[0].id !== svc.id) {
                alert('Este C√ìDIGO j√° est√° em uso nos seus servi√ßos.');
                return;
              }
            }

            const now = firebase.firestore.FieldValue.serverTimestamp();
            await col.doc(svc.id).update({
              codigo: codigoTrim || null,
              nome: nomeTrim,
              precoBase: Number(precoNum.toFixed(2)),
              duracaoMin: durNum,
              sinonimos: novasTags,
              updatedAt: now
            });

            await loadServices();
            alert('Servi√ßo atualizado com sucesso.');
          } catch (err) {
            console.error('[precos] edit error', err);
            alert('N√£o foi poss√≠vel salvar as altera√ß√µes agora. Tente novamente.');
          }
        }
      });

      photoInput.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file || !photoSvcId) {
          photoSvcId = null;
          return;
        }
        if (file.size > MAX_PHOTO_BYTES) {
          alert('Arquivo muito grande. Use uma foto de at√© 2 MB.');
          photoInput.value = '';
          photoSvcId = null;
          return;
        }

        try {
          const token = await currentUser.getIdToken(true);
          const url = BACKEND_BASE.replace(/\/$/,'') + '/api/servicos/foto';
          const fd = new FormData();
          fd.append('file', file);
          fd.append('servicoId', photoSvcId);
          fd.append('contentType', file.type || 'image/png');

          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token
            },
            body: fd
          });

          const text = await res.text();
          let json;
          try { json = JSON.parse(text); } catch { json = {}; }

          if (!res.ok || json.ok === false) {
            alert(json.error || ('N√£o foi poss√≠vel enviar a foto agora. (HTTP ' + res.status + ')'));
          } else {
            if (json.fotoUrl || json.fotoPath) {
              const svc = dataAll.find(s => s.id === photoSvcId);
              if (svc) {
                if (json.fotoUrl) svc.fotoUrlLegacy = json.fotoUrl;
                if (json.fotoPath) svc.fotoPath = json.fotoPath;
              }
            }
            await loadServices();
            alert('Foto atualizada com sucesso.');
          }
        } catch (err) {
          console.error('[precos] foto upload error', err);
          alert('N√£o foi poss√≠vel enviar a foto agora. Verifique sua conex√£o e tente de novo.');
        } finally {
          photoSvcId = null;
          photoInput.value = '';
        }
      });

      async function loadServices(){
        const db = firebase.firestore();
        const col = db.collection('profissionais').doc(uid).collection('produtosEServicos');
        const snap = await col.orderBy('nome').get();
        dataAll = snap.docs.map(d=>{
          const v = d.data() || {};
          return {
            id: d.id,
            codigo: v.codigo || '',
            nome: v.nome || '',
            precoBase: typeof v.precoBase === 'number' ? v.precoBase : parseFloat(v.precoBase || '0') || 0,
            duracaoMin: typeof v.duracaoMin === 'number' ? v.duracaoMin : parseInt(v.duracaoMin || '0') || 0,
            sinonimos: Array.isArray(v.sinonimos)
              ? v.sinonimos
              : (typeof v.sinonimos === 'string'
                  ? v.sinonimos.split(';').map(s=>s.trim()).filter(Boolean)
                  : []),
            fotoPath: typeof v.fotoPath === 'string' ? v.fotoPath : '',
            fotoUrlLegacy: typeof v.fotoUrl === 'string' ? v.fotoUrl : ''
          };
        });
        applyFilter();
      }

      function normalize(t) {
        return String(t || '')
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '');
      }

      function applyFilter(){
        const q = normalize(byId('search').value || '');
        dataView = !q ? dataAll.slice() : dataAll.filter(s =>
          normalize(s.codigo).includes(q) ||
          normalize(s.nome).includes(q) ||
          normalize((s.sinonimos||[]).join(' ')).includes(q)
        );
        page = 0;
        renderTable();
      }
      byId('search').addEventListener('input', applyFilter);

      function renderTable(){
        const body = byId('svc-body');
        body.innerHTML = '';
        if (!dataView.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 7;
          td.textContent = 'Nenhum servi√ßo cadastrado ainda.';
          tr.appendChild(td);
          body.appendChild(tr);
        } else {
          const start = page * PAGE_SIZE;
          const end = Math.min(start + PAGE_SIZE, dataView.length);

          dataView.slice(start, end).forEach(s => {
            const hasFoto = !!(s.fotoPath || s.fotoUrlLegacy);

            const viewBtnHtml = hasFoto
              ? ' ¬∑ <button class="button button-sm" data-view-photo="' + s.id + '">Ver</button>'
              : '';

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="nowrap">${s.codigo || '-'}</td>
              <td>${s.nome}</td>
              <td class="nowrap">${s.precoBase.toFixed(2)}</td>
              <td class="nowrap">${s.duracaoMin}</td>
              <td>${(s.sinonimos || []).join(', ')}</td>
              <td class="nowrap">
                <span class="help">
                  ${hasFoto ? '1 foto' : 'Sem foto'}${viewBtnHtml}
                </span>
                <button class="button button-sm" data-photo-svc="${s.id}">
                  ${hasFoto ? 'Trocar foto' : 'Anexar foto'}
                </button>
              </td>
              <td class="nowrap">
                <button class="button button-sm" data-edit-svc="${s.id}">Editar</button>
              </td>
            `;
            body.appendChild(tr);
          });
        }
        byId('count').textContent = String(dataView.length);
        byId('prev').disabled = page <= 0;
        byId('next').disabled = (page + 1) * PAGE_SIZE >= dataView.length;
      }

      byId('prev').onclick = ()=>{ if(page>0){ page--; renderTable(); } };
      byId('next').onclick = ()=>{ if((page+1)*PAGE_SIZE < dataView.length){ page++; renderTable(); } };

      async function ensureAuth(){
        await maybeCleanSession();
        // Header/footer agora v√™m s√≥ pelo layout.js (parciais can√¥nicas)

        return new Promise((resolve)=>{
          firebase.auth().onAuthStateChanged(async (u)=>{
            if (!u) {
              REDIRECTING_TO_LOGIN = true;
              log('Sem sess√£o: redirecionando para login');
              location.href = '/pages/login.html';
              return;
            }
            currentUser = u;
            uid = u.uid;
            isVerified = !!u.emailVerified;

            const ready = byId('import-ready');
            if (ready) {
              ready.textContent = 'Voc√™ est√° logado. Pode importar sua planilha .csv.';
            }

            resolve();
          });
        });
      }

      (async function init(){
        try {
          await ensureAuth();
          if (REDIRECTING_TO_LOGIN) return;
          await loadServices();
          log('Pronto.');
        } catch(e) {
          console.error('[precos] init error', e);
          if (!REDIRECTING_TO_LOGIN) {
            const tb = byId('svc-body');
            tb.innerHTML = '<tr><td colspan="7" class="msg err">Falha ao carregar a p√°gina. Recarregue e verifique sua conex√£o.</td></tr>';
          }
        }
      })();
    })();
  </script>
</body>
</html>

