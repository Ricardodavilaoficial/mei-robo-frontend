<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MEI Robô — Mídia (v3.1 — UI melhorada)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f1720;
      --muted:#9aa4b2;
      --accent:#16a34a; /* verde */
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.03);
      --input-border: rgba(255,255,255,0.06);
    }
    html,body{height:100%}
    body{background:var(--bg); color:#e6edf3; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; -webkit-font-smoothing:antialiased; margin:0}
    .container{max-width:980px; margin:0 auto; padding:18px;}
    .card{background:var(--card); border:1px solid rgba(255,255,255,0.04); border-radius:12px; padding:14px}
    .muted{color:var(--muted); font-size:0.93rem}
    .label{font-size:0.95rem; color:#e6edf3; margin-bottom:6px; display:block}
    .input, select, .text-small{background:var(--glass); border:1px solid var(--input-border); padding:10px 12px; border-radius:8px; color:#e6edf3; width:100%; box-sizing:border-box}
    .btn{background:var(--accent); color:white; padding:8px 12px; border-radius:8px; border:none; cursor:pointer}
    .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,0.06); color:#e6edf3; padding:8px 10px; border-radius:8px; cursor:pointer}
    .row{display:flex; gap:12px; align-items:center}
    .col{display:flex; flex-direction:column}
    /* file input custom */
    .file-wrap{display:flex; gap:10px; align-items:center}
    .file-name{max-width:420px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:0.95rem; color:#dbe7d9}
    .file-btn{display:inline-flex; gap:8px; align-items:center}
    /* responsive */
    @media (max-width:640px){ .file-name{max-width:180px} .row{flex-direction:column; align-items:stretch} }
    /* path preview truncated but with full copy on hover */
    .path-preview{max-width:100%; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--muted); font-size:0.9rem}
    .error{color:var(--danger); font-size:0.95rem}
    .hint{color:var(--muted); font-size:0.88rem}
    .quota-box{background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03)}
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="root"></div>
  </div>

  <script type="text/babel">
  const { useState, useEffect, useMemo } = React;
  const CANARY_UID = 'V4eFP2bNdXNtQz2Eh4PxpwHNLOP2';
  const ALLOWED_MIMES = ['image/jpeg','image/png','image/webp','image/gif','application/pdf','video/mp4'];
  const LIMITS = { default: 15 * 1024 * 1024, mp4: 25 * 1024 * 1024 };

  function isValidateMode(){ try{ return new URLSearchParams(window.location.search).has('validate') }catch{ return false } }
  function slugify(text){ return text.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
  function shortId(len=6){ return Math.random().toString(36).slice(2, 2+len); }
  function todayPath(){ const d=new Date(); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yyyy}/${mm}/${dd}`; }
  function formatBytes(b){ if (!b && b!==0) return '0 B'; const u=['B','KB','MB','GB']; let i=0, val=b; while(val>=1024 && i<u.length-1){ val/=1024; i++; } const fixed = val>=100?0: val>=10?1:2; return `${val.toFixed(fixed)} ${u[i]}`; }

  const DEFAULT_SERVICES = [
    { slug: 'corte', name: 'Corte' },
    { slug: 'luzes', name: 'Luzes' },
    { slug: 'morena-luminosa', name: 'Morena Luminosa' },
    { slug: 'barba', name: 'Barba' },
    { slug: 'pintura-parede', name: 'Pintura de parede' },
    { slug: 'mecanica-troca-oleo', name: 'Troca de óleo (mecânico)' }
  ];

  function MediaUploadV31(){
    const validate = isValidateMode();
    const [user] = useState(validate ? { uid: CANARY_UID, name: 'Canário (preview)' } : null);
    const [services] = useState(DEFAULT_SERVICES);
    const [title, setTitle] = useState('');
    const [service, setService] = useState('');
    const [file, setFile] = useState(null);
    const [error, setError] = useState(null);
    const [progress, setProgress] = useState(0);
    const [recent, setRecent] = useState([]);
    const [quota, setQuota] = useState({ limitBytes: 2147483648, bytesUsed: Math.floor(2147483648*0.65), filesCount: 128 });

    useEffect(()=>{ if (validate && !localStorage.getItem('MEDIA_V1')) localStorage.setItem('MEDIA_V1','on'); },[]);

    const canUse = useMemo(()=> {
      if (!user) return false;
      const flag = localStorage.getItem('MEDIA_V1') === 'on';
      return flag && user.uid === CANARY_UID;
    }, [user]);

    function validateFile(f){
      if (!f) return 'Selecione um arquivo';
      if (!ALLOWED_MIMES.includes(f.type)) return 'Tipo não permitido. Use imagem (jpg/png/webp/gif), PDF ou vídeo MP4.';
      const limit = f.type === 'video/mp4' ? LIMITS.mp4 : LIMITS.default;
      if (f.size > limit) return `Arquivo maior que o permitido (${formatBytes(limit)}).`;
      if (quota.bytesUsed >= quota.limitBytes) return 'Cota completa — apague arquivos ou libere espaço.';
      return null;
    }

    function handleChoose(e){
      setError(null);
      const f = e.target.files?.[0] || null;
      if (!f){ setFile(null); return; }
      const v = validateFile(f);
      if (v){ setError(v); setFile(null); return; }
      setFile(f);
    }

    function suggestedPathFor(titleVal, originalName){
      const slug = slugify(titleVal || originalName || 'sem-nome');
      const id = shortId(6);
      const ext = (originalName && originalName.split('.').pop()) || 'jpg';
      return `users/${CANARY_UID}/media/${todayPath()}/${slug}-${id}.${ext}`;
    }

    async function mockUpload(file, onProgress){
      return new Promise((resolve)=>{
        const total = file.size || (1024*500);
        let uploaded = 0;
        const step = Math.max(1024*40, Math.round(total/40));
        const t = setInterval(()=>{
          uploaded += step;
          if (uploaded > total) uploaded = total;
          onProgress(Math.round((uploaded/total)*100));
          if (uploaded >= total){
            clearInterval(t);
            setTimeout(()=> resolve({ ok:true }), 120);
          }
        }, 50);
      });
    }

    async function handleUpload(){
      setError(null);
      if (!title?.trim()) { setError('Preencha o título, ex.: Morena Luminosa — antes'); return; }
      if (!service) { setError('Escolha o serviço relacionado'); return; }
      if (!file) { setError('Selecione um arquivo'); return; }
      const v = validateFile(file);
      if (v){ setError(v); return; }

      try {
        setProgress(1);
        const slug = slugify(title);
        const id = shortId(6);
        const ext = (file.name.split('.').pop() || 'jpg');
        const storagePath = `users/${user.uid}/media/${todayPath()}/${slug}-${id}.${ext}`;

        await mockUpload(file, p=> setProgress(p));
        setQuota(q => ({ ...q, bytesUsed: q.bytesUsed + file.size, filesCount: q.filesCount + 1 }));
        setRecent(r=> [{ name: file.name, path: storagePath, size: file.size, title: title.trim(), service, createdAt: new Date().toISOString() }, ...r]);
        setFile(null); setProgress(0); setTitle(''); setService('');
      } catch(err){
        console.error(err); setError('Erro no upload'); setProgress(0);
      }
    }

    function copyText(t){ if (navigator.clipboard) navigator.clipboard.writeText(t).then(()=> alert('Copiado')); }

    function handleDelete(item){
      if (!confirm('Excluir upload (preview)?')) return;
      setRecent(r => r.filter(x=> x !== item));
      setQuota(q => ({ ...q, filesCount: Math.max(0, q.filesCount-1), bytesUsed: Math.max(0, q.bytesUsed - item.size) }));
    }

    return (
      <div className="space-y-4">
        <div>
          <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
            <div>
              <h2 style={{margin:0, fontSize:'1.15rem'}}>Configuração → Mídia</h2>
              <div className="muted" style={{marginTop:6}}>Envie imagens, PDFs ou vídeos curtos. Dê um título fácil de achar.</div>
            </div>
            <div style={{textAlign:'right'}} className="muted">Preview seguro</div>
          </div>
        </div>

        {!user && <div className="card">Faça login para acessar a área de mídia.</div>}

        {user && !canUse && <div className="card"><div style={{fontWeight:600}}>Recurso em teste (canário)</div><div className="muted" style={{marginTop:6}}>Ative no console: <code>localStorage.setItem('MEDIA_V1','on')</code></div></div>}

        {user && canUse && (
          <div className="card">
            <div style={{display:'grid', gridTemplateColumns:'1fr 260px', gap:12}}>
              <div>
                <label className="label">Título <span className="muted" style={{fontSize:12}}> (como quer achar depois)</span></label>
                <input className="input" value={title} onChange={e=> setTitle(e.target.value)} placeholder="Ex.: Morena Luminosa — antes" />
              </div>

              <div>
                <label className="label">Serviço</label>
                <select className="input" value={service} onChange={e=> setService(e.target.value)}>
                  <option value="">— escolha —</option>
                  {services.map(s=> <option key={s.slug} value={s.slug}>{s.name}</option>)}
                </select>
              </div>
            </div>

            <div style={{marginTop:12}} className="file-wrap">
              <div style={{display:'flex', gap:10, alignItems:'center', flex:1}}>
                <label className="file-btn btn-ghost" style={{cursor:'pointer'}}>
                  <input type="file" id="file" onChange={handleChoose} style={{display:'none'}} />
                  <span style={{fontSize:14}}>Arquivo</span>
                </label>
                <div className="file-name" title={file ? file.name : ''}>{ file ? file.name : 'Nenhum arquivo escolhido' }</div>
              </div>

              <div style={{display:'flex', gap:8, alignItems:'center'}}>
                <button className="btn" onClick={handleUpload}>Enviar</button>
              </div>
            </div>

            {file && (
              <div style={{marginTop:10}}>
                <div className="quota-box">
                  <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                    <div style={{fontSize:14}}><strong>{file.name}</strong></div>
                    <div className="muted">{formatBytes(file.size)}</div>
                  </div>
                  <div style={{marginTop:8, height:8, background:'rgba(255,255,255,0.04)', borderRadius:6, overflow:'hidden'}}>
                    <div style={{height:8, background:'#0ea5a0', width: (progress>0?progress:0) + '%', transition:'width .2s'}}></div>
                  </div>
                </div>
              </div>
            )}

            {error && <div style={{marginTop:8}} className="error">{error}</div>}

            <div style={{marginTop:12}} className="muted">Dica: nomeie a foto com o serviço. Ex.: “Morena Luminosa — antes”. Tipos: jpg, png, webp, gif, pdf, mp4. Máx: imagens/PDF 15MB, vídeo MP4 25MB.</div>

            <div style={{marginTop:12}} className="muted">Destino (sugerido): <span className="path-preview" title={ suggestedPathFor(title, file?.name || 'nome.jpg') }>{ suggestedPathFor(title, file?.name || 'nome.jpg') }</span></div>
          </div>
        )}

        <div className="card">
          <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
            <div>
              <div style={{fontWeight:600}}>Quota</div>
              <div className="muted" style={{marginTop:6}}>Usado: {formatBytes(quota.bytesUsed)} / {formatBytes(quota.limitBytes)} • arquivos: {quota.filesCount}</div>
            </div>
            <div><button className="btn-ghost" onClick={()=> alert('Logs de upload ativados (preview)')}>Ver logs</button></div>
          </div>
        </div>

        <div>
          <h3 style={{marginBottom:6}}>Uploads recentes (preview)</h3>
          <div style={{display:'grid', gap:8}}>
            {recent.length === 0 ? <div className="muted">Nenhum upload</div> : recent.map((r,i)=> (
              <div key={i} className="card row" style={{justifyContent:'space-between'}}>
                <div style={{minWidth:0}}>
                  <div style={{fontWeight:600}}>{r.title} <span className="muted" style={{fontSize:12}}>• {r.name}</span></div>
                  <div className="muted" style={{marginTop:6}} title={r.path}>{r.path}</div>
                </div>
                <div style={{display:'flex', gap:8}}>
                  <button className="btn-ghost" onClick={()=> copyText(r.path)}>Copiar caminho</button>
                  <button className="btn-ghost" onClick={()=> handleDelete(r)} style={{color:'#f97373'}}>Excluir</button>
                </div>
              </div>
            ))}
          </div>
        </div>

      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<MediaUploadV31 />);
  </script>
</body>
</html>
