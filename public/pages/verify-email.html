<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MEI Robô — Verifique seu e-mail</title>

  <!-- Firebase compat (já usado no projeto) -->
  <script defer src="/__/firebase/9.22.2/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/9.22.2/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/init.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0e0f10;color:#e8e8e8;margin:0}
    .wrap{max-width:520px;margin:6rem auto 2rem;padding:24px;background:#151618;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    h1{font-size:1.2rem;margin:0 0 8px}
    p{opacity:.9;line-height:1.5}
    .row{margin:10px 0}
    .hint{font-size:.9rem;opacity:.8}
    .ok{color:#9be69b}
    .err{color:#ff7a7a}
    button{width:100%;padding:14px 16px;border-radius:12px;border:0;cursor:pointer;font-size:1rem}
    .primary{background:#25d366;color:#0b141a;font-weight:600}
    .ghost{background:#2a2d31;color:#e8e8e8}
    .email{font-family:ui-monospace,Consolas,monospace;background:#111;padding:6px 8px;border-radius:8px;display:inline-block}
    .top{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .logo{width:28px;height:28px;border-radius:6px;background:#25d366}
    .row-actions{display:flex;gap:10px;flex-wrap:wrap}
    .row-actions button{flex:1 1 200px}
    small.dim{opacity:.65}
    .muted{opacity:.75}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo"></div>
      <h1>Verificação de e-mail</h1>
    </div>
    <p class="hint">Abra o link que enviamos para seu e-mail. Depois clique no botão abaixo.</p>
    <div class="row">E-mail: <span id="email" class="email">—</span></div>

    <div class="row row-actions">
      <button id="btn" class="primary">Já verifiquei — continuar</button>
      <button id="resendBtn" class="ghost" title="Envia novamente o e-mail com logo e botão">Reenviar e-mail</button>
    </div>

    <div id="msg" class="row hint"></div>
    <div class="row"><small class="dim" id="tip"></small></div>
  </div>

  <script>
    // util: ler ?cont=/alvo
    function getParam(k){return new URLSearchParams(location.search).get(k)||""}
    const cont = getParam("cont") || "/pages/configuracao.html";
    const msg = document.getElementById("msg");
    const btn = document.getElementById("btn");
    const resendBtn = document.getElementById("resendBtn");
    const emailSpan = document.getElementById("email");
    const tip = document.getElementById("tip");
    const LS_KEY = "meirobo_last_verif_sent_at"; // debounce local

    // Preencher e-mail logado (se houver)
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await new Promise(r => setTimeout(r, 200)); // dá tempo do firebase init
        const user = firebase.auth().currentUser || null;
        if (user && user.email) emailSpan.textContent = user.email;
        else emailSpan.textContent = "entre para continuar";
        renderDebounceTip();
      } catch {}
    });

    function renderDebounceTip(){
      const last = Number(localStorage.getItem(LS_KEY) || "0");
      if (!last) { tip.textContent = ""; return; }
      const secs = Math.max(0, 90 - Math.floor((Date.now() - last)/1000));
      tip.textContent = secs > 0
        ? `Você pode reenviar novamente em ${secs}s.`
        : "";
      if (secs > 0) setTimeout(renderDebounceTip, 1000);
    }

    function canResend(){
      const last = Number(localStorage.getItem(LS_KEY) || "0");
      return (Date.now() - last) > 90_000; // 90s
    }

    async function check() {
      msg.textContent = "Verificando...";
      msg.className = "row hint";
      try {
        const user = firebase.auth().currentUser;
        if (!user) { msg.textContent = "Você precisa estar logado."; msg.className = "row err"; return; }
        const idToken = await user.getIdToken(/*forceRefresh=*/true);

        const res = await fetch("/api/auth/check-verification", {
          method: "POST",
          headers: { "Authorization": "Bearer " + idToken }
        });
        const data = await res.json();

        if (!res.ok) {
          msg.textContent = "Falha ao verificar: " + (data.error || res.status);
          msg.className = "row err";
          return;
        }
        if (data.verified) {
          msg.textContent = "E-mail verificado! Redirecionando...";
          msg.className = "row ok";
          setTimeout(() => location.href = cont, 300);
        } else {
          msg.textContent = "Ainda não verificou. Abra o link do e-mail e tente novamente.";
          msg.className = "row err";
        }
      } catch (e) {
        msg.textContent = "Erro: " + (e && e.message ? e.message : e);
        msg.className = "row err";
      }
    }

    async function resend(){
      msg.textContent = "";
      msg.className = "row hint";
      try {
        const user = firebase?.auth?.().currentUser;
        if (!user) { msg.textContent = "Faça login e tente de novo."; msg.className = "row err"; return; }

        // debounce local p/ evitar TOO_MANY_ATTEMPTS_TRY_LATER
        if (!canResend()){
          renderDebounceTip();
          msg.textContent = "Aguarde alguns segundos antes de reenviar de novo.";
          msg.className = "row hint";
          return;
        }

        resendBtn.disabled = true;
        resendBtn.textContent = "Reenviando...";
        const idToken = await user.getIdToken();

        const r = await fetch("/api/auth/send-verification-email", {
          method: "POST",
          headers: { "Authorization": "Bearer " + idToken, "Content-Type": "application/json" },
          body: JSON.stringify({})
        });

        const text = await r.text();
        if (r.ok) {
          localStorage.setItem(LS_KEY, String(Date.now()));
          renderDebounceTip();
          msg.textContent = "Reenviado! Verifique sua caixa de entrada e o spam.";
          msg.className = "row ok";
        } else {
          // Mostra retorno do backend p/ diagnóstico
          msg.textContent = "Falhou ao reenviar: " + (text || r.status);
          msg.className = "row err";
        }
      } catch (e) {
        msg.textContent = "Erro ao reenviar: " + (e?.message || e);
        msg.className = "row err";
      } finally {
        resendBtn.disabled = false;
        resendBtn.textContent = "Reenviar e-mail";
      }
    }

    btn.addEventListener("click", check);
    resendBtn.addEventListener("click", resend);
  </script>
</body>
</html>
