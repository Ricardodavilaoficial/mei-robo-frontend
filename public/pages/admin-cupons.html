<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>ADMIN — Cupons (diag5)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Estilos canônicos -->
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" href="data:,">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- Init (DEFAULT com apiKey real) -->
  <script src="/assets/firebase-init.js?v=login6"></script>

  <!-- Patch de rotas (mantido) -->
  <script src="/assets/backend-patch.js"></script>

  <!-- Loader de header/footer -->
  <script defer src="/assets/layout.js"></script>
  <!-- DIAG_VERSION=5 -->
</head>
<body>
  <div id="app-header"></div>

  <main class="container">
    <div class="card">
      <h2>Admin • Cupons</h2>
      <p class="note">Acesso restrito. Somente administrador.</p>

      <!-- Badge -->
      <div class="note" style="margin:8px 0;">
        <strong>Versão:</strong> diag5
      </div>

      <!-- Painel de status -->
      <div class="card" style="margin-top:12px; background:#0c171d;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="note">UID: <code id="uid">-</code></span>
          <span class="note">Token: <span id="tok">-</span></span>
          <span class="note">Firebase: <code id="fbStatus">-</code></span>
          <button class="btn secondary" id="refreshToken" type="button">Atualizar token</button>
          <button class="btn secondary" id="listScripts" type="button">Listar scripts</button>
          <button class="btn secondary" id="diagnosticar" type="button">Diagnosticar rotas</button>
          <button class="btn danger" id="stopScan" type="button" title="Cancela a varredura atual">Parar varredura</button>
        </div>
      </div>

      <div id="admin-gate" class="card" style="margin-top:12px; background:#0c171d;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>
            <input type="checkbox" id="toggleAdmin" />
            Eu sou administrador (dev)
          </label>
          <button class="btn secondary" id="saveGate" type="button">Aplicar</button>
          <span class="note">Flag salva em <code>localStorage.isAdmin</code></span>
        </div>
      </div>

      <div id="admin-area" style="display:none; margin-top:14px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="gerar" type="button">Gerar cupom</button>
          <button class="btn secondary" id="listar" type="button">Listar cupons</button>
        </div>

        <div class="grid grid-2" style="margin-top:12px">
          <div>
            <label for="dias">Dias de validade (opcional)</label>
            <input id="dias" class="input" type="number" min="1" step="1" placeholder="ex.: 7" />
          </div>
          <div>
            <label for="prefixo">Prefixo (opcional)</label>
            <input id="prefixo" class="input" placeholder="ex.: MEI" />
          </div>
        </div>

        <pre id="out" style="margin-top:12px; white-space:pre-wrap"></pre>

        <h3 style="margin-top:20px">Cupons</h3>
        <table class="table" id="tbl">
          <thead>
            <tr><th>código</th><th>status</th><th>criadoEm</th><th>expiraEm</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="app-footer"></div>

  <script>
    function lsGet(key) { try { return window.localStorage.getItem(key); } catch { return null; } }
    function lsSet(key, val) { try { window.localStorage.setItem(key, val); } catch {} }
    const token = () => lsGet('idToken') || '';

    function gateApply(){
      const isAdmin = lsGet('isAdmin') === 'true';
      document.getElementById('toggleAdmin').checked = isAdmin;
      document.getElementById('admin-area').style.display = isAdmin ? '' : 'none';
    }

    function setOut(msg){
      const el = document.getElementById('out');
      if(msg == null || msg === '') { el.textContent = ''; return; }
      if(typeof msg === 'string') el.textContent = msg;
      else {
        try { el.textContent = JSON.stringify(msg, null, 2); }
        catch { el.textContent = String(msg); }
      }
    }

    function updateAuthUI(u){
      document.getElementById('uid').textContent = u ? (u.uid || '-') : '-';
      document.getElementById('tok').textContent = token() ? 'token_ok' : '-';
      document.getElementById('fbStatus').textContent = (typeof window.firebase !== 'undefined') ? 'ok' : 'indisponível';
    }

    async function refreshIdToken(){
      try{
        if (typeof firebase === 'undefined') { setOut('Firebase indisponível. Recarregue (Ctrl+F5).'); updateAuthUI(null); return; }
        const u = firebase.auth().currentUser;
        if(!u){ setOut('Sem usuário logado. Faça login.'); updateAuthUI(null); return; }
        const t = await u.getIdToken(true);
        if(t){ lsSet('idToken', t); }
        updateAuthUI(u);
        setOut('Token atualizado e salvo em localStorage.idToken ✅');
      }catch(err){
        setOut({ erro:'Falha ao atualizar token', detalhe: err.message });
      }
    }

    // ===== Controle de varredura (Abort + timeout + limite) =====
    let currentScan = null; // {controller, running}
    function stopScan(reason){
      if (currentScan && currentScan.controller) currentScan.controller.abort();
      currentScan = null;
      if (reason) setOut({ info:'Varredura cancelada', motivo: reason });
    }
    function fetchWithTimeout(url, init, ms, signal){
      const ctrl = new AbortController();
      const timer = setTimeout(()=>ctrl.abort(), ms);
      const composite = new AbortController();
      function abortAll(){ ctrl.abort(); composite.abort(); }
      if (signal) signal.addEventListener('abort', abortAll, { once:true });
      const merged = { ...init, signal: ctrl.signal };
      return fetch(url, merged).finally(()=>clearTimeout(timer));
    }

    async function tryCombos({base, auth, payload, onStep, maxTries=12}){
      const prefixes = ["", "/api", "/api/v1", "/v1"];
      const names = [
        "licencas/gerar-cupom", "licencas/gerar_cupom",
        "licencas/cupom/gerar", "cupons/gerar"
      ];
      const methods = ["GET","PUT","PATCH","POST"]; // ordem segura
      const suffixes = ["", "/"];

      const controller = new AbortController();
      currentScan = { controller, running:true };
      let tries = 0, lastErr = null;

      outer: for (const pfx of prefixes){
        for (const name of names){
          for (const sfx of suffixes){
            for (const m of methods){
              if (!currentScan) break outer;
              if (tries >= maxTries) break outer;
              tries++;
              const path = `${pfx}/${name}${sfx}`.replace(/\/\/+/g,'/');
              const headers = { ...auth };
              let url = base + path;
              const init = { method:m, mode:'cors', headers };

              if (m === "GET"){
                const qs = new URLSearchParams(payload).toString();
                if (qs) url += (sfx ? "" : "") + "?" + qs;
              } else {
                headers['Content-Type'] = 'application/json';
                init.body = JSON.stringify(payload);
              }

              onStep && onStep({ step:tries, method:m, path });

              try{
                const r = await fetchWithTimeout(url, init, 2500, controller.signal);
                if (r.ok){
                  currentScan = null;
                  return { ok:true, res:r, via:{method:m, path} };
                } else {
                  const txt = await r.text().catch(()=>'(sem corpo)');
                  lastErr = `${m} ${path} -> ${r.status}: ${txt.slice(0,140)}`;
                }
              }catch(e){
                lastErr = `${m} ${path} -> ${String(e).slice(0,140)}`;
              }
            }
          }
        }
      }
      currentScan = null;
      return { ok:false, err:lastErr || 'Sem rota 2xx dentro do limite de tentativas.' };
    }

    async function gerar(){
      setOut('Gerando cupom (scan limitado)…');
      const dias = Number(document.getElementById('dias').value || 0);
      const prefixo = document.getElementById('prefixo').value.trim() || null;
      const payload = {};
      if(dias > 0) payload.diasValidade = dias;
      if(prefixo) payload.prefixo = prefixo;

      try{
        const t = token();
        const auth = t ? { 'Authorization': 'Bearer ' + t } : {};
        const base = "https://mei-robo-prod.onrender.com";
        const steps = [];

        const result = await tryCombos({
          base, auth, payload, maxTries: 12,
          onStep:(s)=>{ steps.push(`${s.step}. ${s.method} ${s.path}`); setOut('Tentativas:\n'+steps.join('\n')); }
        });

        if (!result.ok) throw new Error(result.err);

        const ct = result.res.headers.get('content-type') || '';
        const j = ct.includes('application/json') ? await result.res.json() : { ok:true, detalhe:'Cupom gerado (não-JSON)' };
        setOut({ ok:true, via: result.via, resposta: j });
        await listar();
      }catch(err){
        setOut({ erro:'Falha ao gerar cupom', detalhe: err.message });
      }
    }

    async function listar(){
      setOut('Listando cupons (scan limitado)…');
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = '';
      try{
        const t = token();
        const auth = t ? { 'Authorization': 'Bearer ' + t } : {};
        const base = "https://mei-robo-prod.onrender.com";

        // poucas combinações de listagem
        const candidates = [
          "/licencas/cupons", "/licencas/cupons/", "/cupons", "/cupons/",
          "/api/licencas/cupons", "/api/cupons", "/api/v1/licencas/cupons", "/v1/licencas/cupons"
        ];

        const controller = new AbortController();
        currentScan = { controller, running:true };
        let okRes = null, lastErr = null, tried = 0, steps = [];

        for (const path of candidates){
          if (!currentScan || tried >= 8) break;
          tried++;
          steps.push(`${tried}. GET ${path}`); setOut('Tentativas:\n'+steps.join('\n'));
          try{
            const r = await fetchWithTimeout(base + path, { method:'GET', mode:'cors', headers:{ ...auth } }, 2500, controller.signal);
            if (r.ok){ okRes = r; break; }
            const txt = await r.text().catch(()=>'(sem corpo)');
            lastErr = `GET ${path} -> ${r.status}: ${txt.slice(0,140)}`;
          }catch(e){ lastErr = `GET ${path} -> ${String(e).slice(0,140)}`; }
        }
        currentScan = null;

        if (!okRes) throw new Error(lastErr || 'Sem rota 2xx para listagem.');

        const ct = okRes.headers.get('content-type') || '';
        let arr = [];
        if (ct.includes('application/json')) arr = await okRes.json();
        else {
          const txt = await okRes.text();
          setOut({ aviso:'Resposta de listagem não-JSON', sample: (txt||'').slice(0,160) });
        }

        (arr||[]).forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.codigo||c.code||'-'}</td>
            <td>${c.status||'-'}</td>
            <td>${c.criadoEm||c.createdAt||'-'}</td>
            <td>${c.expiraEm||c.expiresAt||'-'}</td>`;
          tb.appendChild(tr);
        });

        setOut(arr && arr.length ? { ok:true, itens: arr.length } : 'Nenhum cupom cadastrado.');
      }catch(err){
        setOut({ erro:'Falha ao listar cupons', detalhe: err.message });
      }
    }

    // ---- Ferramentas / Diagnóstico (como antes) ----
    function listScriptsSafe(){
      var out = [];
      for (var i=0; i<document.scripts.length; i++) {
        var s = document.scripts[i];
        out.push(s.src ? s.src : '(inline)');
      }
      setOut(out.join('\n'));
      console.log('Scripts:', out);
    }

    async function diagnosticarRotas(){
      try {
        setOut('Diagnosticando rotas…');
        if (typeof firebase === 'undefined') { setOut('Firebase indisponível. Recarregue com Ctrl+F5.'); return; }
        const u = firebase.auth().currentUser;
        if(!u){ setOut('Sem usuário logado. Faça login primeiro.'); return; }
        const tok = await u.getIdToken(true);
        const base = "https://mei-robo-prod.onrender.com";
        async function ping(path, method, body){
          let res;
          try {
            res = await fetch(base + path, {
              method, mode:"cors",
              headers: { "Authorization":"Bearer "+tok, ...(method==="POST"||method==="PUT"||method==="PATCH"?{"Content-Type":"application/json"}:{}) },
              body: (method==="POST"||method==="PUT"||method==="PATCH") ? JSON.stringify(body||{origem:"admin-cupons"}) : undefined
            });
          } catch(e) {
            console.log(method, path, '-> FETCH_ERR', String(e));
            return { path, method, status:'FETCH_ERR', allow:'-', acam:'-', sample:String(e) };
          }
          const allow = res.headers.get('allow') || '-';
          const acam  = res.headers.get('access-control-allow-methods') || '-';
          const ct = res.headers.get('content-type') || '';
          let text;
          try { text = ct.includes('application/json') ? JSON.stringify(await res.json()) : await res.text(); }
          catch(e) { text = '(sem corpo)'; }
          const row = { path, method, status: res.status, allow, acam, sample: (text||'').replace(/\s+/g,' ').slice(0,160) };
          console.log(row);
          return row;
        }

        const rows = [];
        rows.push(await ping("/licencas/gerar-cupom", "POST"));
        rows.push(await ping("/licencas/gerar-cupom", "GET"));
        rows.push(await ping("/licencas/gerar-cupom/", "GET"));
        rows.push(await ping("/licencas/gerar_cupom", "GET"));
        rows.push(await ping("/licencas/gerar_cupom/", "GET"));
        rows.push(await ping("/cupons/gerar", "POST"));
        rows.push(await ping("/cupons/gerar", "GET"));
        rows.push(await ping("/licencas/cupons", "GET"));
        rows.push(await ping("/licencas/cupons/", "GET"));
        rows.push(await ping("/cupons", "GET"));
        rows.push(await ping("/cupons/", "GET"));

        setOut("Resultado da sonda:\n" + rows.map(r => `${r.method} ${r.path} -> ${r.status} | Allow: ${r.allow} | ACAM: ${r.acam} | ${r.sample}…`).join('\n'));
      } catch (err) {
        setOut({ erro: 'Falha no diagnóstico', detalhe: err.message });
      }
    }

    // Bindings
    window.addEventListener('DOMContentLoaded', () => {
      gateApply();
      document.getElementById('saveGate').onclick = () => {
        const v = document.getElementById('toggleAdmin').checked;
        lsSet('isAdmin', v ? 'true' : 'false');
        gateApply();
      };
      document.getElementById('gerar').onclick = gerar;
      document.getElementById('listar').onclick = listar;
      document.getElementById('stopScan').onclick = () => stopScan('botão parar');

      const btn = document.getElementById('refreshToken');
      if(btn) btn.onclick = refreshIdToken;

      const lsBtn = document.getElementById('listScripts');
      if(lsBtn) lsBtn.onclick = listScriptsSafe;

      const dgBtn = document.getElementById('diagnosticar');
      if(dgBtn) dgBtn.onclick = diagnosticarRotas;

      try {
        if (typeof firebase !== 'undefined') {
          firebase.auth().onAuthStateChanged(u => updateAuthUI(u || null));
        } else {
          updateAuthUI(null);
        }
      } catch(e) {
        console.warn('AuthState listener falhou:', e);
        updateAuthUI(null);
      }
    });
  </script>
</body>
</html>
