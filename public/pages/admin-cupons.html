<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>ADMIN — Cupons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Estilos canônicos -->
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" href="data:,">

  <!-- 🔹 Firebase v8 (mesma ordem do login) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- 🔹 Init (DEFAULT com apiKey real) -->
  <script src="/assets/firebase-init.js?v=login6"></script>

  <!-- Patch de rotas: garante que /gerar-cupom e /cupons vão ao backend prod -->
  <script src="/assets/backend-patch.js"></script>

  <!-- Loader de header/footer e demais iniciais do app -->
  <script defer src="/assets/layout.js"></script>
</head>
<body>
  <div id="app-header"></div>

  <main class="container">
    <div class="card">
      <h2>Admin • Cupons</h2>
      <p class="note">Acesso restrito. Somente administrador.</p>

      <!-- 🔎 Painel de status de autenticação (exibição/ação segura) -->
      <div class="card" style="margin-top:12px; background:#0c171d;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="note">UID: <code id="uid">-</code></span>
          <span class="note">Token: <span id="tok">-</span></span>
          <span class="note">Firebase: <code id="fbStatus">-</code></span>
          <button class="btn secondary" id="refreshToken" type="button" title="Força refresh e salva em localStorage.idToken">Atualizar token</button>
          <button class="btn secondary" id="listScripts" type="button" title="Lista scripts carregados">Listar scripts</button>
          <button class="btn secondary" id="diagnosticar" type="button" title="Testa rotas/métodos e mostra status">Diagnosticar rotas</button>
        </div>
      </div>

      <div id="admin-gate" class="card" style="margin-top:12px; background:#0c171d;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>
            <input type="checkbox" id="toggleAdmin" />
            Eu sou administrador (dev)
          </label>
          <button class="btn secondary" id="saveGate" type="button">Aplicar</button>
          <span class="note">Flag salva em <code>localStorage.isAdmin</code></span>
        </div>
      </div>

      <div id="admin-area" style="display:none; margin-top:14px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="gerar" type="button">Gerar cupom</button>
          <button class="btn secondary" id="listar" type="button">Listar cupons</button>
        </div>

        <div class="grid grid-2" style="margin-top:12px">
          <div>
            <label for="dias">Dias de validade (opcional)</label>
            <input id="dias" class="input" type="number" min="1" step="1" placeholder="ex.: 7" />
          </div>
          <div>
            <label for="prefixo">Prefixo (opcional)</label>
            <input id="prefixo" class="input" placeholder="ex.: MEI" />
          </div>
        </div>

        <pre id="out" style="margin-top:12px; white-space:pre-wrap"></pre>

        <h3 style="margin-top:20px">Cupons</h3>
        <table class="table" id="tbl">
          <thead>
            <tr><th>código</th><th>status</th><th>criadoEm</th><th>expiraEm</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="app-footer"></div>

  <script>
    // Acesso "seguro" ao localStorage (alguns navegadores podem bloquear)
    function lsGet(key) { try { return window.localStorage.getItem(key); } catch { return null; } }
    function lsSet(key, val) { try { window.localStorage.setItem(key, val); } catch {} }

    const token = () => lsGet('idToken') || ''; // Enviaremos se existir

    function gateApply(){
      const isAdmin = lsGet('isAdmin') === 'true';
      document.getElementById('toggleAdmin').checked = isAdmin;
      document.getElementById('admin-area').style.display = isAdmin ? '' : 'none';
    }

    function setOut(msg){
      const el = document.getElementById('out');
      if(msg == null || msg === '') { el.textContent = ''; return; }
      if(typeof msg === 'string') el.textContent = msg;
      else {
        try { el.textContent = JSON.stringify(msg, null, 2); }
        catch { el.textContent = String(msg); }
      }
    }

    // 🔎 UI de status de auth
    function updateAuthUI(u){
      const uidEl = document.getElementById('uid');
      const tokEl = document.getElementById('tok');
      const fbEl  = document.getElementById('fbStatus');
      uidEl.textContent = u ? (u.uid || '-') : '-';
      const t = token();
      tokEl.textContent = t ? 'token_ok' : '-';
      fbEl.textContent = (typeof window.firebase !== 'undefined') ? 'ok' : 'indisponível';
    }

    async function refreshIdToken(){
      try{
        if (typeof firebase === 'undefined') { setOut('Firebase indisponível. Recarregue a página (Ctrl+F5).'); updateAuthUI(null); return; }
        const u = firebase.auth().currentUser;
        if(!u){ setOut('Sem usuário logado. Faça login.'); updateAuthUI(null); return; }
        const t = await u.getIdToken(true);
        if(t){ lsSet('idToken', t); }
        updateAuthUI(u);
        setOut('Token atualizado e salvo em localStorage.idToken ✅');
      }catch(err){
        setOut({ erro:'Falha ao atualizar token', detalhe: err.message });
      }
    }

    async function gerar(){
      setOut('Gerando cupom...');
      const dias = Number(document.getElementById('dias').value || 0);
      const prefixo = document.getElementById('prefixo').value.trim() || null;
      const body = {};
      if(dias > 0) body.diasValidade = dias;
      if(prefixo) body.prefixo = prefixo;

      try{
        const headers = { 'Content-Type': 'application/json' };
        const t = token();
        if (t) headers['Authorization'] = 'Bearer ' + t;

        // Caminho relativo: backend-patch.js reescreve -> https://mei-robo-prod.onrender.com/licencas/gerar-cupom
        const r = await fetch('/gerar-cupom', {
          method:'POST',
          headers,
          body: JSON.stringify(body)
        });

        const ct = r.headers.get('content-type') || '';
        if(!r.ok){
          const txt = await r.text().catch(()=>'(sem corpo)');
          throw new Error(`POST /gerar-cupom -> ${r.status}: ${txt.slice(0,200)}`);
        }
        const j = ct.includes('application/json') ? await r.json() : { ok:true, detalhe:'Cupom gerado (não-JSON)' };
        setOut(j);
        await listar();
      }catch(err){
        setOut({ erro:'Falha ao gerar cupom', detalhe: err.message });
      }
    }

    async function listar(){
      setOut('Listando cupons...');
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = '';
      try{
        const headers = {};
        const t = token();
        if (t) headers['Authorization'] = 'Bearer ' + t;

        // Caminho relativo: backend-patch.js reescreve -> https://mei-robo-prod.onrender.com/licencas/cupons (mapeado no patch)
        const r = await fetch('/cupons', { headers });
        const ct = r.headers.get('content-type') || '';
        if(!r.ok){
          const txt = await r.text().catch(()=>'(sem corpo)');
          throw new Error(`GET /cupons -> ${r.status}: ${txt.slice(0,200)}`);
        }
        let arr = [];
        if(ct.includes('application/json')) arr = await r.json();
        else {
          const txt = await r.text();
          setOut('⚠️ Resposta inesperada de /cupons (não-JSON).');
          console.warn('Resposta /cupons:', txt);
        }

        (arr||[]).forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.codigo||c.code||'-'}</td>
            <td>${c.status||'-'}</td>
            <td>${c.criadoEm||c.createdAt||'-'}</td>
            <td>${c.expiraEm||c.expiresAt||'-'}</td>`;
          tb.appendChild(tr);
        });

        if(!arr || arr.length === 0){
          setOut('Nenhum cupom cadastrado.');
        }else{
          setOut('Lista de cupons atualizada ✅');
        }
      }catch(err){
        setOut({ erro:'Falha ao listar cupons', detalhe: err.message });
      }
    }

    // 🔧 util simples p/ listar scripts sem usar spread (...)
    function listScriptsSafe(){
      var out = [];
      for (var i=0; i<document.scripts.length; i++) {
        var s = document.scripts[i];
        out.push(s.src ? s.src : '(inline)');
      }
      setOut(out.join('\n'));
      console.log('Scripts:', out);
    }

    async function diagnosticarRotas(){
      try {
        setOut('Diagnosticando rotas…');
        if (typeof firebase === 'undefined') { setOut('Firebase indisponível. Recarregue com Ctrl+F5.'); return; }
        const u = firebase.auth().currentUser;
        if(!u){ setOut('Sem usuário logado. Faça login primeiro.'); return; }
        const tok = await u.getIdToken(true);
        const base = "https://mei-robo-prod.onrender.com";
        async function ping(path, method, body){
          let res;
          try {
            res = await fetch(base + path, {
              method, mode:"cors",
              headers: { "Authorization":"Bearer "+tok, ...(method==="POST"?{"Content-Type":"application/json"}:{}) },
              body: method==="POST" ? JSON.stringify(body||{origem:"admin-cupons"}) : undefined
            });
          } catch(e) {
            console.log(method, path, '-> FETCH_ERR', String(e));
            return { path, method, status:'FETCH_ERR', allow:'-', text:String(e) };
          }
          const allow = res.headers.get('allow') || '-';
          const ct = res.headers.get('content-type') || '';
          let text;
          try {
            if (ct.includes('application/json')) {
              text = JSON.stringify(await res.json());
            } else {
              text = await res.text();
            }
          } catch(e) { text = '(sem corpo)'; }
          const row = { path, method, status: res.status, allow, sample: (text||'').replace(/\s+/g,' ').slice(0,160) };
          console.log(row);
          return row;
        }

        const rows = [];
        rows.push(await ping("/licencas/gerar-cupom", "POST"));
        rows.push(await ping("/licencas/gerar-cupom", "GET"));
        rows.push(await ping("/cupons/gerar", "POST"));
        rows.push(await ping("/cupons/gerar", "GET"));
        rows.push(await ping("/licencas/cupons", "GET"));
        rows.push(await ping("/cupons", "GET"));

        setOut("Resultado da sonda:\n" + rows.map(r => `${r.method} ${r.path} -> ${r.status} | Allow: ${r.allow} | ${r.sample}…`).join('\n'));
      } catch (err) {
        setOut({ erro: 'Falha no diagnóstico', detalhe: err.message });
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      gateApply();
      document.getElementById('saveGate').onclick = () => {
        const v = document.getElementById('toggleAdmin').checked;
        lsSet('isAdmin', v ? 'true' : 'false');
        gateApply();
      };
      document.getElementById('gerar').onclick = gerar;
      document.getElementById('listar').onclick = listar;

      // Auth UI bindings
      const btn = document.getElementById('refreshToken');
      if(btn) btn.onclick = refreshIdToken;

      const lsBtn = document.getElementById('listScripts');
      if(lsBtn) lsBtn.onclick = listScriptsSafe;

      const dgBtn = document.getElementById('diagnosticar');
      if(dgBtn) dgBtn.onclick = diagnosticarRotas;

      try {
        if (typeof firebase !== 'undefined') {
          firebase.auth().onAuthStateChanged(u => updateAuthUI(u || null));
        } else {
          updateAuthUI(null);
        }
      } catch(e) {
        console.warn('AuthState listener falhou:', e);
        updateAuthUI(null);
      }
    });
  </script>
</body>
</html>
