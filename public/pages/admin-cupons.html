<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>ADMIN — Cupons (diag5)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" href="data:,">
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <!-- Init -->
  <script src="/assets/firebase-init.js?v=login6"></script>
  <!-- Patch de rotas -->
  <script src="/assets/backend-patch.js"></script>
  <!-- Loader de header/footer -->
  <script defer src="/assets/layout.js"></script>
  <!-- DIAG_VERSION=5 -->
</head>
<body>
  <div id="app-header"></div>

  <main class="container">
    <div class="card">
      <h2>Admin • Cupons</h2>
      <p class="note">Acesso restrito. Somente administrador.</p>

      <!-- Badge versão -->
      <div class="note" style="margin:8px 0; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <span><strong>Versão:</strong> diag5</span>
        <span id="adminBadge" class="badge" style="padding:2px 6px;border-radius:6px;background:#1b2a33;">status: <code id="admFlag">desconhecido</code></span>
      </div>

      <!-- Último cupom gerado -->
      <div id="last-coupon" class="note" style="display:none; margin:8px 0;">
        <strong>Último cupom:</strong>
        <code id="last-code"></code>
        <small>(via: <span id="last-via"></span>)</small>
        <button class="btn secondary" id="copyLast" type="button" style="margin-left:8px;">Copiar</button>
      </div>

      <!-- Painel de status -->
      <div class="card" style="margin-top:12px; background:#0c171d;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="note">UID: <code id="uid">-</code></span>
          <span class="note">Token: <span id="tok">-</span></span>
          <span class="note">Firebase: <code id="fbStatus">-</code></span>
          <button class="btn secondary" id="refreshToken" type="button">Atualizar token</button>
          <button class="btn secondary" id="listScripts" type="button">Listar scripts</button>
          <button class="btn secondary" id="diagnosticar" type="button">Diagnosticar rotas</button>
          <button class="btn danger" id="stopScan" type="button" title="Cancela a varredura atual">Parar varredura</button>
        </div>
      </div>

      <!-- Chave “dev” (a UI continua, mas não fura segurança do backend) -->
      <div id="admin-gate" class="card" style="margin-top:12px; background:#0c171d;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>
            <input type="checkbox" id="toggleAdmin" />
            Eu sou administrador (dev)
          </label>
          <button class="btn secondary" id="saveGate" type="button">Aplicar</button>
          <span class="note">Flag salva em <code>localStorage.isAdmin</code> (somente visual)</span>
        </div>
      </div>

      <div id="admin-area" style="display:none; margin-top:14px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <button class="btn" id="gerar" type="button">Gerar cupom</button>
          <button class="btn secondary" id="listar" type="button">Atualizar lista</button>
          <span id="noAdminMsg" class="note" style="display:none;">Você não tem permissão para gerar cupons.</span>
        </div>

        <div class="grid grid-2" style="margin-top:12px">
          <div>
            <label for="dias">Dias de validade (opcional)</label>
            <input id="dias" class="input" type="number" min="1" step="1" placeholder="ex.: 7" />
          </div>
          <div>
            <label for="prefixo">Prefixo (opcional)</label>
            <input id="prefixo" class="input" placeholder="ex.: MEI" />
          </div>
        </div>

        <pre id="out" style="margin-top:12px; white-space:pre-wrap"></pre>

        <table class="table" id="tbl" style="margin-top:8px;">
          <thead>
            <tr><th>código</th><th>status</th><th>criadoEm</th><th>expiraEm</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="app-footer"></div>

  <script>
    const ABS_API = "https://mei-robo-prod.onrender.com";

    function lsGet(key) { try { return window.localStorage.getItem(key); } catch { return null; } }
    function lsSet(key, val) { try { window.localStorage.setItem(key, val); } catch {} }
    const token = () => lsGet('idToken') || '';

    function gateApply(){
      const isAdminGate = lsGet('isAdmin') === 'true';
      document.getElementById('toggleAdmin').checked = isAdminGate;
      // Área visível = gate (dev) ON ou não — deixamos visível para listar/copiar mesmo sem admin
      document.getElementById('admin-area').style.display = '';
    }

    function setOut(msg){
      const el = document.getElementById('out');
      if(msg == null || msg === '') { el.textContent = ''; return; }
      if(typeof msg === 'string') el.textContent = msg;
      else {
        try { el.textContent = JSON.stringify(msg, null, 2); }
        catch { el.textContent = String(msg); }
      }
    }

    function updateAuthUI(u){
      document.getElementById('uid').textContent = u ? (u.uid || '-') : '-';
      document.getElementById('tok').textContent = token() ? 'token_ok' : '-';
      document.getElementById('fbStatus').textContent = (typeof window.firebase !== 'undefined') ? 'ok' : 'indisponível';
    }

    async function refreshIdToken(){
      try{
        if (typeof firebase === 'undefined') { setOut('Firebase indisponível. Recarregue (Ctrl+F5).'); updateAuthUI(null); return; }
        const u = firebase.auth().currentUser;
        if(!u){ setOut('Sem usuário logado. Faça login.'); updateAuthUI(null); return; }
        const t = await u.getIdToken(true);
        if(t){ lsSet('idToken', t); }
        updateAuthUI(u);
        setOut('Token atualizado e salvo em localStorage.idToken ✅');
        await applyWhoamiAdmin(); // reavalia após refresh
      }catch(err){
        setOut({ erro:'Falha ao atualizar token', detalhe: err.message });
      }
    }

    // Badge "último cupom"
    function showLastCoupon(code, via){
      const box = document.getElementById('last-coupon');
      const elCode = document.getElementById('last-code');
      const elVia  = document.getElementById('last-via');
      if (!code) { box.style.display = 'none'; return; }
      elCode.textContent = code;
      elVia.textContent  = via || '-';
      box.style.display  = '';
    }
    function saveLastCoupon(code, via){
      try { lsSet('lastCoupon', JSON.stringify({ code, via, at: Date.now() })); } catch {}
      showLastCoupon(code, via);
    }

    // ===== util: timeout + abort (diagnósticos) =====
    let currentScan = null; // {controller, running}
    function stopScan(reason){
      if (currentScan && currentScan.controller) currentScan.controller.abort();
      currentScan = null;
      if (reason) setOut({ info:'Varredura cancelada', motivo: reason });
    }
    function fetchWithTimeout(url, init, ms, signal){
      const ctrl = new AbortController();
      const timer = setTimeout(()=>ctrl.abort(), ms);
      if (signal) signal.addEventListener('abort', ()=>ctrl.abort(), { once:true });
      const merged = { ...init, signal: ctrl.signal };
      return fetch(url, merged).finally(()=>clearTimeout(timer));
    }

    // ===== Checagem: sou admin? (usa /auth/whoami) =====
    async function isAdminUser(){
      try{
        const t = token();
        if (!t) return false;
        const r = await fetch(ABS_API + "/auth/whoami", {
          method: "GET", mode: "cors",
          headers: { "Authorization": "Bearer " + t }
        });
        if (!r.ok) return false;
        const j = await r.json().catch(()=> ({}));
        if (j === null || typeof j !== "object") return false;
        if (j.admin === true || j.is_admin === true) return true;
        if (j.role === "admin") return true;
        if (Array.isArray(j.roles) && j.roles.includes("admin")) return true;
        if (j.claims && (j.claims.admin === true || j.claims.is_admin === true)) return true;
        return false;
      }catch{ return false; }
    }

    // Aplica estado admin na UI (bloqueia geração p/ não-admin)
    async function applyWhoamiAdmin(){
      const adm = await isAdminUser();
      const gerarBtn = document.getElementById('gerar');
      const noAdminMsg = document.getElementById('noAdminMsg');
      const admFlag = document.getElementById('admFlag');

      if (adm) {
        gerarBtn.disabled = false;
        gerarBtn.title = "Gerar cupom (admin)";
        noAdminMsg.style.display = 'none';
        admFlag.textContent = 'admin';
        document.getElementById('adminBadge').style.background = '#10331b';
      } else {
        gerarBtn.disabled = true;
        gerarBtn.title = "Somente administrador pode gerar cupons";
        noAdminMsg.style.display = '';
        admFlag.textContent = 'não-admin';
        document.getElementById('adminBadge').style.background = '#311b10';
      }
      return adm;
    }

    // ====== GERAR ======
    async function gerar(){
      setOut('Gerando cupom…');

      // Hard stop para não-admin: nem chama backend
      const canAdmin = await isAdminUser();
      if (!canAdmin) {
        setOut({ erro: "Permissão negada", detalhe: "Somente administrador pode gerar cupons." });
        return;
      }

      const dias    = Number(document.getElementById('dias').value || 0);
      const prefixo = (document.getElementById('prefixo').value || '').trim();

      const bodyAdmin = {};
      if (dias > 0) bodyAdmin.diasValidade = dias;
      if (prefixo)  bodyAdmin.prefixo = prefixo;
      bodyAdmin.origem = "admin-cupons";

      const headers = { "Content-Type": "application/json" };
      const t = token();
      if (t) headers["Authorization"] = "Bearer " + t;

      async function postJson(url, body){
        const r = await fetch(url, { method:"POST", mode:"cors", headers, body: JSON.stringify(body) });
        const ct = r.headers.get("content-type") || "";
        const data = ct.includes("application/json") ? await r.json() : (await r.text());
        return { ok: r.ok, status: r.status, statusText: r.statusText, data };
      }

      try{
        // rota oficial de admin (backend também protege)
        let via  = "admin";
        let resp = await postJson(ABS_API + "/admin/cupons", bodyAdmin);

        // fallback defensivo: /gerar-cupom também é admin_required no backend
        if ([404,405].includes(resp.status)) {
          resp = await postJson(ABS_API + "/gerar-cupom", bodyAdmin);
        }

        if (!resp.ok) {
          const resumo = typeof resp.data === 'string' ? resp.data.slice(0,200) : JSON.stringify(resp.data).slice(0,200);
          throw new Error(`Falha ao criar cupom: ${resp.status} ${resp.statusText} — ${resumo}`);
        }

        const cup = resp.data || {};
        const codigo = cup.codigo || cup.code || "(sem código)";
        saveLastCoupon(codigo, via);

        setOut({ ok:true, via, cupom: codigo, resposta: cup });
        await listar();
      } catch(err){
        setOut({ erro: "Falha ao gerar cupom", detalhe: String(err.message || err) });
      }
    }

    // ====== LISTAR (usa /__list) ======
    async function listar(){
      setOut('Listando cupons…');
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = '';
      try{
        const t = token();
        const headers = {};
        if (t) headers["Authorization"] = "Bearer " + t;

        const url  = ABS_API + "/__list?col=cuponsAtivacao&limit=50";
        const r = await fetch(url, { method:"GET", mode:"cors", headers });
        const j = await r.json();

        if (!r.ok || !j.ok) throw new Error((j.error||("status "+r.status)));

        const arr = j.items || [];
        for (const c of arr){
          const status =
            (typeof c.usosMax !== "undefined")
              ? ((c.usos || 0) >= (c.usosMax || 1) ? "usado" : "disponível")
              : (c.ativo === false ? "inativo" : "ativo");

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.codigo ?? c.code ?? "-"}</td>
            <td>${status}</td>
            <td>${c.createdAt ?? c.criadoEm ?? "-"}</td>
            <td>${c.expiraEm ?? c.validUntil ?? "-"}</td>`;
          tb.appendChild(tr);
        }

        setOut({ ok:true, itens: arr.length });
      }catch(err){
        setOut({ erro:'Falha ao listar cupons', detalhe: String(err).slice(0,200) });
      }
    }

    // ---- Ferramentas / Diagnóstico ----
    function listScriptsSafe(){
      const out = [];
      for (let i=0; i<document.scripts.length; i++) {
        const s = document.scripts[i];
        out.push(s.src ? s.src : '(inline)');
      }
      setOut(out.join('\n'));
      console.log('Scripts:', out);
    }

    async function diagnosticarRotas(){
      try {
        setOut('Diagnosticando rotas…');
        if (typeof firebase === 'undefined') { setOut('Firebase indisponível. Recarregue com Ctrl+F5.'); return; }
        const u = firebase.auth().currentUser;
        if(!u){ setOut('Sem usuário logado. Faça login primeiro.'); return; }
        const tok = await u.getIdToken(true);
        const base = ABS_API;

        async function ping(path, method, body){
          let res;
          try {
            const needsJson = (method==="POST" || method==="PUT" || method==="PATCH");
            res = await fetch(base + path, {
              method, mode:"cors",
              headers: { "Authorization":"Bearer "+tok, ...(needsJson?{"Content-Type":"application/json"}:{}) },
              body: needsJson ? JSON.stringify(body||{origem:"admin-cupons"}) : undefined
            });
          } catch(e) {
            console.log(method, path, '-> FETCH_ERR', String(e));
            return { path, method, status:'FETCH_ERR', allow:'-', acam:'-', sample:String(e) };
          }
          const allow = res.headers.get('allow') || '-';
          const acam  = res.headers.get('access-control-allow-methods') || '-';
          const ct = res.headers.get('content-type') || '';
          let text;
          try { text = ct.includes('application/json') ? JSON.stringify(await res.json()) : await res.text(); }
          catch(e) { text = '(sem corpo)'; }
          const row = { path, method, status: res.status, allow, acam, sample: (text||'').replace(/\s+/g,' ').slice(0,160) };
          console.log(row);
          return row;
        }

        const rows = [];
        const adm = await isAdminUser();
        if (adm) {
          rows.push(await ping("/admin/cupons", "POST", {diasValidade:3,prefixo:"MEI"}));
          rows.push(await ping("/gerar-cupom", "POST", {diasValidade:3,prefixo:"MEI"}));
        } else {
          rows.push({ path:"/admin/cupons", method:"POST", status:"(não testado)", allow:"-", acam:"-", sample:"usuário não-admin" });
          rows.push({ path:"/gerar-cupom", method:"POST", status:"(não testado)", allow:"-", acam:"-", sample:"usuário não-admin" });
        }
        rows.push(await ping("/__list?col=cuponsAtivacao&limit=5", "GET"));

        setOut("Resultado da sonda:\n" + rows.map(r => `${r.method} ${r.path} -> ${r.status} | Allow: ${r.allow} | ACAM: ${r.acam} | ${r.sample}…`).join('\n'));
      } catch (err) {
        setOut({ erro: 'Falha no diagnóstico', detalhe: err.message });
      }
    }

    // Bindings
    window.addEventListener('DOMContentLoaded', async () => {
      gateApply();

      document.getElementById('saveGate').onclick = () => {
        const v = document.getElementById('toggleAdmin').checked;
        lsSet('isAdmin', v ? 'true' : 'false');
        gateApply();
      };
      document.getElementById('gerar').onclick = gerar;
      document.getElementById('listar').onclick = listar;
      document.getElementById('stopScan').onclick = () => stopScan('botão parar');

      const btn = document.getElementById('refreshToken');
      if(btn) btn.onclick = refreshIdToken;

      const lsBtn = document.getElementById('listScripts');
      if(lsBtn) lsBtn.onclick = listScriptsSafe;

      const dgBtn = document.getElementById('diagnosticar');
      if(dgBtn) dgBtn.onclick = diagnosticarRotas;

      const btnCopy = document.getElementById('copyLast');
      if (btnCopy) btnCopy.onclick = async () => {
        const code = (document.getElementById('last-code').textContent || '').trim();
        if (!code) return;
        try { await navigator.clipboard.writeText(code); setOut('Código copiado ✔'); }
        catch { setOut('Não foi possível copiar automaticamente.'); }
      };

      // Restaura último cupom salvo (UX)
      try {
        const raw = lsGet('lastCoupon');
        if (raw) {
          const obj = JSON.parse(raw);
          showLastCoupon(obj.code, obj.via);
        }
      } catch {}

      try {
        if (typeof firebase !== 'undefined') {
          firebase.auth().onAuthStateChanged(async u => {
            updateAuthUI(u || null);
            await applyWhoamiAdmin();
          });
        } else {
          updateAuthUI(null);
          await applyWhoamiAdmin();
        }
      } catch(e) {
        console.warn('AuthState listener falhou:', e);
        updateAuthUI(null);
        await applyWhoamiAdmin();
      }

      // Carrega lista ao abrir
      listar();
    });
  </script>
</body>
</html>
