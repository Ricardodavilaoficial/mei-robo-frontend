<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>ADMIN ‚Äî Cupons (diag4)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Estilos can√¥nicos -->
  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" href="data:,">

  <!-- üîπ Firebase v8 (mesma ordem do login) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- üîπ Init (DEFAULT com apiKey real) -->
  <script src="/assets/firebase-init.js?v=login6"></script>

  <!-- Patch de rotas (mantido) -->
  <script src="/assets/backend-patch.js"></script>

  <!-- Loader de header/footer e demais iniciais do app -->
  <script defer src="/assets/layout.js"></script>
  <!-- DIAG_VERSION=4 -->
</head>
<body>
  <div id="app-header"></div>

  <main class="container">
    <div class="card">
      <h2>Admin ‚Ä¢ Cupons</h2>
      <p class="note">Acesso restrito. Somente administrador.</p>

      <!-- üîñ Badge de vers√£o vis√≠vel -->
      <div class="note" style="margin:8px 0;">
        <strong>Vers√£o:</strong> diag4
      </div>

      <!-- üîé Painel de status de autentica√ß√£o -->
      <div class="card" style="margin-top:12px; background:#0c171d;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="note">UID: <code id="uid">-</code></span>
          <span class="note">Token: <span id="tok">-</span></span>
          <span class="note">Firebase: <code id="fbStatus">-</code></span>
          <button class="btn secondary" id="refreshToken" type="button">Atualizar token</button>
          <button class="btn secondary" id="listScripts" type="button">Listar scripts</button>
          <button class="btn secondary" id="diagnosticar" type="button">Diagnosticar rotas</button>
        </div>
      </div>

      <div id="admin-gate" class="card" style="margin-top:12px; background:#0c171d;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>
            <input type="checkbox" id="toggleAdmin" />
            Eu sou administrador (dev)
          </label>
          <button class="btn secondary" id="saveGate" type="button">Aplicar</button>
          <span class="note">Flag salva em <code>localStorage.isAdmin</code></span>
        </div>
      </div>

      <div id="admin-area" style="display:none; margin-top:14px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="gerar" type="button">Gerar cupom</button>
          <button class="btn secondary" id="listar" type="button">Listar cupons</button>
        </div>

        <div class="grid grid-2" style="margin-top:12px">
          <div>
            <label for="dias">Dias de validade (opcional)</label>
            <input id="dias" class="input" type="number" min="1" step="1" placeholder="ex.: 7" />
          </div>
          <div>
            <label for="prefixo">Prefixo (opcional)</label>
            <input id="prefixo" class="input" placeholder="ex.: MEI" />
          </div>
        </div>

        <pre id="out" style="margin-top:12px; white-space:pre-wrap"></pre>

        <h3 style="margin-top:20px">Cupons</h3>
        <table class="table" id="tbl">
          <thead>
            <tr><th>c√≥digo</th><th>status</th><th>criadoEm</th><th>expiraEm</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="app-footer"></div>

  <script>
    // Acesso "seguro" ao localStorage
    function lsGet(key) { try { return window.localStorage.getItem(key); } catch { return null; } }
    function lsSet(key, val) { try { window.localStorage.setItem(key, val); } catch {} }

    const token = () => lsGet('idToken') || '';

    function gateApply(){
      const isAdmin = lsGet('isAdmin') === 'true';
      document.getElementById('toggleAdmin').checked = isAdmin;
      document.getElementById('admin-area').style.display = isAdmin ? '' : 'none';
    }

    function setOut(msg){
      const el = document.getElementById('out');
      if(msg == null || msg === '') { el.textContent = ''; return; }
      if(typeof msg === 'string') el.textContent = msg;
      else {
        try { el.textContent = JSON.stringify(msg, null, 2); }
        catch { el.textContent = String(msg); }
      }
    }

    // üîé UI de status de auth
    function updateAuthUI(u){
      const uidEl = document.getElementById('uid');
      const tokEl = document.getElementById('tok');
      const fbEl  = document.getElementById('fbStatus');
      uidEl.textContent = u ? (u.uid || '-') : '-';
      tokEl.textContent = token() ? 'token_ok' : '-';
      fbEl.textContent = (typeof window.firebase !== 'undefined') ? 'ok' : 'indispon√≠vel';
    }

    async function refreshIdToken(){
      try{
        if (typeof firebase === 'undefined') { setOut('Firebase indispon√≠vel. Recarregue (Ctrl+F5).'); updateAuthUI(null); return; }
        const u = firebase.auth().currentUser;
        if(!u){ setOut('Sem usu√°rio logado. Fa√ßa login.'); updateAuthUI(null); return; }
        const t = await u.getIdToken(true);
        if(t){ lsSet('idToken', t); }
        updateAuthUI(u);
        setOut('Token atualizado e salvo em localStorage.idToken ‚úÖ');
      }catch(err){
        setOut({ erro:'Falha ao atualizar token', detalhe: err.message });
      }
    }

    // =============== FALLBACK INTELIGENTE p/ GERAR (prefixos + m√©todos) ===============
    async function gerar(){
      setOut('Gerando cupom...');
      const dias = Number(document.getElementById('dias').value || 0);
      const prefixo = document.getElementById('prefixo').value.trim() || null;
      const payload = {};
      if(dias > 0) payload.diasValidade = dias;
      if(prefixo) payload.prefixo = prefixo;

      try{
        const t = token();
        const auth = t ? { 'Authorization': 'Bearer ' + t } : {};
        const base = "https://mei-robo-prod.onrender.com";

        const prefixes = ["", "/api", "/v1", "/api/v1"];
        const names = [
          "licencas/gerar-cupom", "licencas/gerar_cupom",
          "licencas/cupom/gerar", "cupons/gerar", "cupom/gerar",
          "coupon/generate"
        ];
        const methods = ["GET","PUT","PATCH","POST"]; // GET primeiro (query), depois PUT/PATCH, por √∫ltimo POST
        const suffixes = ["", "/"];

        let lastErr = null, okRes = null, okMeta = null;

        // tenta combina√ß√µes estruturadas
        outer: for (const pfx of prefixes){
          for (const name of names){
            for (const sfx of suffixes){
              const path = `${pfx}/${name}${sfx}`.replace(/\/\/+/g,'/'); // sem dupla barra
              for (const m of methods){
                try{
                  const headers = { ...auth };
                  let url = base + path;
                  const init = { method: m, mode:'cors', headers };

                  if (m === "GET"){
                    const qs = new URLSearchParams(payload).toString();
                    if (qs) url += (sfx ? "" : "") + "?" + qs;
                  } else {
                    headers['Content-Type'] = 'application/json';
                    init.body = JSON.stringify(payload);
                  }

                  const r = await fetch(url, init);
                  if (r.ok){ okRes = r; okMeta = { method:m, path }; break outer; }
                  const txt = await r.text().catch(()=>'(sem corpo)');
                  lastErr = `${m} ${path} -> ${r.status}: ${txt.slice(0,160)}`;
                }catch(e){
                  lastErr = `${m} ${path} -> ${String(e)}`;
                }
              }
            }
          }
        }

        // fallback gen√©rico: endpoints que usam action=? via GET
        if (!okRes){
          const generics = ["licencas", "cupons", "api/licencas", "api/cupons", "v1/licencas", "api/v1/licencas"];
          for (const g of generics){
            const qs = new URLSearchParams({ action:"gerar-cupom", ...payload }).toString();
            const url = `${base}/${g}?${qs}`.replace(/\/\/+/g,'/');
            try{
              const r = await fetch(url, { method:"GET", mode:"cors", headers:{ ...auth }});
              if (r.ok){ okRes = r; okMeta = { method:"GET", path:`/${g}?${qs}` }; break; }
              const txt = await r.text().catch(()=>'(sem corpo)');
              lastErr = `GET /${g}?‚Ä¶ -> ${r.status}: ${txt.slice(0,160)}`;
            }catch(e){ lastErr = `GET /${g}?‚Ä¶ -> ${String(e)}`; }
          }
        }

        if (!okRes) throw new Error(lastErr || 'Nenhuma rota/m√©todo aceitou a requisi√ß√£o.');

        const ct = okRes.headers.get('content-type') || '';
        const j = ct.includes('application/json') ? await okRes.json() : { ok:true, detalhe:'Cupom gerado (n√£o-JSON)' };
        setOut({ ok:true, via: okMeta, resposta: j });
        await listar();
      }catch(err){
        setOut({ erro:'Falha ao gerar cupom', detalhe: err.message });
      }
    }

    // =============== FALLBACK INTELIGENTE p/ LISTAR (prefixos) ===============
    async function listar(){
      setOut('Listando cupons...');
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = '';
      try{
        const t = token();
        const auth = t ? { 'Authorization': 'Bearer ' + t } : {};
        const base = "https://mei-robo-prod.onrender.com";

        const prefixes = ["", "/api", "/v1", "/api/v1"];
        const names = [
          "licencas/cupons", "cupons", "coupon/list", "cupons/listar"
        ];
        const suffixes = ["", "/"];

        let okRes = null, lastErr = null, okMeta = null;

        outer: for (const pfx of prefixes){
          for (const name of names){
            for (const sfx of suffixes){
              const url = `${base}/${pfx}/${name}${sfx}`.replace(/\/\/+/g,'/');
              try{
                const r = await fetch(url, { method:'GET', mode:'cors', headers: { ...auth } });
                if (r.ok){ okRes = r; okMeta = { path: url.replace(base,'') }; break outer; }
                const txt = await r.text().catch(()=>'(sem corpo)');
                lastErr = `GET ${url.replace(base,'')} -> ${r.status}: ${txt.slice(0,160)}`;
              }catch(e){ lastErr = `GET ${url.replace(base,'')} -> ${String(e)}`; }
            }
          }
        }

        if (!okRes) throw new Error(lastErr || 'Nenhuma rota retornou 200.');

        const ct = okRes.headers.get('content-type') || '';
        let arr = [];
        if (ct.includes('application/json')) arr = await okRes.json();
        else {
          const txt = await okRes.text();
          setOut({ aviso:'Resposta de listagem n√£o-JSON', via: okMeta, sample: (txt||'').slice(0,160) });
        }

        (arr||[]).forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.codigo||c.code||'-'}</td>
            <td>${c.status||'-'}</td>
            <td>${c.criadoEm||c.createdAt||'-'}</td>
            <td>${c.expiraEm||c.expiresAt||'-'}</td>`;
          tb.appendChild(tr);
        });

        if(!arr || arr.length === 0){
          setOut({ info:'Nenhum cupom cadastrado.', via: okMeta });
        }else{
          setOut({ ok:true, via: okMeta, itens: arr.length });
        }
      }catch(err){
        setOut({ erro:'Falha ao listar cupons', detalhe: err.message });
      }
    }

    // ---------- Ferramentas de diagn√≥stico (iguais) ----------
    function listScriptsSafe(){
      var out = [];
      for (var i=0; i<document.scripts.length; i++) {
        var s = document.scripts[i];
        out.push(s.src ? s.src : '(inline)');
      }
      setOut(out.join('\n'));
      console.log('Scripts:', out);
    }

    async function diagnosticarRotas(){
      try {
        setOut('Diagnosticando rotas‚Ä¶');
        if (typeof firebase === 'undefined') { setOut('Firebase indispon√≠vel. Recarregue com Ctrl+F5.'); return; }
        const u = firebase.auth().currentUser;
        if(!u){ setOut('Sem usu√°rio logado. Fa√ßa login primeiro.'); return; }
        const tok = await u.getIdToken(true);
        const base = "https://mei-robo-prod.onrender.com";
        async function ping(path, method, body){
          let res;
          try {
            res = await fetch(base + path, {
              method, mode:"cors",
              headers: { "Authorization":"Bearer "+tok, ...(method==="POST"||method==="PUT"||method==="PATCH"?{"Content-Type":"application/json"}:{}) },
              body: (method==="POST"||method==="PUT"||method==="PATCH") ? JSON.stringify(body||{origem:"admin-cupons"}) : undefined
            });
          } catch(e) {
            console.log(method, path, '-> FETCH_ERR', String(e));
            return { path, method, status:'FETCH_ERR', allow:'-', acam:'-', sample:String(e) };
          }
          const allow = res.headers.get('allow') || '-';
          const acam  = res.headers.get('access-control-allow-methods') || '-';
          const ct = res.headers.get('content-type') || '';
          let text;
          try { text = ct.includes('application/json') ? JSON.stringify(await res.json()) : await res.text(); }
          catch(e) { text = '(sem corpo)'; }
          const row = { path, method, status: res.status, allow, acam, sample: (text||'').replace(/\s+/g,' ').slice(0,160) };
          console.log(row);
          return row;
        }

        const rows = [];
        rows.push(await ping("/licencas/gerar-cupom", "POST"));
        rows.push(await ping("/licencas/gerar-cupom", "GET"));
        rows.push(await ping("/licencas/gerar-cupom/", "GET"));
        rows.push(await ping("/licencas/gerar_cupom", "GET"));
        rows.push(await ping("/licencas/gerar_cupom/", "GET"));
        rows.push(await ping("/cupons/gerar", "POST"));
        rows.push(await ping("/cupons/gerar", "GET"));
        rows.push(await ping("/licencas/cupons", "GET"));
        rows.push(await ping("/licencas/cupons/", "GET"));
        rows.push(await ping("/cupons", "GET"));
        rows.push(await ping("/cupons/", "GET"));

        setOut("Resultado da sonda:\n" + rows.map(r => `${r.method} ${r.path} -> ${r.status} | Allow: ${r.allow} | ACAM: ${r.acam} | ${r.sample}‚Ä¶`).join('\n'));
      } catch (err) {
        setOut({ erro: 'Falha no diagn√≥stico', detalhe: err.message });
      }
    }

    // ---------- Bindings ----------
    window.addEventListener('DOMContentLoaded', () => {
      gateApply();
      document.getElementById('saveGate').onclick = () => {
        const v = document.getElementById('toggleAdmin').checked;
        lsSet('isAdmin', v ? 'true' : 'false');
        gateApply();
      };
      document.getElementById('gerar').onclick = gerar;
      document.getElementById('listar').onclick = listar;

      const btn = document.getElementById('refreshToken');
      if(btn) btn.onclick = refreshIdToken;

      const lsBtn = document.getElementById('listScripts');
      if(lsBtn) lsBtn.onclick = listScriptsSafe;

      const dgBtn = document.getElementById('diagnosticar');
      if(dgBtn) dgBtn.onclick = diagnosticarRotas;

      try {
        if (typeof firebase !== 'undefined') {
          firebase.auth().onAuthStateChanged(u => updateAuthUI(u || null));
        } else {
          updateAuthUI(null);
        }
      } catch(e) {
        console.warn('AuthState listener falhou:', e);
        updateAuthUI(null);
      }
    });
  </script>
</body>
</html>
