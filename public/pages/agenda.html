<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agenda ‚Äî MEI Rob√¥</title>
  
  <!-- Caminhos absolutos can√¥nicos -->
  <link rel="stylesheet" href="/assets/styles.css" />
  
  <style>
    /* ===== Agenda (V1.0) ‚Äî microestilos locais ===== */
    :root{
      --card-bg:#0f1513; /* tema escuro herdado */
      --card-br:#1d2b26;
      --muted:#9fb0aa;
      --soft:#cfe3dc;
    }
    body{background:#0b100e;color:#eaf5f0}
    .app-shell{min-height:82svh}
    .toolbar{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .toolbar .group{display:flex;gap:.5rem;align-items:center}
    .input,select{background:#0e1512;border:1px solid #2a3a34;color:#eaf5f0;border-radius:10px;padding:.6rem .8rem}
    .input::placeholder{color:rgba(234,245,240,.55)}
    .badge{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #b8f3cf;background:#e8fff2;color:#0d7a56;border-radius:999px;padding:3px 10px;font-weight:800;font-size:.8rem;white-space:nowrap}
    .badge.soft{background:transparent;color:var(--soft);border-color:#3b524a}
    .status-chip{border-radius:999px;padding:2px 8px;border:1px solid #284036;font-size:.75rem}
    .status-agendado{background:#103d2b}
    .status-reagendar{background:#3a3110}
    .status-cancelado{background:#3a1510;opacity:.7}
    .status-no_show{background:#2b2b2b}
    .section{border:1px solid var(--card-br);background:var(--card-bg);border-radius:16px;padding:1rem}
    .list{display:flex;flex-direction:column;gap:.6rem}
    .item{display:grid;grid-template-columns:48px 1fr auto;gap:.8rem;align-items:center;border:1px solid #1c2a25;background:#0e1512;border-radius:14px;padding:.7rem}
    .avatar{width:48px;height:48px;border-radius:12px;background:#0b3326;border:1px solid #114733;display:flex;align-items:center;justify-content:center;font-weight:900}
    .meta{color:var(--muted);font-size:.86rem}
    .actions{display:flex;gap:.35rem}
    .btn{border:1px solid #2a3a34;background:#0f1513;border-radius:10px;padding:.45rem .7rem;color:#eaf5f0;font-weight:700}
    .btn:hover{background:#13201b}
    .btn.primary{background:#0d7a56;border-color:#0d7a56}
    .btn.warn{border-color:#5a3f11;background:#3a2a0f}
    .btn.danger{border-color:#6a1c17;background:#3a1510}
    .btn.ghost{background:transparent}
    .fab{position:fixed;right:16px;bottom:16px;border-radius:999px;padding:1rem 1.1rem;font-size:1rem;box-shadow:0 10px 28px rgba(0,0,0,.4)}
    .grid{display:grid;gap:.8rem}
    @media(min-width:768px){
      .grid{grid-template-columns:1fr 320px}
    }
    .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem}
    .kpis{display:flex;gap:.5rem;flex-wrap:wrap}
    .kpis .k{border:1px solid var(--card-br);background:var(--card-bg);border-radius:12px;padding:.6rem .8rem}
    .k .n{font-size:1.1rem;font-weight:900}
    .empty{border:1px dashed #3b524a;border-radius:16px;padding:1.2rem;color:var(--muted);text-align:center}
    .muted{color:var(--muted)}
    .tiny{font-size:.78rem}
    .divider{height:1px;background:#1c2a25;margin:.8rem 0}
    dialog{border:1px solid var(--card-br);background:var(--card-bg);border-radius:16px;color:#eaf5f0;padding:0;max-width:520px;width:92vw}
    dialog .hd{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--card-br);padding:.9rem 1rem}
    dialog .bd{padding:1rem}
    dialog .ft{display:flex;gap:.5rem;justify-content:flex-end;border-top:1px solid var(--card-br);padding:.9rem 1rem}
    .row{display:flex;gap:.6rem;flex-wrap:wrap}
    .row>.col{flex:1 1 160px}
    .note{border:1px dashed #3b524a;border-radius:12px;padding:.6rem .7rem}
    .switch{display:inline-flex;align-items:center;gap:.5rem}
    .switch input{accent-color:#0d7a56}
  </style>
</head>
<body class="app-shell">
  <!-- Loader + Header/Footer can√¥nicos via /assets/layout.js (com fallback) -->
  <div id="app-header"></div>
  <main class="app-main container" style="padding:16px 14px 92px">

    <!-- Barra topo / contexto -->
    <div class="section" style="margin-bottom:.8rem">
      <div class="toolbar">
        <span class="badge" id="validateBadge" hidden>üîí Modo valida√ß√£o ativo</span>
        <span class="badge soft">Agenda ¬∑ V1.0</span>
        <div class="group tiny muted" id="tzInfo">Brasil (America/Sao_Paulo)</div>
      </div>
      <div class="divider"></div>
      <div class="toolbar" style="justify-content:space-between">
        <div class="group" style="flex:1 1 auto">
          <input class="input" id="q" placeholder="Buscar por cliente/servi√ßo‚Ä¶" style="width:100%"/>
        </div>
        <div class="group">
          <select id="fStatus" class="input" title="Filtrar status">
            <option value="">Todos</option>
            <option value="agendado">Agendado</option>
            <option value="reagendar">Reagendar</option>
            <option value="cancelado">Cancelado</option>
            <option value="no_show">No‚Äëshow</option>
          </select>
        </div>
        <div class="group">
          <select id="fRange" class="input" title="Per√≠odo">
            <option value="hoje">Hoje</option>
            <option value="amanha">Amanh√£</option>
            <option value="7d" selected>Pr√≥x. 7 dias</option>
          </select>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Lista -->
      <section class="section">
        <div class="section-title">
          <h2 style="font-weight:900">Pr√≥ximos compromissos</h2>
          <div class="kpis">
            <div class="k tiny"><div class="n" id="kAg">0</div><div>Agendado</div></div>
            <div class="k tiny"><div class="n" id="kRg">0</div><div>Reagendar</div></div>
            <div class="k tiny"><div class="n" id="kNs">0</div><div>No‚Äëshow</div></div>
          </div>
        </div>
        <div id="list" class="list"></div>
        <div id="empty" class="empty" hidden>Nenhum agendamento no per√≠odo selecionado.</div>
      </section>

      <!-- Lateral: Regras simples / Prefer√™ncias -->
      <aside class="section" aria-label="Prefer√™ncias da agenda">
        <h3 style="font-weight:900;margin-bottom:.6rem">Regras simples</h3>
        <div class="tiny muted" style="margin-bottom:.8rem">Hor√°rio de atendimento padr√£o: 08:00‚Äì19:00, intervalo de 30 min. Timezone: America/Sao_Paulo.</div>
        <div class="row" style="margin-bottom:.8rem">
          <label class="switch tiny"><input type="checkbox" id="prefOverlap"/> Permitir encaixe imediato (¬±5 min)</label>
          <label class="switch tiny"><input type="checkbox" id="prefSms"/> Enviar lembrete (WhatsApp) 2h antes</label>
        </div>
        <div class="note tiny">Dica: voc√™ pode reagendar r√°pido pela lista, sem abrir o item. Em mensagens sens√≠veis (pre√ßo/prazo/instru√ß√µes), priorizamos resposta em <b>texto</b> para ficar claro.</div>
      </aside>
    </div>

    <!-- FAB: Novo -->
    <button id="fabNew" class="btn primary fab">Ôºã Novo agendamento</button>

    <!-- Modal: Novo / Editar -->
    <dialog id="dlg">
      <div class="hd"><strong id="dlgTitle">Novo agendamento</strong><button class="btn ghost" id="dlgClose">‚úï</button></div>
      <div class="bd">
        <div class="row">
          <div class="col"><label class="tiny muted">Cliente</label><input id="fCliente" class="input" placeholder="Ex.: Carlos"/></div>
          <div class="col"><label class="tiny muted">Servi√ßo/nota</label><input id="fServico" class="input" placeholder="Ex.: Corte infantil"/></div>
        </div>
        <div class="row">
          <div class="col"><label class="tiny muted">Data</label><input id="fData" type="date" class="input"/></div>
          <div class="col"><label class="tiny muted">Hora</label><input id="fHora" type="time" class="input" step="900"/></div>
          <div class="col"><label class="tiny muted">Status</label>
            <select id="fStatusEdit" class="input">
              <option value="agendado" selected>Agendado</option>
              <option value="reagendar">Reagendar</option>
              <option value="cancelado">Cancelado</option>
              <option value="no_show">No‚Äëshow</option>
            </select>
          </div>
        </div>
        <div style="margin-top:.6rem">
          <label class="tiny muted">Observa√ß√µes</label>
          <textarea id="fObs" class="input" rows="3" placeholder="Campo livre (opcional)"></textarea>
        </div>
        <div class="note tiny" style="margin-top:.6rem">Exemplo de entendimento por IA: ‚ÄúOl√° Jo√£o, aqui √© o Pedro. Quero agendar um corte de cabelo para meu filho Carlos, de 12 anos.‚Äù ‚ü∂ Servi√ßo: <b>Corte infantil</b>; Cliente: <b>Carlos</b>; Idade: <b>12</b>.</div>
      </div>
      <div class="ft">
        <button class="btn ghost" id="btnExcluir" hidden>Excluir</button>
        <button class="btn" id="btnSalvar">Salvar</button>
      </div>
    </dialog>

  </main>
  <div id="app-footer"></div>

  <!-- Scripts can√¥nicos -->
  <script src="/assets/layout.js" defer></script>
  <script src="/assets/firebase-init.js" defer></script>
  <script src="/assets/backend-patch.js" defer></script>

  <script>
  ;(() => {
    const qs = new URLSearchParams(location.search)
    const validate = qs.get('validate') === '1'
    const validateBadge = document.getElementById('validateBadge')
    const fabNew = document.getElementById('fabNew')
    const listEl = document.getElementById('list')
    const emptyEl = document.getElementById('empty')
    const kAg = document.getElementById('kAg'), kRg = document.getElementById('kRg'), kNs = document.getElementById('kNs')

    // Filtros
    const q = document.getElementById('q')
    const fStatus = document.getElementById('fStatus')
    const fRange = document.getElementById('fRange')

    // Modal
    const dlg = document.getElementById('dlg')
    const dlgTitle = document.getElementById('dlgTitle')
    const dlgClose = document.getElementById('dlgClose')
    const fCliente = document.getElementById('fCliente')
    const fServico = document.getElementById('fServico')
    const fData = document.getElementById('fData')
    const fHora = document.getElementById('fHora')
    const fStatusEdit = document.getElementById('fStatusEdit')
    const fObs = document.getElementById('fObs')
    const btnSalvar = document.getElementById('btnSalvar')
    const btnExcluir = document.getElementById('btnExcluir')

    // Estado
    let current = null // item sendo editado
    let items = []     // itens carregados

    // Modo valida√ß√£o
    if (validate) {
      validateBadge.hidden = false
      fabNew.title = 'Modo valida√ß√£o ativo ‚Äî sem gravar em produ√ß√£o'
    }

    // Helpers
    const tz = 'America/Sao_Paulo'
    const toDateInput = (d) => new Date(d).toISOString().slice(0,10)
    const toTimeInput = (d) => new Date(d).toTimeString().slice(0,5)

    const fmtHour = (d) => new Intl.DateTimeFormat('pt-BR', { hour:'2-digit', minute:'2-digit', timeZone: tz }).format(d)
    const fmtDayLabel = (d) => {
      const now = new Date(); const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
      const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate())
      const diff = Math.round((dd - today)/86400000)
      if (diff === 0) return 'Hoje'
      if (diff === 1) return 'Amanh√£'
      if (diff < 7 && diff > 1) return d.toLocaleDateString('pt-BR', { weekday:'long' })
      return d.toLocaleDateString('pt-BR')
    }

    const statusClass = (s) => ({
      agendado:'status-agendado', reagendar:'status-reagendar', cancelado:'status-cancelado', 'no_show':'status-no_show'
    })[s] || ''

    function render(){
      // Filtros
      const term = q.value.trim().toLowerCase()
      const st = fStatus.value
      const now = new Date()
      let min = new Date(now)
      let max = new Date(now)
      if (fRange.value === 'hoje') { min.setHours(0,0,0,0); max.setHours(23,59,59,999) }
      else if (fRange.value === 'amanha') { const t = new Date(now); t.setDate(t.getDate()+1); min = new Date(t.setHours(0,0,0,0)); max = new Date(t.setHours(23,59,59,999)) }
      else { max.setDate(max.getDate()+7) }

      const filtered = items.filter(x => {
        const t = new Date(x.when)
        const inRange = t >= min && t <= max
        const txt = (x.cliente+' '+(x.servico||'')).toLowerCase()
        const byTerm = term ? txt.includes(term) : true
        const byStatus = st ? x.status === st : true
        return inRange && byTerm && byStatus
      }).sort((a,b)=> new Date(a.when) - new Date(b.when))

      // KPIs
      kAg.textContent = filtered.filter(i=>i.status==='agendado').length
      kRg.textContent = filtered.filter(i=>i.status==='reagendar').length
      kNs.textContent = filtered.filter(i=>i.status==='no_show').length

      listEl.innerHTML = ''
      if (!filtered.length){ emptyEl.hidden = false; return } else { emptyEl.hidden = true }

      let lastLabel = ''
      for (const it of filtered){
        const d = new Date(it.when)
        const dayLabel = fmtDayLabel(d)
        if (dayLabel !== lastLabel){
          const h = document.createElement('div')
          h.className = 'tiny muted'
          h.style.margin = '.5rem 0 .1rem'
          h.textContent = dayLabel
          listEl.appendChild(h)
          lastLabel = dayLabel
        }
        const el = document.createElement('div')
        el.className = 'item'
        el.innerHTML = `
          <div class="avatar">${(it.cliente||'?').slice(0,2).toUpperCase()}</div>
          <div>
            <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
              <strong>${it.cliente||'‚Äî'}</strong>
              <span class="meta">${fmtHour(d)}</span>
              <span class="status-chip ${statusClass(it.status)} tiny">${(it.status||'agendado').replace('_','-')}</span>
            </div>
            <div class="meta">${it.servico||'‚Äî'}${it.obs? ' ¬∑ '+it.obs: ''}</div>
          </div>
          <div class="actions">
            <button class="btn warn tiny" data-act="reagendar">Reagendar</button>
            <button class="btn danger tiny" data-act="cancelar">Cancelar</button>
            <button class="btn tiny" data-act="no_show">No‚Äëshow</button>
            <button class="btn tiny" data-act="editar">Editar</button>
          </div>`
        el.querySelectorAll('button').forEach(b=>{
          b.addEventListener('click',()=>handleAction(it,b.dataset.act))
          if (validate) b.title = 'Modo valida√ß√£o (somente visual)'
        })
        listEl.appendChild(el)
      }
    }

    function handleAction(item, act){
      if (validate){
        toast('üîí Modo valida√ß√£o: a√ß√£o simulada '+act)
        if (act==='editar') openModal(item)
        return
      }
      if (act==='editar') return openModal(item)
      if (act==='reagendar'){ item.status='reagendar'; saveItem(item,true) }
      if (act==='cancelar'){ item.status='cancelado'; saveItem(item,true) }
      if (act==='no_show'){ item.status='no_show'; saveItem(item,true) }
    }

    function openModal(item){
      current = item||null
      dlgTitle.textContent = item? 'Editar agendamento' : 'Novo agendamento'
      btnExcluir.hidden = !item
      fCliente.value = item?.cliente||''
      fServico.value = item?.servico||''
      const d = item? new Date(item.when) : new Date()
      fData.value = toDateInput(d)
      fHora.value = toTimeInput(d)
      fStatusEdit.value = item?.status||'agendado'
      fObs.value = item?.obs||''
      dlg.showModal()
    }

    dlgClose.addEventListener('click', ()=> dlg.close())
    fabNew.addEventListener('click', ()=> openModal(null))

    btnSalvar.addEventListener('click', ()=>{
      if (validate){ toast('üîí Modo valida√ß√£o: nada ser√° gravado.'); return }
      const when = new Date(fData.value + 'T' + fHora.value + ':00')
      const payload = {
        cliente: fCliente.value.trim(),
        servico: fServico.value.trim(),
        status: fStatusEdit.value,
        obs: fObs.value.trim()||null,
        when: when.toISOString(),
        atualizadoEm: new Date().toISOString(),
      }
      if (!payload.cliente || !fData.value || !fHora.value){ toast('Preencha cliente, data e hora.'); return }
      if (current){
        Object.assign(current, payload)
        saveItem(current,false)
      } else {
        payload.criadoEm = new Date().toISOString()
        saveItem(payload,false)
      }
      dlg.close()
    })

    btnExcluir.addEventListener('click', ()=>{
      if (validate){ toast('üîí Modo valida√ß√£o: exclus√£o simulada.'); return }
      if (!current) return
      deleteItem(current)
      dlg.close()
    })

    q.addEventListener('input', render)
    fStatus.addEventListener('change', render)
    fRange.addEventListener('change', render)

    // ====== Data layer ======
    // Produ√ß√£o: busca em Firestore (profissionais/{uid}/agendamentos)
    // Campos: {cliente, servico, when(ISO), status, obs, criadoEm, atualizadoEm}
    async function load(){
      if (validate){
        items = demoItems()
        render(); return
      }
      try{
        // Requer firebase j√° inicializado por /assets/firebase-init.js
        const auth = window.firebase?.auth?.()
        const db = window.firebase?.firestore?.()
        const uid = auth?.currentUser?.uid
        if (!uid){ items = []; render(); toast('Fa√ßa login para ver a agenda.'); return }
        const start = new Date();
        const end = new Date(); end.setDate(end.getDate()+7)
        const snap = await db.collection('profissionais').doc(uid).collection('agendamentos')
          .where('when', '>=', start.toISOString())
          .where('when', '<=', end.toISOString())
          .get()
        items = snap.docs.map(d=> ({ id:d.id, ...d.data() }))
        render()
      }catch(e){ console.error(e); toast('Falha ao carregar agenda.') }
    }

    async function saveItem(item, silent){
      try{
        const auth = window.firebase?.auth?.()
        const db = window.firebase?.firestore?.()
        const uid = auth?.currentUser?.uid
        if (!uid) return toast('Sess√£o expirada. Fa√ßa login.')
        if (item.id){
          await db.collection('profissionais').doc(uid).collection('agendamentos').doc(item.id).set(item, { merge:true })
        } else {
          const ref = await db.collection('profissionais').doc(uid).collection('agendamentos').add(item)
          item.id = ref.id
        }
        if (!silent) toast('Agendamento salvo.')
        await load()
      }catch(e){ console.error(e); toast('Erro ao salvar.') }
    }

    async function deleteItem(item){
      try{
        const auth = window.firebase?.auth?.()
        const db = window.firebase?.firestore?.()
        const uid = auth?.currentUser?.uid
        if (!uid) return toast('Sess√£o expirada. Fa√ßa login.')
        if (!item.id) return
        await db.collection('profissionais').doc(uid).collection('agendamentos').doc(item.id).delete()
        toast('Agendamento exclu√≠do.')
        await load()
      }catch(e){ console.error(e); toast('Erro ao excluir.') }
    }

    // ====== Demo (validate=1) ======
    function demoItems(){
      const base = new Date();
      const d1 = new Date(base); d1.setHours(10,0,0,0)
      const d2 = new Date(base); d2.setDate(d2.getDate()+1); d2.setHours(14,30,0,0)
      const d3 = new Date(base); d3.setDate(d3.getDate()+2); d3.setHours(9,30,0,0)
      return [
        {id:'d1', cliente:'Carlos', servico:'Corte infantil', when:d1.toISOString(), status:'agendado', obs:'12 anos', criadoEm:new Date().toISOString(), atualizadoEm:new Date().toISOString()},
        {id:'d2', cliente:'Ana Paula', servico:'Colora√ß√£o', when:d2.toISOString(), status:'reagendar', obs:null, criadoEm:new Date().toISOString(), atualizadoEm:new Date().toISOString()},
        {id:'d3', cliente:'Rafael', servico:'Barba', when:d3.toISOString(), status:'no_show', obs:'Avisou atraso', criadoEm:new Date().toISOString(), atualizadoEm:new Date().toISOString()},
      ]
    }

    // Toast m√≠nimo
    function toast(msg){
      let t = document.getElementById('__toast');
      if (!t){ t = document.createElement('div'); t.id='__toast'; document.body.appendChild(t);
        t.style.position='fixed'; t.style.left='50%'; t.style.bottom='20px'; t.style.transform='translateX(-50%)'; t.style.background='#0d7a56'; t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.fontWeight='800'; t.style.zIndex='9999'; }
      t.textContent = msg; t.style.opacity='1';
      setTimeout(()=>{ t.style.transition='opacity .3s'; t.style.opacity='0' }, 1500)
    }

    // Start
    document.addEventListener('DOMContentLoaded', load)
  })()
  </script>
</body>
</html>
