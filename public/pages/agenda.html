<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agenda — MEI Robô (V1.5 FINAL)</title>

  <!-- Assets (cache-bust final) -->
  <link rel="stylesheet" href="/assets/styles.css?v=20250909h" />

  <style>
    /* ===========================
       Agenda V1.5 FINAL — base UI
       Elegante, simétrica, sóbria
       =========================== */

    :root{
      --card-bg:#0f1513;
      --card-br:#1d2b26;
      --muted:#9fb0aa;
      --soft:#cfe3dc;
      --accent:#0d7a56;
      --ink:#eaf5f0;
      --line:#22352e;
      --panel:#0e1512;
      --pill:#2a3a34;
      --green:#0d7a56;
    }

    /* Página */
    body{ background:#0b100e; color:var(--ink); margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .app-shell{ min-height:82svh; }
    .container{ width:100%; max-width:1200px; margin:0 auto; }

    /* Componentes base */
    .section{ border:1px solid var(--card-br); background:var(--card-bg); border-radius:16px; padding:1rem; }
    .tiny{ font-size:.78rem; }
    .muted{ color:var(--muted); }
    .btn{
      border:1px solid var(--pill);
      background:var(--card-bg);
      border-radius:10px;
      padding:.55rem .85rem;
      color:var(--ink);
      font-weight:700;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .02s ease;
    }
    .btn:hover{ background:#13201b; }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:var(--accent); border-color:var(--accent); }
    .btn.ghost{ background:transparent; }
    .btn.tab.active{ background:var(--green); border-color:var(--green); color:#042b1b; }

    .input, select, textarea{
      background:var(--panel);
      border:1px solid var(--pill);
      color:var(--ink);
      border-radius:10px;
      padding:.6rem .8rem;
      width:100%;
      box-sizing:border-box;
    }
    .input::placeholder{ color:rgba(234,245,240,.55); }

    /* HERO (mini-dashboard) */
    .hero{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    .hero .grow{ flex:1 1 auto; }
    .kpis{ display:flex; gap:.8rem; flex-wrap:wrap; }
    .k .n{ font-weight:900; font-size:1.05rem; }
    #periodMeta{ margin-top:.4rem; }

    /* Layout principal (ordem visual) */
    .daybook{ display:flex; flex-direction:column; gap:1rem; margin-top:.8rem; }

    /* Páginas “Hoje” / “Amanhã” */
    .page{ border:1px solid #1c2a25; background:var(--panel); border-radius:14px; padding:.9rem; }
    .page .hd{ display:flex; align-items:center; justify-content:space-between; margin-bottom:.6rem; gap:.6rem; flex-wrap:wrap; }

    /* Chips */
    .chips{ display:flex; gap:.4rem; flex-wrap:wrap; }
    .chip{ border:1px solid var(--pill); background:#0f1a16; border-radius:999px; padding:.25rem .6rem; font-size:.78rem; cursor:pointer; }
    .chip.active{ background:var(--green); border-color:var(--green); color:#042b1b; }
    .chip.service{ border-style:dashed; }

    /* Grade do caderno (HH:MM + conteúdo) */
    .grid{ display:grid; grid-template-columns:88px 1fr; gap:.6rem; }

    /* ===========================
       Slots com ALTURA ÚNICA
       (livre e ocupado iguais)
       =========================== */
    .slot{
      display:flex;
      gap:.6rem;
      align-items:center;
      border:1px solid var(--line);
      border-radius:10px;
      padding:.5rem .7rem;
      min-height:44px;      /* altura única */
      max-height:44px;      /* evita variação */
      background:transparent;
      overflow:hidden;
    }
    .slot.busy{ background:#11241d; border-style:solid; }
    .slot.free{ background:transparent; border-style:dashed; }

    .slot .h{
      font-weight:900;
      width:80px; flex:0 0 80px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .slot .txt{
      flex:1; line-height:1.35;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* Semana (resumo) — mesma largura; lista só agendados */
    .week{ display:grid; gap:.6rem; }
    @media(min-width:900px){ .week{ grid-template-columns:repeat(7,1fr) } }
    @media(max-width:899px){ .week{ grid-template-columns:repeat(2,1fr) } }
    .day{ border:1px solid #1c2a25; background:var(--panel); border-radius:14px; padding:.6rem; }
    .day.hoy{ outline:2px solid var(--accent); }
    .day .hd{ display:flex; align-items:center; justify-content:space-between; margin-bottom:.4rem; }
    .pill{ display:inline-block; border:1px solid var(--pill); border-radius:999px; padding:.15rem .5rem; font-size:.72rem; }
    .mini-slot{
      display:flex; justify-content:space-between;
      border:1px solid var(--line);
      border-radius:10px;
      padding:.45rem .55rem;
      min-height:40px; max-height:40px;
      background:#10231c;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      margin:.35rem 0;
    }

    /* Lista do dia */
    .list{ display:flex; flex-direction:column; gap:.6rem; }
    .item{ display:grid; grid-template-columns:44px 1fr auto; gap:.8rem; align-items:center; border:1px solid #1c2a25; background:var(--panel); border-radius:14px; padding:.7rem; }
    .avatar{ width:44px; height:44px; border-radius:12px; background:#0b3326; border:1px solid #114733; display:flex; align-items:center; justify-content:center; font-weight:900; }
    .meta{ color:var(--muted); font-size:.86rem; }

    /* Status chip */
    .status{ border-radius:999px; padding:2px 8px; border:1px solid #284036; font-size:.75rem; }
    .s-ag{ background:#103d2b; }
    .s-rg{ background:#3a3110; }
    .s-cl{ background:#3a1510; opacity:.85; }
    .s-ns{ background:#2b2b2b; }

    /* Modais */
    dialog{ border:1px solid var(--card-br); background:var(--card-bg); border-radius:16px; color:var(--ink); padding:0; max-width:760px; width:95vw; }
    dialog .hd{ display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--card-br); padding:.9rem 1rem; }
    dialog .bd{ padding:1rem; }
    dialog .ft{ display:flex; gap:.5rem; justify-content:flex-end; border-top:1px solid var(--card-br); padding:.9rem 1rem; }

    /* FAB (mobile) */
    .fab{ position:fixed; right:16px; bottom:16px; border-radius:999px; padding:1rem 1.1rem; font-size:1rem; box-shadow:0 10px 28px rgba(0,0,0,.4); }

    /* Rodapé: busca rápida */
    .footer-search{ display:flex; gap:.6rem; flex-wrap:wrap; margin-top:.8rem; }
    .footer-search .grow{ flex:1 1 220px; }

    /* Estados */
    .state{ border:1px dashed #2b3b33; border-radius:12px; padding:12px; color:var(--muted); background:#0f1a16; }
  </style>
</head>
<body class="app-shell">
  <div id="app-header"></div>

  <main class="app-main container" style="padding:16px 14px 120px">
    <!-- HERO (mini-dashboard) -->
    <section class="section" style="margin-bottom:.8rem">
      <div class="hero" id="heroBar">
        <div class="kpis">
          <div class="k tiny"><div class="n" id="kHoje">0</div><div>Hoje</div></div>
          <div class="k tiny"><div class="n" id="kAmanha">0</div><div>Amanhã</div></div>
          <div class="k tiny"><div class="n" id="k7d">0</div><div>Próx. 7 dias</div></div>
        </div>
        <div class="grow"></div>
        <div class="controls" style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">
          <button id="btnHoje" class="btn tab">Hoje</button>
          <button id="btnAmanha" class="btn tab tiny">Amanhã</button>
          <button id="btnSemana" class="btn tab tiny">Próx. 7 dias</button>
          <input id="dtCustom" type="date" class="input" title="Escolher data" />
          <button id="btnNovo" class="btn primary">＋ Novo agendamento</button>
        </div>
      </div>
      <div class="tiny muted" id="periodMeta">Exibindo: 08:00–19:00 · Intervalo 30 min · Fuso America/Sao_Paulo</div>
    </section>

    <!-- CADERNO: Hoje + Amanhã (sempre todos horários visíveis) -->
    <section class="daybook">
      <div class="page" id="pageHoje">
        <div class="hd">
          <span class="nm"><strong>Hoje</strong> <span class="tiny muted" id="lblHojeDate"></span> · <span class="tiny muted">08:00–19:00 · a cada 30 min</span></span>
          <div class="chips" data-scope="today">
            <span class="chip active" data-filter="all">Todos</span>
            <span class="chip" data-filter="busy">Marcados</span>
            <span class="chip" data-filter="free">Livres</span>
            <span class="chip service" data-filter="service">Serviço…</span>
          </div>
        </div>
        <div class="grid" id="gridHoje" aria-label="Caderno do dia — Hoje"></div>
      </div>

      <div class="page" id="pageAmanha">
        <div class="hd">
          <span class="nm"><strong>Amanhã</strong> <span class="tiny muted" id="lblAmanhaDate"></span> · <span class="tiny muted">08:00–19:00 · a cada 30 min</span></span>
          <div class="chips" data-scope="tomorrow">
            <span class="chip active" data-filter="all">Todos</span>
            <span class="chip" data-filter="busy">Marcados</span>
            <span class="chip" data-filter="free">Livres</span>
            <span class="chip service" data-filter="service">Serviço…</span>
          </div>
        </div>
        <div class="grid" id="gridAmanha" aria-label="Caderno do dia — Amanhã"></div>
      </div>
    </section>

    <!-- SEMANA (resumo: todos os horários de cada dia, ocupados ou livres) -->
    <section class="section" style="margin-top:1rem">
      <h2 id="weekTitle" style="font-weight:900;margin-bottom:.6rem">Semana: —</h2>
      <div class="week" id="week"></div>
    </section>

    <!-- LISTA DETALHADA DO DIA (filtrada) -->
    <section class="section" style="margin-top:.8rem">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap">
        <h3 id="dayTitle" style="font-weight:900;margin:0">Hoje</h3>
        <div>
          <button id="btnFiltros" class="btn ghost tiny">Filtrar</button>
          <button id="btnBuscar" class="btn ghost tiny">Buscar</button>
        </div>
      </div>
      <div id="list" class="list"></div>
      <div id="empty" class="state tiny" hidden>Sem horários por aqui.</div>
    </section>

    <!-- RODAPÉ: Busca rápida -->
    <section class="section" style="margin-top:.8rem">
      <h3 style="font-weight:900;margin-bottom:.4rem">Busca rápida</h3>
      <div class="footer-search">
        <input id="qFooter" class="input grow" placeholder="Busque por cliente ou serviço" />
        <input id="qDate" type="date" class="input" title="Buscar por data" />
        <select id="sStatusFooter" class="input">
          <option value="">Todas as situações</option>
          <option value="agendado">Marcado</option>
          <option value="reagendar">Reagendar</option>
          <option value="cancelado">Cancelado</option>
          <option value="no_show">Não compareceu</option>
        </select>
        <button id="btnApplyFooter" class="btn">Aplicar</button>
      </div>
    </section>

    <!-- MODAIS -->
    <dialog id="dlgBusca">
      <div class="hd"><strong>Buscar</strong><button class="btn ghost" id="bClose">✕</button></div>
      <div class="bd"><input id="q" class="input" placeholder="Busque por cliente ou serviço"/></div>
      <div class="ft"><button class="btn" id="bApply">Aplicar</button></div>
    </dialog>

    <dialog id="dlgFiltros">
      <div class="hd"><strong>Filtros</strong><button class="btn ghost" id="fClose">✕</button></div>
      <div class="bd">
        <div style="display:flex;gap:.6rem;flex-wrap:wrap">
          <div style="flex:1 1 160px">
            <label class="tiny muted">Situação</label>
            <select id="fStatus" class="input">
              <option value="">Todas</option>
              <option value="agendado">Marcado</option>
              <option value="reagendar">Reagendar</option>
              <option value="cancelado">Cancelado</option>
              <option value="no_show">Não compareceu</option>
            </select>
          </div>
          <div style="flex:1 1 160px">
            <label class="tiny muted">Período</label>
            <select id="fRange" class="input">
              <option value="dia">Dia selecionado</option>
              <option value="3d">Próx. 3 dias</option>
              <option value="7d" selected>Próx. 7 dias</option>
            </select>
          </div>
        </div>
        <div class="tiny muted" style="margin-top:.6rem">Fuso: America/Sao_Paulo · 08:00–19:00 · Intervalo 30 min</div>
      </div>
      <div class="ft"><button class="btn" id="fApply">Aplicar</button></div>
    </dialog>

    <dialog id="dlg">
      <div class="hd"><strong id="dlgTitle">Novo agendamento</strong><button class="btn ghost" id="dlgClose">✕</button></div>
      <div class="bd">
        <div style="display:flex;gap:.6rem;flex-wrap:wrap">
          <div style="flex:1 1 160px"><label class="tiny muted">Cliente</label><input id="fCliente" class="input" placeholder="Ex.: Carlos"/></div>
          <div style="flex:1 1 160px"><label class="tiny muted">Serviço/nota</label><input id="fServico" class="input" placeholder="Ex.: Corte infantil"/></div>
        </div>
        <div style="display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.6rem">
          <div style="flex:1 1 120px"><label class="tiny muted">Data</label><input id="fData" type="date" class="input"/></div>
          <div style="flex:1 1 120px"><label class="tiny muted">Hora</label><input id="fHora" type="time" class="input" step="900"/></div>
          <div style="flex:1 1 120px"><label class="tiny muted">Preço (R$)</label><input id="fPreco" class="input" inputmode="decimal" placeholder="Ex.: 40,00"/></div>
          <div style="flex:1 1 160px">
            <label class="tiny muted">Situação</label>
            <select id="fStatusEdit" class="input">
              <option value="agendado" selected>Marcado</option>
              <option value="reagendar">Reagendar</option>
              <option value="cancelado">Cancelado</option>
              <option value="no_show">Não compareceu</option>
            </select>
          </div>
        </div>
        <div style="margin-top:.6rem">
          <label class="tiny muted">Observações</label>
          <textarea id="fObs" class="input" rows="3" placeholder="Campo livre (opcional)"></textarea>
        </div>
        <div class="tiny muted" style="margin-top:.6rem">Exemplo de IA: “Agendar corte para meu filho Carlos, 12 anos.” → Serviço: <b>Corte infantil</b>; Cliente: <b>Carlos</b>; Idade: <b>12</b>.</div>
      </div>
      <div class="ft">
        <button class="btn ghost" id="btnExcluir" hidden>Excluir</button>
        <button class="btn" id="btnSalvar">Salvar</button>
      </div>
    </dialog>

    <button id="fabNew" class="btn primary fab">＋ Novo</button>
  </main>

  <div id="app-footer"></div>
  <!-- Scripts com cache-bust -->
  <script src="/assets/layout.js?v=20250909h" defer></script>
  <script src="/assets/firebase-init.js?v=20250909h" defer></script>
  <script src="/assets/backend-patch.js?v=20250909h" defer></script>

  <script>
  ;(()=>{
    const qs = new URLSearchParams(location.search);
    const validate = qs.get('validate')==='1';

    // ===== Refs principais =====
    const gridHoje   = document.getElementById('gridHoje');
    const gridAmanha = document.getElementById('gridAmanha');
    const week       = document.getElementById('week');
    const weekTitle  = document.getElementById('weekTitle');
    const dayTitle   = document.getElementById('dayTitle');
    const listEl     = document.getElementById('list');
    const emptyEl    = document.getElementById('empty');

    const btnHoje   = document.getElementById('btnHoje');
    const btnAmanha = document.getElementById('btnAmanha');
    const btnSemana = document.getElementById('btnSemana');
    const dtCustom  = document.getElementById('dtCustom');
    const btnNovo   = document.getElementById('btnNovo');
    const fabNew    = document.getElementById('fabNew');

    const qFooter   = document.getElementById('qFooter');
    const qDate     = document.getElementById('qDate');
    const sStatusFooter = document.getElementById('sStatusFooter');
    const btnApplyFooter = document.getElementById('btnApplyFooter');

    const dlgBusca  = document.getElementById('dlgBusca');
    const bClose    = document.getElementById('bClose');
    const bApply    = document.getElementById('bApply');
    const q         = document.getElementById('q');

    const dlgFiltros = document.getElementById('dlgFiltros');
    const fClose     = document.getElementById('fClose');
    const fApply     = document.getElementById('fApply');
    const fStatus    = document.getElementById('fStatus');
    const fRange     = document.getElementById('fRange');

    const dlg        = document.getElementById('dlg');
    const dlgTitle   = document.getElementById('dlgTitle');
    const dlgClose   = document.getElementById('dlgClose');
    const fCliente   = document.getElementById('fCliente');
    const fServico   = document.getElementById('fServico');
    const fData      = document.getElementById('fData');
    const fHora      = document.getElementById('fHora');
    const fPreco     = document.getElementById('fPreco');
    const fStatusEdit= document.getElementById('fStatusEdit');
    const fObs       = document.getElementById('fObs');
    const btnSalvar  = document.getElementById('btnSalvar');
    const btnExcluir = document.getElementById('btnExcluir');

    const lblHojeDate   = document.getElementById('lblHojeDate');
    const lblAmanhaDate = document.getElementById('lblAmanhaDate');

    // ===== Estado =====
    let items = [];
    let current = null;
    let selectedDate = startOfDay(new Date());
    let filters = { today:{mode:'all', service:''}, tomorrow:{mode:'all', service:''} };

    // ===== Helpers =====
    const tz='America/Sao_Paulo';
    function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
    const toDateInput = d=> new Date(d).toISOString().slice(0,10);
    const toTimeInput = d=> new Date(d).toTimeString().slice(0,5);
    const fmtHour = d=> new Intl.DateTimeFormat('pt-BR',{hour:'2-digit',minute:'2-digit',timeZone:tz}).format(d);
    const fmtMoney = v=> { try{ const n=Number(String(v).replace('.','').replace(',','.')); return n.toFixed(2).replace('.',',') }catch{ return v } };
    const fmtDate = d=> new Intl.DateTimeFormat('pt-BR',{timeZone:tz}).format(d);

    function statusChip(s){
      const map={ agendado:['s-ag','Marcado'], reagendar:['s-rg','Reagendar'], cancelado:['s-cl','Cancelado'], no_show:['s-ns','Não compareceu'] };
      const [cls,txt]=map[s]||map.agendado;
      return `<span class="status ${cls} tiny">${txt}</span>`;
    }

    // ===== Tabs / navegação =====
    function setActiveTab(btn){
      [btnHoje,btnAmanha,btnSemana].forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      ;[btnHoje,btnAmanha,btnSemana].forEach(b=> b.style.order = 0);
      btn.style.order = -1;
    }

    btnHoje.addEventListener('click',()=>{ selectedDate=startOfDay(new Date()); setActiveTab(btnHoje); updateAll(); });
    btnAmanha.addEventListener('click',()=>{ const d=new Date(); d.setDate(d.getDate()+1); selectedDate=startOfDay(d); setActiveTab(btnAmanha); updateAll(); });
    btnSemana.addEventListener('click',()=>{ setActiveTab(btnSemana); window.scrollTo({top:document.querySelector('#weekTitle').offsetTop-16,behavior:'smooth'}); });
    dtCustom.addEventListener('change',()=>{ const d=new Date(dtCustom.value+'T00:00:00'); if(!isNaN(d)) { selectedDate=startOfDay(d); updateAll(); } });
    btnNovo.addEventListener('click',()=> openModal(null));
    fabNew.addEventListener('click',()=> openModal(null));

    // ===== Busca / filtros globais =====
    document.getElementById('btnBuscar').addEventListener('click',()=> dlgBusca.showModal());
    bClose.addEventListener('click',()=> dlgBusca.close());
    bApply.addEventListener('click',()=>{ dlgBusca.close(); updateAll(); });

    document.getElementById('btnFiltros').addEventListener('click',()=> dlgFiltros.showModal());
    fClose.addEventListener('click',()=> dlgFiltros.close());
    fApply.addEventListener('click',()=>{ dlgFiltros.close(); updateAll(); });

    btnApplyFooter.addEventListener('click',()=>{
      q.value = qFooter.value;
      fStatus.value = sStatusFooter.value;
      const dv = (qDate.value||'').trim();
      if(dv){ dtCustom.value = dv; const d=new Date(dv+'T00:00:00'); if(!isNaN(d)) selectedDate=startOfDay(d); }
      updateAll();
    });

    // ===== Chips locais por caderno =====
    document.querySelectorAll('.chips').forEach(bar=>{
      bar.addEventListener('click', (ev)=>{
        const t = ev.target.closest('.chip'); if(!t) return;
        const scope = bar.getAttribute('data-scope');
        bar.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        t.classList.add('active');
        const filter = t.getAttribute('data-filter');
        if(filter==='service'){
          const svc = prompt('Qual serviço deseja filtrar? (ex.: Corte, Coloração, Infantil)');
          filters[scope].mode = 'service';
          filters[scope].service = (svc||'').trim();
        }else{
          filters[scope].mode = filter;
          if(filter!=='service') filters[scope].service = '';
        }
        updateAll();
      });
    });

    // ===== Caderno do dia (TODOS horários) =====
    function buildDayPage(container, day, all, scope){
      container.innerHTML='';
      const start=8, end=19;
      const term = (q?.value||'').trim().toLowerCase();
      const stGlobal = (fStatus.value||'');
      const local = filters[scope];

      for(let h=start; h<end; h++){
        for (const m of [0,30]){
          const slotDate = new Date(day.getFullYear(),day.getMonth(),day.getDate(),h,m);
          const hh=String(h).padStart(2,'0'), mm=String(m).padStart(2,'0');
          const found = all.find(i=>{ const d=new Date(i.when); return sameDay(d,day) && d.getHours()===h && d.getMinutes()===m });

          // filtros locais/globais
          let show = true;
          if(local.mode==='busy' && !found) show=false;
          if(local.mode==='free' && found) show=false;
          if(local.mode==='service' && found){ const svc=(local.service||'').toLowerCase(); if(svc && !(String(found.servico||'').toLowerCase().includes(svc))) show=false }
          if(stGlobal && (!found || found.status!==stGlobal)) show=false;
          if(term){
            if(found){ const txt=(found.cliente+' '+(found.servico||'')+' '+(found.obs||'')).toLowerCase(); if(!txt.includes(term)) show=false }
            else if(!'livre'.includes(term) && !(`${hh}:${mm}`).includes(term)) show=false
          }
          if(!show) continue;

          const row = document.createElement('div');
          row.className='slot '+(found?'busy':'free');
          const right = found
            ? `<b>${found.cliente}</b> · ${(found.servico||'—')}${found.preco? ` · <b>R$ ${fmtMoney(found.preco)}</b>`:''}${found.obs? ' · '+found.obs:''} ${statusChip(found.status)}`
            : `<span class='muted'>livre</span>`;
          row.innerHTML = `<span class="h">${hh}:${mm}</span><div class="txt">${right}</div>`;
          row.addEventListener('click',()=>{ if(found){ openModal(found) } else { openModal({ when: slotDate }) } });
          container.appendChild(row);
        }
      }

      if(!container.children.length){
        const empty=document.createElement('div');
        empty.className='state tiny';
        empty.textContent='Sem horários por aqui.';
        container.appendChild(empty)
      }
    }
    // ===== SEMANA (resumo) — TODOS os horários por dia =====
    function renderWeek(){
      week.innerHTML='';
      const base = selectedDate;

      const startLabel = new Intl.DateTimeFormat('pt-BR',{timeZone:tz, day:'2-digit', month:'short'}).format(base);
      const end = new Date(base); end.setDate(end.getDate()+6);
      const endLabel = new Intl.DateTimeFormat('pt-BR',{timeZone:tz, day:'2-digit', month:'short'}).format(end);
      weekTitle.textContent = `Semana: ${startLabel} – ${endLabel}`;

      const term = (q?.value||'').trim().toLowerCase();
      const stGlobal = (fStatus.value||'');

      const days = [...Array(7)].map((_,i)=>{ const d=new Date(base); d.setDate(d.getDate()+i); return d });

      days.forEach(d=>{
        const el=document.createElement('div');
        el.className='day'+(sameDay(d, selectedDate)? ' hoy':'');
        const lbl = dayLabel(d);

        // aplica filtros globais/busca ao contar agendados (pill)
        let dayItems = items.filter(i=> sameDay(new Date(i.when), d));
        if(stGlobal) dayItems = dayItems.filter(x=> x.status===stGlobal);
        if(term){
          dayItems = dayItems.filter(x=>{
            const txt=(x.cliente+' '+(x.servico||'')+' '+(x.obs||'')).toLowerCase();
            return txt.includes(term);
          });
        }
        dayItems.sort((a,b)=> new Date(a.when)-new Date(b.when));

        el.innerHTML = `<div class="hd"><span>${lbl}</span><span class="pill">${dayItems.length} agendamentos</span></div>`;

        // grade de TODOS os horários (08:00–19:00, a cada 30 min)
        const start=8, endH=19;
        for(let h=start; h<endH; h++){
          for (const m of [0,30]){
            const found = dayItems.find(i=>{
              const di=new Date(i.when);
              return di.getHours()===h && di.getMinutes()===m;
            });
            const hhmm = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            const row = document.createElement('div');
            row.className='mini-slot'+(found?' busy':' free');
            row.innerHTML = found
              ? `<span>${hhmm}</span><span>${found.cliente} · ${(found.servico||'—')}</span>`
              : `<span>${hhmm}</span><span class="muted">livre</span>`;
            row.addEventListener('click',()=>{
              selectedDate = startOfDay(d);
              updateAll();
              // rolar para o caderno correspondente
              const anchor = sameDay(d, startOfDay(new Date())) ? '#pageHoje' : '#pageAmanha';
              const target = document.querySelector(anchor);
              if(target) window.scrollTo({top: target.offsetTop - 12, behavior:'smooth'});
            });
            el.appendChild(row);
          }
        }
        el.addEventListener('click',()=>{ selectedDate=startOfDay(d); updateAll(); });
        week.appendChild(el);
      });
    }

    // ===== Lista detalhada (período selecionado) =====
    function renderList(){
      const base = selectedDate;
      dayTitle.textContent = dayLabel(base);

      const term = (q?.value||'').trim().toLowerCase();
      const st = fStatus.value;
      const range = fRange.value;

      const end = new Date(base);
      if (range==='3d') end.setDate(end.getDate()+2);
      else if (range==='7d') end.setDate(end.getDate()+6);

      const filtered = items
        .filter(x=>{
          const d=new Date(x.when);
          const inRange = d>=base && d<=end;
          const txt=(x.cliente+' '+(x.servico||'')+' '+(x.obs||'')).toLowerCase();
          const byTerm = term? txt.includes(term) : true;
          const byStatus = st? x.status===st : true;
          return inRange && byTerm && byStatus;
        })
        .sort((a,b)=> new Date(a.when)- new Date(b.when));

      listEl.innerHTML='';
      if (!filtered.length){ emptyEl.hidden=false; return } else { emptyEl.hidden=true }

      for (const it of filtered){
        const d=new Date(it.when);
        const el=document.createElement('div'); el.className='item';
        el.innerHTML = `
          <div class="avatar">${(it.cliente||'?').slice(0,2).toUpperCase()}</div>
          <div>
            <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
              <strong>${it.cliente||'—'}</strong>
              <span class="meta">${fmtHour(d)}</span>
              ${statusChip(it.status)}
            </div>
            <div class="meta">${it.servico||'—'}${it.preco? ' · <b>R$ '+fmtMoney(it.preco)+'</b>':''}${it.obs? ' · '+it.obs: ''}</div>
          </div>
          <div class="actions" style="display:flex;gap:.4rem;flex-wrap:wrap">
            <button class="btn ghost tiny" data-act="reagendar">Reagendar</button>
            <button class="btn ghost tiny" data-act="cancelar">Cancelar</button>
            <button class="btn ghost tiny" data-act="no_show">Não compareceu</button>
            <button class="btn tiny" data-act="editar">Editar</button>
          </div>`;
        el.querySelectorAll('button').forEach(b=> b.addEventListener('click',()=>handleAction(it,b.dataset.act)));
        listEl.appendChild(el);
      }
    }

    // ===== Rótulos e KPIs =====
    function dayLabel(d){
      const today = startOfDay(new Date());
      const tomorrow = startOfDay(new Date(Date.now()+86400000));
      if (sameDay(d,today))    return 'Hoje';
      if (sameDay(d,tomorrow)) return 'Amanhã';
      return d.toLocaleDateString('pt-BR',{weekday:'short', day:'2-digit', month:'2-digit'});
    }

    function renderHero(){
      const today    = startOfDay(new Date());
      const tomorrow = startOfDay(new Date(Date.now()+86400000));
      const in7 = new Date(today); in7.setDate(in7.getDate()+6);
      document.getElementById('kHoje').textContent   = items.filter(i=> sameDay(new Date(i.when),today)).length;
      document.getElementById('kAmanha').textContent = items.filter(i=> sameDay(new Date(i.when),tomorrow)).length;
      document.getElementById('k7d').textContent     = items.filter(i=> new Date(i.when) >= today && new Date(i.when) <= in7).length;
    }

    // ===== Ciclo de atualização =====
    function updateAll(){
      const today = startOfDay(new Date());
      const tomorrow = startOfDay(new Date(Date.now()+86400000));

      // Datas nos títulos Hoje/Amanhã
      lblHojeDate.textContent   = `(${fmtDate(today)})`;
      lblAmanhaDate.textContent = `(${fmtDate(tomorrow)})`;

      // Cadernos do dia (TODOS horários)
      buildDayPage(gridHoje,   today,    items, 'today');
      buildDayPage(gridAmanha, tomorrow, items, 'tomorrow');

      // Semana completa + lista + KPIs
      renderWeek();
      renderList();
      renderHero();

      // Define o datepicker se vazio
      if (!dtCustom.value){ dtCustom.value = toDateInput(selectedDate) }
    }

    // ===== Editor (modal) =====
    function openModal(item){
      current = item||null;
      dlgTitle.textContent = item?.id? 'Editar agendamento':'Novo agendamento';
      btnExcluir.hidden = !item?.id;

      fCliente.value = item?.cliente||'';
      fServico.value = item?.servico||'';
      fPreco.value   = item?.preco? fmtMoney(item.preco):'';
      const d = item?.when? new Date(item.when) : (item?.when instanceof Date? item.when : selectedDate);
      fData.value    = toDateInput(d);
      fHora.value    = toTimeInput(d);
      fStatusEdit.value = item?.status||'agendado';
      fObs.value     = item?.obs||'';
      dlg.showModal();
    }
    dlgClose.addEventListener('click',()=> dlg.close());

    btnSalvar.addEventListener('click',()=>{
      if (validate){ toast('🔒 Validação: nada será gravado.'); return }
      const when = new Date(fData.value+'T'+fHora.value+':00');
      const preco = parseFloat(String(fPreco.value||'').replace('.','').replace(',','.'));
      const payload = {
        cliente:fCliente.value.trim(),
        servico:fServico.value.trim(),
        preco:isNaN(preco)? null:Number(preco.toFixed(2)),
        status:fStatusEdit.value,
        obs:fObs.value.trim()||null,
        when:when.toISOString(),
        atualizadoEm:new Date().toISOString()
      };
      if (!payload.cliente || !fData.value || !fHora.value){ toast('Preencha cliente, data e hora.'); return }
      if (current?.id){ Object.assign(current,payload); saveItem(current,false) }
      else { payload.criadoEm=new Date().toISOString(); saveItem(payload,false) }
      dlg.close();
    });

    btnExcluir.addEventListener('click',()=>{
      if (validate){ toast('🔒 Validação: exclusão simulada.'); return }
      if (!current?.id) return;
      deleteItem(current);
      dlg.close();
    });

    function handleAction(item, act){
      if (validate){
        toast('🔒 Validação: '+(act==='no_show'?'Não compareceu':act)+' (simulado)');
        if (act==='editar') openModal(item);
        return;
      }
      if (act==='editar')   return openModal(item);
      if (act==='reagendar'){ item.status='reagendar'; saveItem(item,true) }
      if (act==='cancelar'){ item.status='cancelado'; saveItem(item,true) }
      if (act==='no_show'){ item.status='no_show'; saveItem(item,true) }
    }

    // ===== Data layer (Firebase) =====
    async function load(){
      setActiveTab(btnHoje);
      if (validate){ items = demoItems(); updateAll(); return }
      try{
        const auth=window.firebase?.auth?.();
        const db=window.firebase?.firestore?.();
        const uid=auth?.currentUser?.uid;
        if (!uid){
          items=[]; updateAll();
          return toast('Faça login para ver a agenda.');
        }
        const start = startOfDay(new Date());
        const end   = new Date(start); end.setDate(end.getDate()+31);
        const snap = await db.collection('profissionais').doc(uid).collection('agendamentos')
          .where('when','>=',start.toISOString())
          .where('when','<=',end.toISOString())
          .get();
        items = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
        updateAll();
      }catch(e){
        console.error(e);
        toast('Falha ao carregar agenda.');
      }
    }

    async function saveItem(item, silent){
      try{
        const auth=window.firebase?.auth?.();
        const db=window.firebase?.firestore?.();
        const uid=auth?.currentUser?.uid;
        if(!uid) return toast('Sessão expirada. Faça login.');
        const col=db.collection('profissionais').doc(uid).collection('agendamentos');
        if(item.id){ await col.doc(item.id).set(item,{merge:true}) }
        else { const ref=await col.add(item); item.id=ref.id }
        if(!silent) toast('Agendamento salvo.');
        await load();
      }catch(e){
        console.error(e);
        toast('Erro ao salvar.');
      }
    }

    async function deleteItem(item){
      try{
        const auth=window.firebase?.auth?.();
        const db=window.firebase?.firestore?.();
        const uid=auth?.currentUser?.uid;
        if(!uid) return toast('Sessão expirada. Faça login.');
        if(!item.id) return;
        await db.collection('profissionais').doc(uid).collection('agendamentos').doc(item.id).delete();
        toast('Agendamento excluído.');
        await load();
      }catch(e){
        console.error(e);
        toast('Erro ao excluir.');
      }
    }

    // ===== Demo (modo validação) =====
    function demoItems(){
      const base = startOfDay(new Date());
      const mk=(dayOffset,h,m,cliente,servico,preco,obs,status='agendado')=>({
        id: Math.random().toString(36).slice(2),
        cliente, servico, preco, obs, status,
        when: new Date(base.getFullYear(),base.getMonth(),base.getDate()+dayOffset,h,m).toISOString(),
        criadoEm:new Date().toISOString(),
        atualizadoEm:new Date().toISOString()
      });
      return [
        mk(0,8,0,'Carlos','Corte infantil',40,'12 anos'),
        mk(0,8,30,'Marina','Escova',60,null),
        mk(0,9,0,'Rafael','Barba',35,'—','no_show'),
        mk(0,10,0,'Ana Paula','Coloração',120,'Traga referência','reagendar'),
        mk(0,10,30,'João V.','Corte masculino',45,null),
        mk(0,11,30,'Patrícia','Manicure',50,null),
        mk(0,14,0,'Dona Lúcia','Hidratação',70,null),
        mk(0,16,30,'Bianca','Penteado',150,'Evento'),
        mk(1,9,30,'Felipe','Corte',40,null),
        mk(1,11,0,'Camila','Coloração raiz',130,null),
        mk(1,15,0,'Pedro','Corte + Barba',75,'Cliente recorrente'),
        mk(2,10,30,'Luan','Corte',40,null),
        mk(2,13,0,'Marta','Escova',60,null),
        mk(3,9,0,'Eduardo','Barba',35,null),
        mk(4,17,0,'Sofia','Penteado',160,'Formatura'),
        mk(5,10,0,'Tamires','Corte',45,null),
        mk(6,18,30,'Diego','Coloração total',180,null)
      ];
    }

    // ===== Toast =====
    function toast(msg){
      let t=document.getElementById('__toast');
      if(!t){
        t=document.createElement('div'); t.id='__toast'; document.body.appendChild(t);
        t.style.position='fixed'; t.style.left='50%'; t.style.bottom='20px';
        t.style.transform='translateX(-50%)'; t.style.background= 'var(--accent)';
        t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='10px';
        t.style.fontWeight='800'; t.style.zIndex='9999';
      }
      t.textContent=msg; t.style.opacity='1';
      setTimeout(()=>{ t.style.transition='opacity .3s'; t.style.opacity='0' },1500);
    }

    // ===== Boot =====
    document.addEventListener('DOMContentLoaded', load);
  })()
  </script>
</body>
</html>

