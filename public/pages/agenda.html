<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>AGENDA — CANÔNICA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/styles.css" />
  <script defer src="/assets/layout.js?v=20250905a"></script>
</head>
<body>
  <div id="app-header"></div>

  <main class="container">
    <div class="card">
      <h2>Agenda</h2>
      <p>
        Cadastre compromissos manualmente (a IA também agenda via WhatsApp).
        Regras v1:
        <span class="badge">+2 dias</span> •
        <span class="badge">sem fins de semana</span> •
        <span class="badge">sem conflito</span>.
      </p>

      <div class="grid grid-2" style="margin-top:16px">
        <div>
          <label for="tipo">Tipo de compromisso</label>
          <select id="tipo" class="input">
            <option value="visita">Visita no cliente</option>
            <option value="visitaRecebida">Cliente vem até mim</option>
            <option value="video">Reunião por vídeo</option>
            <option value="outro">Outro</option>
          </select>
        </div>

        <div>
          <label for="local">Local (opcional)</label>
          <input id="local" class="input" placeholder="Endereço, link de vídeo, etc." />
        </div>

        <div>
          <label for="data">Data</label>
          <input id="data" class="input" type="date" />
        </div>

        <div>
          <label for="hora">Horário</label>
          <input id="hora" class="input" type="time" />
        </div>

        <div>
          <label for="duracaoMin">Duração (minutos)</label>
          <input id="duracaoMin" class="input" type="number" min="15" step="5" value="30" />
        </div>

        <div>
          <label for="clienteId">ID do Cliente</label>
          <input id="clienteId" class="input" placeholder="ex.: cli-001" />
        </div>

        <div>
          <label for="servicoId">ID do Serviço</label>
          <input id="servicoId" class="input" placeholder="ex.: srv-001" />
        </div>

        <div style="grid-column:1/-1">
          <label for="observacoes">Observações</label>
          <textarea id="observacoes" class="input" rows="3" placeholder="Ex.: levar a lata de tinta azul"></textarea>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:14px">
        <button class="btn" id="criar" disabled>Criar compromisso</button>
        <button class="btn secondary" id="listar">Atualizar lista</button>
      </div>

      <pre id="out" style="margin-top:12px"></pre>

      <h3 style="margin-top:20px">Meus agendamentos</h3>
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>id</th><th>data</th><th>hora</th><th>dur</th><th>tipo</th><th>estado</th><th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <div id="app-footer"></div>

  <script>
    // ===== Helpers base =====
    const token = () => localStorage.getItem('idToken');

    function isoFromLocalDateTime(dateStr, timeStr){
      if(!dateStr || !timeStr) return null;
      const [y,m,d] = dateStr.split('-').map(Number);
      const [hh,mm] = timeStr.split(':').map(Number);
      const local = new Date(y, m-1, d, hh, mm, 0);
      const iso = new Date(local.getTime() - local.getTimezoneOffset()*60000).toISOString();
      return iso.replace('.000Z','Z');
    }

    function addDays(date, days){
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + days);
      return d;
    }

    function ymd(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function isWeekendStr(dateStr){
      const [y,m,d] = dateStr.split('-').map(Number);
      const dt = new Date(y, m-1, d, 12, 0, 0);
      const day = dt.getDay(); // 0=dom, 6=sáb
      return day === 0 || day === 6;
    }

    function nonEmpty(v){ return v != null && String(v).trim() !== ''; }

    function setOut(msg){
      const el = document.getElementById('out');
      if(msg == null || msg === '') { el.textContent = ''; return; }
      if(typeof msg === 'string') el.textContent = msg;
      else el.textContent = JSON.stringify(msg, null, 2);
    }

    // ===== Cache simples dos agendamentos para checar conflito =====
    let _cacheAgendas = [];

    async function fetchAgendamentos(){
      const r = await fetch('/agendamentos', { headers: { 'Authorization':'Bearer '+token() }});
      const ct = r.headers.get('content-type') || '';
      if(!r.ok){
        const txt = await r.text().catch(()=>'(sem corpo)');
        throw new Error(`GET /agendamentos -> ${r.status}: ${txt.slice(0,200)}`);
      }
      if(ct.includes('application/json')){
        const arr = await r.json();
        _cacheAgendas = Array.isArray(arr) ? arr : [];
      }else{
        // resposta inesperada: não despejar "código"
        const txt = await r.text();
        _cacheAgendas = [];
        setOut('⚠️ Resposta inesperada de /agendamentos (não-JSON).');
        console.warn('Resposta /agendamentos:', txt);
      }
      return _cacheAgendas;
    }

    // ===== Renderização da tabela =====
    async function listar(){
      try{
        setOut(''); // limpa mensagens ao listar
        const arr = await fetchAgendamentos();
        const tb = document.querySelector('#tbl tbody');
        tb.innerHTML = '';
        (arr||[]).forEach(x => {
          const dt = new Date(x.dataHora);
          const data = dt.toLocaleDateString('pt-BR');
          const hora = dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${x.id}</td>
            <td>${data}</td>
            <td>${hora}</td>
            <td>${x.duracaoMin}</td>
            <td>${x.tipo||'-'}</td>
            <td>${x.estado}</td>
            <td>
              <button class='btn' data-id='${x.id}' data-ac='confirmar'>Confirmar</button>
              <button class='btn secondary' data-id='${x.id}' data-ac="cancelar">Cancelar</button>
            </td>`;
          tb.appendChild(tr);
        });
        if(!arr || arr.length === 0){
          setOut('Lista atualizada: nenhum agendamento encontrado.');
        }
        tb.querySelectorAll('button').forEach(b => b.onclick = onAcaoAgendamento);
      }catch(err){
        setOut(`Erro ao listar: ${err.message}`);
      }
    }

    async function onAcaoAgendamento(ev){
      const id = ev.target.getAttribute('data-id');
      const ac = ev.target.getAttribute('data-ac');
      try{
        const r = await fetch(`/agendamentos/${id}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+token()},
          body: JSON.stringify({acao:ac})
        });
        const t = await r.text();
        alert(t);
        listar();
      }catch(err){
        alert('Falha: ' + err.message);
      }
    }

    // ===== Validações v1 =====
    function computeMinDateStr(){
      const d2 = addDays(new Date(), 2); // +2 dias
      return ymd(d2);
    }

    function getForm(){
      const data = document.getElementById('data').value;
      const hora = document.getElementById('hora').value;
      const clienteId = document.getElementById('clienteId').value.trim();
      const servicoId = document.getElementById('servicoId').value.trim();
      const duracaoMin = Number(document.getElementById('duracaoMin').value || 0);
      const tipo = document.getElementById('tipo').value;
      const local = document.getElementById('local').value.trim() || null;
      const observacoes = document.getElementById('observacoes').value.trim() || null;
      const dataHoraISO = isoFromLocalDateTime(data, hora);
      return { data, hora, clienteId, servicoId, duracaoMin, tipo, local, observacoes, dataHoraISO };
    }

    function validateBasic(form){
      const reasons = [];
      if(!nonEmpty(form.clienteId)) reasons.push('Informe o ID do Cliente.');
      if(!nonEmpty(form.servicoId)) reasons.push('Informe o ID do Serviço.');
      if(!nonEmpty(form.data)) reasons.push('Escolha a data.');
      if(!nonEmpty(form.hora)) reasons.push('Escolha o horário.');
      if(!(form.duracaoMin >= 15)) reasons.push('Duração mínima é 15 minutos.');
      const minDateStr = computeMinDateStr();
      if(form.data && form.data < minDateStr){
        reasons.push(`Data deve ser a partir de ${minDateStr} (regra +2 dias).`);
      }
      if(form.data && isWeekendStr(form.data)){
        reasons.push('Não é permitido agendar sábado/domingo.');
      }
      if(form.hora && !/^\d{2}:\d{2}$/.test(form.hora)){
        reasons.push('Horário inválido.');
      }
      const ok = reasons.length === 0;
      return { ok, reasons };
    }

    function hasHorarioConflito(form){
      if(!form.dataHoraISO) return false;
      const alvo = new Date(form.dataHoraISO).getTime();
      return _cacheAgendas.some(x => {
        const t = new Date(x.dataHora).getTime();
        const estado = String(x.estado||'').toLowerCase();
        const relevante = (estado.includes('pend') || estado.includes('conf'));
        return relevante && t === alvo;
      });
    }

    function updateCreateBtn(){
      const btn = document.getElementById('criar');
      const form = getForm();
      const basic = validateBasic(form);
      let msg = [];
      if(!basic.ok) msg = msg.concat(basic.reasons);
      if(basic.ok && hasHorarioConflito(form)){
        msg.push('Já existe compromisso pendente/confirmado nesse mesmo horário.');
      }
      if(msg.length > 0){
        btn.disabled = true;
        setOut('⚠️ ' + msg.join(' '));
      }else{
        btn.disabled = false;
        setOut('Pronto para criar ✅');
      }
    }

    async function criar(){
      const form = getForm();
      const basic = validateBasic(form);
      if(!basic.ok){ setOut({ erro: 'Validação', motivos: basic.reasons }); return; }
      try { await fetchAgendamentos(); } catch(_) {}
      if(hasHorarioConflito(form)){ setOut({ erro: 'Conflito', detalhe: 'Já existe compromisso pendente/confirmado nesse mesmo horário.' }); return; }
      try{
        const r = await fetch('/agendamentos', {
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+token()},
          body: JSON.stringify({
            clienteId:  form.clienteId,
            servicoId:  form.servicoId,
            dataHora:   form.dataHoraISO,
            duracaoMin: form.duracaoMin,
            tipo:       form.tipo,
            local:      form.local,
            observacoes:form.observacoes
          })
        });
        const ct = r.headers.get('content-type') || '';
        if(!r.ok){
          const txt = await r.text().catch(()=>'(sem corpo)');
          throw new Error(`POST /agendamentos -> ${r.status}: ${txt.slice(0,200)}`);
        }
        const j = ct.includes('application/json') ? await r.json() : { ok: true, detalhe: 'Criado (não-JSON)' };
        setOut(j);
        if(!j.erro) { await listar(); updateCreateBtn(); }
      }catch(err){
        setOut({ erro: 'Falha no POST /agendamentos', detalhe: err.message });
      }
    }

    function wireInputs(){
      ['tipo','local','data','hora','duracaoMin','clienteId','servicoId','observacoes'].forEach(id => {
        const el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('input', updateCreateBtn);
        el.addEventListener('change', updateCreateBtn);
      });
    }

    function applyMinDate(){
      const inputDate = document.getElementById('data');
      inputDate.min = ymd(addDays(new Date(), 2));
    }

    window.addEventListener('DOMContentLoaded', async () => {
      applyMinDate();
      wireInputs();
      await listar();
      updateCreateBtn();
      document.getElementById('listar').onclick = listar;
      document.getElementById('criar').onclick = criar;
    });
  </script>
</body>
</html>
