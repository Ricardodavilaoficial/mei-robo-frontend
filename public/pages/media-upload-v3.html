<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MEI Robô — Mídia (Passo 2/4 v3: Upload com Title + Service)</title>

  <!-- Tailwind CDN for preview only -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM + Babel for in-browser JSX (preview) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { background:#0b0f14; color:#e6edf3; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .container { max-width: 960px; margin: 0 auto; padding: 1rem; }
    code { background: rgba(255,255,255,0.04); padding: .1rem .35rem; border-radius: .32rem; }
    .muted { color: #9aa4b2; font-size: 0.9rem; }
    .input, select { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); padding: .45rem .6rem; border-radius: .375rem; color: #e6edf3; }
  </style>
</head>
<body>
  <div class="container">
    <div class="mb-4 rounded-xl border border-yellow-600/30 bg-yellow-900/10 p-3 text-sm text-yellow-200">
      <strong>Preview seguro v3:</strong> abra com <code>?validate=1</code>. Em preview simulamos login do canário e não gravamos nada.
    </div>

    <div id="root"></div>
  </div>

  <script type="text/babel">
  const { useState, useEffect, useMemo } = React;
  const CANARY_UID = 'V4eFP2bNdXNtQz2Eh4PxpwHNLOP2';
  const ALLOWED_MIMES = ['image/jpeg','image/png','image/webp','image/gif','application/pdf','video/mp4'];
  const LIMITS = { default: 15 * 1024 * 1024, mp4: 25 * 1024 * 1024 };

  function isValidateMode(){ try{ return new URLSearchParams(window.location.search).has('validate') }catch{ return false } }
  function slugify(text){
    return text.toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  }
  function shortId(len=6){ const s = Math.random().toString(36).slice(2, 2+len); return s; }
  function todayPath(){ const d=new Date(); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yyyy}/${mm}/${dd}`; }
  function formatBytes(b){ if (!b && b!==0) return '0 B'; const u=['B','KB','MB','GB']; let i=0, val=b; while(val>=1024 && i<u.length-1){ val/=1024; i++; } const fixed = val>=100?0: val>=10?1:2; return `${val.toFixed(fixed)} ${u[i]}`; }

  // Minimal services mock (you can replace by sending your list later)
  const DEFAULT_SERVICES = [
    { slug: 'corte', name: 'Corte' },
    { slug: 'luzes', name: 'Luzes' },
    { slug: 'morena-luminosa', name: 'Morena Luminosa' },
    { slug: 'barba', name: 'Barba' },
    { slug: 'hidratar', name: 'Hidratação' },
    { slug: 'penteado', name: 'Penteado' }
  ];

  // Mock upload to simulate progress
  function mockUpload(file, onProgress){
    return new Promise((resolve)=>{
      const total = file.size || (1024*500);
      let uploaded = 0;
      const step = Math.max(1024*40, Math.round(total/50));
      const t = setInterval(()=>{
        uploaded += step;
        if (uploaded > total) uploaded = total;
        onProgress(Math.round((uploaded/total)*100));
        if (uploaded >= total){
          clearInterval(t);
          setTimeout(()=> resolve({ path: `users/${CANARY_UID}/media/${todayPath()}/${file.name}` }), 200);
        }
      }, 60);
    });
  }

  function MediaUploadV3(){
    const validate = isValidateMode();
    const [user, setUser] = useState(validate ? { uid: CANARY_UID, name: 'Canário (preview)' } : null);
    const [services, setServices] = useState(DEFAULT_SERVICES);
    const [title, setTitle] = useState('');
    const [service, setService] = useState('');
    const [file, setFile] = useState(null);
    const [error, setError] = useState(null);
    const [progress, setProgress] = useState(0);
    const [recent, setRecent] = useState([]);
    const [quota, setQuota] = useState({ limitBytes: 2147483648, bytesUsed: Math.floor(2147483648*0.65), filesCount: 128 });

    useEffect(()=>{
      // if in validate mode, ensure local flag exists for demo convenience
      if (validate && !localStorage.getItem('MEDIA_V1')) localStorage.setItem('MEDIA_V1','on');
    },[]);

    const canUse = useMemo(()=> {
      if (!user) return false;
      const flag = localStorage.getItem('MEDIA_V1') === 'on';
      return flag && user.uid === CANARY_UID;
    }, [user]);

    function validateFile(f){
      if (!f) return 'Nenhum arquivo selecionado';
      if (!ALLOWED_MIMES.includes(f.type)) return `Tipo não permitido: ${f.type}`;
      const limit = f.type === 'video/mp4' ? LIMITS.mp4 : LIMITS.default;
      if (f.size > limit) return `Arquivo maior que o limite (${formatBytes(limit)})`;
      if (quota.bytesUsed >= quota.limitBytes) return 'Cota completa — novos uploads bloqueados';
      return null;
    }

    function handleChoose(e){
      setError(null);
      const f = e.target.files?.[0] || null;
      if (!f){ setFile(null); return; }
      const v = validateFile(f);
      if (v){ setError(v); setFile(null); return; }
      setFile(f);
    }

    function suggestedPathFor(titleVal, originalName){
      const slug = slugify(titleVal || originalName || 'sem-nome');
      const id = shortId(6);
      const ext = (originalName && originalName.split('.').pop()) || 'jpg';
      return `users/${CANARY_UID}/media/${todayPath()}/${slug}-${id}.${ext}`;
    }

    async function handleUpload(){
      setError(null);
      if (!title?.trim()) { setError('Preencha o título (ex.: Morena Luminosa — antes)'); return; }
      if (!service) { setError('Escolha o serviço relacionado (obrigatório)'); return; }
      if (!file) { setError('Selecione um arquivo para enviar'); return; }
      const v = validateFile(file);
      if (v){ setError(v); return; }

      try {
        setProgress(1);
        // compute path preview
        const slug = slugify(title);
        const id = shortId(6);
        const ext = (file.name.split('.').pop() || 'jpg');
        const storagePath = `users/${user.uid}/media/${todayPath()}/${slug}-${id}.${ext}`;

        // In production: use Firebase Storage SDK to upload to storagePath
        const res = await mockUpload(file, p => setProgress(p));
        // update quota mock
        setQuota(q => ({ ...q, bytesUsed: q.bytesUsed + file.size, filesCount: q.filesCount + 1 }));
        // add to recent with metadata
        setRecent(r=> [{ name: file.name, path: storagePath, size: file.size, title: title.trim(), service, createdAt: new Date().toISOString() }, ...r]);
        // reset
        setFile(null);
        setProgress(0);
      } catch(err){
        console.error(err);
        setError('Falha no upload (mock)');
        setProgress(0);
      }
    }

    function handleCopyPath(p){
      if (navigator.clipboard) navigator.clipboard.writeText(p).then(()=> alert('Caminho copiado'));
    }

    function handleDelete(item){
      if (!confirm('Excluir upload (preview)?')) return;
      setRecent(r => r.filter(x=> x !== item));
      setQuota(q => ({ ...q, filesCount: Math.max(0, q.filesCount-1), bytesUsed: Math.max(0, q.bytesUsed - item.size) }));
    }

    return (
      <div className="max-w-3xl mx-auto space-y-4">
        <div>
          <h1 className="text-2xl font-semibold">Configuração → Mídia (Upload v3)</h1>
          <p className="muted mt-1">Campos mínimos para evitar envio errado. Em preview nada é gravado.</p>
        </div>

        {!user && (
          <div className="rounded p-3 bg-gray-900 border">Faça login para acessar a área de mídia.</div>
        )}

        {user && !canUse && (
          <div className="rounded p-3 bg-gray-900 border">
            <div className="font-medium">Recurso em teste (canário)</div>
            <div className="muted mt-1">Ative no console: <code>localStorage.setItem('MEDIA_V1','on')</code> e recarregue.</div>
          </div>
        )}

        {user && canUse && (
          <div className="rounded-lg bg-gray-900 border p-4 space-y-3">
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <label className="sm:col-span-2 space-y-1">
                <div className="text-sm">Título <span className="text-xs text-gray-400">(obrigatório)</span></div>
                <input className="input w-full" value={title} onChange={e=> setTitle(e.target.value)} placeholder="Ex.: Morena Luminosa — antes" />
              </label>

              <label className="space-y-1">
                <div className="text-sm">Serviço <span className="text-xs text-gray-400">(obrigatório)</span></div>
                <select className="input w-full" value={service} onChange={e=> setService(e.target.value)}>
                  <option value="">— escolha —</option>
                  {services.map(s=> <option key={s.slug} value={s.slug}>{s.name}</option>)}
                </select>
              </label>
            </div>

            <div className="pt-2">
              <div className="text-sm muted">Arquivo</div>
              <div className="flex items-center gap-2 mt-2">
                <input id="file" type="file" onChange={handleChoose} />
                <button onClick={handleUpload} className="px-3 py-1 rounded bg-green-600 text-white text-sm">Enviar</button>
                <div className="text-xs text-gray-400">Destino (sugerido): <code className="ml-1">{ suggestedPathFor(title, file?.name || 'nome.jpg') }</code></div>
              </div>
            </div>

            {file && (
              <div className="p-2 bg-gray-800 rounded text-sm">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium">{file.name}</div>
                    <div className="muted text-xs">{file.type} • {formatBytes(file.size)}</div>
                  </div>
                  <div className="text-xs muted">{progress>0 && progress<100 ? `Upload ${progress}%` : ''}</div>
                </div>
                <div className="w-full bg-gray-700 h-3 rounded mt-3 overflow-hidden">
                  <div className="bg-blue-500 h-3" style={{ width: progress + '%' }}></div>
                </div>
              </div>
            )}

            {error && <div className="text-sm text-red-400">{error}</div>}

            <div className="pt-3 border-t border-gray-800 text-xs text-gray-400">
              Sugestão de tamanhos: imagens 2–3 MB, vídeos curtos até 16 MB, PDFs 10–15 MB. Regras: jpeg/png/webp/gif/pdf/mp4.
            </div>
          </div>
        )}

        <div className="rounded border bg-gray-900 p-3">
          <div className="text-sm font-medium">Quota (mock)</div>
          <div className="text-xs text-gray-400 mt-1">Usado: {formatBytes(quota.bytesUsed)} / {formatBytes(quota.limitBytes)} • arquivos: {quota.filesCount}</div>
        </div>

        <div>
          <h3 className="text-lg font-medium">Uploads recentes (preview)</h3>
          {recent.length === 0 ? <div className="muted text-sm mt-2">Nenhum upload realizado ainda.</div> : (
            <ul className="space-y-2 mt-3">
              {recent.map((r,i) => (
                <li key={i} className="flex items-center justify-between bg-gray-900 p-2 rounded">
                  <div>
                    <div className="font-medium">{r.title} — <span className="muted text-sm">{r.name}</span></div>
                    <div className="muted text-xs">{r.path} • {formatBytes(r.size)}</div>
                  </div>
                  <div className="flex gap-2">
                    <button className="text-xs px-2 py-1 border rounded" onClick={()=> handleCopyPath(r.path)}>Copiar caminho</button>
                    <button className="text-xs px-2 py-1 border rounded text-red-400" onClick={()=> handleDelete(r)}>Excluir</button>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>

      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<MediaUploadV3 />);
  </script>
</body>
</html>
