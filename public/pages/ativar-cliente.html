<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Concluir Assinatura — MEI Robô</title>

  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" href="data:,">
  <script defer src="/assets/layout.js"></script>

  <style>
    /* Dark sóbrio sem mudar o verde padrão do site */
    .wrap { max-width:820px; margin:24px auto; padding:0 12px; }
    .card-dark { background:#101414; color:#e9f4f1; border:1px solid #23302e; border-radius:14px; padding:16px; }
    .muted { color:#b6c9c3; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge { padding:2px 8px; border:1px solid #23302e; border-radius:999px; font-size:12px; }
    .ok { border-color:#2f6; }
    .warn { border-color:#fd6; }
    .err { border-color:#f88; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .cta { font-weight:800; }
    details { margin-top:10px; }
    .list { margin:0; padding-left: 18px; }

    /* Cupom */
    .coupon { margin-top:12px; }
    .coupon .inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .coupon input { min-width: 220px; }
    .hint { font-size:12px; color:#b6c9c3; }
    .msg-ok { color:#9ff5c7; }
    .msg-err { color:#ffbdbd; }
  </style>
</head>
<body>
  <div id="app-header"></div>

  <main class="wrap">
    <div class="card-dark">
      <h2 style="margin:0 0 6px">Concluir assinatura</h2>
      <p class="muted" style="margin:0 0 12px">
        Vamos checar seu vínculo com a empresa. Assim que estiver tudo certo,
        você poderá finalizar a assinatura com segurança.
      </p>

      <div id="status" class="badge muted">verificando…</div>

      <div id="content" style="margin-top:12px"></div>

      <!-- CUPOM: só aparece quando o gate liberar -->
      <div id="couponBox" class="coupon" hidden>
        <label for="codigo"><strong>Tenho um cupom</strong></label>
        <div class="inline">
          <input id="codigo" class="input" placeholder="Ex.: MEIROBO89" autocomplete="one-time-code" />
          <button id="btnValidar" class="btn-secondary" type="button">Validar</button>
          <button id="btnAplicar" class="btn-secondary" type="button" disabled>Aplicar</button>
        </div>
        <div id="couponMsg" class="hint" aria-live="polite"></div>
      </div>

      <div class="actions" id="actions" hidden>
        <button id="btnCheckout" class="cta">Seguir para assinatura</button>
        <a id="btnDocs" class="btn-secondary" href="/pages/vinculo.html">Enviar documentos</a>
      </div>

      <details>
        <summary>Ajuda</summary>
        <ul class="list">
          <li><strong>Vínculo pendente</strong>: podemos pedir documentos simples (ex.: comprovante de vínculo/ autorização).</li>
          <li><strong>Revisão manual</strong>: quando necessário, analisamos em poucas horas úteis.</li>
          <li><strong>Assinatura</strong>: planos sem fidelidade; você revisa tudo antes de confirmar.</li>
        </ul>
      </details>
    </div>
  </main>

  <div id="app-footer"></div>

  <script>
  (function(){
    const API_BASE = "https://mei-robo-prod.onrender.com";
    const API = {
      gate1:   API_BASE + "/api/stripe/gate",
      gate2:   API_BASE + "/api/conta/status",
      checkout:API_BASE + "/api/stripe/checkout",
      cupomValidar: API_BASE + "/api/cupons/validar-publico",
      cupomAtivar:  API_BASE + "/api/cupons/ativar"
    };

    const $status = document.getElementById('status');
    const $content = document.getElementById('content');
    const $actions = document.getElementById('actions');
    const $btnCheckout = document.getElementById('btnCheckout');
    const $btnDocs = document.getElementById('btnDocs');

    // Cupom UI
    const $couponBox = document.getElementById('couponBox');
    const $codigo = document.getElementById('codigo');
    const $btnValidar = document.getElementById('btnValidar');
    const $btnAplicar = document.getElementById('btnAplicar');
    const $couponMsg = document.getElementById('couponMsg');

    // Estado de cupom
    const cupomState = { valid:false, aplicado:false, codigo:null };

    function pill(text, cls){ $status.textContent = text; $status.className = 'badge ' + (cls || 'muted'); }
    function html(parts){ return parts.filter(Boolean).join(''); }
    function msg(info, type){ $couponMsg.textContent = info; $couponMsg.className = 'hint ' + (type||''); }

    // --- helpers cupom (mesmos do admin, simplificados) ---
    function normalizeCode(v){ return String(v || '').trim().toUpperCase().replace(/[^A-Z0-9-]/g,''); }
    function savePendingCupom(codigo){
      try{ localStorage.setItem('cupomPendente', JSON.stringify({ codigo, ts: Date.now(), ttl: 3600_000 })); }catch{}
    }
    function readPendingCupom(){
      try{
        const raw = localStorage.getItem('cupomPendente'); if(!raw) return null;
        const o = JSON.parse(raw); if(!o || !o.codigo) return null;
        if ((Date.now() - (o.ts||0)) > (o.ttl||0)) { localStorage.removeItem('cupomPendente'); return null; }
        return o.codigo;
      }catch{ return null; }
    }
    function clearPendingCupom(){ try{ localStorage.removeItem('cupomPendente'); }catch{} }

    async function fetchJSON(url, opts){
      const r = await fetch(url, Object.assign({ credentials:'include' }, opts||{}));
      const ct = r.headers.get('content-type') || '';
      const body = ct.includes('application/json') ? await r.json() : await r.text();
      return { ok: r.ok, status: r.status, body };
    }

    function asGate(obj){
      if (!obj || typeof obj !== 'object') return null;
      const stripe_enabled = !!(obj.stripe_enabled ?? obj.stripeEnabled ?? obj.gate_ok ?? obj.ok);
      const reason = obj.reason || obj.state || '';
      return {
        stripe_enabled,
        reason,
        needs_docs: !!(obj.needs_docs ?? obj.needsDocs),
        pending_review: !!(obj.pending_review ?? obj.pendingReview),
        scoreVinculo: (typeof obj.scoreVinculo === 'number' ? obj.scoreVinculo : null)
      };
    }

    function renderUnauth(){
      pill('entre para continuar', 'warn');
      $content.innerHTML = '<p class="muted">Você precisa entrar na sua conta para concluir a assinatura.</p><p><a class="btn-secondary" href="/pages/login.html">Entrar</a></p>';
      $actions.hidden = true;
      $couponBox.hidden = true;
    }

    function renderBlocked(o){
      const needs = !!o.needs_docs;
      const pending = !!o.pending_review;
      pill('vínculo pendente', 'warn');
      $content.innerHTML = html([
        '<p><strong>Precisamos confirmar seu vínculo com a empresa.</strong></p>',
        needs ? '<p class="muted">Envie os documentos solicitados para liberar sua assinatura.</p>' : '',
        pending ? '<p class="muted">Estamos revisando seus documentos. Normalmente leva poucas horas úteis.</p>' : ''
      ]);
      $btnDocs.hidden = !needs;
      $actions.hidden = false;
      $btnCheckout.disabled = true;
      $btnCheckout.title = "Assinatura liberada após a confirmação do vínculo.";
      $couponBox.hidden = true; // cupom só com gate liberado
    }

    function renderReady(){
      pill('tudo certo ✔', 'ok');
      $content.innerHTML = '<p><strong>Seu vínculo está confirmado.</strong> Você pode seguir para a etapa de assinatura com segurança.</p>';
      $actions.hidden = false;
      $btnDocs.hidden = true;
      $btnCheckout.disabled = false;
      $btnCheckout.title = "";

      // mostra UI de cupom quando liberado
      $couponBox.hidden = false;

      // Preenche com um cupom pendente se existir
      const pend = readPendingCupom();
      if (pend && !$codigo.value) { $codigo.value = pend; msg('Cupom pendente detectado. Clique em Validar.', ''); }
    }

    function renderError(){
      pill('não foi possível verificar agora', 'err');
      $content.innerHTML = '<p class="muted">Tente novamente em alguns instantes. Se persistir, fale com o suporte.</p>';
      $actions.hidden = true;
      $couponBox.hidden = true;
    }

    async function load(){
      try{
        pill('verificando…', 'muted');
        // tenta gate1 e depois gate2
        let g = null;
        const r1 = await fetchJSON(API.gate1).catch(()=>null);
        if (r1 && r1.ok && r1.body) g = asGate(r1.body);
        if (!g) {
          const r2 = await fetchJSON(API.gate2).catch(()=>null);
          if (r2 && r2.ok && r2.body) g = asGate(r2.body);
          if (!g && ((r1 && r1.status===401) || (r2 && r2.status===401))) { renderUnauth(); return; }
        }
        if (!g) { renderError(); return; }

        if (g.stripe_enabled) renderReady();
        else renderBlocked(g);
      } catch(e){
        console.error(e);
        renderError();
      }
    }

    // --- Cupom: validar/aplicar ---
    async function validarCupom(){
      const codigo = normalizeCode($codigo.value);
      if (!codigo) { msg('Digite um código de cupom.', ''); $codigo.focus(); return; }
      msg('Validando…', '');
      $btnValidar.disabled = true; $btnAplicar.disabled = true;
      try{
        const r = await fetchJSON(API.cupomValidar, {
          method:'POST',
          headers:{ 'Content-Type': 'application/json' },
          body: JSON.stringify({ codigo })
        });
        if (r.ok && r.body && (r.body.ok || r.body.valido || r.body.disponivel)) {
          cupomState.valid = true; cupomState.codigo = codigo;
          msg('Cupom válido! Clique em Aplicar para vincular à sua conta.', 'msg-ok');
          $btnAplicar.disabled = false;
          savePendingCupom(codigo);
        } else {
          cupomState.valid = false; cupomState.codigo = null;
          msg('Cupom inválido ou indisponível.', 'msg-err');
          $btnAplicar.disabled = true;
          clearPendingCupom();
        }
      } catch(e){
        msg('Falha ao validar agora. Tente novamente.', 'msg-err');
      } finally {
        $btnValidar.disabled = false;
      }
    }

    async function aplicarCupom(){
      const codigo = normalizeCode($codigo.value);
      if (!cupomState.valid || !codigo) { msg('Valide o cupom antes de aplicar.', ''); return; }
      msg('Aplicando…', '');
      $btnAplicar.disabled = true;
      try{
        const r = await fetchJSON(API.cupomAtivar, {
          method:'POST',
          headers:{ 'Content-Type': 'application/json' },
          body: JSON.stringify({ codigo })
        });
        if (r.ok && r.body) {
          cupomState.aplicado = true;
          msg('Cupom aplicado com sucesso! O desconto aparecerá na próxima etapa.', 'msg-ok');
          clearPendingCupom();
        } else if (r.status === 401) {
          msg('Faça login para aplicar o cupom.', 'msg-err');
        } else {
          msg('Não foi possível aplicar. Tente novamente.', 'msg-err');
          $btnAplicar.disabled = false;
        }
      } catch(e){
        msg('Erro de rede ao aplicar. Tente novamente.', 'msg-err');
        $btnAplicar.disabled = false;
      }
    }

    // --- Checkout ---
    async function proceedCheckout(){
      try{
        $btnCheckout.disabled = true;
        $btnCheckout.textContent = 'Preparando…';

        // Se o backend aceitar cupom via querystring e ainda não estiver aplicado,
        // você pode optar por enviar ?cupom=CODIGO. Caso já aplique no perfil, não precisa.
        const codigo = normalizeCode($codigo.value);
        const qs = (!cupomState.aplicado && codigo) ? ('?cupom=' + encodeURIComponent(codigo)) : '';
        const r = await fetchJSON(API.checkout + qs);

        if (r.ok && r.body && (r.body.checkoutUrl || r.body.url)) {
          const url = r.body.checkoutUrl || r.body.url;
          location.href = url;
          return;
        }
        // fallback: permanece nesta mesma página (não vai para admin)
        $btnCheckout.disabled = false;
        $btnCheckout.textContent = 'Seguir para assinatura';
        alert('Não foi possível iniciar a assinatura agora. Tente novamente.');
      } catch(e){
        console.error(e);
        $btnCheckout.disabled = false;
        $btnCheckout.textContent = 'Seguir para assinatura';
        alert('Não foi possível iniciar a assinatura agora. Tente novamente.');
      }
    }

    // Eventos
    $btnValidar.addEventListener('click', validarCupom);
    $btnAplicar.addEventListener('click', aplicarCupom);
    $btnCheckout.addEventListener('click', proceedCheckout);

    document.addEventListener('DOMContentLoaded', load);
  })();
  </script>
</body>
</html>
