<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Confirmar vínculo — MEI Robô</title>

  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" href="data:,">
  <script src="/assets/firebase-init.js"></script>
  <script src="/assets/backend-patch.js"></script>
  <script defer src="/assets/layout.js"></script>

  <style>
    .wrap { max-width:860px; margin:24px auto; padding:0 12px; }
    .card-dark { background:#101414; color:#e9f4f1; border:1px solid #23302e; border-radius:14px; padding:16px; }
    .muted { color:#b6c9c3; }
    .badge { padding:2px 8px; border:1px solid #23302e; border-radius:999px; font-size:12px; }
    .ok { border-color:#2f6; } .warn { border-color:#fd6; } .err { border-color:#f88; }
    .section { margin-top:14px; }
    .list { margin:0; padding-left:18px; }
    .upload-area{ border:2px dashed #23302e; border-radius:12px; padding:18px; cursor:pointer; background:#141a1a; }
    .upload-area:hover{ background:#0f1413; }
    .upload-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .btn-mini{ cursor:pointer; border-radius:999px; padding:8px 14px; font-weight:800; border:1px solid #23302e; background:#0c1211; color:#e9f4f1; }
    .file-list{ list-style:none; padding:0; margin:12px 0 0; }
    .file-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; background:#0c1211; border:1px solid #23302e; border-radius:10px; padding:8px 12px; margin:6px 0 }
    .file-meta{ font-size:.95rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:#e9f4f1 }
    .remove-btn{ background:#0c1211; border:1px solid #8a3a3a; color:#ffbdbd; border-radius:999px; padding:6px 10px; font-weight:800; cursor:pointer }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .cta { font-weight:800; }
    .small { font-size:12px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#0f1413; border:1px solid #23302e; font-size:12px; margin-right:6px }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
  </style>
</head>
<body>
  <div id="app-header"></div>

  <main class="wrap">
    <div class="card-dark">
      <h2 id="pageTitle" style="margin:0 0 6px">Confirme seu vínculo com a empresa</h2>
      <p id="pageSubtitle" class="muted" style="margin:0 0 8px">
        Para sua segurança e da empresa, precisamos validar que você está <strong>vinculado ao CNPJ</strong> ou tem
        <strong>autorização</strong>. É rápido e você só faz uma vez.
      </p>
      <div id="pill" class="badge muted">verificando status…</div>

      <!-- STATUS RENDER -->
      <div id="statusBox" class="section"></div>

      <!-- UPLOAD -->
      <div class="section" id="uploadBox" hidden>
        <h3 style="margin:0 0 6px">Enviar documentos</h3>
        <p class="muted small" style="margin:0 0 8px">
          Aceitamos PDF, JPG ou PNG. Exemplos: contrato social, cartão CNPJ com autorização, procuração, contracheque da empresa, etc.
          Envie arquivos legíveis, cobrindo nome e CNPJ da empresa, e seu nome como responsável ou autorizado.
        </p>
        <div id="uploadArea" class="upload-area" tabindex="0" role="button" aria-label="Enviar documentos por clique ou arraste">
          <div> Clique para escolher <em>(ou arraste)</em> seus arquivos aqui. </div>
          <div class="upload-actions">
            <input id="docFiles" type="file" accept=".pdf,.jpg,.jpeg,.png,image/*,application/pdf" multiple hidden />
            <button type="button" class="btn-mini" id="btnChoose">Escolher arquivos</button>
            <button type="button" class="btn-mini" id="btnClear">Limpar</button>
          </div>
          <ul id="fileList" class="file-list"></ul>
        </div>

        <div class="actions">
          <button id="btnSend" class="cta">Enviar para análise</button>
          <a href="/pages/ativar-cliente.html" class="btn-secondary">Voltar</a>
        </div>
        <div id="msg" class="muted small" style="margin-top:6px"></div>
      </div>

      <details class="section">
        <summary>O que acontece depois?</summary>
        <ul class="list">
          <li><strong>Revisão rápida</strong>: geralmente em poucas horas úteis.</li>
          <li><strong>Privacidade</strong>: seus documentos são usados só para verificação e ficam seguros.</li>
          <li><strong>Depois de aprovado</strong>: a assinatura é liberada automaticamente.</li>
        </ul>
      </details>
    </div>
  </main>

  <div id="app-footer"></div>

  <script>
  (function(){
    const API_BASE = "https://mei-robo-prod.onrender.com";
    const API = {
      status: API_BASE + "/api/verificacao/autoridade/status",
      upload: API_BASE + "/api/verificacao/autoridade/upload",
      gate:   API_BASE + "/api/stripe/gate" // guarda extra
    };

    const qs = new URLSearchParams(location.search);
    const mock = (qs.get('mock')||'').toLowerCase(); // needs | pending | approved | error

    const $pageTitle = document.getElementById('pageTitle');
    const $pageSubtitle = document.getElementById('pageSubtitle');
    const $pill = document.getElementById('pill');
    const $statusBox = document.getElementById('statusBox');
    const $uploadBox = document.getElementById('uploadBox');
    const $uploadArea = document.getElementById('uploadArea');
    const $docFiles = document.getElementById('docFiles');
    const $btnChoose = document.getElementById('btnChoose');
    const $btnClear = document.getElementById('btnClear');
    const $fileList = document.getElementById('fileList');
    const $btnSend = document.getElementById('btnSend');
    const $msg = document.getElementById('msg');

    const state = { files: [], view: 'needs' };

    function pill(text, cls){ $pill.textContent = text; $pill.className = 'badge ' + (cls || 'muted'); }
    function h(parts){ return parts.filter(Boolean).join(''); }

    function setApprovedHeader(){
      $pageTitle.textContent = 'Vínculo confirmado com a empresa';
      $pageSubtitle.innerHTML = 'Está tudo certo — você já pode concluir sua assinatura com segurança.';
    }
    function setDefaultHeader(){
      $pageTitle.textContent = 'Confirme seu vínculo com a empresa';
      $pageSubtitle.innerHTML = 'Para sua segurança e da empresa, precisamos validar que você está <strong>vinculado ao CNPJ</strong> ou tem <strong>autorização</strong>. É rápido e você só faz uma vez.';
    }

    function renderStatus(view){
      state.view = view;
      if (view === 'approved'){
        setApprovedHeader();
        pill('aprovado ✔', 'ok');
        $statusBox.innerHTML = h([
          '<p><strong>Seu vínculo está aprovado.</strong></p>',
          '<p class="muted small">Você já pode concluir a assinatura com segurança.</p>',
          '<p><a class="cta" href="/pages/ativar-cliente.html">Seguir para assinatura</a></p>'
        ]);
        $uploadBox.hidden = true;
        $btnSend.disabled = true;
        $uploadArea.setAttribute('aria-hidden','true');
        $uploadArea.style.pointerEvents = 'none';
        return;
      }
      if (view === 'pending'){
        setDefaultHeader();
        pill('em revisão', 'warn');
        $statusBox.innerHTML = '<p class="muted">Recebemos seus documentos e estamos analisando. Normalmente leva poucas horas úteis.</p>';
        $uploadBox.hidden = true;
        $btnSend.disabled = true;
        $uploadArea.setAttribute('aria-hidden','true');
        $uploadArea.style.pointerEvents = 'none';
        return;
      }
      if (view === 'needs'){
        setDefaultHeader();
        pill('documentos necessários', 'warn');
        $statusBox.innerHTML = '<p>Precisamos de documentos para confirmar seu vínculo com a empresa.</p>';
        $uploadBox.hidden = false;
        $btnSend.disabled = false;
        $uploadArea.removeAttribute('aria-hidden');
        $uploadArea.style.pointerEvents = '';
        return;
      }
      setDefaultHeader();
      pill('não foi possível verificar agora', 'err');
      $statusBox.innerHTML = '<p class="muted">Tente novamente em instantes. Se persistir, fale com o suporte.</p>';
      $uploadBox.hidden = true;
      $btnSend.disabled = true;
      $uploadArea.setAttribute('aria-hidden','true');
      $uploadArea.style.pointerEvents = 'none';
    }

    function mockStatus(){
      if (mock === 'approved') return { ok:true, body:{ stripe_enabled:true, reason:'ok' } };
      if (mock === 'pending') return { ok:true, body:{ pending_review:true, needs_docs:false, reason:'pending_review' } };
      if (mock === 'needs')   return { ok:true, body:{ pending_review:false, needs_docs:true, reason:'needs_docs' } };
      if (mock === 'error')   return { ok:false, status:500 };
      return null;
    }

    function asViewFromStatus(resp){
      const b = resp && resp.body ? resp.body : {};
      if (b.stripe_enabled || b.reason === 'ok' || b.aprovado) return 'approved';
      if (b.pending_review) return 'pending';
      if (b.needs_docs) return 'needs';
      return 'error';
    }

    function asViewFromGate(resp){
      const b = resp && resp.body ? resp.body : {};
      const stripe_enabled = !!(b.stripe_enabled || b.stripeEnabled || b.ok || b.gate_ok);
      const needs_docs = !!(b.needs_docs || b.needsDocs);
      if (stripe_enabled && !needs_docs) return 'approved';
      if (needs_docs) return 'needs';
      return null;
    }

    async function fetchJSON(url, opts){
      const r = await fetch(url, Object.assign({ credentials:'include' }, opts||{}));
      const ct = r.headers.get('content-type') || '';
      const body = ct.includes('application/json') ? await r.json() : await r.text();
      return { ok:r.ok, status:r.status, body };
    }

    async function loadStatus(){
      try{
        pill('verificando status…', 'muted');
        const mk = mockStatus();
        if (mk) { renderStatus(asViewFromStatus(mk)); return; }

        const respStatus = await fetchJSON(API.status).catch(()=>null);
        let view = (respStatus && respStatus.ok) ? asViewFromStatus(respStatus) : 'error';

        const respGate = await fetchJSON(API.gate).catch(()=>null);
        const gateView = (respGate && respGate.ok) ? asViewFromGate(respGate) : null;
        if (gateView === 'approved') view = 'approved';
        if (gateView === 'needs') view = 'needs';

        renderStatus(view);
      } catch(e){
        renderStatus('error');
      }
    }

    function renderFiles(){
      $fileList.innerHTML = '';
      state.files.forEach((f, idx) => {
        const li = document.createElement('li'); li.className='file-item';
        const meta = document.createElement('div'); meta.className='file-meta'; meta.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
        const rm = document.createElement('button'); rm.className='remove-btn'; rm.textContent='Remover';
        rm.addEventListener('click', ()=>{ state.files.splice(idx,1); renderFiles(); });
        li.appendChild(meta); li.appendChild(rm); $fileList.appendChild(li);
      });
    }

    function addFiles(list){
      let total = state.files.reduce((s,f)=>s+f.size,0);
      for (const f of list) {
        const okType = /pdf|png|jpg|jpeg/i.test(f.type) || /\.(pdf|png|jpg|jpeg)$/i.test(f.name);
        if (!okType) { $msg.textContent='Apenas PDF, JPG ou PNG.'; continue; }
        if (state.files.length >= 10) { $msg.textContent='Limite de 10 arquivos.'; break; }
        total += f.size;
        if (total > 25 * 1024 * 1024) { $msg.textContent='Limite total de 25MB por envio.'; break; }
        state.files.push(f);
      }
      renderFiles();
    }

    async function send(){
      if (state.view !== 'needs'){
        $msg.textContent = 'No momento não há necessidade de enviar documentos.';
        return;
      }
      if (!state.files.length){ $msg.textContent='Selecione ao menos um arquivo.'; return; }
      $btnSend.disabled = true; $msg.textContent='Enviando…';
      const fd = new FormData();
      state.files.forEach((f)=> fd.append('files[]', f, f.name));
      try{
        const r = await fetchJSON(API.upload, { method:'POST', body:fd });
        if (r.ok) {
          $msg.textContent='Recebido! Vamos revisar em breve.';
          state.files = []; renderFiles();
          renderStatus('pending');
        } else if (r.status === 401){
          $msg.textContent='Faça login para enviar documentos.';
          $btnSend.disabled = false;
        } else {
          $msg.textContent='Não foi possível enviar agora. Tente novamente.';
          $btnSend.disabled = false;
        }
      } catch(e){
        $msg.textContent='Falha de rede. Tente novamente.';
        $btnSend.disabled = false;
      }
    }

    $btnChoose.addEventListener('click', ()=> $docFiles.click());
    $btnClear .addEventListener('click', ()=> { state.files = []; renderFiles(); $msg.textContent=''; });
    $docFiles .addEventListener('change', (e)=> { if (e.target.files) addFiles(e.target.files); $docFiles.value=''; });
    $uploadArea.addEventListener('click', (e)=> { const t=e.target; if (t && t.closest && t.closest('.btn-mini')) return; $docFiles.click(); });
    $uploadArea.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    $uploadArea.addEventListener('drop', (e)=>{ e.preventDefault(); if (e.dataTransfer && e.dataTransfer.files) addFiles(e.dataTransfer.files); });

    $btnSend.addEventListener('click', send);
    document.addEventListener('DOMContentLoaded', loadStatus);
  })();
  </script>
</body>
</html>
