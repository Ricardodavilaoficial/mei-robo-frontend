<!doctype html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configura√ß√£o de comunica√ß√£o ‚Äî MEI Rob√¥</title>

  <link rel="canonical" href="https://www.meirobo.com.br/pages/configuracao.html" />
  <meta property="og:url" content="https://www.meirobo.com.br/pages/configuracao.html" />
  <meta name="twitter:url" content="https://www.meirobo.com.br/pages/configuracao.html" />

  <link rel="stylesheet" href="/assets/styles.css" />
  <script defer src="/assets/layout.js?v=2025-09-06-07"></script>

  <!-- ‚úÖ Firebase Hosting SDKs (necess√°rio para auth/token nesta p√°gina) -->
  <script defer src="/__/firebase/9.22.2/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/9.22.2/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/init.js"></script>
  <script>
    // Ajuste de idioma do e-mail/verifica√ß√µes, e log defensivo de inicializa√ß√£o
    window.addEventListener('load', () => {
      try {
        if (window.firebase?.apps?.length) {
          try { firebase.auth().languageCode = 'pt_BR'; } catch(_){}
          console.log('[configuracao] Firebase pronto (Hosting init).');
        } else {
          console.error('[configuracao] Firebase n√£o inicializou via Hosting.');
        }
      } catch (e) {
        console.error('[configuracao] Erro ao inicializar Firebase:', e);
      }
    });
  </script>

  <style>
    :root { --input-h: 48px; --input-br: 10px; --hint: .92rem; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    @media (max-width: 900px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    .mt-6{margin-top:6px}.mt-8{margin-top:8px}.mt-12{margin-top:12px}.mt-16{margin-top:16px}.mt-20{margin-top:20px}.mt-24{margin-top:24px}
    .w-100{width:100%}.hint{font-size:var(--hint);opacity:.9} form section{margin-top:18px} form label{display:block;margin:8px 0}

    :root {
      --bg-input: rgba(255,255,255,0.06);
      --bd-input: #374151;
      --fg-input: #e5e7eb;
      --ph-input: 0.55;
      --fg-display: #e5e7eb;
    }

    input[type="text"],input[type="email"],input[type="tel"],select{
      width:100%;height:var(--input-h);
      border:1px solid var(--bd-input);
      border-radius:var(--input-br);
      padding:0 12px;color:var(--fg-input);
      outline:none;box-sizing:border-box;background:var(--bg-input);
    }
    input::placeholder{opacity:var(--ph-input)}

    /* Ajuste visual da se√ß√£o de agenda: inputs no tema escuro */
    #agenda-form input[type="time"],
    #agenda-form input[type="number"],
    #agenda-form select {
      background: var(--bg-input);
      color: var(--fg-input);
      border-color: var(--bd-input);
    }

    .display-value{display:block;padding:10px 0 2px;font-weight:600;color:var(--fg-display);letter-spacing:.2px}
    .btn{padding:10px 14px;border:0;border-radius:8px;cursor:pointer}
    .btn.primary{background:#25D366;color:#fff}
    .btn.outline{background:transparent;border:1px solid var(--bd-input);color:#fff}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .card + .card{margin-top:16px}
    .pill{display:inline-block;font-size:.76rem;line-height:1;padding:5px 8px;border-radius:999px;vertical-align:middle;margin-left:8px}
    .pill-pending{background:#fff7e6;color:#8a5a00;border:1px solid #f5d08a}
    .pill-prov{background:#eef5ff;color:#0b63c9;border:1px solid #cfe0ff}
    .pill-active{background:#e8fff2;color:#116a3d;border:1px solid #25D366}
    .pill-failed{background:#feecec;color:#9b1c1c;border:1px solid #fecaca}
    .branding-options { display:grid; gap:10px; }
    .branding-option { display:flex; align-items:flex-start; gap:10px; padding:10px; border:1px solid var(--bd-input); border-radius:10px; background:rgba(255,255,255,0.03); }
    .branding-option small { opacity:.8 }
    .soft{opacity:.8}

    .upload-area{
      border:1px dashed var(--bd-input);
      border-radius:12px;
      padding:16px;
      background:rgba(255,255,255,0.03);
    }
    .upload-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px }
    .file-list{ list-style:none; padding:0; margin:12px 0 0 }
    .file-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; background:rgba(255,255,255,0.04); border:1px solid var(--bd-input); border-radius:10px; padding:8px 12px; margin:6px 0 }
    .file-meta{ font-size:.95rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:#e9f4f1 }
    .remove-btn{ background:transparent; border:1px solid #8a3a3a; color:#ffbdbd; border-radius:999px; padding:6px 10px; font-weight:800; cursor:pointer }
    .progress-wrap{ margin-top:8px }
    .progress{ width:100%; height:8px; background:rgba(255,255,255,0.08); border-radius:999px; overflow:hidden }
    .progress > span{ display:block; height:100%; width:0% }

    #authStatus { margin:8px 0 0; font-size:.9rem; opacity:.85 }
  </style>

  <script>
    window.API_BASE = "https://mei-robo-prod.onrender.com";
  </script>

<style id="vozwa-simple-css">
  /* UX simples: Voz via WhatsApp */
  #vozWaCode, #vozWaMsgReady, #btnVozWaCopiar, #btnVozWaAbrir, #btnVozWaRecarregar, #btnVozWaRefazer { display:none !important; }
</style>

</head>
<body>
  <div id="app-header"></div>

  <main class="container">
    <div class="card">
      <h2>Configura√ß√£o de comunica√ß√£o</h2>
      <p id="authStatus" class="hint"></p>
      <p class="hint">Como voc√™ fala com as pessoas no WhatsApp. Capriche aqui: isso aumenta respostas, or√ßamentos e fechamentos.</p>
      <p class="hint mt-8">Este √© o <strong>padr√£o geral</strong>. Depois d√° pra ajustar por contato.</p>

      <!-- Bloco opcional: aparece apenas se faltar CNPJ -->
      <section id="cnpjInlineForm" class="card-dark" style="display:none; padding:12px; margin:12px 0;">
        <h3 style="margin:0 0 6px;">Informe seu CNPJ</h3>
        <div class="hint" style="margin:4px 0 10px;">Usamos o CNPJ para preencher seus dados automaticamente.</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input id="cnpjInput" class="input" type="text" inputmode="numeric" maxlength="18"
                 placeholder="00.000.000/0000-00" style="min-width:220px;">
          <button id="btnSalvarCnpj" class="cta">Salvar CNPJ</button>
          <span id="cnpjMsg" class="hint"></span>
        </div>
      </section>

      <form id="config-form" class="mt-16" novalidate>
        <section id="sec-waba">
          <h3>WhatsApp Business - Conta comercial com MEI Rob√¥ - <span id="waba-badge" class="pill pill-pending">em valida√ß√£o</span></h3>
          <p id="waba-fixed" class="hint mt-6">
            Voc√™ receber√° um <strong>n√∫mero novo do WhatsApp Business</strong> (virtual, <strong>sem chip</strong>), adequado para conta comercial.
            Voc√™ pode manter seus n√∫meros atuais, <strong>acrescentando o novo n√∫mero e mantendo a mesma forma que voc√™ j√° utiliza</strong>;
            o rob√¥ usar√° este n√∫mero quando estiver <strong>Ativo</strong>. A libera√ß√£o acontece ap√≥s a <strong>configura√ß√£o e implanta√ß√£o pelo MEI Rob√¥</strong>,
            em at√© <strong>7 dias √∫teis</strong>.
          </p>
          <p id="waba-note" class="hint"></p>
          <p id="waba-eta" class="hint"></p>
        </section>

        <section class="mt-20">
          <h3>Dados da conta</h3>
          <div class="grid-2">
            <div>
              <label>Nome</label>
              <span id="disp-nome" class="display-value">‚Äî</span>
              <input type="hidden" name="nome" id="hid-nome" />
            </div>
            <div>
              <label>E-mail</label>
              <span id="disp-email" class="display-value">‚Äî</span>
              <input type="hidden" name="email" id="hid-email" />
            </div>

            <label>Seu WhatsApp (para notifica√ß√µes)
              <input type="tel" name="telefone" autocomplete="tel" placeholder="Ex.: +55 11 91234-5678" />
              <span class="hint">Usaremos este n√∫mero para avisos e testes. O n√∫mero do MEI Rob√¥ ser√° configurado depois.</span>
            </label>

            <div>
              <label>CNPJ</label>
              <span id="disp-cnpj" class="display-value">‚Äî</span>
              <input type="hidden" name="cnpj" id="hid-cnpj" />
              <span class="hint soft">CNPJ vinculado √† conta. Para alterar, fale com o suporte.</span>
            </div>
          </div>

          <div class="grid-2 mt-12">
            <div>
              <label>Raz√£o Social (legal)</label>
              <span id="disp-legalname" class="display-value">‚Äî</span>
              <input type="hidden" name="legal_name" id="hid-legalname" />
            </div>
            <div>
              <label>Nome Fantasia</label>
              <span id="disp-tradename" class="display-value">‚Äî</span>
              <input type="hidden" name="trade_name" id="hid-tradename" />
            </div>
          </div>

          <!-- Campos adicionados para exibi√ß√£o somente-leitura (m√≠nimo necess√°rio) -->
          <div class="grid-2 mt-12">
            <div>
              <label>Situa√ß√£o</label>
              <span id="disp-situacao" class="display-value">‚Äî</span>
              <input type="hidden" id="hid-situacao" />
            </div>
            <div>
              <label>Abertura</label>
              <span id="disp-abertura" class="display-value">‚Äî</span>
              <input type="hidden" id="hid-abertura" />
            </div>
          </div>

          <div class="mt-12">
            <label>Endere√ßo</label>
            <span id="disp-endereco" class="display-value">‚Äî</span>
            <input type="hidden" id="hid-endereco" />
          </div>
          
          <!-- PATCH 1 ‚Äì par√°grafo substitu√≠do -->
          <p class="hint mt-8">
            A aprova√ß√£o do n√∫mero de WhatsApp do MEI Rob√¥ depende de voc√™ estar vinculado(a) ao CNPJ informado e,
            quando n√£o for titular ou s√≥cio(a), ter autoriza√ß√£o formal da empresa. Usamos os dados p√∫blicos da Receita Federal
            para conferir o CNPJ e, durante a implanta√ß√£o (at√© 7 dias √∫teis), podemos confirmar automaticamente o v√≠nculo do respons√°vel
            e bloquear a conta em caso de ind√≠cios de uso indevido.
          </p>

          <p id="cnpj-vinculo-hint" class="hint mt-8"></p>

          <!-- üîí Declara√ß√£o de Autoriza√ß√£o (colada no aviso de v√≠nculo do CNPJ) -->
          <div id="autorizacao-container" style="margin-top: 12px;">
            <label style="display:flex;align-items:flex-start;gap:8px;cursor:pointer;">
              <input id="autorizacaoCNPJ" type="checkbox" style="margin-top:4px;" />
              <span style="font-size:14px;color:#ddd;line-height:1.4;">
                Se voc√™ n√£o for o dono(a) ou s√≥cio(a) do CNPJ, precisa estar autorizado(a)
                pela empresa para usar o MEI Rob√¥. 
                <strong>Para seguir com este CNPJ, confirme que voc√™ est√° autorizado(a).</strong>
              </span>
            </label>
            <div id="autorizacaoErro" style="color:#ff6b6b;font-size:13px;display:none;margin-top:6px;">
              Para continuar, confirme que voc√™ est√° autorizado(a) pela empresa.
              Sem isso, a tela de avan√ßo fica bloqueada.
            </div>
          </div>

          <!-- Bloco extra: s√≥ aparece quando houver d√∫vida de v√≠nculo -->
          <div id="vinculo-extra-wrapper" class="mt-8" hidden>
            <div class="mt-4">
              <label for="cpf-responsavel">CPF de quem declara autoriza√ß√£o</label>
              <input
                id="cpf-responsavel"
                class="input"
                inputmode="numeric"
                autocomplete="off"
                placeholder="Digite apenas n√∫meros"
                maxlength="14"
              />
              <p class="hint">
                Usamos apenas para registrar quem declarou estar autorizado(a) a contratar o MEI Rob√¥ em nome da empresa.
                N√£o compartilhamos este dado com terceiros.
              </p>
            </div>

            <label class="mt-4" style="display:flex;gap:8px;align-items:flex-start;">
              <input type="checkbox" id="chk-vinculo-autorizado" />
              <span>Sou autorizado(a) pela empresa a prosseguir.</span>
            </label>

            <p id="vinculo-extra-erro" class="hint" style="color:#ffbdbd;display:none;"></p>
          </div>
        </section>

        <section>
          <h3>Como seu neg√≥cio deve aparecer para os clientes?</h3>
          <div class="branding-options" id="branding-options">
            <label class="branding-option">
              <input type="radio" name="branding_choice" value="trade_name" />
              <div>
                <div><strong>Usar Nome Fantasia</strong> <small>(se existir)</small></div>
                <div class="hint">Aparece em mensagens, or√ßamentos e materiais.</div>
              </div>
            </label>

            <label class="branding-option">
              <input type="radio" name="branding_choice" value="legal_name" />
              <div>
                <div><strong>Usar Raz√£o Social</strong></div>
                <div class="hint">Op√ß√£o conservadora, costuma bater com cadastros oficiais.</div>
              </div>
            </label>

            <label class="branding-option">
              <input type="radio" name="branding_choice" value="custom" />
              <div class="w-100">
                <div><strong>Definir um nome personalizado</strong></div>
                <input type="text" name="public_brand" id="public_brand" placeholder="Ex.: Ed Barba" class="mt-8" />
                <div class="hint mt-6">Esse nome aparece para seus clientes. Documentos fiscais continuam com a Raz√£o Social.</div>
              </div>
            </label>
          </div>
        </section>

        <section>
          <h3>Segmento profissional</h3>
          <div class="grid-2">
            <div>
              <label>Segmento (CNAE)</label>
              <span id="disp-segmento" class="display-value">‚Äî</span>
              <input type="hidden" name="segmento" id="hid-segmento" />
            </div>
            <label>√Årea que voc√™ mais atua
              <input type="text" name="esp1" placeholder="Ex.: Pneus / Corte masculino / Direito trabalhista" />
            </label>
            <label>Outra √°rea de atua√ß√£o (opcional)
              <input type="text" name="esp2" placeholder="Ex.: Troca de √≥leo / Barba / Contratos" />
            </label>
          </div>
        </section>

        <section>
          <h3>Seu jeito de falar</h3>
          <p class="hint">Defina o estilo que voc√™ costuma usar com a maioria dos clientes. Depois d√° pra personalizar por contato.</p>

          <div class="grid-3">
            <label>Formalidade
              <select name="formalidade">
                <option value="alta">Alta ‚Äî ‚ÄúPrezado Sr. Jo√£o‚Ä¶‚Äù</option>
                <option value="media" selected>M√©dia ‚Äî ‚ÄúOl√°, Jo√£o, tudo bem?‚Äù</option>
                <option value="baixa">Baixa ‚Äî ‚ÄúE a√≠, Jo√£o, beleza?‚Äù</option>
              </select>
            </label>
            <label>Usa emojis?
              <select name="emojis">
                <option value="sim" selected>Sim</option>
                <option value="as_vezes">√Äs vezes</option>
                <option value="nao">N√£o</option>
              </select>
            </label>
            <label>Sauda√ß√£o preferida
              <input type="text" name="saudacao" placeholder="Ex.: Ol√°! Tudo bem? / Bom dia! Como vai?" />
            </label>
          </div>

          <div class="grid-2 mt-12">
            <label>Como voc√™ costuma ser chamado?
              <input type="text" name="display_name" placeholder="Ex.: Ricardo / Ricardo ‚Äî Barbeiro / Dr. Ricardo / Ricard√£o üòé" />
              <span class="hint">Esse √© o nome que aparece nas mensagens, quando necess√°rio. Voc√™ pode mudar por contato depois.</span>
            </label>
            <label>Fechamento de conversa (opcional)
              <input type="text" name="closing_text" placeholder="Ex.: Abra√ßo. Ricardo / Obrigado! Ricardo" />
              <span class="hint">Usado s√≥ quando fizer sentido.</span>
            </label>
          </div>

          <div class="grid-2 mt-12">
            <label>Hor√°rio de resposta padr√£o
              <select name="janela_resposta" id="janela_resposta">
                <option value="24x7" selected>Sempre dispon√≠vel (24/7 ‚Äî padr√£o do MEI Rob√¥)</option>
                <option value="comercial">Hor√°rio comercial (Seg‚ÄìSex, 9h‚Äì18h)</option>
                <option value="estendido">Estendido (Seg‚ÄìS√°b, 8h‚Äì20h)</option>
                <option value="custom">Personalizado‚Ä¶</option>
              </select>
            </label>
          </div>
          <div id="custom-horario" class="mt-8" style="display:none">
            <label>Informe seu hor√°rio (livre)
              <input type="text" name="janela_resposta_custom" placeholder="Ex.: Respondo das 9h √†s 18h e, √†s vezes, at√© 22h" />
            </label>
          </div>
        </section>

        <!-- ====== Voz (upload/grava√ß√£o + progresso + polling) ====== -->
        <section class="mt-24" id="sec-voz">
          <h3>Sua voz (obrigat√≥rio) ‚Äî envio pelo WhatsApp</h3>
          <p class="hint">
            Para o MEI Rob√¥ falar com a sua voz, voc√™ vai enviar √°udios <strong>pelo WhatsApp</strong>.
            Aqui a gente s√≥ te guia e mostra o status. (Sem anexar arquivos por aqui.)
          </p>

          
<!-- REMOVIDO: bloco legado de voz (upload/grava√ß√£o) -->

          <!-- ====== Voz via WhatsApp (v1.0) ‚Äî UI nova ====== -->
<div class="upload-area" id="vozWaArea" style="margin-top:12px;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <div>
      <strong>Sua voz (pelo WhatsApp)</strong>
      <span id="vozWaBadge" class="pill pill-pending">aguardando</span>
      <div class="hint mt-6">
        √â simples: clique no bot√£o abaixo, o WhatsApp vai abrir no seu celular. A√≠ √© s√≥ mandar <strong>um √°udio de 1‚Äì2 minutos</strong> falando normal.
      </div>
      <div class="hint mt-6" style="opacity:.85">
        Dica r√°pida: diga seu nome, seu servi√ßo e como voc√™ atende um cliente (‚ÄúOi! Aqui √© o ...‚Äù).
      </div>
      <div id="vozWaErroHumano" class="hint" style="display:none; margin-top:8px;"></div>
    </div>
    <div class="hint" style="opacity:.85">
      <div><strong>Status:</strong> <span id="vozWaStatusText">Aguardando</span></div>
      <div><small id="vozWaUpdatedAt"></small></div>
    </div>
  </div>

  <div class="upload-actions mt-12">
    <button type="button" class="btn primary" id="btnVozWaGerar">ENVIAR MINHA VOZ NO WHATSAPP</button>
  </div>

  <audio id="vozWaPlayer" controls style="display:none; margin-top:10px; width:100%"></audio>
</div>

<!-- ====== /Voz via WhatsApp ====== -->

        </section>

        <!-- PATCH 1: esconder bot√£o antigo de salvar/continuar -->
        <div class="mt-24">
          <!-- Bot√£o antigo de avan√ßar foi desativado; a jornada segue agora pela agenda. -->
          <button id="btn-salvar" type="button" class="btn primary" style="display:inline-flex">Salvar e continuar</button>
          <span id="config-feedback" class="hint mt-8" style="margin-left:8px;"></span>
        </div>
      </form>


    <!-- Configura√ß√£o da agenda (form + resumo) -->
    <section class="card" style="margin-top:14px;">
      <strong>Configura√ß√£o da agenda do MEI Rob√¥</strong>
      <p class="note" style="margin:6px 0 10px;">
        Estas s√£o as regras que o MEI Rob√¥ usa para sugerir hor√°rios aos seus clientes.
        Ajuste abaixo os dias, hor√°rios e a anteced√™ncia m√≠nima.
      </p>

      <div id="agenda-alert" class="hint" style="margin-bottom:8px;"></div>

      <div id="agenda-summary" class="card" style="margin:10px 0 12px; padding:12px 14px; background:#0d0f10; border:1px solid #333; border-radius:14px;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
    <div>
      <strong>Seu hor√°rio de atendimento (padr√£o)</strong>
      <div class="hint" id="agenda-summary-text" style="margin-top:6px;">Seg‚ÄìSex, 09:00‚Äì18:00 (voc√™ pode editar)</div>
    </div>
    <button type="button" class="btn outline" id="btnAgendaEditar">Editar</button>
  </div>
</div>
<form id="agenda-form" class="mt-12" style="display:none;">
        <label class="hint" style="margin-bottom:4px;">Dias de atendimento</label>
        <div class="grid-3" style="margin-bottom:10px;">
          <label><input type="checkbox" name="diasAtendimento" value="seg" /> Seg</label>
          <label><input type="checkbox" name="diasAtendimento" value="ter" /> Ter</label>
          <label><input type="checkbox" name="diasAtendimento" value="qua" /> Qua</label>
          <label><input type="checkbox" name="diasAtendimento" value="qui" /> Qui</label>
          <label><input type="checkbox" name="diasAtendimento" value="sex" /> Sex</label>
          <label><input type="checkbox" name="diasAtendimento" value="sab" /> S√°b</label>
          <label><input type="checkbox" name="diasAtendimento" value="dom" /> Dom</label>
        </div>

        <div class="grid-3">
          <label>In√≠cio do atendimento
            <input type="time" name="atendimentoInicio" required />
          </label>
          <label>Fim do atendimento
            <input type="time" name="atendimentoFim" required />
          </label>
          <label>Intervalo entre hor√°rios
            <select name="intervaloMin">
              <option value="15">15 minutos</option>
              <option value="30">30 minutos</option>
              <option value="45">45 minutos</option>
              <option value="60">60 minutos</option>
            </select>
          </label>
        </div>

        <div class="grid-3 mt-12">
          <label>Anteced√™ncia m√≠nima (dias)
            <input type="number" name="antecedenciaMinDias" min="0" max="365" step="1" />
          </label>
        </div>

        <div class="mt-12">
          <!-- PATCH 4: renomear bot√£o da agenda -->
          <button id="agenda-save-btn" type="submit" class="btn outline">Salvar e continuar</button>
        </div>
      </form>

      <hr style="margin:16px 0; border-color:rgba(255,255,255,0.08);" />

      <div id="dashboard-cta" class="mt-16" style="display:none;">
        <p class="hint" style="margin-bottom:6px;">
          Configura√ß√£o inicial conclu√≠da. Quando quiser, voc√™ pode voltar para o painel principal por aqui.
        </p>
        <button id="btn-dashboard" type="button" class="btn primary">
          Ir para o painel
        </button>
      </div>

      <ul class="list muted" id="agendaConfigResumo">
        <li>Carregando configura√ß√£o da agenda‚Ä¶</li>
      </ul>
      <p class="hint" style="margin-top:6px;">
        O MEI Rob√¥ usa essas regras sempre que um cliente pedir hor√°rio pelo WhatsApp.
        Voc√™ pode voltar aqui e ajustar a agenda a qualquer momento.
      </p>
    </section>

    <!-- PATCH 3: CTA para voltar ao painel (aparece s√≥ depois da configura√ß√£o inicial conclu√≠da) -->
    <section id="config-done-panel" class="card" style="margin-top:14px; display:none;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
        <div>
          <strong>Tudo certo com a sua configura√ß√£o.</strong>
          <p class="hint mt-6">
            Se voc√™ s√≥ queria ajustar alguma coisa, pode voltar para o painel do MEI Rob√¥ quando quiser.
          </p>
        </div>
        <div>
          <button id="btn-go-dashboard" type="button" class="btn primary">
            Ir para o painel do MEI Rob√¥
          </button>
        </div>
      </div>
    </section>
  </main>

  <div id="app-footer"></div>

  <script>
    // üîß Ajuste: prioriza window.API_BASE (se j√° definido) e mant√©m fallback para localStorage/config padr√£o
    console.log('[configuracao] v2025-12-09-b (com stripe gate heuristico)');
    const API_BASE = (window.API_BASE || localStorage.getItem('apiBase') || 'https://mei-robo-prod.onrender.com').replace(/\/+$/, '');

    // === REMOVIDO: enforceVerifiedEmail baseado em check-verification, para evitar ping-pong com outras telas ===
    // O controle principal de verifica√ß√£o de e-mail fica no fluxo cadastro.html + backend.

    /* ===== Gatekeeper robusto ===== */
    const authStatus = document.getElementById('authStatus');
    function setAuthMsg(t){ authStatus.textContent = t || ''; }

    function waitForFirebaseAuthReady(timeoutMs=12000){
      return new Promise(res=>{
        const start=Date.now();
        (function loop(){
          const ok = !!(window.firebase && firebase.apps && firebase.apps.length && firebase.auth);
          if (ok) return res(true);
          if (Date.now()-start > timeoutMs) return res(false);
          setTimeout(loop, 60);
        })();
      });
    }

    function waitForUser(timeoutMs=12000){
      return new Promise(res=>{
        const auth = firebase.auth();
        const u = auth.currentUser;
        if (u) return res(u);
        let done=false;
        const t = setTimeout(()=>{ if(!done){ done=true; unsub(); res(null); } }, timeoutMs);
        const unsub = auth.onAuthStateChanged(async user=>{
          if (done) return;
          done=true; clearTimeout(t); unsub();
          res(user||null);
        });
      });
    }

    async function refreshTokenSafe(user){
      try { await user.getIdToken(true); } catch(_) {}
    }

    // üîß NOVO: garante apenas que o usu√°rio est√° logado. N√£o redireciona mais para verify-email.html.
    async function ensureVerifiedOrSendBack(){
      const okSdk = await waitForFirebaseAuthReady();
      if (!okSdk){
        setAuthMsg('Servi√ßo de autentica√ß√£o indispon√≠vel. Recarregue a p√°gina.');
        return false;
      }

      let user = firebase.auth().currentUser;
      if (!user){
        setAuthMsg('Conectando‚Ä¶');
        user = await waitForUser(8000);
      }

      if (!user){
        setAuthMsg('Sess√£o n√£o encontrada. Redirecionando ao login‚Ä¶');
        location.href = '/pages/login.html?next=' + encodeURIComponent('/pages/configuracao.html');
        return false;
      }

      try { await user.reload(); } catch(_) {}
      await refreshTokenSafe(user);

      // N√£o vamos mais checar user.emailVerified aqui. O backend j√° protege o que for necess√°rio.
      setAuthMsg('');
      return true;
    }

    /* ===== Utilit√°rios ===== */
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[s])); }
    function formatDateBR(iso){ try { const d=new Date(iso); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}` } catch(_){ return iso; } }
    function onlyDigits(s){ return String(s||'').replace(/\D+/g,''); }
    
    function toE164(raw){
      const s = String(raw||'').trim();
      if (!s) return null;
      const d = onlyDigits(s);
      if (!d) return null;

      // se j√° veio com +, respeita
      if (s.startsWith('+')) return '+' + d;

      // se j√° tem DDI 55
      if (d.startsWith('55') && (d.length === 12 || d.length === 13)) return '+' + d;

      // se veio s√≥ DDD+numero (10 ou 11 d√≠gitos)
      if (d.length === 10 || d.length === 11) return '+55' + d;

      return null;
    }
    

    // === Valida√ß√£o simples de CNPJ ===
    function isValidCNPJ(cnpj){
      cnpj = onlyDigits(cnpj||'');
      if (cnpj.length !== 14) return false;
      // rejeita CNPJs com todos os d√≠gitos iguais (000..., 111..., etc.)
      if (/^(\d)1{13}$/.test(cnpj)) return false;
      let t = 12, d1 = 0, d2 = 0, p1 = 5, p2 = 6;
      for (let i = 0; i < t; i++) {
        const n = parseInt(cnpj[i],10);
        d1 += n * p1; d2 += n * p2;
        p1 = (p1===2)?9:p1-1; p2 = (p2===2)?9:p2-1;
      }
      d1 = 11 - (d1 % 11); if (d1 > 9) d1 = 0;
      d2 += d1 * 2; d2 = 11 - (d2 % 11); if (d2 > 9) d2 = 0;
      return (parseInt(cnpj[12],10) === d1) && (parseInt(cnpj[13],10) === d2);
    }

    const form = document.getElementById('config-form');
    const cfgFeedback = document.getElementById('config-feedback');
    const btnSalvar = document.getElementById('btn-salvar');

    const dNome  = document.getElementById('disp-nome');
    const dEmail = document.getElementById('disp-email');
    const dCnpj  = document.getElementById('disp-cnpj');
    const dSeg   = document.getElementById('disp-segmento');
    const dLegal = document.getElementById('disp-legalname');
    const dTrade = document.getElementById('disp-tradename');
    const dSitu  = document.getElementById('disp-situacao');
    const dAber  = document.getElementById('disp-abertura');
    const dEnd   = document.getElementById('disp-endereco');

    const hNome  = document.getElementById('hid-nome');
    const hEmail = document.getElementById('hid-email');
    const hCnpj  = document.getElementById('hid-cnpj');
    const hSeg   = document.getElementById('hid-segmento');
    const hLegal = document.getElementById('hid-legalname');
    const hTrade = document.getElementById('hid-tradename');
    const hSitu  = document.getElementById('hid-situacao');
    const hAber  = document.getElementById('hid-abertura');
    const hEnd   = document.getElementById('hid-endereco');

    const fTel   = form.querySelector('input[name="telefone"]');
    const fEsp1  = form.querySelector('input[name="esp1"]');
    const fEsp2  = form.querySelector('input[name="esp2"]');
    const fFormal= form.querySelector('select[name="formalidade"]');
    const fEmojis= form.querySelector('select[name="emojis"]');
    const fSaud  = form.querySelector('input[name="saudacao"]');
    const fDisp  = form.querySelector('input[name="display_name"]');
    const fClose = form.querySelector('input[name="closing_text"]');
    const fJanela= document.getElementById('janela_resposta');
    const wrapCustom = document.getElementById('custom-horario');
    const fJanelaCustom = form.querySelector('input[name="janela_resposta_custom"]');

    const brandingOptions = document.getElementsByName('branding_choice');
    const fPublicBrand = document.getElementById('public_brand');

    const wabaBadge = document.getElementById('waba-badge');
    const wabaNote  = document.getElementById('waba-note');
    const wabaEta   = document.getElementById('waba-eta');

    const cnpjVinculoHint = document.getElementById('cnpj-vinculo-hint');

    // Autoriza√ß√£o leve quando n√£o conseguimos confirmar o v√≠nculo pelo nome
    const autorizacaoCheckbox = document.getElementById('autorizacaoCNPJ');
    const autorizacaoErro = document.getElementById('autorizacaoErro')
    
    const cnpjForm = document.getElementById('cnpjInlineForm');
    const cnpjInput = document.getElementById('cnpjInput');
    const btnSalvarCnpj = document.getElementById('btnSalvarCnpj');
    const cnpjMsg = document.getElementById('cnpjMsg');

    // Agenda DOM
    const agendaResumoEl = document.getElementById('agendaConfigResumo');
    const agendaFormEl = document.getElementById('agenda-form');

    // Agenda (modo simples): 1 clique para "hor√°rio comercial" e um bot√£o para abrir detalhes
    const btnAgendaPreset = document.getElementById('btnAgendaPreset');
    const btnAgendaToggle = document.getElementById('btnAgendaToggle');
    if (agendaFormEl && agendaResumoEl) {
      // come√ßa compacto: mostra resumo e esconde o "painel de avi√£o"
      agendaFormEl.style.display = 'none';

      if (btnAgendaToggle) {
        btnAgendaToggle.onclick = () => {
          const open = (agendaFormEl.style.display !== 'none');
          agendaFormEl.style.display = open ? 'none' : 'block';
          btnAgendaToggle.textContent = open ? 'Editar detalhes' : 'Fechar detalhes';
        };
      }

      if (btnAgendaPreset) {
        btnAgendaPreset.onclick = async () => {
          try {
            // seg‚Äìsex, 09:00‚Äì18:00, intervalo 30, anteced√™ncia 0
            agendaFormEl.querySelectorAll('input[name="diasAtendimento"]').forEach(el => {
              const v = (el.value || '').toLowerCase();
              el.checked = (v === 'seg' || v === 'ter' || v === 'qua' || v === 'qui' || v === 'sex');
            });
            const fIni = agendaFormEl.querySelector('input[name="atendimentoInicio"]');
            const fFim = agendaFormEl.querySelector('input[name="atendimentoFim"]');
            const fInt = agendaFormEl.querySelector('select[name="intervaloMin"]');
            const fAnt = agendaFormEl.querySelector('input[name="antecedenciaMinDias"]');
            if (fIni) fIni.value = '09:00';
            if (fFim) fFim.value = '18:00';
            if (fInt) fInt.value = '30';
            if (fAnt) fAnt.value = '0';

            // salva usando o fluxo existente (sem reinventar)
            if (typeof salvarAgendaConfig === 'function') {
              await salvarAgendaConfig(new Event('submit'));
            } else {
              // fallback: dispara submit do form
              agendaFormEl.requestSubmit();
            }

            // volta pro modo compacto
            agendaFormEl.style.display = 'none';
            if (btnAgendaToggle) btnAgendaToggle.textContent = 'Editar detalhes';
          } catch(e) {
            console.debug('[agenda] preset failed', e);
          }
        };
      }
    }
    const agendaAlertEl = document.getElementById('agenda-alert');
    const agendaSaveBtn = document.getElementById('agenda-save-btn');
    let currentAgendaConfig = null;
    let agendaSavedOk = false; // ‚úÖ usamos isso para saber se a agenda j√° foi salva nesta jornada
    let destinoPosConfig = '/pages/ativar-cliente.html'; // default: onboarding ainda em andamento
    let contaAtiva = false; // üî¥ NOVO: ser√° preenchido com base em /api/conta/status

    // Indica se o usu√°rio chegou aqui vindo do dashboard
    let veioDoDashboard = false;

    function detectarOrigemDashboard() {
      // 1) Querystring: ?from=dashboard ou ?origem=dashboard
      try {
        const params = new URLSearchParams(window.location.search || '');
        const from = (params.get('from') || params.get('origem') || '').toLowerCase();
        if (from === 'dashboard') {
          return true;
        }
      } catch (_) {}

      // 2) Fallback: referrer contendo /pages/dashboard.html
      try {
        const ref = document.referrer || '';
        if (ref.includes('/pages/dashboard.html')) {
          return true;
        }
      } catch (_) {}

      return false;
    }

    // PATCH 3 ‚Äî CTA de voltar ao painel
    const panelDoneEl = document.getElementById('config-done-panel');
    const btnGoDashboard = document.getElementById('btn-go-dashboard');

    // Bot√£o de retorno ao painel (vers√£o antiga, hoje n√£o √© mais usada)
    const dashCta = document.getElementById('dashboard-cta');
    const dashBtn = document.getElementById('btn-dashboard');

    fJanela.addEventListener('change', () => {
      wrapCustom.style.display = (fJanela.value === 'custom') ? 'block' : 'none';
    });

    function selectBranding(choice){
      for (const r of brandingOptions) r.checked = (r.value === choice);
      if (choice === 'custom') fPublicBrand.removeAttribute('disabled');
      else fPublicBrand.setAttribute('disabled','disabled');
    }

    function initBranding(data){
      const legal = data.legal_name || '';
      const trade = data.trade_name || '';
      hLegal.value = legal; dLegal.textContent = legal || '‚Äî';
      hTrade.value = trade; dTrade.textContent = trade || '‚Äî';

      const choice = data.branding_choice || (trade ? 'trade_name' : 'legal_name');
      const custom = data.public_brand || '';
      selectBranding(choice);
      if (custom) fPublicBrand.value = custom;
      if (choice !== 'custom') fPublicBrand.value = custom || '';
    }

    async function getAuthContext() {
      let idToken = null;
      let uid = null;
      if (window.firebase && firebase.auth && firebase.auth().currentUser) {
        const user = firebase.auth().currentUser;
        uid = user.uid;
        try { idToken = await user.getIdToken(true); } catch(_) {}
      }
      return { uid, idToken };
    }
    
        /* ===== Voz via WhatsApp (constantes v1.0) ===== */
    // FASE 1 (ISOLAMENTO): Voz N√ÉO roda nesta p√°gina. Esta UI aqui √© apenas vitrine.
    // A configura√ß√£o obrigat√≥ria de voz acontece em /pages/configuracao_voz.html
    window.__VOZWA_DISABLED_IN_CONFIG__ = !!window.__VOICE_DISABLED_IN_CONFIG__;
    if (window.__VOZWA_DISABLED_IN_CONFIG__) {
      (function(){
        const go = ()=>{ try{ window.location.href = '/pages/configuracao_voz.html'; }catch(e){} };
        const ids = [
          'btnVozWaGerar','btnVozWaCopiar','btnVozWaAbrir',
          'btnVozWaGerar2','btnVozWaCopiar2','btnVozWaAbrir2',
          'btnVozWaCopy','btnVozWaOpen','btnVozWaOpen2'
        ];
        for (const id of ids){
          const el = document.getElementById(id);
          if (!el) continue;
          el.onclick = go;
          // mant√©m clic√°vel: serve apenas para levar pra pr√≥xima etapa
          if (typeof el.disabled !== 'undefined') el.disabled = false;
        }
        const st = document.getElementById('vozWaStatus') || document.getElementById('voiceStatus');
        if (st) st.innerHTML = 'A voz √© configurada na pr√≥xima etapa.';
        console.log('[configuracao] voz isolada (Fase 1).');
      })();
    }
window.VOICE_WA_NUMBER_E164 = window.VOICE_WA_NUMBER_E164 || '+5551985648608'; // trocar aqui quando virar oficial // ‚ö†Ô∏è trocar em 2‚Äì3 dias aqui e s√≥ aqui

    
    // estado novo (a ‚Äúverdade‚Äù da voz agora vem do backend)
    const vozWaState = {
      // dados necess√°rios pro fluxo
      waNumberE164: null,   // vem de /api/voz/whatsapp/config
      toE164: null,         // vem do input name="telefone" (config do MEI)
      code: '',             // c√≥digo para WhatsApp, gerado por /api/voz/whatsapp/invite

      // status do fluxo
      status: 'waiting',    // pode ser: waiting | receiving | processing | ready | failed
      ready: false,         // vai ser atualizado depois de /status (backend)

      polling: false,       // controle de requisi√ß√£o (para n√£o ficar repetindo)
      stop: false,          // controle de fluxo (caso a opera√ß√£o precise ser abortada)
      lastError: '',        // erro registrado
      lastUrl: '',          // √∫ltima URL (para logs ou debug)
    };

    /* ===== Voz ===== */
    // ===== Voz via WhatsApp (v1.0) ‚Äî constantes e DOM =====


async function _fetchVozWaConfig(){
  try {
    const ctx = await getAuthContext();
    const tok = ctx?.idToken || (typeof idToken !== 'undefined' ? idToken : null);

    const headers = {};
    if (tok) headers['Authorization'] = 'Bearer ' + tok;

    const r = await fetch('/api/voz/whatsapp/config', { method:'GET', headers, cache:'no-store' });
    const j = await r.json().catch(()=> ({}));
    if (r.ok && j && j.ok) {
      vozWaState.waNumberE164 = String(j.waNumberE164 || '').trim() || null;
      return j;
    }
  } catch(_) {}
  return null;
}



/* =========================================================
 * Voz do MEI via WhatsApp ‚Äî UI simples (1 bot√£o) + status
 * - Sem upload local
 * - Usa backend:
 *   GET  /api/voz/whatsapp/config
 *   GET  /api/voz/whatsapp/status
 *   POST /api/voz/whatsapp/invite
 *   POST /api/voz/whatsapp/reset (opcional/avan√ßado)
 * ========================================================= */

window.vozWaEls = {
  area: document.getElementById('vozWaArea'),
  badge: document.getElementById('vozWaBadge'),
  statusText: document.getElementById('vozWaStatusText'),
  updatedAt: document.getElementById('vozWaUpdatedAt'),

  // (mantemos no DOM pra compat, mas escondemos no modo simples)
  code: document.getElementById('vozWaCode'),
  msgReady: document.getElementById('vozWaMsgReady'),
  codeHint: document.getElementById('vozWaCodeHint'),
  erroHumano: document.getElementById('vozWaErroHumano'),

  btnGerar: document.getElementById('btnVozWaGerar'),         // vira o bot√£o √∫nico
  btnCopiar: document.getElementById('btnVozWaCopiar'),       // avan√ßado (escondido)
  btnAbrir: document.getElementById('btnVozWaAbrir'),         // avan√ßado (escondido)
  btnRecarregar: document.getElementById('btnVozWaRecarregar'),// avan√ßado (escondido)
  btnRefazer: document.getElementById('btnVozWaRefazer'),     // avan√ßado (escondido)

  player: document.getElementById('vozWaPlayer'),
};

// VOICE_WA_PATCH_INVITE_V3: marca UI nova (evita init antigo reclamar/duplicar)
if (window.__VOICE_DISABLED_IN_CONFIG__) {
  // FASE 1: qualquer bot√£o de voz aqui vira apenas redirecionamento
  const go = ()=>{ try{ window.location.href='/pages/configuracao_voz.html'; }catch(e){} };
  try{
    const b = document.getElementById('btnVozWaGerar'); if (b) b.onclick = go;
    const c = document.getElementById('btnVozWaCopiar'); if (c) c.onclick = go;
    const o = document.getElementById('btnVozWaAbrir'); if (o) o.onclick = go;
    const st = document.getElementById('vozWaStatus') || document.getElementById('voiceStatus');
    if (st) st.innerHTML = 'Configura√ß√£o de voz: prossiga em <strong>Voz</strong> (pr√≥xima etapa).';
  }catch(_){}
} else {
  window.__vozwa_new_ui = true;
}

function _vozWaSetText(el, txt){ if (el) el.textContent = (txt == null ? '' : String(txt)); }
function _vozWaShow(el){ if (el) el.style.display = ''; }
function _vozWaHide(el){ if (el) el.style.display = 'none'; }

function _vozWaBadge(kind, txt){
  const wa = window.vozWaEls;
  if (!wa || !wa.badge) return;
  wa.badge.className = 'pill ' + (kind || 'pill-pending');
  wa.badge.textContent = txt || '';
}

function _vozWaStatus(txt){
  const wa = window.vozWaEls;
  if (!wa) return;
  _vozWaSetText(wa.statusText, txt || '');
}

function _vozWaUpdated(iso){
  const wa = window.vozWaEls;
  if (!wa || !wa.updatedAt) return;
  if (!iso) { wa.updatedAt.textContent = ''; return; }
  try {
    const d = new Date(iso);
    if (isNaN(d.getTime())) { wa.updatedAt.textContent = String(iso); return; }
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    wa.updatedAt.textContent = `${hh}:${mm}`;
  } catch(_) {
    wa.updatedAt.textContent = String(iso);
  }
}

function _vozWaError(msg){
  const wa = window.vozWaEls;
  if (!wa || !wa.erroHumano) return;
  wa.erroHumano.style.display = msg ? 'block' : 'none';
  wa.erroHumano.textContent = msg || '';
}

function _vozWaGetToE164FromForm(){
  // tenta puxar do input name="telefone" (config do MEI)
  try {
    const el = document.querySelector('input[name="telefone"]') || document.getElementById('telefone') || null;
    const v = (el && el.value) ? String(el.value).trim() : '';
    return v || null;
  } catch(_) { return null; }
}
async function _vozWaFetch(path, opts){
  // FASE 1 (ISOLAMENTO): n√£o chamar backend de voz nesta p√°gina
  if (window.__VOZWA_DISABLED_IN_CONFIG__ || window.__VOICE_DISABLED_IN_CONFIG__) {
    return { ok:false, status:0, disabled:true, data:null };
  }
  // VOICE_WA_PATCH_INVITE_V4: token sempre anexado (evita 401 por timing)
  let tok = null;
  if (path && path[0] !== "/") path = "/" + path;

  // 1) tenta currentUser imediato
  try{
    if (window.firebase && firebase.auth && firebase.auth().currentUser) {
      tok = await firebase.auth().currentUser.getIdToken(true);
    }
  }catch(_){}

  // 2) se n√£o veio, espera o onAuthStateChanged (resolve ‚ÄúcurrentUser null‚Äù intermitente)
  if (!tok) {
    try{
      await new Promise((resolve, reject)=>{
        if (!window.firebase || !firebase.auth) return reject(new Error("firebase_not_loaded"));
        const unsub = firebase.auth().onAuthStateChanged(async (u)=>{
          try{
            if (u) tok = await u.getIdToken(true);
            try{ if (typeof unsub === "function") unsub(); }catch(_){}
            resolve();
          }catch(e){
            try{ if (typeof unsub === "function") unsub(); }catch(_){}
            reject(e);
          }
        });
        setTimeout(()=>{
          try{ if (typeof unsub === "function") unsub(); }catch(_){}
          reject(new Error("auth_timeout"));
        }, 2500);
      });
    }catch(_){}
  }

  // 3) fallback opcional (se existir nesse escopo)
  if (!tok) {
    try{ if (typeof getIdTokenSafe === "function") tok = await getIdTokenSafe(); }catch(_){}
  }

  const headers = Object.assign({}, (opts && opts.headers) || {});
  if (tok) headers["Authorization"] = "Bearer " + tok;

  const finalOpts = Object.assign({ cache:"no-store", headers }, opts || {});
  const base = (window.API_BASE || "https://mei-robo-prod.onrender.com");

  const r = await fetch(base + path, finalOpts);
  const ct = (r.headers.get("content-type") || "").toLowerCase();
  const body = ct.includes("application/json") ? await r.json().catch(()=>({})) : await r.text().catch(()=>"");
  return { ok:r.ok, status:r.status, body };
}
function _vozWaApplyStatus(payload){
  const wa = window.vozWaEls;
  const s = String(payload?.status || payload?.state || payload?.phase || 'waiting').toLowerCase();
  const updatedAt = payload?.updatedAt || payload?.updated_at || payload?.lastAt || payload?.last_at || '';
  _vozWaUpdated(updatedAt);

  if (s === 'ready' || s === 'saved' || payload?.ready === true) {
    _vozWaBadge('pill-active', 'pronto');
    _vozWaStatus('Voz pronta ‚úÖ');
  } else if (s === 'receiving') {
    _vozWaBadge('pill-prov', 'recebendo‚Ä¶');
    _vozWaStatus('Recebendo seu √°udio no WhatsApp‚Ä¶');
  } else if (s === 'processing') {
    _vozWaBadge('pill-prov', 'processando‚Ä¶');
    _vozWaStatus('Processando sua voz‚Ä¶');
  } else if (s === 'failed') {
    _vozWaBadge('pill-failed', 'falhou');
    _vozWaStatus('Falhou');
  } else {
    _vozWaBadge('pill-pending', 'aguardando');
    _vozWaStatus('Aguardando sua voz');
  }

  // player (se backend retornar url)
  try {
    const url = payload?.audioUrl || payload?.audio_url || payload?.previewUrl || payload?.preview_url || '';
    if (wa?.player) {
      if (url) {
        wa.player.src = url;
        wa.player.style.display = 'block';
      } else {
        wa.player.style.display = 'none';
      }
    }
  } catch(_) {}
}

async function _vozWaPollStatus(stopAfterMs){
  const started = Date.now();
  while (Date.now() - started < (stopAfterMs || 120000)) {
    try {
      const out = await _vozWaFetch('/api/voz/whatsapp/status', { method:'GET' });
      if (out.ok && out.body && out.body.ok) {
        _vozWaApplyStatus(out.body);
        if (out.body.ready === true || String(out.body.status||'').toLowerCase()==='ready') return;
      }
    } catch(_) {}
    await new Promise(r => setTimeout(r, 4000));
  }
}

async function setupVoice(uid, idTokenParam){
  const wa = window.vozWaEls;
  if (!wa || !wa.area) return;

  // modo simples: esconder tudo que confunde
  _vozWaHide(wa.code);
  _vozWaHide(wa.msgReady);
  _vozWaHide(wa.codeHint);
  _vozWaHide(wa.btnCopiar);
  _vozWaHide(wa.btnAbrir);
  _vozWaHide(wa.btnRecarregar);
  _vozWaHide(wa.btnRefazer);

  // bot√£o √∫nico
  if (wa.btnGerar) {
    wa.btnGerar.textContent = 'ENVIAR MINHA VOZ NO WHATSAPP';
    wa.btnGerar.classList.add('primary');
  }

  _vozWaError('');
  _vozWaBadge('pill-pending', 'aguardando');
  _vozWaStatus('Aguardando sua voz');
  _vozWaUpdated('');

  // carrega config (n√∫mero oficial) e status inicial
  try {
    const cfg = await _vozWaFetch('/api/voz/whatsapp/config', { method:'GET' });
    if (!cfg.ok) {
      _vozWaError('N√£o consegui carregar a configura√ß√£o de voz agora. Recarregue a p√°gina.');
    }
  } catch(_) {}

  try {
    const st = await _vozWaFetch('/api/voz/whatsapp/status', { method:'GET' });
    if (st.ok && st.body && st.body.ok) _vozWaApplyStatus(st.body);
  } catch(_) {}

  if (wa.btnGerar) {
    wa.btnGerar.onclick = async () => {
      wa.btnGerar.disabled = true;
      _vozWaError('');
      _vozWaBadge('pill-prov', 'preparando‚Ä¶');
      _vozWaStatus('Abrindo seu WhatsApp‚Ä¶');

      try {
        // 1) garante config (pega n√∫mero oficial)
        const cfg = await _vozWaFetch('/api/voz/whatsapp/config', { method:'GET' });
        const waNumber = (cfg.body && cfg.body.waNumberE164) ? String(cfg.body.waNumberE164) : '';

        // 2) gera convite/c√≥digo
        let toE164 = _vozWaGetToE164FromForm();
        if (!toE164) {
          _vozWaBadge('pill-failed', 'aten√ß√£o');
          _vozWaStatus('Preencha seu WhatsApp (com DDD) antes de gerar o convite.');
          _vozWaError('Informe seu n√∫mero no campo Telefone/WhatsApp e tente novamente.');
          return;
        }
        const invite = await _vozWaFetch('/api/voz/whatsapp/invite', {
          method:'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ toE164 })
        });

        if (!invite.ok || !invite.body || !invite.body.ok) {
          _vozWaBadge('pill-failed', 'falhou');
          _vozWaStatus('N√£o consegui iniciar agora');
          _vozWaError(invite.body?.error || 'N√£o consegui iniciar agora. Tente novamente.');
          return;
        }

        const code = String(invite.body.code || '').trim();
        const num = String(invite.body.waNumberE164 || waNumber || '').replace(/\D/g,'');
        const msg = `MEIROBO VOZ ${code}`;
        const url = 'https://wa.me/' + num + '?text=' + encodeURIComponent(msg);

        window.open(url, '_blank', 'noopener');

        _vozWaBadge('pill-prov', 'aguardando‚Ä¶');
        _vozWaStatus('Envie o √°udio no WhatsApp (1‚Äì2 min falando normal).');
        // polling curto
        _vozWaPollStatus(180000);
      } catch(e){
        _vozWaBadge('pill-failed', 'falhou');
        _vozWaStatus('Falha');
        _vozWaError('Falha ao abrir o WhatsApp. Tente novamente.');
      } finally {
        wa.btnGerar.disabled = false;
      }
    };
  }
}
    /* ===== Helpers empresa/CNPJ ===== */
    function getField(obj, keys){
      for (const k of keys){
        if (obj && obj[k] != null && obj[k] !== '') return obj[k];
      }
      return '';
    }
    function pickCNAE(empresa){
      const c1 = empresa.cnaePrincipal || empresa.cnae_principal || null;
      if (c1 && (c1.codigo || c1.descricao)) return c1;
      const arr = empresa.cnaes || empresa.cnaesPrincipais || [];
      return Array.isArray(arr) && arr.length ? arr[0] : {};
    }
    async function fetchJson(url, headers) {
      const r = await fetch(url, { headers: headers || {}, cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    }
    function formatEnderecoFrom(empresa){
      const e = empresa?.endereco || {};
      const municipio = (typeof e.municipio === 'object') ? (e.municipio.nome || e.municipio.sigla || '') : (e.municipio || '');
      const uf        = (typeof e.uf === 'object')        ? (e.uf.sigla || e.uf.nome || '')        : (e.uf || '');
      const parts = [e.logradouro, e.numero, e.bairro, municipio, uf, e.cep].filter(Boolean);
      return parts.join(', ');
    }

    function populateFromEmpresa(empresa) {
      if (!empresa) return;
      const cnpjRaw = getField(empresa, ['cnpj','cnpjSemMascara','cnpj_sem_mascara','cnpj_basico','id']);
      const cnpjDig = onlyDigits(cnpjRaw || '');
      if (cnpjDig) { dCnpj.textContent = cnpjDig; hCnpj.value = cnpjDig; }

      const legal = getField(empresa, ['razaoSocial','razao_social','nomeEmpresarial','legal_name']);
      const trade = getField(empresa, ['nomeFantasia','nome_fantasia','trade_name']);
      if (legal) { dLegal.textContent = legal; hLegal.value = legal; }
      if (trade) { dTrade.textContent = trade; hTrade.value = trade; }

      const cnae = pickCNAE(empresa);
      const seg = [cnae.codigo, cnae.descricao].filter(Boolean).join(' ‚Äî ');
      if (seg) { dSeg.textContent = seg; hSeg.value = seg; }

      // ===== situa√ß√£o, abertura e endere√ßo (somente leitura)
      const situ = getField(empresa, ['situacao']);
      const abrt = getField(empresa, ['dataAbertura','abertura','data_inicio_atividade']);
      const end  = formatEnderecoFrom(empresa);
      if (situ){ dSitu.textContent = situ; hSitu.value = situ; }
      if (abrt){ dAber.textContent = abrt.includes('-') ? formatDateBR(abrt) : abrt; hAber.value = abrt; }
      if (end){  dEnd.textContent = end; hEnd.value = end; }
    }

    async function loadEmpresaFromContaStatus(uid, idToken) {
      try {
        if (!uid) return null;
        const headers = {}; 
        if (idToken) headers['Authorization'] = 'Bearer ' + idToken;
        const j = await fetchJson(`${API_BASE}/api/conta/status?uid=${encodeURIComponent(uid)}`, headers);

        if (j && j.empresa) {
          populateFromEmpresa(j.empresa);
          const municipio = j.empresa?.endereco?.municipio || j.empresa?.municipio || '';
          const uf = j.empresa?.endereco?.uf || j.empresa?.uf || '';
          if (cnpjVinculoHint && (municipio || uf)) {
            cnpjVinculoHint.textContent =
              `CNPJ encontrado na Receita Federal (${municipio}${uf ? ' / ' + uf : ''}). ` +
              `Isso confirma apenas os dados da empresa. O v√≠nculo do respons√°vel ser√° verificado durante a ativa√ß√£o do n√∫mero.`;
          }
        } else if (j && typeof j === 'object') {
          populateFromEmpresa(j);
          const municipio = j?.endereco?.municipio || j?.municipio || '';
          const uf = j?.endereco?.uf || j?.uf || '';
          if (cnpjVinculoHint && (municipio || uf)) {
            cnpjVinculoHint.textContent =
              `CNPJ encontrado na Receita Federal (${municipio}${uf ? ' / ' + uf : ''}). ` +
              `Isso confirma apenas os dados da empresa. O v√≠nculo do respons√°vel ser√° verificado durante a ativa√ß√£o do n√∫mero.`;
          }
        }
        
        // üî¥ NOVO: detectar se a conta j√° est√° ativa/licenciada
        try {
          const lic = j && j.licenca ? j.licenca : null;
          if (lic) {
            const origemRaw = String(lic.origem || '').toLowerCase();
            const statusRaw = String(lic.status || '').toLowerCase();

            const origemEhCupom = origemRaw.startsWith('cupom');
            const statusAtivo =
              statusRaw === 'ativa' ||
              statusRaw === 'active' ||
              statusRaw === 'trial' ||
              statusRaw === 'trialing';

            if (origemEhCupom || statusAtivo) {
              contaAtiva = true;
              console.log('[configuracao] contaAtiva=true (licenca)', lic);
            }
          }

          // fallback: alguns backends podem mandar status/origem soltos
          const licencaStatusSolto = String(j?.licencaStatus || '').toLowerCase();
          const licencaOrigemSolta = String(j?.licencaOrigem || '').toLowerCase();
          if (!contaAtiva) {
            const origemCupomSolta = licencaOrigemSolta.startsWith('cupom');
            const statusAtivoSolto =
              licencaStatusSolto === 'ativa' ||
              licencaStatusSolto === 'active' ||
              licencaStatusSolto === 'trial' ||
              licencaStatusSolto === 'trialing';
            if (origemCupomSolta || statusAtivoSolto) {
              contaAtiva = true;
              console.log('[configuracao] contaAtiva=true (licenca solta)', {
                licencaStatusSolto,
                licencaOrigemSolta,
              });
            }
          }
        } catch (e) {
          console.warn('[configuracao] falha ao interpretar licenca em /api/conta/status', e);
        }

        return j;

      } catch (_) {
        return null;
      }
    }

    // ======= configura√ß√£o/CNPJ inline (como estava) =======>
    async function fetchConfig(tok){
      const r = await fetch(`${API_BASE}/api/configuracao`, { headers: { "Authorization": tok ? ("Bearer " + tok) : "", "Accept":"application/json" } });
      if (!r.ok) throw new Error("config_fetch_failed");
      return r.json();
    }
    async function postConfigCNPJ(tok, cnpj){
      const r = await fetch(`${API_BASE}/api/configuracao`, {
        method: "POST",
        headers: { "Authorization": tok ? ("Bearer " + tok) : "", "Content-Type":"application/json", "Accept":"application/json" },
        body: JSON.stringify({ cnpj })
      });
      return r;
    }
    async function checkCnpjAvailability(cnpj){
      const r = await fetch(`${API_BASE}/api/cnpj/availability?cnpj=` + onlyDigits(cnpj));
      return r.ok;
    }

    /* ===== Buscar DETALHES do CNPJ (p√∫blico) ===== */
    async function fetchEmpresaDetalhes(cnpj14){
      const c = onlyDigits(cnpj14||'');
      if (!c || c.length !== 14) return null;
      const urls = [
        `${API_BASE}/api/cnpj/${c}`,
        `${API_BASE}/integracoes/cnpj/${c}`, // fallback legado
      ];
      for (const u of urls){
        try {
          const j = await fetchJson(u);
          if (j && typeof j === 'object') return j;
        } catch(_) {}
      }
      return null;
    }

    /* ===== Stripe Gate: usar o que o backend j√° sabe sobre pagamento/cupom ===== */
    async function aplicarHeuristicaStripeGate(idToken) {
      try {
        // Se veio do dashboard, n√£o deixamos o Stripe mudar o destino
        if (veioDoDashboard) {
          console.log('[configuracao] origem=dashboard ‚Üí ignorando stripe/gate, destinoPosConfig=', destinoPosConfig);
          return;
        }

        const headers = {};
        if (idToken) {
          headers['Authorization'] = 'Bearer ' + idToken;
        }

        const resp = await fetch(`${API_BASE}/api/stripe/gate`, {
          method: 'GET',
          headers,
          cache: 'no-store'
        });

        if (!resp.ok) {
          console.warn('[configuracao] stripe/gate n√£o-ok:', resp.status);
          return;
        }

        const j = await resp.json().catch(() => null);
        if (!j || typeof j !== 'object') {
          console.warn('[configuracao] stripe/gate retornou payload inesperado:', j);
          return;
        }

        // V√°rios nomes poss√≠veis, para n√£o depender de um √∫nico contrato.
        const requiresPayment =
          (typeof j.requiresPayment === 'boolean') ? j.requiresPayment : null;
        const canSkipPayment =
          (typeof j.canSkipPayment === 'boolean') ? j.canSkipPayment : null;

        const statusRaw =
          String(j.status || j.licencaStatus || '').toLowerCase();
        const origemRaw =
          String(j.origem || j.licencaOrigem || '').toLowerCase();

        let liberarPainel = false;

        // 1) Sinal direto
        if (canSkipPayment === true) liberarPainel = true;
        if (requiresPayment === false) liberarPainel = true;

        // 2) Origem baseada em cupom
        if (origemRaw.startsWith('cupom')) {
          liberarPainel = true;
        }

        // 3) Status de licen√ßa "ativa"
        if (
          statusRaw === 'ativa' ||
          statusRaw === 'active' ||
          statusRaw === 'trial' ||
          statusRaw === 'trialing'
        ) {
          liberarPainel = true;
        }

        if (liberarPainel) {
          destinoPosConfig = '/pages/dashboard.html';
          console.log('[configuracao] stripe/gate liberou painel; destinoPosConfig ajustado para dashboard', j);
        } else {
          console.log('[configuracao] stripe/gate n√£o liberou painel explicitamente; mantendo destinoPosConfig=', destinoPosConfig, j);
        }
      } catch (e) {
        console.warn('[configuracao] erro ao consultar stripe/gate:', e);
      }
    }

    /* ===== AGENDA: helpers ===== */
    function normalizeAgendaConfig(raw){
      const cfg = (raw && typeof raw === 'object') ? raw : {};
      const dias = (Array.isArray(cfg.diasAtendimento) && cfg.diasAtendimento.length)
        ? cfg.diasAtendimento
        : ['seg','ter','qua','qui','sex'];

      return {
        diasAtendimento: dias,
        atendimentoInicio: cfg.atendimentoInicio || '08:00',
        atendimentoFim: cfg.atendimentoFim || '18:30',
        intervaloMin: (typeof cfg.intervaloMin === 'number' && cfg.intervaloMin > 0) ? cfg.intervaloMin : 30,
        antecedenciaMinDias: (typeof cfg.antecedenciaMinDias === 'number') ? cfg.antecedenciaMinDias : 2
      };
    }

    function setAgendaMessage(msg, kind){
      if (!agendaAlertEl) return;
      agendaAlertEl.textContent = msg || '';
      if (!msg){
        agendaAlertEl.style.color = '';
        return;
      }
      if (kind === 'error') agendaAlertEl.style.color = '#ffbdbd';
      else if (kind === 'success') agendaAlertEl.style.color = '#8ff0c3';
      else agendaAlertEl.style.color = '';
    }

    function preencherAgendaForm(cfg){
      if (!agendaFormEl || !cfg) return;

      const dias = cfg.diasAtendimento || [];
      agendaFormEl.querySelectorAll('input[name="diasAtendimento"]').forEach(el => {
        el.checked = dias.includes(el.value);
      });

      const fIni = agendaFormEl.querySelector('input[name="atendimentoInicio"]');
      const fFim = agendaFormEl.querySelector('input[name="atendimentoFim"]');
      const fInt = agendaFormEl.querySelector('select[name="intervaloMin"]');
      const fAnt = agendaFormEl.querySelector('input[name="antecedenciaMinDias"]');

      if (fIni) fIni.value = cfg.atendimentoInicio || '08:00';
      if (fFim) fFim.value = cfg.atendimentoFim || '18:30';
      if (fInt) fInt.value = String(cfg.intervaloMin || 30);
      if (fAnt) fAnt.value = String(cfg.antecedenciaMinDias ?? 2);
    }

    function lerAgendaDoForm(){
      const result = {
        diasAtendimento: [],
        atendimentoInicio: '',
        atendimentoFim: '',
        intervaloMin: 30,
        antecedenciaMinDias: 2
      };
      if (!agendaFormEl) return result;

      agendaFormEl.querySelectorAll('input[name="diasAtendimento"]:checked').forEach(el => {
        result.diasAtendimento.push(el.value);
      });

      const fIni = agendaFormEl.querySelector('input[name="atendimentoInicio"]');
      const fFim = agendaFormEl.querySelector('input[name="atendimentoFim"]');
      const fInt = agendaFormEl.querySelector('select[name="intervaloMin"]');
      const fAnt = agendaFormEl.querySelector('input[name="antecedenciaMinDias"]');

      result.atendimentoInicio = fIni ? (fIni.value || '') : '';
      result.atendimentoFim    = fFim ? (fFim.value || '') : '';
      result.intervaloMin      = fInt ? (parseInt(fInt.value,10) || 30) : 30;
      result.antecedenciaMinDias = fAnt ? (parseInt(fAnt.value,10) || 2) : 2;

      return result;
    }

    function validarAgendaCfg(cfg){
      if (!cfg.diasAtendimento || !cfg.diasAtendimento.length) {
        return 'Escolha pelo menos um dia de atendimento.';
      }
      if (!cfg.atendimentoInicio || !cfg.atendimentoFim) {
        return 'Informe hor√°rio de in√≠cio e fim do atendimento.';
      }
      if (cfg.atendimentoInicio >= cfg.atendimentoFim) {
        return 'O hor√°rio de in√≠cio precisa ser antes do hor√°rio de fim.';
      }
      if (cfg.intervaloMin < 5) {
        return 'Intervalo m√≠nimo muito curto.';
      }
      if (cfg.antecedenciaMinDias < 0) {
        return 'Anteced√™ncia m√≠nima n√£o pode ser negativa.';
      }
      return null;
    }

    // Se a pessoa marcar a autoriza√ß√£o, some o erro embaixo do texto
    if (autorizacaoCheckbox) {
      autorizacaoCheckbox.addEventListener('change', () => {
        if (autorizacaoErro) {
          autorizacaoErro.style.display = autorizacaoCheckbox.checked ? 'none' : 'block';
        }
      });
    }
    // PATCH 3 ‚Äî l√≥gica da "configura√ß√£o inicial conclu√≠da"
    function isConfigInicialConcluida() {
      // 1) Voz (v1.0 WhatsApp): conta como pronta quando o backend disser "saved/ready"
      const okVoz = !!(vozWaState && vozWaState.ready);

      // 2) Agenda: j√° salva no backend (carregada ou rec√©m-salva)
      const okAgenda = !!agendaSavedOk;

      // 3) Config m√≠nima de conta: CNPJ + Nome + Email
      const msgObrig = validarConfigObrigatoria();
      const okConfig = !msgObrig;

      return okVoz && okAgenda && okConfig;
    }

    function updateDashboardCTAVisibility() {
      if (!panelDoneEl || !btnGoDashboard) return;

      if (isConfigInicialConcluida()) {
        panelDoneEl.style.display = 'block';
      } else {
        panelDoneEl.style.display = 'none';
      }
    }

    function atualizarAgendaResumo(cfg){
      if (!agendaResumoEl) return;
      agendaResumoEl.innerHTML = '';

      if (!cfg){
        const li = document.createElement('li');
        li.textContent = 'Sua agenda ainda n√£o est√° configurada. Ajuste acima como deseja atender.';
        agendaResumoEl.appendChild(li);
        return;
      }

      const mapaDia = {
        seg: 'segunda',
        ter: 'ter√ßa',
        qua: 'quarta',
        qui: 'quinta',
        sex: 'sexta',
        sab: 's√°bado',
        dom: 'domingo'
      };

      const diasStr = (cfg.diasAtendimento || [])
        .map(d => mapaDia[d] || d)
        .join(', ') || 'segunda a sexta (padr√£o)';

      const ini = cfg.atendimentoInicio || '08:00';
      const fim = cfg.atendimentoFim   || '18:30';
      const passo = cfg.intervaloMin || 30;
      const ant = (cfg.antecedenciaMinDias ?? 2);

      const l1 = document.createElement('li');
      l1.textContent = 'Dias de atendimento: ' + diasStr;
      const l2 = document.createElement('li');
      l2.textContent = 'Hor√°rio de atendimento: ' + ini + ' √†s ' + fim;
      const l3 = document.createElement('li');
      l3.textContent = 'Intervalo entre hor√°rios: ' + passo + ' minutos';
      const l4 = document.createElement('li');
      l4.textContent = 'Anteced√™ncia m√≠nima para agendar: ' + ant + ' dia(s)';

      agendaResumoEl.appendChild(l1);
      agendaResumoEl.appendChild(l2);
      agendaResumoEl.appendChild(l3);
      agendaResumoEl.appendChild(l4);
    }

    async function carregarAgendaConfigFromApi(){
      if (!agendaFormEl && !agendaResumoEl) return;
      const idToken = await getIdTokenOrNull();
      if (!idToken) {
        atualizarAgendaResumo(null);
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/agenda/config`, {
          headers: {
            'Authorization': 'Bearer ' + idToken
          }
        });

        if (res.status === 404) {
          console.info('[configuracao] Agenda ainda n√£o configurada (404). Usando defaults.');
          currentAgendaConfig = normalizeAgendaConfig({});
          preencherAgendaForm(currentAgendaConfig);
          atualizarAgendaResumo(null);
          agendaSavedOk = false; // ainda n√£o existe configura√ß√£o de agenda
          return;
        }

        if (!res.ok) {
          throw new Error('HTTP ' + res.status);
        }

        const data = await res.json().catch(() => ({}));
        currentAgendaConfig = normalizeAgendaConfig(data);
        preencherAgendaForm(currentAgendaConfig);
        atualizarAgendaResumo(currentAgendaConfig);
        agendaSavedOk = true; // ‚úÖ j√° existe agenda salva no servidor
      } catch (e) {
        console.warn('[configuracao] Erro ao carregar agenda; usando defaults.', e);
        currentAgendaConfig = normalizeAgendaConfig({});
        preencherAgendaForm(currentAgendaConfig);
        atualizarAgendaResumo(null);
        agendaSavedOk = false;
      }
    }

    // PATCH 3.1 ‚Äî helper de valida√ß√£o da config m√≠nima
    function validarConfigObrigatoria() {
      const faltando = [];

      if (!hCnpj.value) {
        faltando.push('CNPJ vinculado √† conta');
      }
      if (!hNome.value) {
        faltando.push('Nome da conta');
      }
      if (!hEmail.value) {
        faltando.push('E-mail da conta');
      }

      if (faltando.length) {
        return 'Antes de continuar, complete: ' + faltando.join(', ') + '.';
      }
      return null;
    }

    // PATCH 3.2 ‚Äî nova fun√ß√£o salvarAgendaConfig (voz + config + agenda + redirect)
    async function salvarAgendaConfig(ev){
      ev.preventDefault();
      if (!agendaFormEl) return;

      // 1) Voz obrigat√≥ria para avan√ßar (WhatsApp v1.0)
if (!vozWaState || !vozWaState.ready) {
  const msg = 'Antes de continuar, envie sua voz pelo WhatsApp (c√≥digo de voz + √°udio).';
  setAgendaMessage(msg, 'error');
  try { document.getElementById('sec-voz')?.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(_) {}
  return;
}

      // 2) Campos m√≠nimos da configura√ß√£o de comunica√ß√£o
      const msgCfg = validarConfigObrigatoria();
      if (msgCfg) {
        setAgendaMessage(msgCfg, 'error');
        try {
          // sobe a p√°gina at√© o topo do formul√°rio de config
          const y = form.offsetTop || 0;
          window.scrollTo({ top: Math.max(y - 40, 0), behavior: 'smooth' });
        } catch (_) {}
        return;
      }
  
      // 2.1) Autoriza√ß√£o quando n√£o conseguimos confirmar o v√≠nculo pelo nome
      // S√≥ bloqueia se:
      // - o hint tiver um aviso (‚ö†) E
      // - a pessoa ainda n√£o marcou que est√° autorizada pela empresa
      const hintTexto = (cnpjVinculoHint && cnpjVinculoHint.textContent || '').trim();
      const temAlertaVinculo = /‚ö†/.test(hintTexto) && /n√£o conseguimos confirmar|nao conseguimos confirmar|diverg/i.test(hintTexto);

      if (temAlertaVinculo && autorizacaoCheckbox && !autorizacaoCheckbox.checked) {
        setAgendaMessage('Para seguir, confirme que voc√™ est√° autorizado(a) pela empresa a usar este CNPJ.', 'error');
        if (autorizacaoErro) {
          autorizacaoErro.style.display = 'block';
          autorizacaoErro.textContent = 'Para continuar, confirme que voc√™ est√° autorizado(a) pela empresa.';
        }
        try {
          // rola at√© o bloco de autoriza√ß√£o pra ficar bem na cara
          const boxTop = document.getElementById('autorizacao-container')?.offsetTop || form.offsetTop || 0;
          window.scrollTo({ top: Math.max(boxTop - 40, 0), behavior: 'smooth' });
        } catch (_) {}
        return;
      } else if (autorizacaoErro) {
        // Se n√£o tiver alerta ou se j√° marcou, some com o erro
        autorizacaoErro.style.display = 'none';
        autorizacaoErro.textContent = '';
      }
      
      // 3) Valida√ß√£o da agenda (dias/hor√°rios/anteced√™ncia)
      const payload = lerAgendaDoForm();
      const err = validarAgendaCfg(payload);
      if (err) {
        setAgendaMessage(err, 'error');
        return;
      }

      // 4) Token
      const idToken = await getIdTokenOrNull();
      if (!idToken) {
        setAgendaMessage('Sess√£o expirada. Fa√ßa login novamente.', 'error');
        return;
      }

      try {
        if (agendaSaveBtn) {
          agendaSaveBtn.disabled = true;
          agendaSaveBtn.textContent = 'Salvando‚Ä¶';
        }
        setAgendaMessage('Salvando seus dados e a configura√ß√£o de agenda‚Ä¶', null);

        // 4.1. Salvar configura√ß√µes de comunica√ß√£o primeiro
        const cfgResult = await salvarConfiguracaoSemRedirect();
        if (!cfgResult || !cfgResult.ok) {
          setAgendaMessage('N√£o foi poss√≠vel salvar seus dados de comunica√ß√£o. Confira os campos acima e tente novamente.', 'error');
          try {
            const y = form.offsetTop || 0;
            window.scrollTo({ top: Math.max(y - 40, 0), behavior: 'smooth' });
          } catch (_) {}
          return;
        }

        // 4.2. Salvar agenda
        const res = await fetch(`${API_BASE}/api/agenda/config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + idToken
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error('HTTP ' + res.status);
        }

        currentAgendaConfig = payload;
        atualizarAgendaResumo(currentAgendaConfig);
        agendaSavedOk = true; // garantir que marcamos como salva nesta jornada
        updateDashboardCTAVisibility(); // PATCH 3 ‚Äî reavalia CTA do painel
        setAgendaMessage('Configura√ß√£o de agenda salva com sucesso. Indo para a pr√≥xima etapa‚Ä¶', 'success');

        // 4.3. Agora sim, avan√ßa a jornada
        setTimeout(() => {
          window.location.href = destinoPosConfig;
        }, 800);

      } catch (e) {
        console.error('[configuracao] Erro ao salvar agenda', e);
        setAgendaMessage('N√£o foi poss√≠vel salvar a agenda agora. Tente novamente.', 'error');
      } finally {
        if (agendaSaveBtn) {
          agendaSaveBtn.disabled = false;
          agendaSaveBtn.textContent = 'Salvar e continuar';
        }
      }
    }

    async function setupAgendaConfig(){
      await carregarAgendaConfigFromApi();
      if (agendaFormEl) {
        agendaFormEl.addEventListener('submit', salvarAgendaConfig);
      }
      if (agendaSaveBtn) {
        agendaSaveBtn.textContent = 'Salvar e continuar'; // ‚úÖ bot√£o final da p√°gina
      }
      updateDashboardCTAVisibility(); // PATCH 3 ‚Äî decide se mostra o CTA ao carregar a p√°gina
    }

    /* ===== Inicializa√ß√£o ===== */
    (async function gatekeeper(){
      const ok = await ensureVerifiedOrSendBack();
      if (!ok) return;
      init();
    })();

    async function init() {
      // PATCH 3 ‚Äî a√ß√£o do bot√£o "Ir para o painel do MEI Rob√¥"
      if (btnGoDashboard) {
        btnGoDashboard.addEventListener('click', () => {
          // Se o seu painel tiver outro caminho, troque a URL abaixo.
          window.location.href = '/pages/dashboard.html';
        });
      }

      const { uid, idToken } = await getAuthContext();
      if (!uid) {
        location.href = '/pages/login.html?next=' + encodeURIComponent('/pages/configuracao.html');
        return;
      }

      // Detecta se o usu√°rio veio do dashboard; se sim, o destino padr√£o j√° √© voltar pra l√°
      veioDoDashboard = detectarOrigemDashboard();
      if (veioDoDashboard) {
        destinoPosConfig = '/pages/dashboard.html';
        console.log('[configuracao] origem=dashboard ‚Üí destinoPosConfig inicial =', destinoPosConfig);
      }

      // 1) Preenche via /api/conta/status
      await loadEmpresaFromContaStatus(uid, idToken);

      try {
        // 2) /api/configuracao (pode dar 404 no primeiro acesso)
        const headers = {}; if (idToken) headers['Authorization'] = 'Bearer ' + idToken;
        const resp = await fetch(`${API_BASE}/api/configuracao`, { method: 'GET', headers });
        let payload = null;

        if (resp.status === 404) {
          payload = {};
        } else if (resp.status === 401) {
          // Sess√£o pode estar em transi√ß√£o (token ainda n√£o veio).
          // N√£o redireciona √† for√ßa; s√≥ mostra uma mensagem leve.
          setAuthMsg('Sess√£o em atualiza√ß√£o. Recarregue a p√°gina se o problema continuar.');
          payload = {};
        } else if (resp.status === 403 || resp.status === 428) {
          // üîß Antes redirecionava para verify-email.html, causando "volta" indesejada.
          // Agora mantemos o usu√°rio no fluxo principal (cadastro controla verifica√ß√£o).
          setAuthMsg('Confirme seu e-mail na tela de cadastro e, depois, volte para esta tela.');
          return;
        } else if (!resp.ok) {
          payload = {};
        } else {
          payload = await resp.json();
        }

        const data = (payload && payload.data) ? payload.data : (payload || {});
        let user = firebase.auth().currentUser;
        try { await user?.reload(); } catch(_){}
        const authEmail = user?.email || '';
        const authName = user?.displayName || (data.nome || '');

        // Decide destino p√≥s-configura√ß√£o com base na licen√ßa e, em √∫ltimo caso, no statusAtivacao
        const statusAtivacao = String(data.statusAtivacao || '').trim();

        // Dados de licen√ßa vindos da pr√≥pria /api/configuracao
        const licCfg = data.licenca || {};
        const licStatusCfg = String(licCfg.status || data.licencaStatus || '').toLowerCase();
        const licOrigemCfg = String(licCfg.origem || data.licencaOrigem || '').toLowerCase();

        const origemEhCupomCfg = licOrigemCfg.startsWith('cupom');
        const statusAtivoCfg =
          licStatusCfg === 'ativa' ||
          licStatusCfg === 'active' ||
          licStatusCfg === 'trial' ||
          licStatusCfg === 'trialing';

        // üî¥ Regra de produ√ß√£o FINAL (respeitando origem=dashboard):
        // 1) Se tiver licen√ßa ativa OU origem cupom (configura√ß√£o) ‚Üí painel
        // 2) Sen√£o, se contaAtiva==true via /api/conta/status ‚Üí painel
        // 3) Sen√£o, se statusAtivacao tiver algum valor diferente de "aguardando-voz" ‚Üí painel (fallback legado)
        // 4) Caso contr√°rio ‚Üí tela de conclus√£o de assinatura
        if (!veioDoDashboard) {
          // üîí FASE 1 (isolamento): configuracao.html N√ÉO ativa conta e N√ÉO processa voz.
          // Regra saud√°vel:
          // - Se j√° estiver "ok" (licen√ßa ativa/cupom/config ou conta ativa), volta para o painel.
          // - Caso contr√°rio (onboarding ainda pendente), encaminha para a tela de VOZ (obrigat√≥ria).
          if (origemEhCupomCfg || statusAtivoCfg || contaAtiva) {
            destinoPosConfig = '/pages/dashboard.html';
          } else {
            destinoPosConfig = '/pages/configuracao_voz.html';
          }
        }

        console.log('[configuracao] (pr√©-gate) statusAtivacao=', statusAtivacao,
                    'licStatusCfg=', licStatusCfg,
                    'licOrigemCfg=', licOrigemCfg,
                    'contaAtiva=', contaAtiva,
                    'veioDoDashboard=', veioDoDashboard,
                    'destinoPosConfig=', destinoPosConfig);

        // üîÅ Passo extra: deixar o stripe/gate ter a palavra final, se ele souber que a conta j√° est√° liberada
        await aplicarHeuristicaStripeGate(idToken);

        console.log('[configuracao] (p√≥s-gate) destinoPosConfig FINAL=', destinoPosConfig);

        if (authName)  { dNome.textContent = authName; hNome.value = authName; }
        if (authEmail) { dEmail.textContent = authEmail; hEmail.value = authEmail; }

        const cnpjDigits = onlyDigits(data?.cnpj || data?.cnpjSemMascara || data?.cnpj_basico || hCnpj.value || '');
        if (cnpjDigits) { dCnpj.textContent = cnpjDigits; hCnpj.value = cnpjDigits; }

        if (data.segmento)   { dSeg.textContent = data.segmento; hSeg.value = data.segmento; }
        const legalCfg = data.legal_name || data.razaoSocial || data.razao_social || data.nomeEmpresarial || '';
        const tradeCfg = data.trade_name || data.nomeFantasia || data.nome_fantasia || '';
        if (legalCfg) { dLegal.textContent = legalCfg; hLegal.value = legalCfg; }
        if (tradeCfg) { dTrade.textContent = tradeCfg; hTrade.value = tradeCfg; }

        // Fallback para situa√ß√£o, abertura e endere√ßo vindos da pr√≥pria /api/configuracao
        if (data.situacao && (dSitu.textContent === '‚Äî' || !dSitu.textContent.trim())) {
          dSitu.textContent = data.situacao;
          hSitu.value = data.situacao;
        }

        const abCfg = data.abertura || data.dataAbertura || data.data_inicio_atividade;
        if (abCfg && (dAber.textContent === '‚Äî' || !dAber.textContent.trim())) {
          dAber.textContent = String(abCfg).includes('-') ? formatDateBR(abCfg) : abCfg;
          hAber.value = abCfg;
        }

        if (data.endereco && (dEnd.textContent === '‚Äî' || !dEnd.textContent.trim())) {
          let endStr = '';
          if (typeof data.endereco === 'string') {
            endStr = data.endereco;
          } else {
            endStr = formatEnderecoFrom({ endereco: data.endereco });
          }
          if (endStr) {
            dEnd.textContent = endStr;
            hEnd.value = endStr;
          }
        }

        if (data.telefone) fTel.value = data.telefone;
        if (data.esp1) fEsp1.value = data.esp1;
        if (data.esp2) fEsp2.value = data.esp2;
        if (data.formalidade) fFormal.value = data.formalidade;
        if (data.emojis) fEmojis.value = data.emojis;
        if (data.saudacao) fSaud.value = data.saudacao;
        if (data.display_name) fDisp.value = data.display_name;
        if (data.closing_text) fClose.value = data.closing_text;
        if (data.janela_resposta) {
          fJanela.value = data.janela_resposta;
          wrapCustom.style.display = (fJanela.value === 'custom') ? 'block' : 'none';
        }
        if (data.janela_resposta_custom) fJanelaCustom.value = data.janela_resposta_custom;

        initBranding(data);

        // (Opcional) refor√ßo de v√≠nculo por nome
        async function tryCheckCnpjVinculo(cnpj14, nomeBusca){
          try {
            if (!cnpj14) return;
            const u = `${API_BASE}/integracoes/cnpj/${encodeURIComponent(cnpj14)}?nome=${encodeURIComponent(nomeBusca||'')}`;
            const r = await fetch(u, { credentials: "include" });
            if (!r.ok) return;

            const j = await r.json();
            const v = j && j.vinculoNome && j.vinculoNome.avaliacao;

            if (!cnpjVinculoHint) return;

            if (v === 'EXATO') {
              // v√≠nculo forte: nome bate como respons√°vel/empres√°rio
              cnpjVinculoHint.textContent =
                '‚úÖ V√≠nculo confirmado automaticamente: seu nome consta como respons√°vel pelo CNPJ na base consultada.';
            } else if (v === 'PROVAVEL') {
              // v√≠nculo prov√°vel, mas n√£o perfeito
              cnpjVinculoHint.textContent =
                '‚úÖ Temos indicativos de que seu nome se relaciona ao quadro societ√°rio da empresa. ' +
                'A confirma√ß√£o final ocorre durante o processo de ativa√ß√£o. Pode seguir normalmente com a configura√ß√£o.';
            } else {
              // qualquer outro caso (n√£o encontrado, divergente etc.)
              cnpjVinculoHint.textContent =
                '‚ö† N√£o conseguimos confirmar automaticamente seu nome como respons√°vel por este CNPJ. ' +
                'Voc√™ pode seguir normalmente, mas poderemos pedir documentos ou confirma√ß√£o adicional durante a ativa√ß√£o.';
            }
          } catch(_){}
        }

        tryCheckCnpjVinculo(hCnpj.value || '', authName || '');

        // ===== Se j√° temos CNPJ, buscar DETALHES p√∫blicos e sobrepor exibi√ß√£o =====
        if (hCnpj.value){
          try {
            const emp = await fetchEmpresaDetalhes(hCnpj.value);
            if (emp) populateFromEmpresa(emp);
          } catch(_){}
        }

        // Voz/WABA como j√° estava (com novo setupVoice)
        setupVoice(uid, idToken);
        await loadWabaStatus(uid, idToken);

        // Agenda (nova): carregamento + form
        await setupAgendaConfig();

        // PATCH 3 ‚Äî √∫ltima checagem ao terminar o carregamento inicial
        updateDashboardCTAVisibility();

        // ===== Se ainda n√£o h√° CNPJ, exibir bloco inline =====
        if (!hCnpj.value) {
          if (cnpjForm && cnpjInput && btnSalvarCnpj && cnpjMsg) {
            cnpjForm.style.display = 'block';
            btnSalvarCnpj.addEventListener('click', async (e)=>{
              e.preventDefault();
              cnpjMsg.textContent = 'Validando CNPJ...';
              const raw = cnpjInput.value.trim();
              const digits = onlyDigits(raw);
              if (!isValidCNPJ(digits)) { cnpjMsg.textContent = 'CNPJ inv√°lido. Confira e tente novamente.'; return; }

              try {
                const okAvail = await checkCnpjAvailability(digits);
                if (!okAvail) { /* apenas informativo */ }
              } catch(_){}

              cnpjMsg.textContent = 'Salvando...';
              try{
                const tok = (await firebase.auth().currentUser?.getIdToken(true)) || null;
                const r = await postConfigCNPJ(tok, digits);
                if (r.ok){
                  cnpjMsg.textContent = 'CNPJ salvo. Atualizando...';
                  try{
                    const j2 = await fetchConfig(tok);
                    const d2 = j2.data || j2 || {};
                    const c2 = onlyDigits(d2.cnpj || d2.cnpjSemMascara || d2.cnpj_basico || digits);
                    if (c2){ dCnpj.textContent = c2; hCnpj.value = c2; }
                    const legal2 = d2.legal_name || d2.razaoSocial || d2.razao_social || d2.nomeEmpresarial;
                    const trade2 = d2.trade_name || d2.nomeFantasia || d2.nome_fantasia;
                    if (legal2){ dLegal.textContent = legal2; hLegal.value = legal2; }
                    if (trade2){ dTrade.textContent = trade2; hTrade.value = trade2; }
                    // buscar detalhes logo ap√≥s salvar
                    try {
                      const emp2 = await fetchEmpresaDetalhes(c2);
                      if (emp2) populateFromEmpresa(emp2);
                    } catch(_){}
                  }catch(_){
                  }
                  cnpjForm.style.display = 'none';
                  cnpjMsg.textContent = '';
                  tryCheckCnpjVinculo(hCnpj.value || '', authName || '');
                } else if (r.status === 404 || r.status === 405){
                  cnpjMsg.textContent = 'Servidor ainda n√£o aceita salvar aqui. Voc√™ pode continuar e tentaremos preencher depois.';
                } else {
                  cnpjMsg.textContent = 'Falha ao salvar. Tente novamente.';
                }
              }catch(_){
                cnpjMsg.textContent = 'Erro ao salvar. Tente novamente.';
              }
            });
          }
        }

      } catch(e) {
        // permanece na tela
      }
    }

    async function loadWabaStatus(uid, idToken){
      try {
        if (!uid) { setWabaUI('UNKNOWN'); return; }
        const headers = {}; if (idToken) headers['Authorization'] = 'Bearer ' + idToken;
        const r = await fetch(`${API_BASE}/api/waba/status?uid=${encodeURIComponent(uid)}`, { headers });
        if (r.status === 404) {
          // console.info('[configuracao] /api/waba/status ‚Üí 404 (rota inexistente). Status = UNKNOWN.');
          setWabaUI('UNKNOWN');
          return;
        }
        if (!r.ok) { setWabaUI('UNKNOWN'); return; }
        const data = await r.json();
        setWabaUI(String(data.status || 'UNKNOWN').toUpperCase(), data);
        if (data.status && !/ACTIVE|FAILED/i.test(data.status)) {
          setTimeout(() => loadWabaStatus(uid, idToken), 60000);
        }
      } catch(e){
        setWabaUI('UNKNOWN');
      }
    }

    function setWabaUI(status, data){
      const s = (status || '').toUpperCase();
      const badge = document.getElementById('waba-badge');
      const note = document.getElementById('waba-note');
      const eta  = document.getElementById('waba-eta');
      badge.className = 'pill'; eta.textContent = ''; note.textContent = '';

      if (s === 'ACTIVE') {
        badge.classList.add('pill-active'); badge.textContent = 'ativo';
        const num = (data && data.numberE164) ? data.numberE164 : '';
        note.innerHTML = 'N√∫mero virtual <strong>ativado</strong> ' + (num ? '(' + escapeHtml(num) + ')' : '') + '. Tudo pronto para atender.';
      } else if (s === 'PROVISIONING') {
        badge.classList.add('pill-prov'); badge.textContent = 'ativando‚Ä¶';
        note.innerHTML = 'Estamos ativando seu n√∫mero virtual.';
        if (data && data.eta) eta.textContent = 'Entrega prevista at√©: ' + formatDateBR(data.eta);
      } else if (s === 'PENDING') {
        badge.classList.add('pill-pending'); badge.textContent = 'em valida√ß√£o';
        note.innerHTML = 'Aguardando valida√ß√£o e implanta√ß√£o.';
        if (data && data.eta) eta.textContent = 'Entrega prevista at√©: ' + formatDateBR(data.eta) + ' (at√© 7 dias √∫teis).';
        else eta.textContent = 'Entrega prevista: at√© 7 dias √∫teis.';
      } else if (s === 'FAILED') {
        badge.classList.add('pill-failed'); badge.textContent = 'falhou';
        note.textContent = 'N√£o foi poss√≠vel ativar o n√∫mero. Verifique a documenta√ß√£o e tente novamente.';
      } else {
        badge.classList.add('pill-pending'); badge.textContent = 'em valida√ß√£o';
        note.textContent = 'Estamos verificando o status do seu n√∫mero virtual.';
      }
    }

    /* ===== Submit (ajustado: s√≥ libera quando voz estiver READY ou player v√°lido) ===== */
    async function getIdTokenOrNull() {
      try {
        const user = firebase.auth().currentUser;
        if (!user) return null;
        return await user.getIdToken(true);
      } catch (e) {
        console.error("[configuracao] falha ao obter idToken:", e);
        return null;
      }
    }

    // PATCH 2 ‚Äî salvar configura√ß√£o SEM redirect (helper da agenda)
    async function salvarConfiguracaoSemRedirect() {
      cfgFeedback.textContent = '';

      const formEl = document.getElementById('config-form');
      const fd = new FormData(formEl);

      // garante que o uid v√° no form (caso ainda n√£o esteja)
      try {
        const user = firebase.auth().currentUser;
        if (user && !fd.get("uid")) {
          fd.set("uid", user.uid);
        }
      } catch (_) {}

      if (fd.get('janela_resposta') !== 'custom') fd.delete('janela_resposta_custom');
      fd.set('cnpj', document.getElementById('hid-cnpj').value || '');
      fd.set('segmento', document.getElementById('hid-segmento').value || '');
      fd.set('legal_name', document.getElementById('hid-legalname').value || '');
      fd.set('trade_name', document.getElementById('hid-tradename').value || '');

      const brandingChoice = (fd.get('branding_choice') || '').trim();
      if (brandingChoice !== 'custom') fd.set('public_brand', '');

      const headers = {};
      const idToken = await getIdTokenOrNull();
      if (idToken) {
        headers["Authorization"] = "Bearer " + idToken;
      }

      let resp;
      try {
        resp = await fetch(`${API_BASE}/api/configuracao`, {
          method: 'POST',
          headers,
          body: fd
        });
      } catch (e) {
        console.error("[configuracao] erro de rede:", e);
        cfgFeedback.textContent = '‚ùå Erro ao comunicar com o servidor.';
        return { ok:false, status:null, message:'erro_rede' };
      }

      let payload;
      try {
        const ct = resp.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          payload = await resp.json();
        } else {
          payload = { message: await resp.text() };
        }
      } catch (_) {
        payload = null;
      }

      if (!resp.ok) {
        let msg = '‚ùå Falha ao salvar configura√ß√µes de comunica√ß√£o.';
        if (payload && payload.message) {
          msg += ' ' + payload.message;
        }
        console.error("[configuracao] erro HTTP:", resp.status, payload);
        cfgFeedback.textContent = msg;
        return { ok:false, status:resp.status, message:msg };
      }

      console.log("[configuracao] salvo:", payload);
      cfgFeedback.textContent = '‚úÖ Dados de comunica√ß√£o salvos.';
      updateDashboardCTAVisibility(); // PATCH 3 ‚Äî talvez agora j√° tenha tudo para liberar o painel
      return { ok:true, status:resp.status, payload };
    }

    // PATCH 2 ‚Äî submit do form principal s√≥ salva (sem redirecionar)
    form.addEventListener('submit', function (event) {
      event.preventDefault();
      salvarConfiguracaoSemRedirect();
    });

    for (const r of document.getElementsByName('branding_choice')) {
      r.addEventListener('change', () => {
        const choice = r.value;
        for (const x of document.getElementsByName('branding_choice')) x.checked = (x.value === choice);
        if (choice === 'custom') document.getElementById('public_brand').removeAttribute('disabled');
        else document.getElementById('public_brand').setAttribute('disabled','disabled');
      });
    }
    /* ===== PATCH: initVozWaUI (liga a se√ß√£o ‚ÄúVoz via WhatsApp‚Äù) ===== */
    (function initVozWaUI(){
  function $(id){ return document.getElementById(id); }

  function mount(){
    const wa = {
      area: $("vozWaArea"),
      badge: $("vozWaBadge"),
      statusText: $("vozWaStatusText"),
      updatedAt: $("vozWaUpdatedAt"),
      code: $("vozWaCode"),
      msgReady: $("vozWaMsgReady"),
      codeHint: $("vozWaCodeHint"),
      erroHumano: $("vozWaErroHumano"),
      btnGerar: $("btnVozWaGerar"),
      btnCopiar: $("btnVozWaCopiar"),
      btnAbrir: $("btnVozWaAbrir"),
      btnRecarregar: $("btnVozWaRecarregar"),
      btnRefazer: $("btnVozWaRefazer"),
      player: $("vozWaPlayer"),
    };

    // exp√µe para debug
    window.vozWaEls = wa;

    if (window.__vozwa_new_ui) { return; }

    if (!wa.area || !wa.btnGerar || !wa.code || !wa.msgReady) {
      console.warn('[voz-wa] elementos n√£o encontrados (DOM incompleto).');
      return;
    }

    const numberE164 = String(window.VOICE_WA_NUMBER_E164 || '').trim() || '+5551985648608';
    const waDigits = numberE164.replace(/\D+/g,''); // s√≥ n√∫meros
    const waMeBase = `https://wa.me/${waDigits}`;

    function showErr(msg){
      if (!wa.erroHumano) return;
      wa.erroHumano.style.display = msg ? 'block' : 'none';
      wa.erroHumano.textContent = msg || '';
    }

    function setReadyMsg(code){
      showErr('');
      wa.code.value = code;
      wa.msgReady.value = `MEIROBO VOZ ${code}`;
      if (wa.btnCopiar) wa.btnCopiar.disabled = false;

      if (wa.btnAbrir) {
        wa.btnAbrir.href = `${waMeBase}?text=${encodeURIComponent(wa.msgReady.value)}`;
      }
      if (wa.codeHint) wa.codeHint.textContent = 'Copie a mensagem pronta e envie no WhatsApp.';
    }

    // Gera o c√≥digo local (MVP seguro) ‚Äî sem backend aqui
    function genCode(){
      return Math.random().toString(36).slice(2, 8).toUpperCase();
    }

    wa.btnGerar.addEventListener('click', async ()=> {
      // Seguran√ßa m√°xima: muda s√≥ o fluxo da voz WA, sem tocar no resto da p√°gina.
      if (!wa.btnGerar) return;
      wa.btnGerar.disabled = true;
      try{
        showErr('');
        if (wa.statusText) wa.statusText.textContent = 'Gerando c√≥digo...';

        // Pega telefone do MEI (N√ÉO altera o campo, s√≥ l√™)
        const telEl = document.querySelector('input[name="telefone"], input[name="whatsapp"], #whatsapp');
        const toRaw = (telEl && telEl.value ? String(telEl.value) : '').trim();

        if (!toRaw || toRaw.length < 8) {
          showErr('Preencha seu WhatsApp e clique em Salvar antes de enviar a voz.');
          if (wa.statusText) wa.statusText.textContent = 'WhatsApp do MEI n√£o preenchido.';
          return;
        }

        // 1) Gera o c√≥digo no backend (fonte da verdade)
        const linkPayload = await apiFetchJson(`${API_BASE}/api/voz/whatsapp/link`, {
          method: 'POST',
          body: JSON.stringify({})
        });

        const code = (linkPayload && linkPayload.code) ? String(linkPayload.code).trim() : '';
        if (!code) {
          showErr('N√£o foi poss√≠vel gerar o c√≥digo. Tente novamente.');
          if (wa.statusText) wa.statusText.textContent = 'Falha ao gerar c√≥digo.';
          return;
        }

        // Atualiza UI (mensagem pronta: "MEIROBO VOZ <CODE>")
        setReadyMsg(code);
        if (wa.statusText) wa.statusText.textContent = 'C√≥digo gerado. Agora registrando seu WhatsApp...';

        // 2) Registra/autoriza o remetente no backend (e tenta invite outbound se estiver ligado)
        const invitePayload = await apiFetchJson(`${API_BASE}/api/voz/whatsapp/invite`, {
          method: 'POST',
          body: JSON.stringify({ toE164: toRaw })
        });

        if (wa.badge) wa.badge.textContent = 'Pronto';
        if (wa.statusText) wa.statusText.textContent = 'Pronto: copie a mensagem e envie no WhatsApp.';
        if (wa.updatedAt) wa.updatedAt.textContent = 'agora';
        // Se o backend retornou next/detalhe, n√£o ‚Äúinventamos‚Äù ‚Äî s√≥ exibimos se j√° existir na UI.
        // (mantemos sil√™ncio para n√£o interferir em outros fluxos)
      }catch(e){
        const status = e && (e.status || e.statusCode);
        const body = e && e.body;
        console.error('[voz-wa] falha invite/link', e);

        if (status === 401) {
          showErr('Sess√£o expirada. Fa√ßa login novamente e tente de novo.');
          if (wa.statusText) wa.statusText.textContent = 'N√£o autenticado (401).';
          return;
        }
        if (status === 403) {
          showErr('Seu n√∫mero n√£o est√° autorizado para teste ainda (403).');
          if (wa.statusText) wa.statusText.textContent = 'N√£o autorizado (403).';
          return;
        }
        if (status === 400) {
          const hint = (body && body.hint) ? String(body.hint) : '';
          showErr(hint || 'WhatsApp inv√°lido. Preencha com DDD e clique em Salvar.');
          if (wa.statusText) wa.statusText.textContent = 'Dados inv√°lidos (400).';
          return;
        }

        showErr('Falha ao preparar a voz via WhatsApp. Recarregue a p√°gina e tente novamente.');
        if (wa.statusText) wa.statusText.textContent = 'Falha no preparo da voz.';
      }finally{
        wa.btnGerar.disabled = false;
      }
    });
if (wa.btnCopiar){
      wa.btnCopiar.addEventListener('click', async ()=> {
        try{
          await navigator.clipboard.writeText(wa.msgReady.value || '');
          if (wa.codeHint) wa.codeHint.textContent = 'Copiado ‚úÖ Agora √© s√≥ colar no WhatsApp.';
        }catch(_){
          if (wa.codeHint) wa.codeHint.textContent = 'Copie manualmente a mensagem pronta e cole no WhatsApp.';
        }
      });
    }

    console.log('[voz-wa] UI ligada. number=', numberE164);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', mount);
  } else {
    mount();
  }
})();</script>

  <script>
    (function(){
      const hintEl = document.getElementById('cnpj-vinculo-hint');
      const wrapper = document.getElementById('vinculo-extra-wrapper');
      const cpfInput = document.getElementById('cpf-responsavel');
      const chkAut = document.getElementById('chk-vinculo-autorizado');
      const erroEl = document.getElementById('vinculo-extra-erro');

      if (!hintEl || !wrapper) {
        console.warn('[configuracao] vinculo-extra-wrapper n√£o inicializado (sem CNPJ hint).');
        return;
      }

      function apenasNumeros(str){
        return String(str || '').replace(/\D+/g, '');
      }

      // PATCH 4 ‚Äì s√≥ mostra quando houver ‚ö† no hint
      function atualizarVisibilidade(){
        const texto = (hintEl.textContent || '').trim();

        // S√≥ considera "warning" quando houver o s√≠mbolo ‚ö† no texto do hint
        const hasWarning = /‚ö†/.test(texto);

        wrapper.hidden = !hasWarning;
        if (!hasWarning) {
          // zera campos se o v√≠nculo voltar a ficar totalmente OK
          if (cpfInput) cpfInput.value = '';
          if (chkAut) chkAut.checked = false;
          if (erroEl) { erroEl.style.display = 'none'; erroEl.textContent = ''; }
        }
      }

      // Roda uma vez na carga
      atualizarVisibilidade();

      // Observa mudan√ßas no hint para ligar/desligar o bloco
      const obs = new MutationObserver(function(){
        atualizarVisibilidade();
      });

      obs.observe(hintEl, { childList:true, characterData:true, subtree:true });

      // Valida√ß√£o leve no blur do CPF (opcional, n√£o bloqueia fluxo)
      if (cpfInput) {
        cpfInput.addEventListener('blur', function(){
          if (wrapper.hidden) return;
          const v = apenasNumeros(cpfInput.value);
          if (v && v.length > 0 && v.length < 11) {
            if (erroEl) {
              erroEl.style.display = 'block';
              erroEl.textContent = 'CPF parece incompleto.';
            }
          } else if (erroEl) {
            erroEl.style.display = 'none';
            erroEl.textContent = '';
          }
        });
      }

      if (chkAut && erroEl) {
        chkAut.addEventListener('change', function(){
          if (!chkAut.checked) {
            erroEl.style.display = 'block';
            erroEl.textContent = 'Para continuar, marque que voc√™ est√° autorizado(a) pela empresa.';
          } else {
            erroEl.style.display = 'none';
            erroEl.textContent = '';
          }
        });
      }
    })();
  </script>

<script>
/* ===== INIT: Agenda compacta + Voz via WhatsApp (sem painel de avi√£o) =====
 * - Mant√©m CNPJ do arquivo can√¥nico
 * - Agenda: usa os IDs do sec-agenda (compacto)
 * - Voz: usa o bot√£o √∫nico #btnVozWaGerar e integra com backend (invite) quando existir
 */
(function(){
  function $(id){ return document.getElementById(id); }
  function esc(s){ return String(s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  async function getIdTokenSafe(){
    try{
      if (window.firebase && firebase.auth){
        const u = (typeof firebase.auth === "function") ? firebase.auth().currentUser : firebase.auth.currentUser;
        if (u) return await u.getIdToken(true);
      }
    }catch(e){}
    return null;
  }
  async function apiFetchJson(url, opts){
    opts = opts || {};
    opts.headers = opts.headers || {};
    if (!opts.headers["Content-Type"] && opts.method && opts.method.toUpperCase() !== "GET"){
      opts.headers["Content-Type"] = "application/json";
    }
    const tok = await getIdTokenSafe();
    if (tok) opts.headers["Authorization"] = "Bearer " + tok;
    const res = await fetch(url, opts);
    const ct = (res.headers.get("content-type")||"").toLowerCase();
    const body = ct.includes("application/json") ? await res.json().catch(()=>null) : await res.text().catch(()=>null);
    if (!res.ok){
      const msg = (body && body.error) ? body.error : (typeof body === "string" ? body : ("HTTP " + res.status));
      const err = new Error(msg);
      err.status = res.status;
      err.body = body;
      throw err;
    }
    return body;
  }

  // ===== AGENDA (compacta) =====
  (function initAgendaCompact(){
    const wrap = $("agendaSummaryWrap");
    const edit = $("agendaEditArea");
    if (!wrap || !edit) return;

    const el = {
      resumo: $("agendaConfigResumo"),
      btnEditar: $("btnAgendaEditar"),
      btnCancelar: $("btnAgendaCancelar"),
      btnSalvar: $("btnAgendaSalvar"),
      // editor
      d1:$("ag_d1"), d2:$("ag_d2"), d3:$("ag_d3"), d4:$("ag_d4"), d5:$("ag_d5"), d6:$("ag_d6"), d7:$("ag_d7"),
      ini:$("ag_ini"), fim:$("ag_fim"),
      lead:$("ag_lead"), same:$("ag_same"), max:$("ag_max"),
      status:$("agendaStatus")
    };

    function setStatus(html){ if (el.status) el.status.innerHTML = html || ""; }

    function summarize(cfg){
      try{
        const days = [];
        const map = [
          ["Dom", cfg.sun],["Seg", cfg.mon],["Ter", cfg.tue],["Qua", cfg.wed],["Qui", cfg.thu],["Sex", cfg.fri],["S√°b", cfg.sat]
        ];
        map.forEach(([nm,on])=>{ if (on) days.push(nm); });
        const dias = days.length ? days.join(", ") : "nenhum dia";
        const faixa = (cfg.start||"--:--") + "‚Äì" + (cfg.end||"--:--");
        const lead = (cfg.lead_min!=null) ? (cfg.lead_min + " min") : "‚Äî";
        const same = cfg.allow_same_day ? "sim" : "n√£o";
        const max = (cfg.max_per_day!=null) ? cfg.max_per_day : "‚Äî";
        return `Dias: ${dias} ‚Ä¢ Hor√°rio: ${faixa} ‚Ä¢ Anteced√™ncia: ${lead} ‚Ä¢ Hoje: ${same} ‚Ä¢ Limite/dia: ${max}`;
      }catch(e){
        return "Agenda carregada.";
      }
    }

    function editorFromCfg(cfg){
      if (!cfg) return;
      if (el.d1) el.d1.checked = !!cfg.sun;
      if (el.d2) el.d2.checked = !!cfg.mon;
      if (el.d3) el.d3.checked = !!cfg.tue;
      if (el.d4) el.d4.checked = !!cfg.wed;
      if (el.d5) el.d5.checked = !!cfg.thu;
      if (el.d6) el.d6.checked = !!cfg.fri;
      if (el.d7) el.d7.checked = !!cfg.sat;
      if (el.ini) el.ini.value = cfg.start || "09:00";
      if (el.fim) el.fim.value = cfg.end || "18:00";
      if (el.lead) el.lead.value = String(cfg.lead_min ?? 60);
      if (el.same) el.same.checked = !!cfg.allow_same_day;
      if (el.max) el.max.value = String(cfg.max_per_day ?? 8);
    }

    function cfgFromEditor(){
      return {
        sun: !!(el.d1 && el.d1.checked),
        mon: !!(el.d2 && el.d2.checked),
        tue: !!(el.d3 && el.d3.checked),
        wed: !!(el.d4 && el.d4.checked),
        thu: !!(el.d5 && el.d5.checked),
        fri: !!(el.d6 && el.d6.checked),
        sat: !!(el.d7 && el.d7.checked),
        start: (el.ini && el.ini.value) || "09:00",
        end: (el.fim && el.fim.value) || "18:00",
        lead_min: parseInt((el.lead && el.lead.value) || "60",10),
        allow_same_day: !!(el.same && el.same.checked),
        max_per_day: parseInt((el.max && el.max.value) || "8",10),
      };
    }

    let currentCfg = null;

    async function load(){
      setStatus("<span class='muted'>Carregando agenda‚Ä¶</span>");
      try{
        // endpoint j√° existente no backend (mant√©m compat)
        const payload = await apiFetchJson("/api/agenda/config", { method:"GET" });
        currentCfg = payload && (payload.config || payload) || null;
        if (el.resumo) el.resumo.textContent = summarize(currentCfg || {});
        editorFromCfg(currentCfg || {});
        setStatus("");
      }catch(e){
        setStatus("<span class='warn'>N√£o consegui carregar a agenda agora.</span>");
      }
    }

    function openEdit(){
      wrap.style.display = "none";
      edit.style.display = "";
      editorFromCfg(currentCfg || {});
      setStatus("");
    }
    function closeEdit(){
      edit.style.display = "none";
      wrap.style.display = "";
      setStatus("");
    }

    if (el.btnEditar) el.btnEditar.onclick = openEdit;
    if (el.btnCancelar) el.btnCancelar.onclick = closeEdit;

    if (el.btnSalvar) el.btnSalvar.onclick = async ()=>{
      setStatus("<span class='muted'>Salvando‚Ä¶</span>");
      try{
        const cfg = cfgFromEditor();
        const payload = await apiFetchJson("/api/agenda/config", { method:"POST", body: JSON.stringify({ config: cfg }) });
        currentCfg = payload && (payload.config || cfg);
        if (el.resumo) el.resumo.textContent = summarize(currentCfg || cfg);
        setStatus("<span class='ok'>Agenda salva ‚úÖ</span>");
        closeEdit();
      }catch(e){
        setStatus("<span class='warn'>Falha ao salvar a agenda.</span>");
      }
    };

    load();
  })();

  // ===== VOZ via WhatsApp (bot√£o √∫nico) =====
  (function initVozWaSimple(){
    if (window.__vozwa_new_ui) return; // ‚úÖ n√£o sobrescrever a UI nova
    window.__vozwa_new_ui = true;      // ‚úÖ trava multiverso: garante dono √∫nico do bot√£o
    const btn = $("btnVozWaGerar");
    const player = $("voicePlayer");
    if (!btn) return;

    function toast(msg){
      try{
        const el = $("vozWaStatus") || $("voiceStatus") || null;
        if (el) el.innerHTML = esc(msg);
      }catch(e){}
    }

    btn.onclick = async ()=>{
      btn.disabled = true;
      toast("Gerando instru√ß√£o‚Ä¶");
      try{
        const base = (window.API_BASE || "https://mei-robo-prod.onrender.com");
        const t = await getIdTokenSafe();
        if (!t) throw new Error("no_token");
        const toE164 =
          (window.__vozWa_toE164 && String(window.__vozWa_toE164).trim()) ||
          (($("whatsapp") || $("telefone") || $("phone") || null) ? (String(( $("whatsapp")||$("telefone")||$("phone") ).value||"").trim()) : "");

        if (!toE164 || toE164.length < 8) {
          toast("Preencha seu WhatsApp (com +55...) e clique em Salvar antes de enviar a voz.");
          return;
        }
        const payload = await (await fetch(base + "/api/voz/whatsapp/invite", { method:"POST", headers:{ "Authorization":"Bearer " + t, "Content-Type":"application/json" }, body: JSON.stringify({ toE164 }) })).json();
        // backend deve devolver link/message/c√≥digo; tratamos tudo na boa
        const code = payload && (payload.code || payload.codigo || payload.inviteCode);
        const waLink = payload && (payload.wa_link || payload.waLink || payload.link || payload.url);
        const msg = payload && (payload.message || payload.msg);
        if (waLink){
          window.open(waLink, "_blank", "noopener");
          toast("Pronto. Envie o √°udio no WhatsApp ‚úÖ");
        }else if (msg){
          navigator.clipboard?.writeText(msg).catch(()=>{});
          toast("Copiei a mensagem. Cole no WhatsApp ‚úÖ");
        }else{
          toast(code ? ("C√≥digo gerado: " + esc(code)) : "Instru√ß√£o gerada ‚úÖ");
        }
      }catch(e){
        toast("N√£o consegui iniciar agora. Verifique login e tente de novo.");
      }finally{
        btn.disabled = false;
      }
    };
  })();

})();
</script>


<!-- ===== PATCH: restore "Salvar e continuar" (safe wiring) ===== -->
<script>
(function(){
  try{
    var btn = document.getElementById('btn-salvar');
    if(!btn) return;

    // Make it visible + clickable (even if an older script hid it)
    try{ btn.style.display = 'inline-flex'; }catch(e){}
    try{ btn.disabled = false; }catch(e){}

    // IMPORTANT: Do not duplicate business rules.
    // We simply trigger the existing agenda save+continue flow (which already handles:
    // - voice gate, config gate, authority gate
    // - save config + save agenda
    // - redirect (dashboard vs onboarding)
    btn.onclick = function(){
      try{
        var agendaForm = document.getElementById('agenda-form');
        if(agendaForm){
          // Fire the existing submit handler (salvarAgendaConfig is bound via addEventListener)
          var ev = new Event('submit', { bubbles:true, cancelable:true });
          agendaForm.dispatchEvent(ev);
          return;
        }

        // Fallback: if agenda form isn't present, try to find the bottom "Salvar e continuar" button
        var agendaBtn = document.getElementById('agenda-save-btn');
        if(agendaBtn && typeof agendaBtn.click === 'function'){
          agendaBtn.click();
          return;
        }

        console.warn('[btn-salvar] agenda-form n√£o encontrado; nada para acionar.');
      }catch(err){
        console.error('[btn-salvar] falha ao acionar fluxo de salvar/continuar:', err);
      }
    };
  }catch(e){
    console.error('[btn-salvar] patch init falhou:', e);
  }
})();
</script>

<!-- PATCH: mover "Salvar e continuar" para o final (abaixo da Agenda) -->
<script>
(function(){
  function move(){
    var btn = document.getElementById('btn-salvar');
    if(!btn) return;

    // garante que est√° vis√≠vel
    btn.style.display = 'inline-flex';
    btn.disabled = false;

    // tenta ancorar abaixo da √°rea da agenda
    var anchor =
      document.getElementById('agendaArea') ||
      document.getElementById('agendaWrap') ||
      document.getElementById('agenda-form') ||
      document.getElementById('agenda-card') ||
      document.querySelector('#agenda-form') ||
      null;
    
    // se o form estiver hidden, ancora no pai (container vis√≠vel)
    if (anchor && anchor.style && anchor.style.display === 'none' && anchor.parentElement) {
      anchor = anchor.parentElement;
    }
    
    if(!anchor) return;

    // coloca o bot√£o logo depois do bloco da agenda
    anchor.insertAdjacentElement('afterend', btn);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', move);
  } else {
    move();
  }
})();
</script>

<!-- ===== /PATCH ===== -->


<script>
/* FASE 1: isolador de voz (configuracao.html)
 * - garante que nenhum handler de voz fique ativo aqui
 * - qualquer clique em bot√µes de voz vira redirecionamento
 */
(function(){
  try{
    if (!window.__VOICE_DISABLED_IN_CONFIG__) return;
    const go = ()=>{ try{ window.location.href='/pages/configuracao_voz.html'; }catch(e){} };
    const ids = [
      'btnVozWaGerar','btnVozWaCopiar','btnVozWaAbrir',
      'btnVozWaGerar2','btnVozWaCopiar2','btnVozWaAbrir2',
      'btnVozWaCopy','btnVozWaOpen','btnVozWaOpen2'
    ];
    for (const id of ids){
      const el = document.getElementById(id);
      if (el) el.onclick = go;
    }
  }catch(e){}
})();
</script>
</body>
</html>












