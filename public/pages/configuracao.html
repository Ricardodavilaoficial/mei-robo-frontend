<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configura√ß√£o de comunica√ß√£o ‚Äî MEI Rob√¥</title>

  <!-- Canonical WWW v1.0 (placeholders est√°ticos; layout.js pode sobrescrever em runtime) -->
  <link rel="canonical" href="https://www.meirobo.com.br/pages/configuracao.html" />
  <meta property="og:url" content="https://www.meirobo.com.br/pages/configuracao.html" />
  <meta name="twitter:url" content="https://www.meirobo.com.br/pages/configuracao.html" />

  <link rel="stylesheet" href="/assets/styles.css" />
  <!-- Bust leve pra evitar cache local -->
  <script defer src="/assets/layout.js?v=2025-09-06-07"></script>

  <style>
    :root { --input-h: 48px; --input-br: 10px; --hint: .92rem; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    @media (max-width: 900px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
    .mt-6{margin-top:6px}.mt-8{margin-top:8px}.mt-12{margin-top:12px}.mt-16{margin-top:16px}.mt-20{margin-top:20px}.mt-24{margin-top:24px}
    .w-100{width:100%}.hint{font-size:var(--hint);opacity:.9} form section{margin-top:18px} form label{display:block;margin:8px 0}

    /* ===== Tema escuro local (apenas nesta p√°gina) ===== */
    /* Usa tons pr√≥ximos ao restante da plataforma */
    :root {
      --bg-input: rgba(255,255,255,0.06);
      --bd-input: #374151;   /* cinza-500 aprox */
      --fg-input: #e5e7eb;   /* cinza-200 aprox */
      --ph-input: 0.55;      /* opacidade do placeholder */
      --fg-display: #e5e7eb;
    }

    /* Inputs padr√£o (apenas os edit√°veis ficam assim) */
    input[type="text"],input[type="email"],input[type="tel"],select{
      width:100%;height:var(--input-h);
      border:1px solid var(--bd-input);
      border-radius:var(--input-br);
      padding:0 12px;
      color:var(--fg-input);
      outline:none;box-sizing:border-box;
      background:var(--bg-input);
    }
    input::placeholder{opacity:var(--ph-input)}

    /* Valores fixos exibidos ‚Äúsecos‚Äù (sem caixa) */
    .display-value{
      display:block;
      padding: 10px 0 2px;
      font-weight:600;
      color:var(--fg-display);
      letter-spacing:.2px;
    }

    /* Bot√µes */
    .btn{padding:10px 14px;border:0;border-radius:8px;cursor:pointer}
    .btn.primary{background:#25D366;color:#fff}
    .btn.outline{background:transparent;border:1px solid var(--bd-input);color:var(--fg-input)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .card + .card{margin-top:16px}

    /* Badges (apenas para status WABA) */
    .pill{display:inline-block;font-size:.76rem;line-height:1;padding:5px 8px;border-radius:999px;vertical-align:middle;margin-left:8px}
    .pill-pending{background:#fff7e6;color:#8a5a00;border:1px solid #f5d08a}
    .pill-prov{background:#eef5ff;color:#0b63c9;border:1px solid #cfe0ff}
    .pill-active{background:#e8fff2;color:#116a3d;border:1px solid #25D366}
    .pill-failed{background:#feecec;color:#9b1c1c;border:1px solid #fecaca}

    /* Branding radios */
    .branding-options { display:grid; gap:10px; }
    .branding-option { display:flex; align-items:flex-start; gap:10px; padding:10px; border:1px solid var(--bd-input); border-radius:10px; background:rgba(255,255,255,0.03); }
    .branding-option small { opacity:.8 }
  </style>
</head>
<body>
  <div id="app-header"></div>

  <main class="container">
    <div class="card">
      <h2>Configura√ß√£o de comunica√ß√£o</h2>
      <p class="hint">Como voc√™ fala com as pessoas no WhatsApp. Capriche aqui: isso aumenta respostas, or√ßamentos e fechamentos.</p>
      <p class="hint mt-8">Este √© o <strong>padr√£o geral</strong>. Depois d√° pra ajustar por contato.</p>

      <form id="config-form" class="mt-16" novalidate>
        <!-- Status do n√∫mero virtual -->
        <section id="sec-waba">
          <h3>WhatsApp Business - Conta comercial com MEI Rob√¥ - <span id="waba-badge" class="pill pill-pending">em valida√ß√£o</span></h3>
          <p id="waba-fixed" class="hint mt-6">
            Voc√™ receber√° um <strong>n√∫mero novo do WhatsApp Business</strong> (virtual, <strong>sem chip</strong>), adequado para conta comercial.
            Voc√™ pode manter seus n√∫meros atuais, <strong>acrescentando o novo n√∫mero e mantendo a mesma forma que voc√™ j√° utiliza</strong>;
            o rob√¥ usar√° este n√∫mero quando estiver <strong>Ativo</strong>. A libera√ß√£o acontece ap√≥s a <strong>configura√ß√£o e implanta√ß√£o pelo MEI Rob√¥</strong>,
            em at√© <strong>7 dias √∫teis</strong>.
          </p>
          <p id="waba-note" class="hint"></p>
          <p id="waba-eta" class="hint"></p>
        </section>

        <!-- Dados da conta (exibi√ß√£o seca) -->
        <section class="mt-20">
          <h3>Dados da conta</h3>
          <div class="grid-2">
            <div>
              <label>Nome</label>
              <span id="disp-nome" class="display-value">‚Äî</span>
              <input type="hidden" name="nome" id="hid-nome" />
            </div>
            <div>
              <label>E-mail</label>
              <span id="disp-email" class="display-value">‚Äî</span>
              <input type="hidden" name="email" id="hid-email" />
            </div>

            <!-- WhatsApp do usu√°rio (para notifica√ß√µes) -->
            <label>Seu WhatsApp (para notifica√ß√µes)
              <input type="tel" name="telefone" autocomplete="tel" placeholder="Ex.: +55 11 91234-5678" />
              <span class="hint">Usaremos este n√∫mero para avisos e testes. O n√∫mero do MEI Rob√¥ ser√° configurado depois.</span>
            </label>

            <div>
              <label>CNPJ</label>
              <span id="disp-cnpj" class="display-value">‚Äî</span>
              <input type="hidden" name="cnpj" id="hid-cnpj" />
            </div>
          </div>

          <!-- Identidade legal (somente leitura) -->
          <div class="grid-2 mt-12">
            <div>
              <label>Raz√£o Social (legal)</label>
              <span id="disp-legalname" class="display-value">‚Äî</span>
              <input type="hidden" name="legal_name" id="hid-legalname" />
            </div>
            <div>
              <label>Nome Fantasia</label>
              <span id="disp-tradename" class="display-value">‚Äî</span>
              <input type="hidden" name="trade_name" id="hid-tradename" />
            </div>
          </div>

          <!-- V√≠nculo leve ao CNPJ (n√£o-bloqueante) -->
          <p id="cnpj-vinculo-hint" class="hint mt-8"></p>
        </section>

        <!-- Marca p√∫blica -->
        <section>
          <h3>Como seu neg√≥cio deve aparecer para os clientes?</h3>
          <div class="branding-options" id="branding-options">
            <label class="branding-option">
              <input type="radio" name="branding_choice" value="trade_name" />
              <div>
                <div><strong>Usar Nome Fantasia</strong> <small>(se existir)</small></div>
                <div class="hint">Aparece em mensagens, or√ßamentos e materiais.</div>
              </div>
            </label>

            <label class="branding-option">
              <input type="radio" name="branding_choice" value="legal_name" />
              <div>
                <div><strong>Usar Raz√£o Social</strong></div>
                <div class="hint">Op√ß√£o conservadora, costuma bater com cadastros oficiais.</div>
              </div>
            </label>

            <label class="branding-option">
              <input type="radio" name="branding_choice" value="custom" />
              <div class="w-100">
                <div><strong>Definir um nome personalizado</strong></div>
                <input type="text" name="public_brand" id="public_brand" placeholder="Ex.: Ed Barba" class="mt-8" />
                <div class="hint mt-6">Esse nome aparece para seus clientes. Documentos fiscais continuam com a Raz√£o Social.</div>
              </div>
            </label>
          </div>
        </section>

        <!-- Segmento e √°reas -->
        <section>
          <h3>Segmento profissional</h3>
          <div class="grid-2">
            <div>
              <label>Segmento (CNAE)</label>
              <span id="disp-segmento" class="display-value">‚Äî</span>
              <input type="hidden" name="segmento" id="hid-segmento" />
            </div>
            <label>√Årea que voc√™ mais atua
              <input type="text" name="esp1" placeholder="Ex.: Pneus / Corte masculino / Direito trabalhista" />
            </label>
            <label>Outra √°rea de atua√ß√£o (opcional)
              <input type="text" name="esp2" placeholder="Ex.: Troca de √≥leo / Barba / Contratos" />
            </label>
          </div>
        </section>

        <!-- Seu jeito de falar -->
        <section>
          <h3>Seu jeito de falar</h3>
          <p class="hint">Defina o estilo que voc√™ costuma usar com a maioria dos clientes. Depois d√° pra personalizar por contato.</p>

          <div class="grid-3">
            <label>Formalidade
              <select name="formalidade">
                <option value="alta">Alta ‚Äî ‚ÄúPrezado Sr. Jo√£o‚Ä¶‚Äù</option>
                <option value="media" selected>M√©dia ‚Äî ‚ÄúOl√°, Jo√£o, tudo bem?‚Äù</option>
                <option value="baixa">Baixa ‚Äî ‚ÄúE a√≠, Jo√£o, beleza?‚Äù</option>
              </select>
            </label>
            <label>Usa emojis?
              <select name="emojis">
                <option value="sim" selected>Sim</option>
                <option value="as_vezes">√Äs vezes</option>
                <option value="nao">N√£o</option>
              </select>
            </label>
            <label>Sauda√ß√£o preferida
              <input type="text" name="saudacao" placeholder="Ex.: Ol√°! Tudo bem? / Bom dia! Como vai?" />
            </label>
          </div>

          <div class="grid-2 mt-12">
            <label>Como voc√™ costuma ser chamado?
              <input type="text" name="display_name" placeholder="Ex.: Ricardo / Ricardo ‚Äî Barbeiro / Dr. Ricardo / Ricard√£o üòé" />
              <span class="hint">Esse √© o nome que aparece nas mensagens, quando necess√°rio. Voc√™ pode mudar por contato depois.</span>
            </label>
            <label>Fechamento de conversa (opcional)
              <input type="text" name="closing_text" placeholder="Ex.: Abra√ßo. Ricardo / Obrigado! Ricardo" />
              <span class="hint">Usado s√≥ quando fizer sentido.</span>
            </label>
          </div>

          <div class="grid-2 mt-12">
            <label>Hor√°rio de resposta padr√£o
              <select name="janela_resposta" id="janela_resposta">
                <option value="24x7" selected>Sempre dispon√≠vel (24/7 ‚Äî padr√£o do MEI Rob√¥)</option>
                <option value="comercial">Hor√°rio comercial (Seg‚ÄìSex, 9h‚Äì18h)</option>
                <option value="estendido">Estendido (Seg‚ÄìS√°b, 8h‚Äì20h)</option>
                <option value="custom">Personalizado‚Ä¶</option>
              </select>
            </label>
          </div>
          <div id="custom-horario" class="mt-8" style="display:none">
            <label>Informe seu hor√°rio (livre)
              <input type="text" name="janela_resposta_custom" placeholder="Ex.: Respondo das 9h √†s 18h e, √†s vezes, at√© 22h" />
            </label>
          </div>
        </section>

        <div class="mt-24">
          <button id="btn-salvar" type="submit" class="btn primary">Salvar e continuar</button>
          <span id="config-feedback" class="hint mt-8" style="margin-left:8px;"></span>
        </div>
      </form>
    </div>
  </main>

  <div id="app-footer"></div>

  <script>
    // ============================ API BASE ============================
    const API_BASE = (localStorage.getItem('apiBase') || 'https://mei-robo-prod.onrender.com').replace(/\/+$/, '');

    // ====================== Firebase readiness helper =================
    async function waitForFirebaseAuth(timeoutMs = 10000) {
      return new Promise((resolve) => {
        const start = Date.now();
        (function check() {
          const ready = !!(window.firebase && firebase.apps && firebase.apps.length && firebase.auth);
          if (ready) return resolve(true);
          if (Date.now() - start > timeoutMs) return resolve(false);
          setTimeout(check, 50);
        })();
      });
    }

    // =============== AUTH GATE (discreto; sem CTA de login aqui) ======
    (async function authGate() {
      const fbReady = await waitForFirebaseAuth();
      if (fbReady && window.firebase && firebase.auth) {
        await new Promise((resolve) => {
          let resolved = false;
          const unsub = firebase.auth().onAuthStateChanged((user) => {
            if (resolved) return;
            resolved = true; unsub();
            resolve();
          });
          setTimeout(() => { if (!resolved) { resolved = true; resolve(); } }, 3000);
        });
      }
    })();

    // ============================== HELPERS ===========================
    async function getAuthContext() {
      let uid = localStorage.getItem('uid') || sessionStorage.getItem('uid') || null;
      let idToken = null;
      if (window.firebase && firebase.auth) {
        try {
          const user = firebase.auth().currentUser;
          if (user) {
            uid = user.uid;
            idToken = await user.getIdToken(true);
          }
        } catch (_) {}
      }
      return { uid, idToken };
    }

    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[s])); }
    function formatDateBR(iso){
      try { const d = new Date(iso); const dd = String(d.getDate()).padStart(2,'0'); const mm = String(d.getMonth()+1).padStart(2,'0'); const yy = d.getFullYear(); return `${dd}/${mm}/${yy}`; }
      catch(_){ return iso; }
    }
    function onlyDigits(s){ return String(s||'').replace(/\D+/g,''); }

    // ============================== ELEMENTOS =========================
    const form = document.getElementById('config-form');
    const cfgFeedback = document.getElementById('config-feedback');
    const btnSalvar = document.getElementById('btn-salvar');

    // Displays e inputs ocultos p/ dados fixos
    const dNome = document.getElementById('disp-nome');
    const dEmail = document.getElementById('disp-email');
    const dCnpj = document.getElementById('disp-cnpj');
    const dSeg  = document.getElementById('disp-segmento');
    const dLegal= document.getElementById('disp-legalname');
    const dTrade= document.getElementById('disp-tradename');

    const hNome = document.getElementById('hid-nome');
    const hEmail= document.getElementById('hid-email');
    const hCnpj = document.getElementById('hid-cnpj');
    const hSeg  = document.getElementById('hid-segmento');
    const hLegal= document.getElementById('hid-legalname');
    const hTrade= document.getElementById('hid-tradename');

    // Edit√°veis
    const fTel   = form.querySelector('input[name="telefone"]');
    const fEsp1  = form.querySelector('input[name="esp1"]');
    const fEsp2  = form.querySelector('input[name="esp2"]');
    const fFormal= form.querySelector('select[name="formalidade"]');
    const fEmojis= form.querySelector('select[name="emojis"]');
    const fSaud  = form.querySelector('input[name="saudacao"]');
    const fDisp  = form.querySelector('input[name="display_name"]');
    const fClose = form.querySelector('input[name="closing_text"]');
    const fJanela= document.getElementById('janela_resposta');
    const wrapCustom = document.getElementById('custom-horario');
    const fJanelaCustom = form.querySelector('input[name="janela_resposta_custom"]');

    // Branding
    const brandingOptions = document.getElementsByName('branding_choice');
    const fPublicBrand = document.getElementById('public_brand');

    // WABA UI
    const wabaBadge = document.getElementById('waba-badge');
    const wabaNote  = document.getElementById('waba-note');
    const wabaEta   = document.getElementById('waba-eta');

    // CNPJ v√≠nculo hint
    const cnpjVinculoHint = document.getElementById('cnpj-vinculo-hint');

    fJanela.addEventListener('change', () => {
      wrapCustom.style.display = (fJanela.value === 'custom') ? 'block' : 'none';
    });

    function selectBranding(choice){
      for (const r of brandingOptions) r.checked = (r.value === choice);
      // s√≥ mostra/capta public_brand quando custom
      if (choice === 'custom') {
        fPublicBrand.removeAttribute('disabled');
      } else {
        fPublicBrand.setAttribute('disabled','disabled');
      }
    }

    function initBranding(data){
      // data pode trazer legal_name, trade_name, branding_choice, public_brand
      const legal = data.legal_name || '';
      const trade = data.trade_name || '';
      hLegal.value = legal; dLegal.textContent = legal || '‚Äî';
      hTrade.value = trade; dTrade.textContent = trade || '‚Äî';

      const choice = data.branding_choice || (trade ? 'trade_name' : 'legal_name');
      const custom = data.public_brand || '';

      selectBranding(choice);
      if (custom) fPublicBrand.value = custom;
      if (choice !== 'custom') fPublicBrand.value = custom || ''; // mant√©m vazio quando n√£o for custom
    }

    // ============================== INIT ==============================
    (async function init() {
      await waitForFirebaseAuth();
      const { uid, idToken } = await getAuthContext();

      // Carrega snapshot de configura√ß√£o
      if (uid) {
        try {
          const headers = {}; if (idToken) headers['Authorization'] = 'Bearer ' + idToken;
          const resp = await fetch(`${API_BASE}/api/configuracao?uid=${encodeURIComponent(uid)}`, { method: 'GET', headers });
          if (resp.ok) {
            const data = await resp.json();

            // Exibe dados fixos (secos) + mant√©m hidden p/ payload
            if (data.nome)  { dNome.textContent = data.nome; hNome.value = data.nome; }
            if (data.email) { dEmail.textContent = data.email; hEmail.value = data.email; }
            if (data.cnpj)  { dCnpj.textContent = data.cnpj; hCnpj.value = data.cnpj; }
            if (data.segmento) { dSeg.textContent = data.segmento; hSeg.value = data.segmento; }

            // Identidade legal/trade se vierem do backend
            if (data.legal_name) { dLegal.textContent = data.legal_name; hLegal.value = data.legal_name; }
            if (data.trade_name) { dTrade.textContent = data.trade_name; hTrade.value = data.trade_name; }

            // Demais campos
            if (data.telefone) fTel.value = data.telefone;
            if (data.esp1) fEsp1.value = data.esp1;
            if (data.esp2) fEsp2.value = data.esp2;
            if (data.formalidade) fFormal.value = data.formalidade;
            if (data.emojis) fEmojis.value = data.emojis;
            if (data.saudacao) fSaud.value = data.saudacao;
            if (data.display_name) fDisp.value = data.display_name;
            if (data.closing_text) fClose.value = data.closing_text;
            if (data.janela_resposta) {
              fJanela.value = data.janela_resposta;
              wrapCustom.style.display = (fJanela.value === 'custom') ? 'block' : 'none';
            }
            if (data.janela_resposta_custom) {
              fJanelaCustom.value = data.janela_resposta_custom;
            }

            // Inicializa branding (marca p√∫blica)
            initBranding(data);

            // Se temos CNPJ mas n√£o temos segmento, tentar auto-fill via rota p√∫blica
            const cnpjDigits = onlyDigits(hCnpj.value);
            if (cnpjDigits.length === 14 && !hSeg.value) {
              await tryAutofillFromCNPJ(cnpjDigits);
            }

            // Verifica√ß√£o leve de v√≠nculo (n√£o-bloqueante)
            if (cnpjDigits.length === 14 && hNome.value) {
              tryCheckCnpjVinculo(cnpjDigits, hNome.value);
            }
          } else {
            cfgFeedback.textContent = '‚ö†Ô∏è N√£o foi poss√≠vel carregar seus dados agora.';
          }
        } catch (err) {
          console.error(err);
          cfgFeedback.textContent = '‚ö†Ô∏è Erro ao carregar dados.';
        }
      }

      // Carrega status do n√∫mero virtual (WABA)
      await loadWabaStatus(uid, idToken);
    })();

    async function tryAutofillFromCNPJ(cnpj14){
      try {
        console.log('[cnpj] consulta iniciada');
        const r = await fetch(`${API_BASE}/integracoes/cnpj/${encodeURIComponent(cnpj14)}`);
        if (!r.ok) { console.warn('[cnpj] falha', r.status); return; }
        const j = await r.json();
        // Segmento (CNAE descri√ß√£o)
        const desc = (j && j.cnaePrincipal && j.cnaePrincipal.descricao) ? String(j.cnaePrincipal.descricao) : '';
        if (desc && !hSeg.value) {
          hSeg.value = desc;
          dSeg.textContent = desc;
          console.log('[cnpj] segmento preenchido');
        }
        // Legal / trade se vierem e ainda n√£o estiverem setados
        if (j && j.razaoSocial && !hLegal.value) { hLegal.value = j.razaoSocial; dLegal.textContent = j.razaoSocial; }
        if (j && j.nomeFantasia && !hTrade.value) { hTrade.value = j.nomeFantasia; dTrade.textContent = j.nomeFantasia; }

        // Branding: se n√£o houve escolha ainda, preferir trade_name se existir
        if (![...brandingOptions].some(r=>r.checked)) {
          selectBranding(hTrade.value ? 'trade_name' : 'legal_name');
        }
      } catch(e){
        console.warn('[cnpj] erro', e);
      }
    }

    async function tryCheckCnpjVinculo(cnpj14, nomeBusca){
      try {
        const u = `${API_BASE}/integracoes/cnpj/${encodeURIComponent(cnpj14)}?nome=${encodeURIComponent(nomeBusca)}`;
        const r = await fetch(u);
        if (!r.ok) return;
        const j = await r.json();
        const v = j && j.vinculoNome && j.vinculoNome.avaliacao;
        if (v === 'EXATO' || v === 'PROVAVEL') {
          cnpjVinculoHint.textContent = '‚úÖ V√≠nculo ao CNPJ: ok.';
        } else if (v === 'NAO_ENCONTRADO') {
          cnpjVinculoHint.textContent = '‚ö†Ô∏è N√£o confirmamos v√≠nculo do nome informado com este CNPJ. Se estiver tudo certo, siga; nossa valida√ß√£o acontece no backend.';
        }
      } catch(_){}
    }

    async function loadWabaStatus(uid, idToken){
      try {
        if (!uid) { setWabaUI('UNKNOWN'); return; }
        const headers = {}; if (idToken) headers['Authorization'] = 'Bearer ' + idToken;
        const r = await fetch(`${API_BASE}/api/waba/status?uid=${encodeURIComponent(uid)}`, { headers });
        if (!r.ok) { setWabaUI('UNKNOWN'); return; }
        const data = await r.json();
        setWabaUI(String(data.status || 'UNKNOWN').toUpperCase(), data);

        if (data.status && !/ACTIVE|FAILED/i.test(data.status)) {
          setTimeout(() => loadWabaStatus(uid, idToken), 60000);
        }
      } catch(e){
        console.warn('[waba] status erro:', e);
        setWabaUI('UNKNOWN');
      }
    }

    function setWabaUI(status, data){
      const s = (status || '').toUpperCase();
      const badge = wabaBadge; const note = wabaNote; const eta = wabaEta;
      badge.className = 'pill'; eta.textContent = ''; note.textContent = '';

      if (s === 'ACTIVE') {
        badge.classList.add('pill-active'); badge.textContent = 'ativo';
        const num = (data && data.numberE164) ? data.numberE164 : '';
        note.innerHTML = 'N√∫mero virtual <strong>ativado</strong> ' + (num ? '(' + escapeHtml(num) + ')' : '') + '. Tudo pronto para atender.';
      } else if (s === 'PROVISIONING') {
        badge.classList.add('pill-prov'); badge.textContent = 'ativando‚Ä¶';
        note.innerHTML = 'Estamos ativando seu n√∫mero virtual.';
        if (data && data.eta) eta.textContent = 'Entrega prevista at√©: ' + formatDateBR(data.eta);
      } else if (s === 'PENDING') {
        badge.classList.add('pill-pending'); badge.textContent = 'em valida√ß√£o';
        note.innerHTML = 'Aguardando valida√ß√£o e implanta√ß√£o.';
        if (data && data.eta) eta.textContent = 'Entrega prevista at√©: ' + formatDateBR(data.eta) + ' (at√© 7 dias √∫teis).';
        else eta.textContent = 'Entrega prevista: at√© 7 dias √∫teis.';
      } else if (s === 'FAILED') {
        badge.classList.add('pill-failed'); badge.textContent = 'falhou';
        note.textContent = 'N√£o foi poss√≠vel ativar o n√∫mero. Verifique a documenta√ß√£o e tente novamente.';
      } else {
        badge.classList.add('pill-pending'); badge.textContent = 'em valida√ß√£o';
        note.textContent = 'Estamos verificando o status do seu n√∫mero virtual.';
      }
    }

    // ============================== SUBMIT ============================
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      cfgFeedback.textContent = '';
      btnSalvar.disabled = true;
      btnSalvar.textContent = 'Enviando‚Ä¶';

      const { uid, idToken } = await getAuthContext();
      if (!uid) {
        cfgFeedback.textContent = '‚ùå Fa√ßa login para salvar suas configura√ß√µes.';
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'Salvar e continuar';
        return;
      }

      try {
        const fd = new FormData(form);
        fd.append('uid', uid);

        if (fd.get('janela_resposta') !== 'custom') {
          fd.delete('janela_resposta_custom');
        }

        // Segmento vem do hidden (preenchido por auto-fill do CNPJ, se houver)
        fd.set('segmento', document.getElementById('hid-segmento').value || '');

        // Branding: se n√£o for custom, limpamos public_brand (evita sujar o BD)
        const brandingChoice = (fd.get('branding_choice') || '').trim();
        if (brandingChoice !== 'custom') {
          fd.set('public_brand', '');
        }

        // Identidade legal/trade (somente se j√° carregadas)
        fd.set('legal_name', document.getElementById('hid-legalname').value || '');
        fd.set('trade_name', document.getElementById('hid-tradename').value || '');

        const headers = {}; if (idToken) headers['Authorization'] = 'Bearer ' + idToken;
        const resp = await fetch(`${API_BASE}/api/configuracao`, {
          method: 'POST', headers, body: fd
        });

        let payload; const ct = resp.headers.get('content-type') || '';
        if (ct.includes('application/json')) payload = await resp.json();
        else payload = { message: await resp.text() };

        if (!resp.ok) {
          cfgFeedback.textContent = '‚ùå Falha ao salvar: ' + (payload?.message || JSON.stringify(payload));
          btnSalvar.disabled = false; btnSalvar.textContent = 'Salvar e continuar';
          return;
        }

        cfgFeedback.textContent = '‚úÖ Configura√ß√£o salva. Continuando‚Ä¶';
        setTimeout(() => { window.location.href = '/pages/dashboard.html'; }, 600);
      } catch (err) {
        console.error(err);
        cfgFeedback.textContent = '‚ùå Erro ao comunicar com o servidor.';
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'Salvar e continuar';
      }
    });

    // Branding: clique nos radios ‚Üí habilita/desabilita input custom
    for (const r of brandingOptions) {
      r.addEventListener('change', () => selectBranding(r.value));
    }
  </script>
</body>
</html>
