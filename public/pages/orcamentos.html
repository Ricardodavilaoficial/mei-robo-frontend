<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Or√ßamentos ‚Äî MEI Rob√¥ (v1.6 timbrado)</title>

  <!-- Canonical simples (podemos ajustar depois se quiser) -->
  <link rel="canonical" href="https://www.meirobo.com.br/pages/orcamentos.html" />

  <link rel="stylesheet" href="/assets/styles.css" />
  <script src="/assets/layout.js" defer></script>

  <!-- Firebase compat (mesmo padr√£o das outras telas logadas) -->
  <script defer src="/__/firebase/9.22.2/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/9.22.2/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/9.22.2/firebase-firestore-compat.js"></script>
  <script defer src="/__/firebase/init.js"></script>

  <style>
    :root{
      --bg:#0d1117;
      --page-bg:#020617;
      --card:#111827;
      --card-soft:#0b1220;
      --br:#1f2937;
      --soft:#cfe3dc;
      --muted:#9fb0aa;
      --txt:#e6edf3;
      --danger:#ff6961;
      --accent:#238636; /* ser√° sobrescrito pela corPrincipal do MEI */
    }
    html,body{
      background:var(--bg);
      color:var(--txt);
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    main{
      max-width:980px;
      margin:0 auto;
      padding:16px;
    }
    .page{
      background:var(--page-bg);
      border-radius:16px;
      padding:16px;
      box-shadow:0 12px 40px rgba(0,0,0,.4);
      border:1px solid #020617;
    }
    h1{
      font-size:1.5rem;
      margin:0 0 4px;
      color:var(--soft);
    }
    .subtitle{
      font-size:.9rem;
      color:var(--muted);
      margin-bottom:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--br);
      border-radius:14px;
      padding:14px;
      margin:10px 0;
    }
    .card-soft{
      background:var(--card-soft);
      border-radius:12px;
      padding:10px 12px;
    }
    .header-grid{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-box{
      width:52px;
      height:52px;
      border-radius:14px;
      border:1px solid var(--br);
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:.9rem;
      overflow:hidden;
    }
    .avatar-box{
      width:40px;
      height:40px;
      border-radius:999px;
      border:1px solid var(--br);
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:.75rem;
      overflow:hidden;
    }
    .brand-text h2{
      margin:0;
      font-size:1.1rem;
      color:var(--accent);
    }
    .brand-text .slogan{
      margin:2px 0 0;
      font-size:.85rem;
      color:var(--muted);
    }
    .info-mei{
      text-align:right;
      font-size:.8rem;
      color:var(--muted);
    }
    .info-mei strong{color:var(--soft);}
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--br);
      font-size:.8rem;
      color:var(--soft);
    }
    .meta{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:.85rem;
      color:var(--muted);
    }
    .meta strong{color:var(--soft);}
    h2.section-title{
      margin:4px 0 6px;
      font-size:1rem;
      color:var(--soft);
    }
    label{
      font-weight:600;
      font-size:.9rem;
      display:block;
      margin-top:6px;
    }
    input[type="text"],
    input[type="number"],
    textarea,
    select{
      width:100%;
      background:#020617;
      color:var(--txt);
      border:1px solid var(--br);
      border-radius:10px;
      padding:8px 10px;
      margin-top:4px;
      font-size:.9rem;
    }
    input::placeholder,
    textarea::placeholder{
      color:var(--muted);
    }
    textarea{
      resize:vertical;
      min-height:60px;
    }
    .kicker{
      font-size:.8rem;
      color:var(--muted);
      margin-top:4px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .grid-3{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
    }
    .right{text-align:right;}
    .btn{
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:10px;
      padding:9px 13px;
      cursor:pointer;
      font-weight:700;
      font-size:.9rem;
    }
    .btn:hover{filter:brightness(1.06);}
    .btn-ghost{
      background:transparent;
      border:1px solid var(--br);
      color:var(--txt);
    }
    .btn-danger{
      background:var(--danger);
      color:#fff;
    }

    /* Tabela de itens */
    #tabela-wrap{
      max-height:260px;
      overflow:auto;
      border:1px solid var(--br);
      border-radius:12px;
      margin-top:4px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:.85rem;
    }
    col.col-cod{width:90px}
    col.col-item{width:auto}
    col.col-preco{width:110px}
    col.col-qtd{width:70px}
    col.col-dur{width:80px}
    col.col-sub{width:120px}
    col.col-act{width:80px}
    thead th{
      background:#020617;
      position:sticky;
      top:0;
      z-index:1;
      color:var(--soft);
    }
    th,td{
      border-bottom:1px solid var(--br);
      padding:6px;
      vertical-align:middle;
    }
    td.right{text-align:right;}
    .w-100{width:100%}
    .h-32{height:32px}

    .totais{
      font-size:.95rem;
      margin-top:6px;
    }
    .totais strong{color:var(--soft);}

    .only-print{display:none;}

    @media print{
      body{background:#fff;color:#000;}
      .no-print{display:none!important;}
      .only-print{display:block;}
      .page{
        background:#fff;
        box-shadow:none;
        border-radius:0;
        border:none;
        padding:8mm;
      }
      #tabela-wrap{
        max-height:none;
        overflow:visible;
        border:none;
      }
      table th,table td{border-color:#ddd;}
    }
  </style>
</head>
<body>
  <div id="app-header" class="no-print"></div>
  <main>
    <div class="page">
      <header>
        <h1>Or√ßamento formal</h1>
        <p class="subtitle">
          Use esta tela para enviar um or√ßamento timbrado quando o cliente pedir ‚Äúpor escrito‚Äù.
          No dia a dia, o MEI Rob√¥ continua passando pre√ßos direto no WhatsApp.
        </p>
      </header>

      <!-- Cabe√ßalho timbrado -->
      <section class="card">
        <div class="header-grid">
          <div class="brand">
            <div class="logo-box" id="logoBoxTopo"><span>Logo</span></div>
            <div class="brand-text">
              <h2 id="orcNomeEmpresaTopo">Seu nome / MEI aqui</h2>
              <div class="slogan" id="orcSloganTopo">Frase de destaque do seu neg√≥cio.</div>
            </div>
          </div>
          <div class="avatar-box" id="avatarTopo"><span>Foto</span></div>
          <div class="info-mei">
            <div><strong>CNPJ/CPF:</strong> <span id="orcDocumentoTopo">‚Äî</span></div>
            <div><strong>WhatsApp:</strong> <span id="orcTelefoneTopo">‚Äî</span></div>
            <div><strong>Cidade/UF:</strong> <span id="orcCidadeTopo">‚Äî</span></div>
            <div style="margin-top:4px;">
              <span class="badge">Or√ßamento</span>
              <span class="badge" id="numero-badge" style="display:none;"></span>
            </div>
            <div class="kicker" id="dataHoje"></div>
          </div>
        </div>
      </section>

      <!-- Dados do cliente -->
      <section class="card">
        <h2 class="section-title">Dados do cliente</h2>
        <div class="grid-2">
          <div>
            <label for="tipoCliente">Tipo de cliente</label>
            <select id="tipoCliente">
              <option value="condominio">Condom√≠nio</option>
              <option value="pf">Pessoa f√≠sica</option>
              <option value="pj">Empresa</option>
              <option value="outro">Outro</option>
            </select>
          </div>
          <div>
            <label for="nomeCliente">Nome / Condom√≠nio</label>
            <input type="text" id="nomeCliente" placeholder="Ex.: Residencial Jardim das Palmeiras / Jo√£o Silva" />
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label for="contatoCliente">Pessoa de contato</label>
            <input type="text" id="contatoCliente" placeholder="Ex.: S√≠ndico Jo√£o Pereira" />
          </div>
          <div>
            <label for="telCliente">Telefone / WhatsApp</label>
            <input type="text" id="telCliente" placeholder="Ex.: (51) 98888-0000" />
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label for="emailCliente">E-mail</label>
            <input type="text" id="emailCliente" placeholder="Ex.: sindico@condominio.com.br" />
          </div>
          <div>
            <label for="obsCliente">Refer√™ncia / bloco / observa√ß√£o</label>
            <input type="text" id="obsCliente" placeholder="Ex.: Bloco B ‚Äî aptos 201 a 204" />
          </div>
        </div>
        <p class="kicker">
          Estes dados servem para identificar claramente para quem o or√ßamento foi enviado.
        </p>
      </section>

      <!-- Busca e a√ß√µes de linhas -->
      <section class="card no-print">
        <div class="grid-3">
          <div>
            <label>Adicionar por c√≥digo ou nome</label>
            <input type="text" id="busca" placeholder="Ex.: #BARB01 ou 'corte de cabelo'"/>
            <div class="kicker">Dica: use #C√ìDIGO para adicionar direto.</div>
          </div>
          <div style="align-self:end">
            <button class="btn" id="btn-buscar">Adicionar</button>
            <button class="btn btn-ghost" id="btn-add-linha">Adicionar linha</button>
          </div>
          <div style="align-self:end" class="right">
            <button class="btn" id="btn-salvar">Gerar n√∫mero</button>
          </div>
        </div>
      </section>

      <!-- Itens do or√ßamento -->
      <section class="card">
        <h2 class="section-title">Itens do or√ßamento</h2>
        <div id="tabela-wrap">
          <table id="tabela-itens">
            <colgroup>
              <col class="col-cod"/>
              <col class="col-item"/>
              <col class="col-preco"/>
              <col class="col-qtd"/>
              <col class="col-dur"/>
              <col class="col-sub"/>
              <col class="col-act"/>
            </colgroup>
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Item</th>
                <th>Pre√ßo (R$)</th>
                <th>Qtd</th>
                <th>Dura√ß√£o</th>
                <th class="right">Subtotal (R$)</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbody-itens"></tbody>
          </table>
        </div>
        <div class="totais">
          <div class="row" style="justify-content:flex-end;gap:18px;">
            <div><strong>Total:</strong> <span id="totalGeral">R$ 0,00</span></div>
          </div>
        </div>
      </section>

      <!-- Condi√ß√µes + validade -->
      <section class="card">
        <h2 class="section-title">Condi√ß√µes e validade</h2>
        <div class="card-soft">
          <div class="kicker"><strong>Validade:</strong> <span id="validadeResumo">Este or√ßamento √© uma estimativa e pode variar conforme agenda e disponibilidade.</span></div>
          <div class="kicker" style="margin-top:4px;"><strong>Condi√ß√µes de pagamento:</strong> <span id="condicoesResumo">Condi√ß√µes de pagamento ser√£o combinadas no momento da confirma√ß√£o.</span></div>
        </div>
      </section>

      <!-- Informa√ß√µes adicionais (edit√°veis por or√ßamento) -->
      <section class="card">
        <h2 class="section-title">Informa√ß√µes adicionais</h2>
        <textarea id="infoAdicionais" rows="3" placeholder="Despesas de deslocamento, frete e condi√ß√µes especiais podem ser combinadas na confirma√ß√£o da proposta."></textarea>
        <div class="row no-print" style="justify-content:space-between;margin-top:4px;">
          <div class="kicker" id="infoStatus">Este texto pode virar padr√£o do seu MEI (salvo em nuvem).</div>
          <div class="row">
            <button class="btn btn-ghost" id="btn-salvar-info-cloud">Salvar como padr√£o (nuvem)</button>
            <button class="btn btn-ghost" id="btn-salvar-info-local" title="Apenas neste dispositivo">Salvar local</button>
          </div>
        </div>
      </section>

      <!-- Mensagem de envio -->
      <section class="card">
        <h2 class="section-title">Mensagem de envio</h2>
        <textarea id="msgEnvio" rows="3">Ol√°, segue conforme combinado o or√ßamento detalhado. Ele ainda n√£o √© proposta e est√° sujeito √† disponibilidade e confirma√ß√£o dos valores.</textarea>
        <div class="row no-print" style="justify-content:space-between;margin-top:4px;">
          <div class="kicker" id="msgStatus">Pode virar padr√£o do seu MEI (salvo em nuvem).</div>
          <div class="row">
            <button class="btn btn-ghost" id="btn-salvar-msg-cloud">Salvar como padr√£o (nuvem)</button>
            <button class="btn btn-ghost" id="btn-copiar">Copiar mensagem</button>
          </div>
        </div>
      </section>

      <!-- A√ß√µes finais -->
      <section class="card no-print">
        <div class="row" style="justify-content:space-between;">
          <div class="kicker">Dica: use ‚ÄúImprimir‚Äù para gerar PDF ou leve este link para a reuni√£o.</div>
          <div class="row">
            <button class="btn" id="btn-imprimir">Imprimir</button>
            <button class="btn btn-ghost" id="btn-email">Exportar p/ E-mail</button>
            <button class="btn btn-ghost" id="btn-whats">Exportar p/ WhatsApp</button>
          </div>
        </div>
      </section>

      <p class="kicker" id="avisoFinal" style="font-style:italic;margin-top:8px;">
        Este documento √© um or√ßamento. Os valores s√£o estimativas e podem mudar conforme agenda, estoque ou altera√ß√µes no servi√ßo.
        Este or√ßamento n√£o √© proposta comercial e n√£o gera compromisso autom√°tico. Para transformar em proposta formal, basta solicitar confirma√ß√£o.
      </p>
    </div>
  </main>
  <div id="app-footer" class="no-print"></div>

  <script>
    const el = (id)=>document.getElementById(id);
    const fmt = (v)=>'R$ ' + (Number(v||0)).toFixed(2).replace('.',',');
    const today = new Date();
    const params = new URLSearchParams(location.search);
    const isValidate = params.get('validate') === '1';

    el('dataHoje').textContent = today.toLocaleDateString('pt-BR');

    // ---------------- Estado ----------------
    let numero = '';
    let itens = [];
    for(let i=0;i<5;i++){
      itens.push({codigo:'', nome:'', preco:0, qtd:1, duracao:''});
    }
    renderTabela(); renderTotal();

    // ---------------- Firebase helpers ----------------
    function hasFirebaseCompat(){
      try { return !!(window.firebase && typeof firebase.initializeApp === 'function'); }
      catch(_){ return false; }
    }

    async function getUid(){
      try{
        if(!hasFirebaseCompat() || typeof firebase.auth !== 'function') return null;
        const auth = firebase.auth();
        const current = auth.currentUser;
        if(current) return current.uid;
        return await new Promise(resolve => auth.onAuthStateChanged(u => resolve(u ? u.uid : null)));
      }catch(_){
        return null;
      }
    }

    function getConfigDoc(uid){
      if(!uid || typeof firebase === 'undefined' || typeof firebase.firestore !== 'function') return null;
      try{
        return firebase.firestore()
          .collection('profissionais').doc(uid)
          .collection('config').doc('orcamentos');
      }catch(_){
        return null;
      }
    }

    function setBoxBackground(boxId, url, placeholder){
      const box = el(boxId);
      if(!box) return;
      if(!url){
        box.style.backgroundImage = 'none';
        box.style.backgroundColor = '#020617';
        box.textContent = placeholder || box.textContent || '';
        return;
      }
      box.textContent = '';
      box.style.backgroundColor = '#020617';
      box.style.backgroundImage = `url('${url}')`;
      box.style.backgroundRepeat = 'no-repeat';
      box.style.backgroundPosition = 'center';
      box.style.backgroundSize = 'contain';
    }

    // ---------------- Visual: timbrado e textos da config ----------------
    async function loadOrcamentoVisualConfig(){
      try{
        const uid = await getUid();
        if(!uid){
          // sem login ‚Üí usa placeholders
          return;
        }
        const ref = getConfigDoc(uid);
        if(!ref){
          return;
        }
        const snap = await ref.get();
        if(!snap.exists){
          return;
        }
        const data = snap.data() || {};

        // Cor principal
        const cor = (typeof data.corPrincipal === 'string' && data.corPrincipal.trim()) ? data.corPrincipal : '#238636';
        document.documentElement.style.setProperty('--accent', cor);

        // Topo MEI
        el('orcNomeEmpresaTopo').textContent = data.nomeEmpresa || 'Seu nome / MEI aqui';
        el('orcSloganTopo').textContent = data.slogan || 'Frase de destaque do seu neg√≥cio.';
        el('orcDocumentoTopo').textContent = data.documento || '‚Äî';
        el('orcTelefoneTopo').textContent = data.telefone || '‚Äî';
        el('orcCidadeTopo').textContent = data.cidadeUf || '‚Äî';

        if(data.logoUrl) setBoxBackground('logoBoxTopo', data.logoUrl, 'Logo');
        if(data.avatarUrl) setBoxBackground('avatarTopo', data.avatarUrl, 'Foto');

        // Validade
        const valSpan = el('validadeResumo');
        if(data.mostrarValidade && typeof data.validadeDias === 'number' && data.validadeDias > 0){
          const d = data.validadeDias;
          const sufixo = d === 1 ? 'dia' : 'dias';
          valSpan.textContent = `V√°lido por ${d} ${sufixo} a partir da data de emiss√£o.`;
        } else {
          valSpan.textContent = 'Este or√ßamento √© uma estimativa e pode variar conforme agenda e disponibilidade.';
        }

        // Condi√ß√µes de pagamento
        const condSpan = el('condicoesResumo');
        if(typeof data.condicoesPagamento === 'string' && data.condicoesPagamento.trim()){
          condSpan.textContent = data.condicoesPagamento.trim();
        }

        // Aviso final (rodap√©)
        if(typeof data.textoJuridico === 'string' && data.textoJuridico.trim()){
          el('avisoFinal').textContent = data.textoJuridico.trim();
        }

        // Mensagem de envio padr√£o vinda da config (se marcado)
        if(data.msgEnvio && (data.usarMsgManual !== false)){
          el('msgEnvio').value = data.msgEnvio;
          el('msgStatus').textContent = 'Mensagem carregada da configura√ß√£o de or√ßamentos.';
        }
      }catch(err){
        console.warn('Erro ao carregar visual de or√ßamento:', err);
      }
    }

    // ---------------- L√≥gica de itens ----------------
    el('btn-buscar').addEventListener('click', ()=>{
      const t = el('busca').value.trim();
      if(!t) return;
      let cod = ''; let nome = '';
      if(t.startsWith('#')) cod = t.replace('#','').toUpperCase();
      else nome = t;
      const idx = itens.findIndex(x => !x.nome && !x.codigo);
      const target = idx>=0 ? itens[idx] : (itens.push({codigo:'', nome:'', preco:0, qtd:1, duracao:''}), itens[itens.length-1]);
      if(cod) target.codigo = cod;
      if(nome) target.nome = nome;
      el('busca').value='';
      renderTabela(); renderTotal();
    });

    el('btn-add-linha').addEventListener('click', ()=>{
      itens.push({codigo:'', nome:'', preco:0, qtd:1, duracao:''});
      renderTabela();
    });

    el('btn-salvar').addEventListener('click', ()=>{
      if(!numero){
        const ano = new Date().getFullYear();
        const seq = Math.floor(Math.random()*90000)+10000;
        numero = `ORC-${ano}-${String(seq).padStart(5,'0')}`;
        const badge = el('numero-badge');
        badge.textContent = numero;
        badge.style.display='inline-block';
      }
      alert('‚úÖ N√∫mero de or√ßamento gerado no topo. (v1.0 ainda sem salvar no banco)');
    });

    function rowHasValue(it){
      return (it.nome && it.nome.trim()!=='') || (it.codigo && it.codigo.trim()!=='') || (Number(it.preco)>0);
    }
    function getTotal(){
      return itens.reduce((acc,it)=>{
        if(!rowHasValue(it)) return acc;
        const sub = (Number(it.preco)||0) * (Number(it.qtd)||0);
        return acc+sub;
      },0);
    }
    function renderTotal(){
      el('totalGeral').textContent = fmt(getTotal());
    }
    function renderTabela(){
      const tbody = el('tbody-itens');
      tbody.innerHTML = itens.map((it,i)=>`
        <tr>
          <td><input class="h-32 w-100" type="text" value="${it.codigo||''}" data-i="${i}" data-k="codigo" placeholder="Ex.: BARB01"/></td>
          <td><input class="h-32 w-100" type="text" value="${it.nome||''}" data-i="${i}" data-k="nome" placeholder="Ex.: Manuten√ß√£o de port√µes"/></td>
          <td><input class="h-32 w-100" type="number" step="0.01" value="${it.preco||0}" data-i="${i}" data-k="preco"/></td>
          <td><input class="h-32 w-100" type="number" step="1" value="${it.qtd||1}" data-i="${i}" data-k="qtd"/></td>
          <td><input class="h-32 w-100" type="number" step="5" value="${it.duracao||''}" data-i="${i}" data-k="duracao" placeholder="min"/></td>
          <td class="right">${fmt((Number(it.preco)||0) * (Number(it.qtd)||0))}</td>
          <td class="right"><button class="btn btn-danger" data-rem="${i}">Remover</button></td>
        </tr>
      `).join('');
      tbody.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('input', e=>{
          const i = Number(e.target.dataset.i);
          const k = e.target.dataset.k;
          let v = e.target.value;
          if(['preco','qtd','duracao'].includes(k)) v = Number(v||0);
          itens[i][k] = v;
          renderTotal();
        });
      });
      tbody.querySelectorAll('button[data-rem]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = Number(btn.dataset.rem);
          itens.splice(idx,1);
          renderTabela();
          renderTotal();
        });
      });
    }

    // ---------------- Padr√µes em nuvem (info/msg) ----------------
    const INFO_KEY = 'mei_orc_info_padrao';
    const MSG_KEY  = 'mei_orc_msg_padrao';

    async function loadCloudDefaults(){
      try{
        const uid = await getUid();
        if(!uid){
          el('infoStatus').textContent = 'Entre para salvar/usar o padr√£o em nuvem.';
          el('msgStatus').textContent  = 'Entre para salvar/usar o padr√£o em nuvem.';
          loadLocalDefaults();
          return;
        }
        const ref = getConfigDoc(uid);
        if(!ref){
          el('infoStatus').textContent = 'Nuvem indispon√≠vel. Usando padr√£o local.';
          el('msgStatus').textContent  = 'Nuvem indispon√≠vel. Usando padr√£o local.';
          loadLocalDefaults();
          return;
        }
        const snap = await ref.get();
        if(snap.exists){
          const data = snap.data() || {};
          if(typeof data.infoPadrao === 'string') el('infoAdicionais').value = data.infoPadrao;
          if(typeof data.msgPadrao  === 'string') el('msgEnvio').value       = data.msgPadrao;
          el('infoStatus').textContent = 'Padr√£o carregado da nuvem.';
          el('msgStatus').textContent  = 'Padr√£o carregado da nuvem.';
        } else {
          el('infoStatus').textContent = 'Sem padr√£o na nuvem. Voc√™ pode salvar um.';
          el('msgStatus').textContent  = 'Sem padr√£o na nuvem. Voc√™ pode salvar um.';
          loadLocalDefaults();
        }
      }catch(err){
        console.warn('Cloud defaults error:', err);
        el('infoStatus').textContent = 'N√£o foi poss√≠vel acessar a nuvem. Usando padr√£o local.';
        el('msgStatus').textContent  = 'N√£o foi poss√≠vel acessar a nuvem. Usando padr√£o local.';
        loadLocalDefaults();
      }
    }

    function loadLocalDefaults(){
      try{
        const v = localStorage.getItem(INFO_KEY); if(v) el('infoAdicionais').value = v;
        const m = localStorage.getItem(MSG_KEY);  if(m) el('msgEnvio').value       = m;
      }catch(_){}
    }

    async function saveInfoCloud(){
      try{
        const uid = await getUid();
        if(!uid){ alert('Entre para salvar na nuvem.'); return; }
        const ref = getConfigDoc(uid);
        if(!ref){ alert('Nuvem indispon√≠vel.'); return; }
        await ref.set({ infoPadrao: el('infoAdicionais').value||'', updatedAt:new Date().toISOString() }, { merge:true });
        alert('‚òÅÔ∏è Informa√ß√µes adicionais salvas como padr√£o na nuvem.');
      }catch(err){
        alert('Falha ao salvar na nuvem. Verifique conex√£o/autentica√ß√£o.');
        console.warn(err);
      }
    }

    async function saveMsgCloud(){
      try{
        const uid = await getUid();
        if(!uid){ alert('Entre para salvar na nuvem.'); return; }
        const ref = getConfigDoc(uid);
        if(!ref){ alert('Nuvem indispon√≠vel.'); return; }
        await ref.set({ msgPadrao: el('msgEnvio').value||'', updatedAt:new Date().toISOString() }, { merge:true });
        alert('‚òÅÔ∏è Mensagem de envio salva como padr√£o na nuvem.');
      }catch(err){
        alert('Falha ao salvar na nuvem. Verifique conex√£o/autentica√ß√£o.');
        console.warn(err);
      }
    }

    function saveInfoLocal(){
      try{
        localStorage.setItem(INFO_KEY, el('infoAdicionais').value||'');
        alert('üíæ Salvo localmente neste dispositivo.');
      }catch(_){}
    }

    el('btn-salvar-info-cloud').addEventListener('click', saveInfoCloud);
    el('btn-salvar-msg-cloud').addEventListener('click', saveMsgCloud);
    el('btn-salvar-info-local').addEventListener('click', saveInfoLocal);

    // ---------------- Copiar / Imprimir / Exportar ----------------
    el('btn-copiar').addEventListener('click', ()=>{
      navigator.clipboard.writeText(el('msgEnvio').value||'').then(()=>{
        alert('üìã Mensagem copiada!');
      });
    });

    el('btn-imprimir').addEventListener('click', ()=> window.print());

    el('btn-email').addEventListener('click', ()=>{
      const empresa = el('orcNomeEmpresaTopo').textContent || 'Meu MEI';
      const num = numero || 'Or√ßamento (sem n√∫mero)';
      const cliente = el('nomeCliente').value || 'Cliente';
      const linhas = itens.filter(rowHasValue).map(it=> `- ${it.codigo?('#'+it.codigo+' - '):''}${it.nome||''} x ${it.qtd||1} ‚Äî ${fmt((it.preco||0)*(it.qtd||1))}`).join('%0D%0A');
      const total = getTotal();
      const corpoTxt = `${el('msgEnvio').value||''}

${empresa}
${num}
Cliente: ${cliente}

Itens:
${decodeURIComponent(linhas.replace(/%0D%0A/g,'\n'))}

Total: ${fmt(total)}

${el('infoAdicionais').value||''}`;

      const corpo = encodeURIComponent(corpoTxt);
      const subject = encodeURIComponent(`${empresa} ‚Äî ${num}`);
      location.href = `mailto:?subject=${subject}&body=${corpo}`;
    });

    el('btn-whats').addEventListener('click', ()=>{
      const empresa = el('orcNomeEmpresaTopo').textContent || 'Meu MEI';
      const num = numero || 'Or√ßamento (sem n√∫mero)';
      const cliente = el('nomeCliente').value || 'Cliente';
      const linhas = itens.filter(rowHasValue).map(it=> `‚Ä¢ ${it.codigo?('#'+it.codigo+' - '):''}${it.nome||''} x ${it.qtd||1} ‚Äî ${fmt((it.preco||0)*(it.qtd||1))}`).join('%0A');
      const total = getTotal();
      const texto =
        `${encodeURIComponent(el('msgEnvio').value||'')}` +
        `%0A%0A${encodeURIComponent(empresa)}` +
        `%0A${encodeURIComponent(num)}` +
        `%0ACliente: ${encodeURIComponent(cliente)}` +
        `%0A%0AItens:%0A${encodeURIComponent(linhas)}` +
        `%0A%0ATotal: ${encodeURIComponent(fmt(total))}` +
        `%0A%0A${encodeURIComponent(el('infoAdicionais').value||'')}`;
      window.open(`https://wa.me/?text=${texto}`, '_blank');
    });

    // ---------------- Boot ----------------
    window.addEventListener('load', ()=>{
      loadOrcamentoVisualConfig();
      loadCloudDefaults();
    });
  </script>
</body>
</html>
