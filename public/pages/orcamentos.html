<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Or√ßamentos ‚Äî MEI Rob√¥ (v1.7 timbrado)</title>

  <link rel="canonical" href="https://www.meirobo.com.br/pages/orcamentos.html" />

  <link rel="stylesheet" href="/assets/styles.css" />
  <script src="/assets/layout.js" defer></script>

  <!-- Firebase compat (mesmo padr√£o das outras telas logadas) -->
  <script defer src="/__/firebase/9.22.2/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/9.22.2/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/9.22.2/firebase-firestore-compat.js"></script>
  <script defer src="/__/firebase/init.js"></script>

  <style>
    :root{
      --bg:#0d1117;
      --page-bg:#020617;
      --card:#111827;
      --card-soft:#0b1220;
      --br:#1f2937;
      --soft:#cfe3dc;
      --muted:#9fb0aa;
      --txt:#e6edf3;
      --danger:#ff6961;
      --orc-accent:#238636; /* ser√° sobrescrito pela corPrincipal do MEI, s√≥ aqui */
    }
    html,body{
      background:var(--bg);
      color:var(--txt);
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    main{
      max-width:980px;
      margin:0 auto;
      padding:16px;
    }
    .page{
      background:var(--page-bg);
      border-radius:16px;
      padding:16px;
      box-shadow:0 12px 40px rgba(0,0,0,.4);
      border:1px solid #020617;
    }
    h1{
      font-size:1.5rem;
      margin:0 0 4px;
      color:var(--soft);
    }
    .subtitle{
      font-size:.9rem;
      color:var(--muted);
      margin-bottom:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--br);
      border-radius:14px;
      padding:14px;
      margin:10px 0;
    }
    .card-soft{
      background:var(--card-soft);
      border-radius:12px;
      padding:10px 12px;
    }
    .header-grid{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-box{
      width:52px;
      height:52px;
      border-radius:14px;
      border:1px solid var(--br);
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:.9rem;
      overflow:hidden;
    }
    .avatar-box{
      width:40px;
      height:40px;
      border-radius:999px;
      border:1px solid var(--br);
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:.75rem;
      overflow:hidden;
    }
    .brand-text h2{
      margin:0;
      font-size:1.1rem;
      color:var(--orc-accent);
    }
    .brand-text .slogan{
      margin:2px 0 0;
      font-size:.85rem;
      color:var(--muted);
    }
    .info-mei{
      text-align:right;
      font-size:.8rem;
      color:var(--muted);
    }
    .info-mei strong{color:var(--soft);}
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--br);
      font-size:.8rem;
      color:var(--soft);
    }
    .meta{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:.85rem;
      color:var(--muted);
    }
    .meta strong{color:var(--soft);}
    h2.section-title{
      margin:4px 0 6px;
      font-size:1rem;
      color:var(--soft);
    }
    label{
      font-weight:600;
      font-size:.9rem;
      display:block;
      margin-top:6px;
    }
    input[type="text"],
    input[type="number"],
    textarea,
    select{
      width:100%;
      background:#020617;
      color:var(--txt);
      border:1px solid var(--br);
      border-radius:10px;
      padding:8px 10px;
      margin-top:4px;
      font-size:.9rem;
    }
    input::placeholder,
    textarea::placeholder{
      color:var(--muted);
    }
    textarea{
      resize:vertical;
      min-height:60px;
    }
    .kicker{
      font-size:.8rem;
      color:var(--muted);
      margin-top:4px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .grid-3{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
    }
    .right{text-align:right;}
    .btn{
      background:var(--orc-accent);
      color:#fff;
      border:none;
      border-radius:10px;
      padding:9px 13px;
      cursor:pointer;
      font-weight:700;
      font-size:.9rem;
    }
    .btn:hover{filter:brightness(1.06);}
    .btn-ghost{
      background:transparent;
      border:1px solid var(--br);
      color:var(--txt);
    }
    .btn-danger{
      background:var(--danger);
      color:#fff;
    }

    /* Hist√≥rico de or√ßamentos */
    .table-mini{
      width:100%;
      border-collapse:collapse;
      font-size:.83rem;
    }
    .table-mini th,
    .table-mini td{
      border-bottom:1px solid var(--br);
      padding:6px 4px;
      vertical-align:middle;
    }
    .table-mini th{
      text-align:left;
      color:var(--soft);
      font-weight:600;
    }
    .table-mini td.right{text-align:right;}

    /* Tabela de itens */
    #tabela-wrap{
      max-height:260px;
      overflow:auto;
      border:1px solid var(--br);
      border-radius:12px;
      margin-top:4px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:.85rem;
    }
    col.col-cod{width:90px}
    col.col-item{width:auto}
    col.col-preco{width:110px}
    col.col-qtd{width:70px}
    col.col-dur{width:80px}
    col.col-sub{width:120px}
    col.col-act{width:80px}
    thead th{
      background:#020617;
      position:sticky;
      top:0;
      z-index:1;
      color:var(--soft);
    }
    th,td{
      border-bottom:1px solid var(--br);
      padding:6px;
      vertical-align:middle;
    }
    td.right{text-align:right;}
    .w-100{width:100%}
    .h-32{height:32px}

    .totais{
      font-size:.95rem;
      margin-top:6px;
    }
    .totais strong{color:var(--soft);}

    .only-print{display:none;}

    @media print{
      body{background:#fff;color:#000;}
      .no-print{display:none!important;}
      .only-print{display:block;}
      .page{
        background:#fff;
        box-shadow:none;
        border-radius:0;
        border:none;
        padding:8mm;
      }
      #tabela-wrap{
        max-height:none;
        overflow:visible;
        border:none;
      }
      table th,table td{border-color:#ddd;}
    }
  </style>
</head>
<body>
  <div id="app-header" class="no-print"></div>
  <main>
    <div class="page">
      <header>
        <h1>Or√ßamentos do MEI Rob√¥</h1>
        <p class="subtitle">
          No dia a dia, o MEI Rob√¥ manda os or√ßamentos direto nas conversas de WhatsApp com seus clientes.
          Aqui voc√™ acompanha e monta or√ßamentos timbrados em PDF ou documento, para quando o cliente pedir algo mais formal.
        </p>
      </header>

      <!-- Hist√≥rico de or√ßamentos enviados pelo MEI Rob√¥ -->
      <section class="card no-print">
        <h2 class="section-title">Or√ßamentos enviados automaticamente</h2>
        <p class="kicker">
          Este √© o fluxo padr√£o: o MEI Rob√¥ monta e envia o or√ßamento direto nas conversas de WhatsApp com seus clientes.
          Em breve, esta lista vai mostrar esses or√ßamentos autom√°ticos, para voc√™ consultar por data e valor sempre que precisar.
        </p>
        <div class="row" style="margin-top:4px;justify-content:space-between;">
          <div class="row">
            <div>
              <label style="font-size:.8rem;margin-top:0;">De</label>
              <input type="date" id="filtroDe" style="min-width:130px;font-size:.8rem;">
            </div>
            <div>
              <label style="font-size:.8rem;margin-top:0;">At√©</label>
              <input type="date" id="filtroAte" style="min-width:130px;font-size:.8rem;">
            </div>
          </div>
          <div class="row">
            <div>
              <label style="font-size:.8rem;margin-top:0;">Ordenar por</label>
              <select id="filtroOrdenacao" style="min-width:160px;font-size:.8rem;">
                <option value="recentes">Mais recentes primeiro</option>
                <option value="antigos">Mais antigos primeiro</option>
                <option value="maior">Maior valor</option>
                <option value="menor">Menor valor</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card-soft" id="orcamentos-list-wrap" style="margin-top:6px;">
          <p class="kicker" id="orcamentos-list-vazio">
            Nenhum or√ßamento cadastrado ainda. Assim que ligarmos o envio autom√°tico, os or√ßamentos v√£o aparecer aqui.
          </p>
        </div>
      </section>

      <!-- Cabe√ßalho timbrado (vale tanto para manual quanto autom√°tico) -->
      <section class="card">
        <div class="header-grid">
          <div class="brand">
            <div class="logo-box" id="logoBoxTopo"><span>Logo</span></div>
            <div class="brand-text">
              <h2 id="orcNomeEmpresaTopo">Seu nome / MEI aqui</h2>
              <div class="slogan" id="orcSloganTopo">Frase de destaque do seu neg√≥cio.</div>
            </div>
          </div>
          <div class="avatar-box" id="avatarTopo"><span>Foto</span></div>
          <div class="info-mei">
            <div><strong>CNPJ:</strong> <span id="orcDocumentoTopo">‚Äî</span></div>
            <div><strong>WhatsApp:</strong> <span id="orcTelefoneTopo">‚Äî</span></div>
            <div><strong>Cidade/UF:</strong> <span id="orcCidadeTopo">‚Äî</span></div>
            <div style="margin-top:4px;">
              <span class="badge">Or√ßamento</span>
              <span class="badge" id="numero-badge" style="display:none;"></span>
            </div>
            <div class="kicker" id="dataHoje"></div>
          </div>
        </div>
        <div class="row no-print" style="margin-top:10px;justify-content:space-between;align-items:center;">
          <p class="kicker" style="margin:0;max-width:70%;">
            Este √© o modelo timbrado do seu or√ßamento. Ele usa o CNPJ da sua conta e, se voc√™ quiser, o nome, logo, cidade, condi√ß√µes de pagamento e texto jur√≠dico que voc√™ configurar.
          </p>
          <button class="btn" id="btn-config-timbrado">
            Configurar modelo de or√ßamento
          </button>
        </div>
      </section>

      <!-- Se√ß√£o de toggle do formul√°rio manual -->
      <section class="card no-print">
        <div class="row" style="justify-content:space-between;align-items:flex-start;">
          <div>
            <h2 class="section-title" style="margin-bottom:2px;">Criar or√ßamento manual (opcional)</h2>
            <p class="kicker">
              No dia a dia o MEI Rob√¥ cuida dos or√ßamentos nas conversas de WhatsApp.
              Use o modo manual quando quiser gerar um or√ßamento timbrado em PDF ou documento, ou quando quiser testar o seu modelo.
            </p>
          </div>
          <div>
            <button class="btn btn-ghost" id="btn-toggle-manual">Mostrar formul√°rio</button>
          </div>
        </div>
      </section>

      <!-- Tudo abaixo faz parte do formul√°rio manual (pode ser escondido) -->
      <div id="manual-section" style="display:none;">

        <!-- Dados do cliente -->
        <section class="card">
          <h2 class="section-title">Dados do cliente deste or√ßamento</h2>
          <div class="grid-2">
            <div>
              <label for="tipoCliente">Tipo de cliente</label>
              <select id="tipoCliente">
                <option value="condominio">Condom√≠nio</option>
                <option value="pf">Pessoa f√≠sica</option>
                <option value="pj">Empresa</option>
                <option value="outro">Outro</option>
              </select>
            </div>
            <div>
              <label for="nomeCliente">Nome / Condom√≠nio</label>
              <input type="text" id="nomeCliente" placeholder="Ex.: Residencial Jardim das Palmeiras / Jo√£o Silva" />
            </div>
          </div>
          <div class="grid-2">
            <div>
              <label for="contatoCliente">Pessoa de contato</label>
              <input type="text" id="contatoCliente" placeholder="Ex.: S√≠ndico Jo√£o Pereira" />
            </div>
            <div>
              <label for="telCliente">Telefone / WhatsApp</label>
              <input type="text" id="telCliente" placeholder="Ex.: (51) 98888-0000" />
            </div>
          </div>
          <div class="grid-2">
            <div>
              <label for="emailCliente">E-mail</label>
              <input type="text" id="emailCliente" placeholder="Ex.: sindico@condominio.com.br" />
            </div>
            <div>
              <label for="obsCliente">Refer√™ncia / bloco / observa√ß√£o</label>
              <input type="text" id="obsCliente" placeholder="Ex.: Bloco B ‚Äî aptos 201 a 204" />
            </div>
          </div>
          <p class="kicker">
            Estes dados servem para identificar claramente para quem este or√ßamento foi enviado.
          </p>
        </section>

        <!-- Busca e a√ß√µes de linhas -->
        <section class="card no-print">
          <h2 class="section-title" style="margin-bottom:6px;">Servi√ßos deste or√ßamento</h2>
          <p class="kicker" style="margin-bottom:6px;">
            Tudo que voc√™ adicionar aqui vira linha no or√ßamento timbrado. Use os servi√ßos j√° cadastrados em
            <strong>Servi√ßos</strong> ou escreva s√≥ o nome.
          </p>
          <div class="grid-3">
            <div>
              <label>Adicionar servi√ßo ou produto</label>
              <input type="text" id="busca" placeholder="Ex.: #BARB01 ou corte de cabelo, manuten√ß√£o de port√£o..." />
              <div class="kicker">Dica: use #C√ìDIGO cadastrado em Servi√ßos para preencher mais r√°pido.</div>
            </div>
            <div style="align-self:end">
              <button class="btn" id="btn-buscar">Adicionar √† lista</button>
              <button class="btn btn-ghost" id="btn-add-linha">Linha em branco</button>
            </div>
            <div style="align-self:end" class="right">
              <p class="kicker" style="margin-top:0;">
                O n√∫mero do or√ßamento √© gerado automaticamente quando voc√™ imprimir ou enviar.
              </p>
            </div>
          </div>
        </section>

        <!-- Itens do or√ßamento -->
        <section class="card">
          <h2 class="section-title">Lista de servi√ßos</h2>
          <div id="tabela-wrap">
            <table id="tabela-itens">
              <colgroup>
                <col class="col-cod"/>
                <col class="col-item"/>
                <col class="col-preco"/>
                <col class="col-qtd"/>
                <col class="col-dur"/>
                <col class="col-sub"/>
                <col class="col-act"/>
              </colgroup>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Item</th>
                  <th>Pre√ßo (R$)</th>
                  <th>Qtd</th>
                  <th>Dura√ß√£o</th>
                  <th class="right">Subtotal (R$)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tbody-itens"></tbody>
            </table>
          </div>
          <div class="totais">
            <div class="row" style="justify-content:flex-end;gap:18px;">
              <div><strong>Total:</strong> <span id="totalGeral">R$ 0,00</span></div>
            </div>
          </div>
        </section>

        <!-- Condi√ß√µes + validade -->
        <section class="card">
          <h2 class="section-title">Condi√ß√µes e validade</h2>
          <div class="card-soft">
            <div class="kicker">
              <strong>Validade:</strong>
              <span id="validadeResumo">
                Este or√ßamento √© uma estimativa e pode variar conforme agenda e disponibilidade.
              </span>
            </div>
            <div class="kicker" style="margin-top:4px;">
              <strong>Condi√ß√µes de pagamento:</strong>
              <span id="condicoesResumo">
                Condi√ß√µes de pagamento ser√£o combinadas no momento da confirma√ß√£o.
              </span>
            </div>
          </div>
        </section>

        <!-- Informa√ß√µes adicionais (edit√°veis por or√ßamento) -->
        <section class="card">
          <h2 class="section-title">Informa√ß√µes adicionais deste caso</h2>
          <textarea id="infoAdicionais" rows="3"
            placeholder="Despesas de deslocamento, frete e condi√ß√µes especiais podem ser combinadas na confirma√ß√£o da proposta."></textarea>
          <div class="row no-print" style="justify-content:space-between;margin-top:4px;">
            <div class="kicker" id="infoStatus">
              Este texto vale s√≥ para este or√ßamento. Para mudar o padr√£o geral, use a tela de Configura√ß√£o de Or√ßamentos.
            </div>
            <div class="row">
              <button class="btn btn-ghost" id="btn-salvar-info-local" title="Apenas neste dispositivo">
                Salvar texto localmente
              </button>
            </div>
          </div>
        </section>

        <!-- Mensagem de envio -->
        <section class="card">
          <h2 class="section-title">Mensagem que vai junto no WhatsApp / E-mail</h2>
          <textarea id="msgEnvio" rows="3">
Ol√°, segue conforme combinado o or√ßamento detalhado. Ele ainda n√£o √© proposta e est√° sujeito √† disponibilidade e confirma√ß√£o dos valores.
          </textarea>
          <div class="row no-print" style="justify-content:space-between;margin-top:4px;">
            <div class="kicker" id="msgStatus">
              Esta √© a mensagem s√≥ deste envio. O padr√£o principal voc√™ ajusta na Configura√ß√£o de Or√ßamentos.
            </div>
            <div class="row">
              <button class="btn btn-ghost" id="btn-copiar">Copiar mensagem</button>
            </div>
          </div>
        </section>

        <!-- A√ß√µes finais -->
        <section class="card no-print">
          <div class="row" style="justify-content:space-between;">
            <div class="kicker">
              Dica: use ‚ÄúImprimir‚Äù para gerar PDF ou envie o or√ßamento timbrado por WhatsApp/E-mail.
            </div>
            <div class="row">
              <button class="btn" id="btn-imprimir">Imprimir</button>
              <button class="btn btn-ghost" id="btn-email">Exportar p/ E-mail</button>
              <button class="btn btn-ghost" id="btn-whats">Exportar p/ WhatsApp</button>
            </div>
          </div>
        </section>

        <!-- Assinatura e carimbo no rodap√© do impresso -->
        <section class="only-print" style="margin-top:12px;">
          <div class="row" style="justify-content:space-between;align-items:flex-end;">
            <div>
              <div class="logo-box" id="assinaturaRodape"><span>Assinatura</span></div>
              <div class="kicker">Assinatura</div>
            </div>
            <div>
              <div class="logo-box" id="carimboRodape" style="width:80px;height:80px;"><span>Carimbo</span></div>
              <div class="kicker right">Carimbo</div>
            </div>
          </div>
        </section>

        <p class="kicker" id="avisoFinal" style="font-style:italic;margin-top:8px;">
          Este documento √© um or√ßamento. Os valores s√£o estimativas e podem mudar conforme agenda, estoque ou altera√ß√µes no servi√ßo.
          Este or√ßamento n√£o √© proposta comercial e n√£o gera compromisso autom√°tico. Para transformar em proposta formal, basta solicitar confirma√ß√£o.
        </p>
      </div> <!-- fim manual-section -->
    </div> <!-- fim .page -->

    <!-- Voltar para o painel -->
    <section class="card no-print" style="margin-top:12px;">
      <div class="row" style="justify-content:space-between;">
        <div class="kicker">
          Quando terminar por aqui, voc√™ pode voltar para o painel do MEI Rob√¥.
        </div>
        <button class="btn btn-ghost" id="btn-voltar-dashboard">Voltar para o painel</button>
      </div>
    </section>
  </main>
  <div id="app-footer" class="no-print"></div>

  <script>
    const el = (id)=>document.getElementById(id);
    const fmt = (v)=>'R$ ' + (Number(v||0)).toFixed(2).replace('.',',');
    const today = new Date();
    const params = new URLSearchParams(location.search);
    const isValidate = params.get('validate') === '1';

    if(el('dataHoje')) el('dataHoje').textContent = today.toLocaleDateString('pt-BR');

    // ---------------- Estado ----------------
    let numero = '';
    let itens = [];
    for(let i=0;i<5;i++){
      itens.push({codigo:'', nome:'', preco:0, qtd:1, duracao:''});
    }
    renderTabela(); renderTotal();

    // Cat√°logo de servi√ßos (Pre√ßos) carregado do Firestore
    let servicosCatalog = [];

    // Hist√≥rico vindo do backend
    let orcamentosHistorico = [];

    function renderHistoricoOrcamentos(){
      const wrap = el('orcamentos-list-wrap');
      const vazio = el('orcamentos-list-vazio');
      if(!wrap) return;

      if(!orcamentosHistorico.length){
        if(vazio) vazio.style.display = 'block';
        wrap.querySelectorAll('table').forEach(t=>t.remove());
        return;
      }

      if(vazio) vazio.style.display = 'none';

      const table = document.createElement('table');
      table.className = 'table-mini';

      const linhas = orcamentosHistorico.map(o => {
        // Data: aceita createdAt/enviadoEm como ISO ou Timestamp do Firestore
        let dt = null;
        if (o.createdAt && typeof o.createdAt === 'object' && typeof o.createdAt.seconds === 'number') {
          dt = new Date(o.createdAt.seconds * 1000);
        } else if (o.createdAt) {
          dt = new Date(o.createdAt);
        } else if (o.enviadoEm && typeof o.enviadoEm === 'object' && typeof o.enviadoEm.seconds === 'number') {
          dt = new Date(o.enviadoEm.seconds * 1000);
        } else if (o.enviadoEm) {
          dt = new Date(o.enviadoEm);
        }
        const dataStr = dt && !Number.isNaN(dt.getTime()) ? dt.toLocaleDateString('pt-BR') : (o.dataStr || '');

        // Cliente: trata objeto, string ou fallback
        let cliente = '‚Äî';
        if (o.cliente && typeof o.cliente === 'object') {
          cliente = o.cliente.nome || o.cliente.contato || o.cliente.razaoSocial || o.clienteNome || '‚Äî';
        } else if (typeof o.cliente === 'string' && o.cliente.trim()) {
          cliente = o.cliente.trim();
        } else if (o.clienteNome) {
          cliente = o.clienteNome;
        }

        const origemRotulo = o.origem === 'bot' ? 'MEI Rob√¥' : 'Manual';
        const total = typeof o.total === 'number' ? o.total : Number(o.total || 0);

        return `
          <tr>
            <td>${dataStr}</td>
            <td>${cliente}</td>
            <td>${fmt(total)}</td>
            <td>${origemRotulo}</td>
            <td class="right">
              <button class="btn btn-ghost" style="padding:4px 8px;font-size:.75rem;" data-orc-id="${o.id||''}">
                Ver
              </button>
            </td>
          </tr>
        `;
      }).join('');

      table.innerHTML = `
        <thead>
          <tr>
            <th>Data</th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Origem</th>
            <th class="right">A√ß√£o</th>
          </tr>
        </thead>
        <tbody>${linhas}</tbody>
      `;

      wrap.innerHTML = '';
      wrap.appendChild(table);
    }

    // Carrega lista do backend (GET /api/orcamentos)
    async function carregarHistoricoDoBackend(){
      try{
        if(isValidate){
          console.log('[orcamentos] validate=1 ‚Üí pulando chamada ao backend e usando dados fake');
          orcamentosHistorico = [
            {
              id: 'ORC-VALIDATE-1',
              numero: 'ORC-2025-00001',
              createdAt: new Date(),
              cliente: { nome: 'Cliente Exemplo (modo valida√ß√£o)' },
              origem: 'bot',
              total: 350,
              moeda: 'BRL'
            },
            {
              id: 'ORC-VALIDATE-2',
              numero: 'ORC-2025-00002',
              createdAt: new Date(),
              cliente: { nome: 'Cliente Manual (modo valida√ß√£o)' },
              origem: 'manual',
              total: 120,
              moeda: 'BRL'
            }
          ];
          renderHistoricoOrcamentos();
          return;
        }
        if(!hasFirebaseCompat()){
          console.log('[orcamentos] Firebase compat n√£o dispon√≠vel');
          return;
        }

        const token = await getIdToken();
        if(!token){
          console.log('[orcamentos] sem ID token, usu√°rio n√£o logado');
          return;
        }

        const resp = await fetch('/api/orcamentos', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if(!resp.ok){
          console.warn('[orcamentos] falha ao carregar hist√≥rico:', resp.status);
          return;
        }

        const data = await resp.json();
        // Suporta formatos: {items:[...]}, {orcamentos:[...]}, ou lista direta
        let lista = [];
        if (Array.isArray(data)) {
          lista = data;
        } else if (Array.isArray(data.items)) {
          lista = data.items;
        } else if (Array.isArray(data.orcamentos)) {
          lista = data.orcamentos;
        }
        if(!lista.length){
          // Sem or√ßamentos ainda ‚Üí mant√©m estado ‚Äúvazio‚Äù bonitinho
          orcamentosHistorico = [];
          renderHistoricoOrcamentos();
          return;
        }

        orcamentosHistorico = lista;
        renderHistoricoOrcamentos();
      }catch(err){
        console.warn('[orcamentos] erro ao carregar hist√≥rico:', err);
      }
    }

    // ---------------- Firebase helpers ----------------
    function hasFirebaseCompat(){
      try { return !!(window.firebase && typeof firebase.initializeApp === 'function'); }
      catch(_){ return false; }
    }

    async function getUid(){
      try{
        if(!hasFirebaseCompat() || typeof firebase.auth !== 'function') return null;
        const auth = firebase.auth();
        const current = auth.currentUser;
        if(current) return current.uid;
        return await new Promise(resolve => auth.onAuthStateChanged(u => resolve(u ? u.uid : null)));
      }catch(_){
        return null;
      }
    }

    async function getIdToken(){
      try{
        if(!hasFirebaseCompat() || typeof firebase.auth !== 'function') return null;
        const auth = firebase.auth();
        const current = auth.currentUser;
        const user = current || await new Promise(resolve => auth.onAuthStateChanged(u => resolve(u || null)));
        if(!user) return null;
        return await user.getIdToken();
      }catch(_){
        return null;
      }
    }

    function getConfigDoc(uid){
      if(!uid || typeof firebase === 'undefined' || typeof firebase.firestore !== 'function') return null;
      try{
        return firebase.firestore()
          .collection('profissionais').doc(uid)
          .collection('config').doc('orcamentos');
      }catch(_){
        return null;
      }
    }

    // PATCH 2 ‚Äî logos/assinatura/carimbo com <img> (funciona na impress√£o)
    function setBoxBackground(boxId, url, placeholder){
      const box = el(boxId);
      if (!box) return;

      // Garante uma base neutra
      box.style.backgroundColor = '#020617';
      box.style.backgroundImage = 'none';
      box.style.display = 'flex';
      box.style.alignItems = 'center';
      box.style.justifyContent = 'center';
      box.style.overflow = 'hidden';

      let img = box.querySelector('img');

      if (!url) {
        // Sem imagem ‚Üí mostra texto placeholder
        if (img) {
          img.remove();
        }
        box.textContent = placeholder || box.textContent || '';
        return;
      }

      // Com imagem ‚Üí garante <img> dentro da caixa
      if (!img) {
        img = document.createElement('img');
        img.alt = placeholder || '';
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100%';
        img.style.objectFit = 'contain';
        img.style.display = 'block';
        box.innerHTML = '';
        box.appendChild(img);
      }

      img.src = url;
    }

    const INFO_KEY = 'mei_orc_info_padrao';

    function loadLocalDefaults(){
      try{
        const v = localStorage.getItem(INFO_KEY);
        if(v && el('infoAdicionais')) el('infoAdicionais').value = v;
      }catch(_){}
    }

    function saveInfoLocal(){
      try{
        if(!el('infoAdicionais')) return;
        localStorage.setItem(INFO_KEY, el('infoAdicionais').value||'');
        alert('üíæ Texto salvo localmente neste dispositivo.');
      }catch(_){}
    }

    // ---------------- Visual: timbrado e textos da config ----------------
    async function loadOrcamentoVisualConfig(){
      try{
        const uid = await getUid();
        if(!uid){
          // sem login ‚Üí usa placeholders
          return;
        }
        const ref = getConfigDoc(uid);
        if(!ref){
          return;
        }
        const snap = await ref.get();
        if(!snap.exists){
          return;
        }
        const data = snap.data() || {};

        // Cor principal
        const cor = (typeof data.corPrincipal === 'string' && data.corPrincipal.trim()) ? data.corPrincipal : '#238636';
        document.documentElement.style.setProperty('--orc-accent', cor);

        // Topo MEI
        if(el('orcNomeEmpresaTopo')) el('orcNomeEmpresaTopo').textContent = data.nomeEmpresa || 'Seu nome / MEI aqui';
        if(el('orcSloganTopo')) el('orcSloganTopo').textContent = data.slogan || 'Frase de destaque do seu neg√≥cio.';
        if(el('orcDocumentoTopo')) el('orcDocumentoTopo').textContent = data.documento || '‚Äî';
        if(el('orcTelefoneTopo')) el('orcTelefoneTopo').textContent = data.telefone || '‚Äî';
        if(el('orcCidadeTopo')) el('orcCidadeTopo').textContent = data.cidadeUf || '‚Äî';

        if(data.logoUrl) setBoxBackground('logoBoxTopo', data.logoUrl, 'Logo');
        if(data.avatarUrl) setBoxBackground('avatarTopo', data.avatarUrl, 'Foto');
        if(data.assinaturaUrl) setBoxBackground('assinaturaRodape', data.assinaturaUrl, 'Assinatura');
        if(data.carimboUrl) setBoxBackground('carimboRodape', data.carimboUrl, 'Carimbo');

        // Validade
        const valSpan = el('validadeResumo');
        if(valSpan){
          if(data.mostrarValidade && typeof data.validadeDias === 'number' && data.validadeDias > 0){
            const d = data.validadeDias;
            const sufixo = d === 1 ? 'dia' : 'dias';
            valSpan.textContent = `V√°lido por ${d} ${sufixo} a partir da data de emiss√£o.`;
          } else {
            valSpan.textContent = 'Este or√ßamento √© uma estimativa e pode variar conforme agenda e disponibilidade.';
          }
        }

        // Condi√ß√µes de pagamento
        const condSpan = el('condicoesResumo');
        if(condSpan && typeof data.condicoesPagamento === 'string' && data.condicoesPagamento.trim()){
          condSpan.textContent = data.condicoesPagamento.trim();
        }

        // Aviso final (rodap√©)
        if(typeof data.textoJuridico === 'string' && data.textoJuridico.trim() && el('avisoFinal')){
          el('avisoFinal').textContent = data.textoJuridico.trim();
        }

        // Texto padr√£o de informa√ß√µes adicionais (se campo estiver vazio)
        if(el('infoAdicionais') && !el('infoAdicionais').value && typeof data.infoPadrao === 'string'){
          el('infoAdicionais').value = data.infoPadrao;
          if(el('infoStatus')){
            el('infoStatus').textContent = 'Texto sugerido a partir da sua configura√ß√£o. Voc√™ pode ajustar s√≥ para este or√ßamento.';
          }
        }

        // Mensagem de envio padr√£o (se campo estiver vazio)
        if(el('msgEnvio') && !el('msgEnvio').value.trim()){
          if(typeof data.msgPadrao === 'string' && data.msgPadrao.trim()){
            el('msgEnvio').value = data.msgPadrao;
            if(el('msgStatus')){
              el('msgStatus').textContent = 'Mensagem sugerida pela sua configura√ß√£o. Ajuste √† vontade para este envio.';
            }
          } else if(typeof data.msgEnvio === 'string' && data.msgEnvio.trim()){
            el('msgEnvio').value = data.msgEnvio;
          }
        }
      }catch(err){
        console.warn('Erro ao carregar visual de or√ßamento:', err);
      }
    }

    // ---------------- Cat√°logo de servi√ßos (Pre√ßos) ----------------
    function normalizeText(t){
      return String(t || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'');
    }

    function encontrarServicoPorEntrada(texto){
      if(!texto) return null;
      const raw = String(texto).trim();
      if(!raw) return null;

      let codigoBusca = '';
      let nomeBusca = '';

      if(raw.startsWith('#')){
        codigoBusca = raw.slice(1).toUpperCase();
      }else{
        nomeBusca = normalizeText(raw);
      }

      if(codigoBusca){
        const foundByCode = servicosCatalog.find(s => (s.codigo || '').toUpperCase() === codigoBusca);
        if(foundByCode) return foundByCode;
      }

      if(nomeBusca){
        const byNome = servicosCatalog.find(s => {
          const n = normalizeText(s.nome || '');
          const cod = normalizeText(s.codigo || '');
          const sin = normalizeText((s.sinonimos || []).join(' '));
          return n.includes(nomeBusca) || sin.includes(nomeBusca) || cod === nomeBusca;
        });
        if(byNome) return byNome;
      }

      return null;
    }

    async function loadServicosCatalog(){
      try{
        if(!hasFirebaseCompat()){
          console.log('[orcamentos] sem Firebase compat ‚Üí sem cat√°logo de servi√ßos');
          return;
        }
        const uid = await getUid();
        if(!uid){
          console.log('[orcamentos] usu√°rio n√£o logado ‚Üí sem cat√°logo de servi√ßos');
          return;
        }
        const db = firebase.firestore();
        const col = db.collection('profissionais').doc(uid).collection('produtosEServicos');
        const snap = await col.orderBy('nome').get();
        servicosCatalog = snap.docs.map(d => {
          const v = d.data() || {};
          return {
            id: d.id,
            codigo: v.codigo || '',
            nome: v.nome || '',
            precoBase: typeof v.precoBase === 'number' ? v.precoBase : parseFloat(v.precoBase || '0') || 0,
            duracaoMin: typeof v.duracaoMin === 'number' ? v.duracaoMin : parseInt(v.duracaoMin || '0') || 0,
            sinonimos: Array.isArray(v.sinonimos)
              ? v.sinonimos
              : (typeof v.sinonimos === 'string'
                  ? v.sinonimos.split(';').map(s=>s.trim()).filter(Boolean)
                  : [])
          };
        });
        console.log('[orcamentos] cat√°logo de servi√ßos carregado:', servicosCatalog.length);
      }catch(err){
        console.warn('[orcamentos] erro ao carregar cat√°logo de servi√ßos:', err);
      }
    }

    // ---------------- L√≥gica de itens ----------------
    function rowHasValue(it){
      return (it.nome && it.nome.trim()!=='') || (it.codigo && it.codigo.trim()!=='') || (Number(it.preco)>0);
    }
    function getTotal(){
      return itens.reduce((acc,it)=>{
        if(!rowHasValue(it)) return acc;
        const sub = (Number(it.preco)||0) * (Number(it.qtd)||0);
        return acc+sub;
      },0);
    }
    function renderTotal(){
      if(el('totalGeral')) el('totalGeral').textContent = fmt(getTotal());
    }
    function renderTabela(){
      const tbody = el('tbody-itens');
      if(!tbody) return;
      tbody.innerHTML = itens.map((it,i)=>`
        <tr>
          <td><input class="h-32 w-100" type="text" value="${it.codigo||''}" data-i="${i}" data-k="codigo" placeholder="Ex.: BARB01"/></td>
          <td><input class="h-32 w-100" type="text" value="${it.nome||''}" data-i="${i}" data-k="nome" placeholder="Ex.: Manuten√ß√£o de port√µes"/></td>
          <td><input class="h-32 w-100" type="number" step="0.01" value="${it.preco||0}" data-i="${i}" data-k="preco"/></td>
          <td><input class="h-32 w-100" type="number" step="1" value="${it.qtd||1}" data-i="${i}" data-k="qtd"/></td>
          <td><input class="h-32 w-100" type="number" step="5" value="${it.duracao||''}" data-i="${i}" data-k="duracao" placeholder="min"/></td>
          <td class="right" data-sub="${i}">${fmt((Number(it.preco)||0) * (Number(it.qtd)||0))}</td>
          <td class="right"><button class="btn btn-danger" data-rem="${i}">Remover</button></td>
        </tr>
      `).join('');

      // PATCH 1 ‚Äî atualizar s√≥ a linha + total, sem recurs√£o
      tbody.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('input', e=>{
          const i = Number(e.target.dataset.i);
          const k = e.target.dataset.k;
          let v = e.target.value;

          if(['preco','qtd','duracao'].includes(k)) {
            v = Number(v || 0);
          }

          itens[i][k] = v;

          // Atualiza o subtotal s√≥ dessa linha
          const subCell = tbody.querySelector(`td[data-sub="${i}"]`);
          if (subCell) {
            const precoNum = Number(itens[i].preco) || 0;
            const qtdNum   = Number(itens[i].qtd)   || 0;
            subCell.textContent = fmt(precoNum * qtdNum);
          }

          // Atualiza o total geral
          renderTotal();
        });
      });

      tbody.querySelectorAll('button[data-rem]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = Number(btn.dataset.rem);
          itens.splice(idx,1);
          renderTabela();
          renderTotal();
        });
      });
    }

    function montarPayloadAtual(){
      const cliente = {
        tipo: el('tipoCliente')?.value || '',
        nome: el('nomeCliente')?.value || '',
        contato: el('contatoCliente')?.value || '',
        telefone: el('telCliente')?.value || '',
        email: el('emailCliente')?.value || '',
        referencia: el('obsCliente')?.value || ''
      };

      const itensValidos = itens
        .filter(rowHasValue)
        .map(it => ({
          codigo: it.codigo || null,
          nome: it.nome || '',
          preco: Number(it.preco || 0),
          qtd: Number(it.qtd || 1),
          duracaoMin: it.duracao ? Number(it.duracao || 0) : 0
        }));

      if(!itensValidos.length){
        return null;
      }

      const payload = {
        origem: 'manual',
        cliente,
        itens: itensValidos,
        mensagemEnvio: el('msgEnvio')?.value || '',
        infoAdicionais: el('infoAdicionais')?.value || '',
        total: getTotal(),   // ‚úÖ manda o total j√° calculado
        moeda: 'BRL'         // ‚úÖ contrato v1: sempre BRL
      };

      return payload;
    }

    async function salvarOrcamentoManualNoBackend(){
      try{
        if(isValidate){
          console.log('[orcamentos] validate=1 ‚Üí n√£o grava or√ßamento no backend');
          return;
        }
        if(!hasFirebaseCompat()){
          console.log('[orcamentos] sem Firebase compat, n√£o grava or√ßamento');
          return;
        }

        const token = await getIdToken();
        if(!token){
          console.log('[orcamentos] sem ID token, n√£o grava or√ßamento');
          return;
        }

        const payload = montarPayloadAtual();
        if(!payload){
          console.log('[orcamentos] nenhum item v√°lido para gravar');
          return;
        }

        const resp = await fetch('/api/orcamentos', {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        if(!resp.ok){
          console.warn('[orcamentos] falha ao salvar or√ßamento manual:', resp.status);
          return null;
        }

        const data = await resp.json();
        console.log('[orcamentos] or√ßamento salvo:', data);

        // Se backend devolveu n√∫mero, reaproveita no timbrado
        if(data && data.numero){
          numero = data.numero;
          const badge = el('numero-badge');
          if(badge){
            badge.textContent = numero;
            badge.style.display = 'inline-block';
          }
        }

        // Atualiza hist√≥rico em mem√≥ria
        if(data && data.id){
          orcamentosHistorico.unshift({
            id: data.id,
            createdAt: data.createdAt || new Date().toISOString(),
            clienteNome: payload.cliente?.nome || '',
            origem: payload.origem || 'manual',
            total: data.total || getTotal(),
            moeda: data.moeda || 'BRL'
          });
          renderHistoricoOrcamentos();
        }

        // ‚úÖ retorna o or√ßamento salvo (gancho p/ futuro: enviar-whatsapp por ID, etc.)
        return data;
      }catch(err){
        console.warn('[orcamentos] erro ao salvar or√ßamento manual:', err);
        return null;
      }
    }

    // ---------------- Copiar / Imprimir / Exportar ----------------
    function garantirNumeroOrcamento(){
      if(numero) return;
      const ano = new Date().getFullYear();
      const seq = Math.floor(Math.random()*90000)+10000;
      numero = `ORC-${ano}-${String(seq).padStart(5,'0')}`;
      const badge = el('numero-badge');
      if(badge){
        badge.textContent = numero;
        badge.style.display='inline-block';
      }
    }

    function bindAcoes(){
      const btnBusca = el('btn-buscar');
      if(btnBusca){
        btnBusca.addEventListener('click', ()=>{
          const tEl = el('busca');
          if(!tEl) return;
          const entrada = tEl.value.trim();
          if(!entrada) return;

          // Decide em qual linha cair
          const idx = itens.findIndex(x => !x.nome && !x.codigo && !(Number(x.preco)>0));
          const target = idx>=0 ? itens[idx] : (itens.push({codigo:'', nome:'', preco:0, qtd:1, duracao:''}), itens[itens.length-1]);

          // Tenta achar servi√ßo cadastrado
          const svc = encontrarServicoPorEntrada(entrada);

          if(svc){
            // Preenche com dados do cat√°logo de servi√ßos
            target.codigo  = svc.codigo || '';
            target.nome    = svc.nome || entrada;
            target.preco   = typeof svc.precoBase === 'number' ? svc.precoBase : (parseFloat(svc.precoBase || '0') || 0);
            target.qtd     = 1;
            target.duracao = typeof svc.duracaoMin === 'number' ? svc.duracaoMin : (parseInt(svc.duracaoMin || '0') || 0);
          }else{
            // Fallback: comportamento antigo ‚Äì s√≥ joga texto na linha
            if(entrada.startsWith('#')){
              target.codigo = entrada.replace('#','').toUpperCase();
            }else{
              target.nome = entrada;
            }
          }

          tEl.value='';
          renderTabela(); 
          renderTotal();
        });
      }

      const btnAdd = el('btn-add-linha');
      if(btnAdd){
        btnAdd.addEventListener('click', ()=>{
          itens.push({codigo:'', nome:'', preco:0, qtd:1, duracao:''});
          renderTabela();
        });
      }

      const btnSalvarInfoLocal = el('btn-salvar-info-local');
      if(btnSalvarInfoLocal){
        btnSalvarInfoLocal.addEventListener('click', saveInfoLocal);
      }

      const btnCopiar = el('btn-copiar');
      if(btnCopiar){
        btnCopiar.addEventListener('click', ()=>{
          if(!el('msgEnvio')) return;
          navigator.clipboard.writeText(el('msgEnvio').value||'').then(()=>{
            alert('üìã Mensagem copiada!');
          });
        });
      }

      const btnImprimir = el('btn-imprimir');
      if(btnImprimir){
        btnImprimir.addEventListener('click', async ()=>{
          await salvarOrcamentoManualNoBackend();
          garantirNumeroOrcamento();
          window.print();
        });
      }

      const btnEmail = el('btn-email');
      if (btnEmail) {
        btnEmail.addEventListener('click', async () => {
          await salvarOrcamentoManualNoBackend();
          garantirNumeroOrcamento();

          const empresa = el('orcNomeEmpresaTopo')?.textContent || 'Meu MEI';
          const num = numero || 'Or√ßamento (sem n√∫mero)';
          const cliente = el('nomeCliente')?.value || 'Cliente';

          // Monta linhas em texto puro (com quebras de linha normais)
          const linhas = itens
            .filter(rowHasValue)
            .map(it =>
              `- ${it.codigo ? ('#' + it.codigo + ' - ') : ''}${it.nome || ''} x ${it.qtd || 1} ‚Äî ${fmt((it.preco || 0) * (it.qtd || 1))}`
            )
            .join('\n');

          const total = getTotal();
          const infoExtra = el('infoAdicionais')?.value || '';
          const msgBase = el('msgEnvio')?.value || '';

          const corpoTxt = `${msgBase}

${empresa}
${num}
Cliente: ${cliente}

Itens:
${linhas}

Total: ${fmt(total)}

${infoExtra}`;

          const corpo = encodeURIComponent(corpoTxt);
          const subject = encodeURIComponent(`${empresa} ‚Äî ${num}`);
          location.href = `mailto:?subject=${subject}&body=${corpo}`;
        });
      }

      const btnWhats = el('btn-whats');
      if(btnWhats){
        btnWhats.addEventListener('click', async ()=>{
          await salvarOrcamentoManualNoBackend();
          garantirNumeroOrcamento();

          const empresa = el('orcNomeEmpresaTopo')?.textContent || 'Meu MEI';
          const num = numero || 'Or√ßamento (sem n√∫mero)';
          const cliente = el('nomeCliente')?.value || 'Cliente';

          const linhas = itens
            .filter(rowHasValue)
            .map(it =>
              `‚Ä¢ ${it.codigo ? ('#' + it.codigo + ' - ') : ''}${it.nome || ''} x ${it.qtd || 1} ‚Äî ${fmt((it.preco || 0) * (it.qtd || 1))}`
            )
            .join('\n');

          const total = getTotal();
          const msgBase = el('msgEnvio')?.value || '';
          const infoExtra = el('infoAdicionais')?.value || '';

          const textoPlano =
            `${msgBase}\n\n` +
            `${empresa}\n` +
            `${num}\n` +
            `Cliente: ${cliente}\n\n` +
            `Itens:\n${linhas}\n\n` +
            `Total: ${fmt(total)}\n\n` +
            `${infoExtra}`;

          const texto = encodeURIComponent(textoPlano);
          window.open(`https://wa.me/?text=${texto}`, '_blank');
        });
      }

      const btnConfigTimbrado = el('btn-config-timbrado');
      if (btnConfigTimbrado) {
        btnConfigTimbrado.addEventListener('click', () => {
          let url = '/pages/orcamentos-config.html';
          if (isValidate) {
            url += '?validate=1';
          }
          window.location.href = url;
        });
      }

      const btnVoltar = el('btn-voltar-dashboard');
      if(btnVoltar){
        btnVoltar.addEventListener('click', ()=>{
          window.location.href = '/pages/dashboard.html';
        });
      }

      const btnToggleManual = el('btn-toggle-manual');
      const manualSection = el('manual-section');
      if(btnToggleManual && manualSection){
        let aberto = false;
        const updateLabel = ()=> btnToggleManual.textContent = aberto ? 'Esconder formul√°rio' : 'Mostrar formul√°rio';
        updateLabel();
        btnToggleManual.addEventListener('click', ()=>{
          aberto = !aberto;
          manualSection.style.display = aberto ? 'block' : 'none';
          updateLabel();
        });
      }
    }

    // ---------------- Boot ----------------
    window.addEventListener('load', ()=>{
      renderHistoricoOrcamentos();     // placeholder
      carregarHistoricoDoBackend();    // busca real no /api/orcamentos
      loadLocalDefaults();             // texto local de info adicionais
      loadOrcamentoVisualConfig();     // timbrado + textos padr√£o
      loadServicosCatalog();           // cat√°logo de servi√ßos para preencher pre√ßo/dura√ß√£o
      bindAcoes();                     // eventos de bot√µes
    });
  </script>
</body>
</html>
