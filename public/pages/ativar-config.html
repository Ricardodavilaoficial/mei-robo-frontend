<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Primeiros passos ‚Äî MEI Rob√¥</title>

  <!-- Refor√ßos essenciais e neutros -->
  <meta http-equiv="Cache-Control" content="no-store, max-age=0, must-revalidate" />
  <meta name="robots" content="noindex, nofollow" />

  <link rel="stylesheet" href="/assets/styles.css" />
  <link rel="icon" href="data:,">

  <!-- ‚úÖ Firebase compat (DEVE vir antes do firebase-init.js) -->
  <script defer src="/__/firebase/9.22.2/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/9.22.2/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/init.js"></script>

  <!-- Helper que espera o Firebase e injeta Authorization: Bearer quando necess√°rio -->
  <script src="/assets/firebase-init.js"></script>
  <script src="/assets/backend-patch.js"></script>
  <script defer src="/assets/layout.js"></script>

  <style>
    .wrap { max-width:900px; margin:24px auto; padding:0 12px; }
    .card-dark { background:#101414; color:#e9f4f1; border:1px solid #23302e; border-radius:14px; padding:16px; }
    .muted { color:#b6c9c3; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#0f1413; border:1px solid #23302e; font-size:12px; margin-right:6px }
    .badge { padding:2px 8px; border:1px solid #23302e; border-radius:999px; font-size:12px; }
    .ok { border-color:#2f6; }
    .warn { border-color:#fd6; }
    .err { border-color:#f88; }
    .grid { display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .field { background:#0c1211; border:1px solid #23302e; border-radius:10px; padding:10px; }
    .field .label { font-size:12px; color:#b6c9c3; margin-bottom:4px }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .cta { font-weight:800; }
    .list { margin:0; padding-left:18px; }
  </style>
</head>
<body>
  <div id="app-header"></div>

  <main class="wrap">
    <div class="card-dark">
      <h2 style="margin:0 0 6px">Boas-vindas! Vamos deixar tudo pronto.</h2>
      <p id="introText" class="muted" style="margin:0 0 10px">
        Confirmamos sua assinatura. Confira abaixo os dados da sua empresa (j√° pr√©-preenchidos)
        e avance para as configura√ß√µes iniciais.
      </p>

      <div id="status" class="badge muted">carregando‚Ä¶</div>

      <!-- Identidade pr√°tica dentro do MEI Rob√¥ -->
      <div id="perfil" class="section" style="margin-top:12px"></div>

      <!-- Dados fiscais / CNPJ -->
      <div id="empresa" class="section" style="margin-top:12px"></div>

      <details style="margin-top:10px">
        <summary>O que voc√™ pode fazer agora?</summary>
        <ul class="list">
          <li>Cadastre seus contatos e j√° personalize o jeito que voc√™ fala com cada cliente.</li>
          <li>Liste seus servi√ßos e pre√ßos para o MEI Rob√¥ responder or√ßamentos direto pelo WhatsApp.</li>
          <li>Defina as regras da sua agenda para o MEI Rob√¥ marcar hor√°rios como se fosse voc√™.</li>
          <li>Crie um modelo de or√ßamento timbrado para quando voc√™ precisar formalizar seus pre√ßos.</li>
        </ul>
      </details>

      <p class="muted" style="margin-top:10px">
        Seu n√∫mero de WhatsApp com o MEI Rob√¥ ser√° configurado em at√© <strong>7 dias √∫teis</strong>.
        Enquanto isso, usar essas informa√ß√µes ajuda a deixar sua voz digital, sua agenda e seus atendimentos prontos
        para quando os clientes come√ßarem a chamar.
      </p>

      <div class="actions">
        <a id="btnContinuar" class="cta" href="/pages/dashboard.html">Salvar e continuar</a>
        <a class="btn-secondary" href="/pages/ativar-cliente.html">Voltar</a>
      </div>
      <p id="docsHint" class="muted" style="display:none;margin-top:6px">
        Percebemos uma pend√™ncia de v√≠nculo. Se necess√°rio, <a href="/pages/vinculo.html">envie seus documentos aqui</a>.
      </p>
    </div>
  </main>

  <div id="app-footer"></div>

  <script>
    (function(){
      const API_BASE = "https://mei-robo-prod.onrender.com";
      const API = {
        status:  API_BASE + "/api/conta/status",
        vinculo: API_BASE + "/api/verificacao/autoridade/status",
        config:  API_BASE + "/api/configuracao"
      };

      const $status   = document.getElementById('status');
      const $perfil   = document.getElementById('perfil');
      const $empresa  = document.getElementById('empresa');
      const $docsHint = document.getElementById('docsHint');

      // MOCK de preview: ?mock=ok | missing | error
      const qs = new URLSearchParams(location.search);
      const mock = (qs.get('mock')||'').toLowerCase();
      const isFree = qs.get('free') === '1';
      const hasStripeSession = qs.has('session_id');
      let arrivedMsg = null;

      function pill(text, cls){
        $status.textContent = text;
        $status.className = 'badge ' + (cls || 'muted');
      }

      function html(parts){
        return parts.filter(Boolean).join('');
      }

      // Escapa HTML para evitar XSS em dados vindos do backend
      function esc(s){
        return String(s)
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
      }

      // Texto com placeholder seguro
      function t(v){
        return (v===null||v===undefined||v==='') ? "<span class='muted'>‚Äî</span>" : esc(String(v));
      }

      function fmtCnpj(raw){
        const d = String(raw || '').replace(/\D+/g,'');
        if (d.length !== 14) return raw || '';
        return d.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, "$1.$2.$3/$4-$5");
      }

      // üîë Auth: pega uid + idToken do Firebase (se logado)
      async function getAuthContext(){
        let idToken = null;
        let uid = null;
        try{
          if (window.firebase && firebase.auth && firebase.auth().currentUser) {
            const user = firebase.auth().currentUser;
            uid = user.uid;
            idToken = await user.getIdToken(true);
          }
        } catch(e){
          console.warn('[ativar-config] falha ao obter idToken:', e);
        }
        return { uid, idToken };
      }

      // Normaliza formatos alternativos de resposta
      function normalizeConta(body){
        if (!body || typeof body !== 'object') {
          return { empresa:{}, vinculo:{}, publico:{} };
        }

        // ---- Empresa (jur√≠dica / CNPJ) ----
        const beEmp = body.empresa || {};
        const empresa = body.empresa ? {
          cnpj: beEmp.cnpj || beEmp.cnpjNumero || beEmp.cnpj_numero || beEmp.cnpjFormatado || null,
          razaoSocial: beEmp.razaoSocial || beEmp.razao_social || beEmp.legal_name || null,
          nomeFantasia: beEmp.nomeFantasia || beEmp.nome_fantasia || beEmp.trade_name || null,
          endereco: beEmp.endereco || {
            municipio: beEmp.municipio || beEmp.municipioDescricao || null,
            uf: beEmp.uf || beEmp.estado || null
          },
          cnaePrincipal: beEmp.cnaePrincipal || beEmp.cnae_principal || {
            codigo: beEmp.cnaePrincipalCodigo || beEmp.cnae_principal_codigo || null,
            descricao: beEmp.cnaePrincipalDescricao || beEmp.cnae_principal_descricao || null
          }
        } : {
          // Fallback antigo (body "flat")
          cnpj: body.cnpj || body.CNPJ || null,
          razaoSocial: body.razaoSocial || body.razao || null,
          nomeFantasia: body.nomeFantasia || body.fantasia || null,
          endereco: body.endereco || null,
          cnaePrincipal: body.cnaePrincipal || body.cnae_principal || body.CNAE || null
        };

        // ---- Perfil p√∫blico (o que o cliente v√™) ----
        const bePub = body.publico || body.perfil_publico || {};
        const publico = {
          nomePublico:
            bePub.nomePublico ||
            bePub.nome_publico ||
            bePub.displayName ||
            bePub.nomeNegocio ||
            bePub.nome_negocio ||
            null,
          segmentoPublico:
            bePub.segmentoPublico ||
            bePub.segmento_publico ||
            bePub.nicho ||
            bePub.atividade ||
            null,
          descricaoPublica:
            bePub.descricaoPublica ||
            bePub.descricao_publica ||
            bePub.mensagemBoasVindas ||
            bePub.headline ||
            null,
        };

        const vinculo = body.vinculo || {
          stripe_enabled: !!(body.stripe_enabled || body.stripeEnabled || body.assinatura_ativa),
          needs_docs: !!(body.needs_docs || body.needsDocs || body.docs_pendentes),
          pending_review: !!(body.pending_review || body.revisao_pendente)
        };

        return { empresa, vinculo, publico };
      }

      // Mapeia um CNAE (c√≥digo/descri√ß√£o) para um r√≥tulo amig√°vel
      function mapSegmento(cnae){
        const base = cnae || {};
        const txt = String(base.descricao || base.codigo || '').toLowerCase();
        if (!txt) return { segmento: null, cnae: base };

        const M = [
          { key: /cabeleire|est(√©|e)t(ica|√©tico)|manicure|sal(√£|a)o/, seg: "Beleza e est√©tica" },
          { key: /restaurante|lanchonete|bar|pizzaria|food|delivery|sandu/i, seg: "Alimenta√ß√£o" },
          { key: /constr|reforma|obras|pedreiro|pintor|hidra|el[e√©]tric/i, seg: "Constru√ß√£o e servi√ßos" },
          { key: /com[e√©]rcio|varejo|loja|e-?commerce|market/i, seg: "Com√©rcio e e-commerce" },
          { key: /sa√∫de|cl[i√≠]nica|odont|fisiot|psic|nutri/i, seg: "Sa√∫de e bem-estar" },
          { key: /auto|mec[a√¢]n|oficina|detailing|lava/i, seg: "Automotivo" },
          { key: /educa|curso|aula|treina|coach/i, seg: "Educa√ß√£o e cursos" },
        ];
        const f = M.find(m => m.key.test(txt));
        return { segmento: f ? f.seg : "Outros", cnae: base };
      }

      function setArrivalHeader(){
        const h2 = document.querySelector('h2');
        const p  = document.getElementById('introText');

        if (isFree) {
          if (h2) h2.textContent = 'Boas-vindas! Seu cupom foi aplicado.';
          if (p)  p.innerHTML = 'Seu n√∫mero de WhatsApp com o MEI Rob√¥ chega em at√© 7 dias √∫teis. '
            + 'Cupom validado e licen√ßa ativada. Confira os dados da sua empresa e avance para as configura√ß√µes iniciais.';
          arrivedMsg = 'cupom aplicado';
        } else if (hasStripeSession) {
          if (h2) h2.textContent = 'Boas-vindas! Pagamento confirmado.';
          if (p)  p.innerHTML = 'Seu n√∫mero de WhatsApp com o MEI Rob√¥ chega em at√© 7 dias √∫teis. '
            + 'Confira os dados da sua empresa e avance para as configura√ß√µes iniciais.';
          arrivedMsg = 'pagamento confirmado';
        }
      }

      function renderEmpresa(data){
        const norm = normalizeConta(data);
        const emp  = norm.empresa || {};
        const vinc = norm.vinculo || {};
        const pub  = norm.publico || {};
        const cnae = emp.cnaePrincipal || {};
        const seg  = mapSegmento(cnae);

        // Nome/segmento p√∫blico (o que o cliente v√™)
        const atividadeLabel =
          pub.nomePublico ||
          emp.comoAparecer ||
          cnae.descricao ||
          cnae.codigo ||
          seg.segmento ||
          null;

        const segmentoLabel =
          pub.segmentoPublico ||
          emp.segmentoEscolhido ||
          seg.segmento ||
          null;

        const descricaoPublica = pub.descricaoPublica || null;
        const cnpjFormatado = emp.cnpj ? fmtCnpj(emp.cnpj) : null;
        const cnaeLabel = cnae.descricao || cnae.codigo || emp.cnaeOficialDescricao || null;

        // Card "Como voc√™ vai aparecer..."
        $perfil.innerHTML = html([
          `<div class="field"><div class="label">Como voc√™ vai aparecer no MEI Rob√¥</div><div>${t(atividadeLabel)}</div></div>`,
          `<div class="field" style="margin-top:8px"><div class="label">Segmento</div><div>${t(segmentoLabel)}</div></div>`,
          descricaoPublica
            ? `<div class="field" style="margin-top:8px"><div class="label">Mensagem para seus clientes</div><div>${t(descricaoPublica)}</div></div>`
            : '',
          `<p class="muted" style="margin-top:8px">` +
            `Essas informa√ß√µes s√£o a vitrine do seu neg√≥cio dentro do MEI Rob√¥: √© como os clientes v√£o ver voc√™ em agenda, or√ßamentos e hist√≥rico.` +
          `</p>`
        ]);

        const endereco = emp.endereco || {};
        const loc = [endereco.municipio, endereco.uf].filter(Boolean).map(esc).join(' / ');

        const pills = html([
          emp.cnpj ? `<span class="pill mono">${t(cnpjFormatado || emp.cnpj)}</span>` : '',
          segmentoLabel ? `<span class="pill">${t(segmentoLabel)}</span>` : '',
          cnaeLabel ? `<span class="pill">${t(cnaeLabel)}</span>` : ''
        ]);

        // Card de dados fiscais / CNPJ
        $empresa.innerHTML = html([
          `<div class="field" style="margin-bottom:10px">`,
            `<div class="label">Status da conta</div>`,
            `<div>`,
              `<span class="pill ok">dados carregados ‚úî</span>`,
              vinc.stripe_enabled ? `<span class="pill ok">assinatura ativa ‚úî</span>` : '',
            `</div>`,
          `</div>`,
          `<div class="grid" style="margin-top:4px">`,
            `<div class="field"><div class="label">Raz√£o social</div><div>${t(emp.razaoSocial)}</div></div>`,
            `<div class="field"><div class="label">Nome fantasia</div><div>${t(emp.nomeFantasia)}</div></div>`,
            `<div class="field"><div class="label">CNPJ</div><div>${t(cnpjFormatado || emp.cnpj)}</div></div>`,
            `<div class="field"><div class="label">CNAE principal</div><div>${t(cnaeLabel)}</div></div>`,
            `<div class="field"><div class="label">Munic√≠pio/UF</div><div>${loc || "<span class='muted'>‚Äî</span>"}</div></div>`,
          `</div>`,
          pills ? `<div style="margin-top:10px">${pills}</div>` : '',
          `<p class="muted" style="margin:10px 0 0">` +
            `Esses dados v√™m do seu CNPJ e s√£o usados apenas para cobran√ßa, documentos e verifica√ß√£o da empresa. ` +
            `Seus clientes n√£o veem o CNAE nem essa descri√ß√£o fiscal.` +
          `</p>`
        ]);

        if (vinc.needs_docs) {
          $docsHint.style.display = 'block';
        }
      }

      // MOCK objects (pr√©-visualiza√ß√£o via ?mock=ok|missing|error)
      function mockData(){
        if (mock === 'ok') {
          return {
            empresa: {
              cnpj: "12.345.678/0001-90",
              razaoSocial: "Exemplo Servi√ßos Ltda",
              nomeFantasia: "Exemplo",
              endereco: { municipio: "Porto Alegre", uf: "RS" },
              cnaePrincipal: {
                codigo: "9602-5/01",
                descricao: "Cabeleireiros, manicure e pedicure"
              }
            },
            vinculo: {
              stripe_enabled: true,
              needs_docs: false,
              pending_review: false
            }
          };
        }
        if (mock === 'missing') {
          return {
            empresa: {},
            vinculo: { stripe_enabled: true, needs_docs: false, pending_review: false }
          };
        }
        if (mock === 'error') {
          return null;
        }
        return null;
      }

      // Hidrata os dados de "como voc√™ quer aparecer" a partir de /api/configuracao
      async function hydratePerfilFromConfig(data, auth){
        try{
          const { idToken } = auth || {};
          const headers = {};
          if (idToken) headers['Authorization'] = 'Bearer ' + idToken;

          const r = await fetchJSON(API.config, { headers });
          if (!r || !r.ok || !r.body) return data;

          const body = r.body || {};
          const cfg  = body.data || body || {};   // <--- nosso formato atual
          const empresa = data.empresa || {};

          // Tentamos achar o perfil em alguns formatos comuns
          const perfil = body.perfil || body.profile || body.dadosPerfil || cfg || {};

          const atividade =
            perfil.atividade ||
            perfil.atividade_principal ||
            perfil.comoAparecer ||
            perfil.como_aparecer ||
            cfg.public_brand ||      // <--- nome p√∫blico configurado
            cfg.display_name ||      // <--- "como voc√™ costuma ser chamado?"
            cfg.nome ||              // fallback
            null;

          const segmento =
            perfil.segmento ||
            perfil.segmento_principal ||
            cfg.segmento ||          // <--- segmento vindo de configuracao.html
            cfg.area ||
            cfg.areaAtuacao ||
            null;

          if (atividade) empresa.comoAparecer = atividade;
          if (segmento) empresa.segmentoEscolhido = segmento;

          data.empresa = empresa;

          console.debug('[ativar-config] perfil aplicado a partir de /api/configuracao:', {
            comoAparecer: empresa.comoAparecer,
            segmentoEscolhido: empresa.segmentoEscolhido,
          });

          return data;
        } catch(e){
          console.warn('[ativar-config] hydratePerfilFromConfig erro:', e);
          return data;
        }
      }

      async function fetchJSON(url, options){
        const r = await fetch(url, Object.assign({ credentials:'include' }, options || {}));
        const ct = r.headers.get('content-type') || '';
        const body = ct.includes('application/json') ? await r.json() : await r.text();
        return { ok: r.ok, status: r.status, body };
      }

      async function load(){
        setArrivalHeader(); // atualiza header conforme origem (cupom/stripe)
        try{
          // mock shortcut
          const mk = mockData();
          if (mk) {
            pill('dados carregados ‚úî', 'ok');
            renderEmpresa(mk);
            safeCheckDocs();
            return;
          }

          pill('carregando‚Ä¶', 'muted');

          // üîë tenta pegar uid + token pra chamar /api/conta/status?uid=...
          const auth = await getAuthContext();
          const { uid, idToken } = auth;
          let url = API.status;
          const headers = {};

          if (idToken) {
            headers['Authorization'] = 'Bearer ' + idToken;
            if (uid && !url.includes('uid=')) {
              url = url + '?uid=' + encodeURIComponent(uid);
            }
          }

          let r = await fetchJSON(url, { headers }).catch(()=>null);

          if (!r || !r.ok || !r.body) {
            if (r && r.status === 401) {
              pill('entre para continuar', 'warn');
              $perfil.innerHTML = '';
              $empresa.innerHTML =
                '<p class="muted">Fa√ßa login para ver seus dados.</p>' +
                '<p><a class="btn-secondary" href="/pages/login.html">Entrar</a></p>';
            } else {
              // no p√≥s-pagamento/cupom, n√£o assusta o usu√°rio com "erro"
              if (hasStripeSession || isFree) {
                pill('dados pendentes', 'muted');
                $perfil.innerHTML = '';
                $empresa.innerHTML =
                  '<p class="muted">Voc√™ pode seguir com as configura√ß√µes iniciais; os dados da empresa ser√£o carregados em breve.</p>';
              } else {
                pill('n√£o foi poss√≠vel carregar agora', 'err');
                $perfil.innerHTML = '';
                $empresa.innerHTML =
                  '<p class="muted">Tente novamente em alguns instantes. Se persistir, fale com o suporte.</p>';
              }
            }
            return;
          }

          // üí° Aqui hidrata com o que o MEI escolheu na configura√ß√£o
          let body = r.body;
          body = await hydratePerfilFromConfig(body, auth);

          pill('dados carregados ‚úî', 'ok');
          renderEmpresa(body);
          safeCheckDocs();
        } catch (e){
          console.error('[ativar-config] erro em load:', e);
          // no p√≥s-pagamento/cupom, mantemos a jornada "feliz"
          if (hasStripeSession || isFree) {
            pill('dados pendentes', 'muted');
            $perfil.innerHTML = '';
            $empresa.innerHTML =
              '<p class="muted">Voc√™ pode seguir com as configura√ß√µes iniciais; os dados da empresa ser√£o carregados em breve.</p>';
          } else {
            pill('n√£o foi poss√≠vel carregar agora', 'err');
            $perfil.innerHTML = '';
            $empresa.innerHTML =
              '<p class="muted">Tente novamente em alguns instantes. Se persistir, fale com o suporte.</p>';
          }
        }
      }

      async function safeCheckDocs(){
        try{
          const { idToken } = await getAuthContext();
          const headers = {};
          if (idToken) headers['Authorization'] = 'Bearer ' + idToken;

          const r = await fetchJSON(API.vinculo, { headers });
          if (r && r.ok && r.body) {
            const needs = !!(r.body.needs_docs || r.body.needsDocs || r.body.docs_pendentes);
            if (needs) $docsHint.style.display = 'block';
          }
        } catch(e){
          // opcional, n√£o quebra jornada
          console.warn('[ativar-config] erro em safeCheckDocs:', e);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        try {
          if (window.firebase && firebase.auth) {
            firebase.auth().onAuthStateChanged((user) => {
              if (user) {
                // S√≥ chama load quando j√° temos currentUser/uid/idToken
                load();
              } else {
                // Mesmo tratamento de "n√£o logado" que voc√™ j√° tinha
                pill('entre para continuar', 'warn');
                $perfil.innerHTML = '';
                $empresa.innerHTML =
                  '<p class="muted">Fa√ßa login para ver seus dados.</p>' +
                  '<p><a class="btn-secondary" href="/pages/login.html">Entrar</a></p>';
              }
            });
          } else {
            // Fallback: se por algum motivo o Firebase n√£o estiver carregado,
            // mant√©m o comportamento antigo.
            load();
          }
        } catch (e) {
          console.warn('[ativar-config] falha ao registrar onAuthStateChanged, usando fallback:', e);
          load();
        }
      });
    })();
  </script>
</body>
</html>

