<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MEI Rob√¥ ‚Äî Cadastro</title>

  <!-- Canonical WWW v1.0 placeholders (o layout.js sobrescreve em runtime, se precisar) -->
  <link rel="canonical" href="https://www.meirobo.com.br/cadastro.html" />
  <meta property="og:url" content="https://www.meirobo.com.br/cadastro.html" />
  <meta name="twitter:url" content="https://www.meirobo.com.br/cadastro.html" />
  
  <!-- Firebase Hosting: SDK compat + init autom√°tico -->
  <script defer src="/__/firebase/9.22.2/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/9.22.2/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/init.js?useEmulator=false"></script>
  <script>
  window.addEventListener('load', () => {
    try {
      if (window.firebase?.apps?.length) {
        window.auth = firebase.auth();
        console.log('[cadastro] Firebase pronto (Hosting init).');
      } else {
        console.error('[cadastro] Firebase n√£o inicializou via Hosting.');
      }
    } catch (e) { console.error(e); }
  });
  </script>

  <!-- reCAPTCHA v2 Invisible (fallback N√ÉO usado, mas mantido) -->
  <meta name="RECAPTCHA_SITE_KEY" content="">

  <!-- Cloudflare Turnstile (produ√ß√£o) -->
  <meta name="TURNSTILE_SITE_KEY" content="0x4AAAAAAB0t6kBJwJJgmsr3">
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <link rel="stylesheet" href="/assets/styles.css" />

  <style>
    .card-dark {
      background: #101414;
      color: #e9f4f1;
      border: 1px solid #23302e;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
    }
    .card-dark .hint { color: #b6c9c3; }
    .card-dark .input {
      background: #141a1a;
      border: 1px solid #23302e;
      color: #e9f4f1;
    }
    .card-dark .input:focus {
      border-color: #3a8f7c;
      box-shadow: 0 0 0 2px rgba(31,170,133,0.12);
      outline: 0;
    }
    .btn-disabled { opacity: .6; pointer-events: none; }
  </style>
</head>
<body>
  <div id="app-header"></div>
  <div id="header"></div>

  <main class="section">
    <div class="container form-wrap">
      <h1 style="color:var(--wa-dark); margin:0 0 6px">Criar minha conta</h1>

      <div class="note card-dark" style="margin:10px 0 18px; padding:14px">
        <p class="hint" style="margin:0">
          Sua conta √© pessoal e intransfer√≠vel e s√≥ ser√° validada quando
          <strong>vincular voc√™ ao CNPJ ou procura√ß√£o da empresa</strong>.
          Para ativar o MEI Rob√¥, √© obrigat√≥rio <strong>digitalizar sua voz</strong> para uso exclusivo na sua conta:
          grave √°udios n√≠tidos, em local silencioso e sem eco, falando naturalmente, como numa conversa.
          <strong>O envio de voz ser√° feito na pr√≥xima etapa (Configura√ß√£o da Conta) ap√≥s verificar seu e-mail.</strong><br/>
          Todas as informa√ß√µes s√£o criptografadas e mantidas em sigilo.
          Consulte os <a href="/termos.html" target="_blank" rel="noopener noreferrer">Termos de Uso</a>.
        </p>
      </div>

      <div class="form-grid">
        <form id="signupForm" class="form-card card-dark" action="#" method="POST" novalidate>
          <div class="form-row">
            <label for="nome"><strong>Nome completo</strong></label>
            <input id="nome" name="name" class="input" type="text" placeholder="Ex.: Maria Silva" autocomplete="name" required />
            <span class="hint">Use o seu nome ‚Äî √© quem falar√° com seus clientes.</span>
          </div>

          <div class="form-row">
            <label for="email"><strong>E-mail</strong></label>
            <input id="email" name="email" class="input" type="email" placeholder="voce@email.com"
                   autocomplete="email" required aria-describedby="emailHelp" />
            <span id="emailHelp" class="hint">Enviaremos um link de verifica√ß√£o para este endere√ßo.</span>
          </div>

          <div class="form-row">
            <label for="email2"><strong>Confirmar e-mail</strong></label>
            <input id="email2" name="confirm-email" class="input" type="email" placeholder="Repita o e-mail"
                   autocomplete="email" required aria-describedby="email2Help" />
            <span id="email2Help" class="hint">Digite o mesmo e-mail nos dois campos.</span>
          </div>

          <div class="form-row">
            <label for="cnpj"><strong>CNPJ</strong></label>
            <input id="cnpj" name="cnpj" class="input" inputmode="numeric"
              pattern="^\d{14}$|^\d{2}\.\d{3}\.\d{3}/\d{4}-\d{2}$"
              title="Informe um CNPJ v√°lido (14 d√≠gitos ou 00.000.000/0000-00)"
              placeholder="Somente n√∫meros ou 00.000.000/0000-00" autocomplete="on" required />
            <span class="hint">
              Checamos se j√° existe conta com este CNPJ. Voc√™ precisa estar vinculado ao CNPJ ou autorizado pela empresa.
            </span>
            <div id="cnpjStatus" class="hint" aria-live="polite" style="margin-top:6px"></div>
            <div id="microVinculo" class="hint" style="margin-top:8px">
              Pagamento e cupom ser√£o liberados <strong>depois</strong> que confirmarmos seu v√≠nculo com o CNPJ.
            </div>
          </div>

          <div class="form-row">
            <label for="senha"><strong>Criar senha</strong></label>
            <div class="inline" style="width:100%">
              <input id="senha" name="new-password" class="input" type="password" placeholder="********"
                     minlength="8" autocomplete="new-password" required aria-describedby="pwdRules pwdStrength" style="flex:1" />
              <a role="button" id="togglePwd" class="btn-secondary" aria-pressed="false" aria-controls="senha">Mostrar</a>
            </div>
            <div id="pwdRules" class="hint">M√≠nimo de 8 caracteres com: mai√∫scula, min√∫scula, n√∫mero e s√≠mbolo.</div>
            <div class="meter meter-voice" aria-hidden="true"><span id="pwdBar" class="strength-1"></span></div>
            <div id="pwdStrength" class="hint" aria-live="polite"></div>
          </div>

          <div class="form-row">
            <label for="senha2"><strong>Confirmar senha</strong></label>
            <input id="senha2" name="confirm-password" class="input" type="password" placeholder="Repita a senha" autocomplete="new-password" required />
          </div>

          <div class="form-row full">
            <div class="hint" style="margin-top:4px">
              <em>O envio de voz ser√° feito na <strong>Configura√ß√£o da Conta</strong> ap√≥s confirmar o seu e-mail.</em>
            </div>
          </div>

          <div class="form-row full">
            <label class="inline" style="gap:8px">
              <input type="checkbox" id="aceite" required />
              <span class="hint">
                Li e aceito os <a href="/termos.html" target="_blank" rel="noopener noreferrer">Termos</a> e a
                <a href="/privacidade.html" target="_blank" rel="noopener noreferrer">Pol√≠tica de Privacidade</a>.
              </span>
            </label>
          </div>

          <div id="formMsg" class="hint"></div>

          <div class="actions" style="margin-top:12px">
            <button id="submitBtn" type="submit" class="cta">Avan√ßar</button>
          </div>

          <!-- Turnstile container (render EXPL√çCITO; sem classe cf-turnstile para evitar auto-render) -->
          <div id="cf-turnstile-container"></div>

          <!-- reCAPTCHA invis√≠vel (fallback, n√£o usado em produ√ß√£o) -->
          <div id="recaptcha" class="g-recaptcha" data-size="invisible" style="display:none"></div>
        </form>

        <aside class="side">
          <h3>O que est√° inclu√≠do no plano</h3>
          <ul>
            <li>At√© <strong>500 conversas</strong> iniciadas pelo cliente/m√™s.</li>
            <li>At√© <strong>250 conversas</strong> iniciadas por voc√™.</li>
            <li><strong>2 GB</strong> de mem√≥ria segura para fotos, v√≠deos e cat√°logos.</li>
            <li><strong>Hist√≥rico de clientes</strong> sempre acess√≠vel.</li>
            <li>Respostas em texto e √°udio com a <strong>sua voz digitalizada</strong>.</li>
            <li><strong>Agenda inteligente</strong> com lembretes.</li>
          </ul>
        </aside>
      </div>
    </div>
  </main>

  <div id="app-footer"></div>
  <div id="footer"></div>

  <script src="/assets/layout.js?v=20250905f" defer></script>

  <!-- reCAPTCHA (invisible v2, explicit render) - fallback -->
  <script>
    let recaptchaWidgetId = null;
    let pendingSubmit = null;
    function onRecaptchaLoad(){
      try{
        const meta = document.querySelector('meta[name="RECAPTCHA_SITE_KEY"]');
        const RECAPTCHA_SITE_KEY = meta?.content?.trim();
        if (!window.grecaptcha || !RECAPTCHA_SITE_KEY) return;
        recaptchaWidgetId = grecaptcha.render('recaptcha', {
          sitekey: RECAPTCHA_SITE_KEY,
          size: 'invisible',
          callback: onRecaptchaSuccess,
          'error-callback': onRecaptchaError,
          'expired-callback': onRecaptchaExpired
        });
      } catch(e){ console.error(e); }
    }
    function onRecaptchaSuccess(token){ if (pendingSubmit) pendingSubmit(token); pendingSubmit = null; try{ grecaptcha.reset(recaptchaWidgetId);}catch(_){} }
    function onRecaptchaError(){ const msg=document.getElementById('formMsg'); msg.className='error'; msg.textContent='Falha no reCAPTCHA. Atualize a p√°gina e tente novamente.'; pendingSubmit=null; }
    function onRecaptchaExpired(){}
    window.onRecaptchaLoad = onRecaptchaLoad;
  </script>
  <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>

  <script>
    /* ====== CONFIG do Backend ====== */
    const API_BASE = "https://mei-robo-prod.onrender.com";
    const API = {
      availability: API_BASE + "/api/cnpj/availability",
      cadastro:     API_BASE + "/api/cadastro",
    };

    /* ====== UI refs ====== */
    const form = document.getElementById('signupForm');
    const submitBtn = document.getElementById('submitBtn');
    const formMsg = document.getElementById('formMsg');
    const cnpjInput = document.getElementById('cnpj');
    const cnpjStatus = document.getElementById('cnpjStatus');
    const emailInput = document.getElementById('email');
    const email2Input = document.getElementById('email2');
    const pwd = document.getElementById('senha');
    const pwd2 = document.getElementById('senha2');
    const bar = document.getElementById('pwdBar');
    const strengthText = document.getElementById('pwdStrength');
    const togglePwd = document.getElementById('togglePwd');
    let cnpjAvailability = 'unknown';

    /* ====== Turnstile render expl√≠cito + state ====== */
    let cfWidgetId = null;
    let cfToken = null;
    let turnstileBusy = false;

    function ensureTurnstileWidget(){
      try{
        if (!window.turnstile) return;
        if (cfWidgetId) return;
        const meta = document.querySelector('meta[name="TURNSTILE_SITE_KEY"]');
        const SITE_KEY = (meta?.content || '0x4AAAAAAB0t6kBJwJJgmsr3').trim();

        cfWidgetId = turnstile.render('#cf-turnstile-container', {
          sitekey: SITE_KEY,
          callback: onTurnstile,
          appearance: 'interaction-only',
          execution: 'execute',
          size: 'flexible',
          retry: 'auto',
          'retry-interval': 8000
        });
      } catch(e){ console.error('[turnstile] render falhou', e); }
    }
    document.addEventListener('DOMContentLoaded', ensureTurnstileWidget);
    window.addEventListener('load', ensureTurnstileWidget);

    function onTurnstile(token){
      cfToken = token;
      turnstileBusy = false;
      if (typeof pendingSubmit === 'function') {
        try { pendingSubmit(token); } catch(_) {}
        pendingSubmit = null;
      }
    }

    /* ====== Helpers ====== */
    function normalizeCNPJ(v){ return (v || '').replace(/\D+/g,''); }
    function validateCNPJ(cnpj){
      cnpj = normalizeCNPJ(cnpj);
      if (cnpj.length !== 14) return false;
      if (/^(\d)\1{13}$/.test(cnpj)) return false;
      let length = cnpj.length - 2;
      let numbers = cnpj.substring(0, length);
      const digits = cnpj.substring(length);
      let sum = 0; let pos = length - 7;
      for (let i = length; i >= 1; i--) {
        sum += parseInt(numbers.charAt(length - i), 10) * pos--;
        if (pos < 2) pos = 9;
      }
      let result = sum % 11 < 2 ? 0 : 11 - sum % 11;
      if (result !== parseInt(digits.charAt(0), 10)) return false;
      length = length + 1; numbers = cnpj.substring(0, length); sum = 0; pos = length - 7;
      for (let i = length; i >= 1; i--) {
        sum += parseInt(numbers.charAt(length - i), 10) * pos--;
        if (pos < 2) pos = 9;
      }
      result = sum % 11 < 2 ? 0 : 11 - sum % 11;
      return result === parseInt(digits.charAt(1), 10);
    }
    function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; }

    async function checkCNPJAvailability(){
      const raw = cnpjInput.value;
      const digits = normalizeCNPJ(raw);
      cnpjAvailability = 'unknown';
      cnpjStatus.className = 'hint';
      cnpjStatus.textContent = '';
      if (!validateCNPJ(digits)) {
        cnpjStatus.textContent = 'Revise o CNPJ: os n√∫meros n√£o formam um CNPJ v√°lido.';
        cnpjStatus.className = 'error';
        submitBtn.classList.add('btn-disabled'); submitBtn.setAttribute('aria-disabled','true'); return;
      }
      cnpjStatus.textContent = 'Verificando disponibilidade...';
      cnpjStatus.className = 'hint';
      try{
        const res = await fetch(API.availability + '?cnpj=' + encodeURIComponent(digits));
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (data && data.available === true) {
          cnpjAvailability = 'available';
          cnpjStatus.textContent = 'CNPJ dispon√≠vel para cadastro.';
          cnpjStatus.className = 'ok';
          submitBtn.classList.remove('btn-disabled'); submitBtn.removeAttribute('aria-disabled');
        } else {
          cnpjAvailability = 'unavailable';
          cnpjStatus.textContent = 'Este CNPJ j√° tem conta. Voc√™ pode recuperar o acesso ou usar outro.';
          cnpjStatus.className = 'error';
          submitBtn.classList.add('btn-disabled'); submitBtn.setAttribute('aria-disabled','true');
        }
      } catch {
        cnpjAvailability = 'unknown';
        cnpjStatus.textContent = 'N√£o foi poss√≠vel verificar agora. Validaremos no servidor.';
        cnpjStatus.className = 'hint';
        submitBtn.classList.remove('btn-disabled'); submitBtn.removeAttribute('aria-disabled');
      }
    }
    const debouncedCheck = debounce(checkCNPJAvailability, 600);
    cnpjInput.addEventListener('blur', checkCNPJAvailability);
    cnpjInput.addEventListener('input', debouncedCheck);

    function calcStrength(s){ let score=0; if(!s) return 0; if(s.length>=8)score++; if(s.length>=12)score++; if(/[a-z]/.test(s))score++; if(/[A-Z]/.test(s))score++; if(/[0-9]/.test(s))score++; if(/[^A-Za-z0-9]/.test(s))score++; return Math.min(5, Math.max(0, Math.floor(score*0.8))); }
    function updatePwdMeter(){ const s=pwd.value||''; const st=calcStrength(s); const pct=[0,20,40,60,80,100][st]; document.getElementById('pwdBar').style.width=pct+'%'; strengthText.textContent=s?(['Muito fraca','Fraca','Razo√°vel','Forte','Muito forte','Excelente'][st]):''; }
    pwd.addEventListener('input', updatePwdMeter);
    togglePwd.addEventListener('click', (e)=>{ e.preventDefault(); const visible=pwd.type==='text'; pwd.type=visible?'password':'text'; togglePwd.textContent=visible?'Mostrar':'Ocultar'; togglePwd.setAttribute('aria-pressed', String(!visible)); pwd.focus(); });

    /* ====== Helpers para Auth cleanup ====== */
    async function tryDeleteJustCreatedUser(authInst, createdNewUser){
      try{
        if (!createdNewUser) { try{ await authInst.signOut(); }catch(_){} return; }
        const u = authInst.currentUser;
        if (!u) return;
        if (!u.emailVerified) { await u.delete(); }
        else { await authInst.signOut(); }
      } catch(e){
        try{ await authInst.signOut(); }catch(_){}
        console.warn('[cadastro] falha ao deletar usu√°rio rec√©m-criado:', e?.message || e);
      }
    }

    /* Submit + Turnstile (priorit√°rio) */
    async function proceedSubmit(captchaTokenFromCallback){
      formMsg.className='hint';
      formMsg.textContent='Enviando cadastro com seguran√ßa...';

      submitBtn.classList.add('btn-disabled');
      submitBtn.setAttribute('aria-disabled','true');

      // Captcha token (Turnstile prioridade; fallback: parametro do callback)
      const captchaToken = cfToken || captchaTokenFromCallback || null;

      // Se Turnstile estiver presente mas sem token, n√£o envia
      if (window.turnstile && !captchaToken) {
        formMsg.className='error';
        formMsg.textContent='Valide o desafio de seguran√ßa para continuar.';
        submitBtn.classList.remove('btn-disabled'); submitBtn.removeAttribute('aria-disabled');
        try { if (window.turnstile) turnstile.reset(cfWidgetId); } catch(_) {}
        turnstileBusy = false;
        return;
      }

      // vari√°veis para cleanup de Auth em caso de falha
      let createdNewUser = false;
      let authInst = null;

      try{
        /* ==== Autentica e envia JSON com Bearer (sem cookies) ==== */
        const nome = (document.getElementById('nome').value || '').trim();  /* <‚Äî foi 'name' antes, agora s√≥ vari√°vel local */
        const email = (emailInput.value || '').trim();
        const password = (pwd.value || '');
        const cnpjDigits = normalizeCNPJ(cnpjInput.value || '');

        // Pega Auth
        const getAuthCompatOrModular = () => {
          if (window.firebase?.auth) {
            try { return firebase.auth(); } catch(_) {}
          }
          if (window.getAuth) {
            try { return window.getAuth(); } catch(_) {}
          }
          if (window.auth) return window.auth;
          return null;
        };
        authInst = getAuthCompatOrModular();
        if (!authInst) throw new Error('Firebase Auth n√£o inicializado nesta p√°gina.');

        async function ensureAuthenticated(email, password){
          if (authInst.currentUser) return { user: authInst.currentUser, created: false };

          if (typeof authInst.createUserWithEmailAndPassword === 'function') {
            try {
              const cred = await authInst.createUserWithEmailAndPassword(email, password);
              return { user: cred.user, created: true };
            } catch (e) {
              if (e && (e.code === 'auth/email-already-in-use' || e.code === 'auth/email-already-exists')) {
                const cred = await authInst.signInWithEmailAndPassword(email, password);
                return { user: cred.user, created: false };
              }
              throw e;
            }
          }

          if (window.createUserWithEmailAndPassword && window.signInWithEmailAndPassword) {
            const inst = window.getAuth ? window.getAuth() : authInst;
            try {
              const cred = await window.createUserWithEmailAndPassword(inst, email, password);
              return { user: cred.user, created: true };
            } catch (e) {
              if (e && (e.code === 'auth/email-already-in-use' || e.code === 'auth/email-already-exists')) {
                const cred = await window.signInWithEmailAndPassword(inst, email, password);
                return { user: cred.user, created: false };
              }
              throw e;
            }
          }

          throw new Error('SDK do Firebase Auth indispon√≠vel para criar/entrar.');
        }

        const { user, created } = await ensureAuthenticated(email, password);
        createdNewUser = !!created;
        const idToken = await user.getIdToken();

        // üö© Payload JSON ‚Äî ajustes m√≠nimos: nome + aceitarTermos como string "true"
        const payload = {
          nome,                       // <‚Äî backend espera "nome"
          email,
          cnpj: cnpjDigits,
          aceitarTermos: "true",      // <‚Äî string, n√£o boolean
        };
        if (captchaToken) payload.cf_turnstile = captchaToken;

        const headers = {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': 'Bearer ' + idToken
        };
        if (captchaToken) { headers['cf-turnstile-response'] = captchaToken; }

        const res = await fetch(API.cadastro, {
          method: 'POST',
          headers,
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch(_) {}

        if (!res.ok) {
          console.warn('[cadastro][422/debug]', res.status, data || text);

          const msg = (data && (data.message || data.detail || data.error_description || data.error)) || ('HTTP ' + res.status);

          if (res.status === 429 && data && (data.error === 'captcha_required' || data.error === 'captcha_failed')) {
            formMsg.className='error';
            formMsg.textContent = (data.error === 'captcha_failed')
              ? 'Falha na valida√ß√£o de seguran√ßa. Tente novamente.'
              : 'Valide o desafio de seguran√ßa para continuar.';
            try { if (window.turnstile) turnstile.reset(cfWidgetId); } catch(_) {}
            turnstileBusy = false;
            submitBtn.classList.remove('btn-disabled'); submitBtn.removeAttribute('aria-disabled');
            await tryDeleteJustCreatedUser(authInst, createdNewUser);
            return;
          }

          if (res.status === 422) {
            formMsg.className='error';
            if (data && (data.message || data.detail)) {
              formMsg.textContent = String(data.message || data.detail);
            } else {
              formMsg.textContent = 'Algum campo est√° inv√°lido. Revise nome, e-mail e CNPJ e tente novamente.';
            }
            try { if (window.turnstile) turnstile.reset(cfWidgetId); } catch(_) {}
            turnstileBusy = false;
            submitBtn.classList.remove('btn-disabled'); submitBtn.removeAttribute('aria-disabled');
            await tryDeleteJustCreatedUser(authInst, createdNewUser);
            return;
          }

          throw new Error('Falha no cadastro: ' + msg);
        }

        if (data.next === 'verifyEmail') {
          const mail = (data.email || email).trim();
          location.href = '/verify-email.html?email=' + encodeURIComponent(mail);
          return;
        }
        if (data.checkoutUrl) { location.href = data.checkoutUrl; return; }
        location.href = '/verify-email.html';

      } catch(e){
        console.error(e);
        formMsg.className='error';
        formMsg.textContent='N√£o foi poss√≠vel concluir agora. Tente novamente.';
        submitBtn.classList.remove('btn-disabled'); submitBtn.removeAttribute('aria-disabled');
        try { if (window.turnstile) turnstile.reset(cfWidgetId); } catch(_) {}
        turnstileBusy = false;

        if (authInst) { await tryDeleteJustCreatedUser(authInst, createdNewUser); }
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      formMsg.className='hint'; formMsg.textContent='';

      const e1 = (emailInput.value || '').trim().toLowerCase();
      const e2 = (email2Input.value || '').trim().toLowerCase();
      if (!e1 || !e2 || e1 !== e2) { formMsg.className='error'; formMsg.textContent='Os dois e-mails precisam ser iguais.'; email2Input.focus(); return; }
      if (cnpjAvailability === 'unavailable') { formMsg.className='error'; formMsg.textContent='Este CNPJ j√° tem conta. Voc√™ pode recuperar o acesso ou usar outro.'; return; }
      if (pwd.value !== pwd2.value) { formMsg.className='error'; formMsg.textContent='As duas senhas precisam ser iguais.'; return; }
      const rules=[/[a-z]/,/[A-Z]/,/[0-9]/,/[^A-Za-z0-9]/];
      if (!(rules.every(r=>r.test(pwd.value)) && pwd.value.length>=8)) { formMsg.className='error'; formMsg.textContent='Sua senha precisa ter 8 caracteres, incluindo letras mai√∫sculas, min√∫sculas, n√∫mero e s√≠mbolo.'; return; }
      if (!document.getElementById('aceite').checked) { formMsg.className='error'; formMsg.textContent='Confirme que leu e aceitou os Termos e a Pol√≠tica de Privacidade.'; return; }

      if (window.turnstile) {
        ensureTurnstileWidget();
        if (turnstileBusy) return;
        turnstileBusy = true;
        formMsg.textContent='Validando seguran√ßa...';
        pendingSubmit = (token)=> proceedSubmit(token);
        try {
          try { turnstile.reset(cfWidgetId); } catch(_) {}
          turnstile.execute(cfWidgetId);
        } catch(_) {
          turnstileBusy = false;
          proceedSubmit(null);
        }
        return;
      }

      if (typeof grecaptcha !== 'undefined' && typeof grecaptcha.execute === 'function' && recaptchaWidgetId !== null) {
        formMsg.textContent='Validando seguran√ßa...';
        pendingSubmit = (token)=> proceedSubmit(token);
        grecaptcha.execute(recaptchaWidgetId);
      } else {
        proceedSubmit(null);
      }
    });

    document.addEventListener('DOMContentLoaded', () => { /* init */ });
  </script>
</body>
</html>
