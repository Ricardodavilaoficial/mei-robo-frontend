<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configuração — MEI Robô</title>

  <!-- Canônicos -->
  <link rel="stylesheet" href="/assets/styles.css" />
  <script defer src="/assets/layout.js"></script>

  <style>
    /* pequenos ajustes visuais opcionais */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .mt-16 { margin-top: 16px; }
    .mt-24 { margin-top: 24px; }
    .w-100 { width: 100%; }
    .hint { font-size: .9rem; opacity: .85; }
    form section { margin-top: 16px; }
    form label { display: block; margin: 8px 0; }
    .btn { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; }
    .btn.primary { background: #25D366; color: #fff; }
    .btn.outline { background: #fff; border: 1px solid #ccc; }
    .card + .card { margin-top: 16px; }
  </style>
</head>
<body>
  <div id="app-header"></div>

  <main class="container">
    <div class="card">
      <h2>Configuração Inicial</h2>
      <p>Complete as etapas para ativar seu MEI Robô.</p>

      <!-- Form multi-step -->
      <form id="config-form">

        <!-- Etapa 1: Dados básicos -->
        <section>
          <h3>Dados básicos</h3>
          <div class="grid-2">
            <label>Nome:
              <input class="w-100" type="text" name="nome" required />
            </label>
            <label>Email:
              <input class="w-100" type="email" name="email" required />
            </label>
            <label>Telefone:
              <input class="w-100" type="tel" name="telefone" required />
            </label>
            <label>CNPJ:
              <input class="w-100" type="text" name="cnpj" required />
            </label>
          </div>
        </section>

        <!-- Etapa 2: Segmento -->
        <section>
          <h3>Segmento profissional</h3>
          <div class="grid-2">
            <label>Segmento:
              <input class="w-100" type="text" name="segmento" required />
            </label>
            <label>Especialização 1:
              <input class="w-100" type="text" name="esp1" />
            </label>
            <label>Especialização 2:
              <input class="w-100" type="text" name="esp2" />
            </label>
          </div>
        </section>

        <!-- Etapa 3: Estilo comunicação -->
        <section>
          <h3>Estilo de comunicação</h3>
          <div class="grid-2">
            <label>Formalidade:
              <select class="w-100" name="formalidade">
                <option value="alta">Alta</option>
                <option value="media" selected>Média</option>
                <option value="baixa">Baixa</option>
              </select>
            </label>
            <label>Usa emojis?
              <select class="w-100" name="emojis">
                <option value="sim" selected>Sim</option>
                <option value="nao">Não</option>
              </select>
            </label>
            <label>Saudação preferida:
              <input class="w-100" type="text" name="saudacao" placeholder="Ex.: Olá! Tudo bem?" />
            </label>
          </div>
        </section>

        <!-- Etapa 4: Voz -->
        <section>
          <h3>Clonagem de voz</h3>
          <input type="file" name="voz" accept="audio/*" required />
          <p class="hint"><small>⚠️ O envio da voz é obrigatório para ativação.</small></p>
        </section>

        <div class="mt-24">
          <button type="submit" class="btn primary">Salvar configuração</button>
        </div>
      </form>

      <p id="config-feedback" class="hint mt-16"></p>
    </div>

    <!-- Importar tabela de preços -->
    <div class="card">
      <h3>Importar tabela de preços</h3>
      <p class="hint">Envie um arquivo <strong>.csv</strong> ou <strong>.xlsx</strong> contendo colunas como <em>nome</em>, <em>preço</em> e (opcional) <em>duração</em> em minutos.</p>

      <div class="grid-2">
        <label>Arquivo:
          <input class="w-100" type="file" id="arquivo-precos" accept=".csv,.xlsx" />
        </label>
        <div class="mt-16">
          <button id="btn-importar" class="btn outline">Importar</button>
        </div>
      </div>

      <p id="import-feedback" class="hint mt-16"></p>
    </div>
  </main>

  <div id="app-footer"></div>

  <!-- Scripts da página -->
  <script>
    // =========================================
    // Config de API — defina uma vez no console:
    // localStorage.setItem('apiBase','https://SEU-RENDER.onrender.com')
    // =========================================
    const API_BASE = localStorage.getItem('apiBase') || '';

    // Se já tiver UID autenticado, salve no localStorage em algum momento:
    // localStorage.setItem('uid', 'demo'); // fallback para testes
    const UID = localStorage.getItem('uid') || 'demo';

    // ----------------------------
    // Submit do formulário (config)
    // ----------------------------
    const form = document.getElementById('config-form');
    const cfgFeedback = document.getElementById('config-feedback');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fd = new FormData(form);
      fd.append('uid', UID);

      cfgFeedback.textContent = 'Enviando dados...';

      try {
        const resp = await fetch(`${API_BASE}/api/configuracao`, {
          method: 'POST',
          body: fd
        });

        let payload;
        const ct = resp.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          payload = await resp.json();
        } else {
          payload = { message: await resp.text() };
        }

        if (!resp.ok) {
          cfgFeedback.textContent = '❌ Falha ao salvar: ' + (payload?.message || JSON.stringify(payload));
          return;
        }

        cfgFeedback.textContent = '✅ Configuração salva! UID: ' + (payload?.uid || UID);
        alert('Configuração salva! Status: ' + (payload?.status || 'ok'));
      } catch (err) {
        console.error(err);
        cfgFeedback.textContent = '❌ Erro ao comunicar com o servidor.';
      }
    });

    // ----------------------------
    // Importação de preços (CSV/XLSX)
    // ----------------------------
    const btnImportar = document.getElementById('btn-importar');
    const inputArquivo = document.getElementById('arquivo-precos');
    const importFeedback = document.getElementById('import-feedback');

    btnImportar.addEventListener('click', async () => {
      if (!inputArquivo.files[0]) {
        alert('Selecione um arquivo CSV/XLSX.');
        return;
      }

      importFeedback.textContent = 'Enviando tabela...';

      const fd = new FormData();
      fd.append('uid', UID);
      fd.append('arquivo', inputArquivo.files[0]);

      try {
        const resp = await fetch(`${API_BASE}/api/importar-precos`, {
          method: 'POST',
          body: fd
        });

        let payload;
        const ct = resp.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          payload = await resp.json();
        } else {
          payload = { message: await resp.text() };
        }

        if (!resp.ok) {
          importFeedback.textContent = '❌ Erro: ' + (payload?.message || JSON.stringify(payload));
          return;
        }

        importFeedback.textContent = `✅ Importação concluída! Itens: ${payload?.itens ?? '—'}`;
        alert('Importação concluída!');
      } catch (e) {
        console.error(e);
        importFeedback.textContent = '❌ Erro na importação.';
      }
    });
  </script>
</body>
</html>
